## 要件定義書: ITパスポート学習支援アプリ（仮称） Ver.4 (最終版)

**1. 概要**

本アプリケーションは、あらゆる資格試験の学習者が効率的かつ効果的に学習を進めることを支援するWebアプリケーションである。主な機能として、ユーザーが参考書やドキュメント単位で学習コンテンツを「デッキ」及び「カード」として整理し、カードの内容からGoogle Gemini APIを活用して多様な形式の問題を自動生成する機能、専門用語に関する解説を「ノート」及び「ページ」として作成・管理する機能を提供する。さらに、作成したデッキやノートの共有、カード単位での問題演習と学習記録、そして最適なタイミングでの復習（間隔反復）を支援する機能により、能動的な学習と知識の定着、体系的な理解を促進することを目的とする。認証はGoogleアカウントを利用する。

**2. システム構成**

| 要素                 | 技術                                                | 備考                                                                 |
| :------------------- | :-------------------------------------------------- | :------------------------------------------------------------------- |
| フロントエンド       | Next.js                                             | App Router を推奨                                                    |
| バックエンド/DB      | Supabase                                            | BaaS (**Auth (Googleログイン)**, Database, Storage, Edge Functions等) |
| テキストエディタ     | Tiptap                                              | 用語解説ページ（ノート内のページ）の作成・編集用                     |
| パッケージマネージャ | bun                                                 | 高速なインストール、実行環境                                         |
| 状態管理             | Jotai                                               | Atomicな状態管理ライブラリ                                           |
| UIコンポーネント     | shadcn/ui                                           | 再利用可能なUIコンポーネント群                                       |
| スタイリング         | Tailwind CSS                                        | ユーティリティファーストCSSフレームワーク                            |
| LLM連携            | **Google Gemini API (例: Gemini 1.5 Pro / Flash等)** | カード生成補助、問題バリエーション生成に使用                         |
| 音声認識・文字起こし | **Google Gemini API (マルチモーダル入力)** または **Google Cloud Speech-to-Text API** | 音声データからのテキスト抽出に使用                                   |
| デプロイ環境         | Vercel (推奨) / Netlify / Google Cloud Run / その他 | Next.jsとの親和性が高い                                              |

**3. データモデル概要 (Supabase Database)**

*   **users:** ユーザー情報 (Supabase Auth (Google Provider) と連携)
*   **decks:** デッキ情報 (id, user_id, title, description, created_at, updated_at, is_public, ...)
*   **cards:** カード情報 (id, deck_id, user_id, front_content TEXT, back_content TEXT, source_audio_url, created_at, updated_at, ...)
*   **questions:** 問題バリエーション情報 (id, card_id, user_id, type VARCHAR(20), question_data JSONB, created_at, ...)
*   **pages:** ページ情報 (id, user_id, title, content_tiptap, created_at, updated_at, is_public, ...)
*   **card_page_links:** カードとページのリンク管理 (id, card_id, page_id, created_at)
*   **learning_logs:** 学習記録 (id, user_id, card_id, question_id (nullable), answered_at, is_correct, user_answer, practice_mode VARCHAR(20), review_interval, next_review_at, ...)
*   **share_links:** 共有リンク管理 (id, resource_type enum('deck','note'), resource_id, token, permission_level enum('owner','editor','viewer'), created_at, ...)
*   **deck_shares:** デッキ共有管理 (id, deck_id, user_id, permission_level enum('owner','editor','viewer'), created_at, ...)
*   **page_shares:** ページ共有管理 (id, page_id, user_id, permission_level enum('owner','editor','viewer'), created_at, ...)

**4. 機能要件**

**4.1. ユーザー認証機能 (Googleログイン)**
*   **4.1.1. Googleログイン:** ユーザーはGoogleアカウントを使用してアプリケーションにログインする。(Supabase Auth Google Provider)
*   **4.1.2. ログアウト:** ログイン状態を解除する機能。
*   **4.1.3. 認証コールバック処理:** Google認証後のコールバックを処理するサーバーサイドルート (`/auth/callback/route.ts`) を実装する。

**4.2. デッキ・カード管理機能**
*   **4.2.1. デッキ作成・編集・削除:** 参考書やドキュメント単位でデッキを作成・管理する。
*   **4.2.2. カード作成・編集・削除:** デッキ内にカード（表: `front_content`, 裏: `back_content`）を作成・管理する。問題生成フローは4.3で詳述。
*   **4.2.3. デッキ一覧表示:** 自身が作成したデッキ、共有されたデッキを一覧表示する。
*   **4.2.4. カード一覧表示:** 特定のデッキに含まれるカードを一覧表示する（表の内容をリスト表示など）。
*   **4.2.5. デッキ共有機能:**
    *   共有リンクを発行し、URLを知るユーザーがアクセス可能（リンクに付与する権限: 'editor','viewer'）。
    *   権限レベルはオーナー('owner')、編集者('editor')、閲覧者('viewer')の3種類を設定可能。
    *   生成した共有リンクは `share_links` テーブルで管理し、有効期限や無効化も考慮。
    *   招待制共有のため、受信ユーザーを `deck_shares` テーブルに追加し、権限を付与する。

**4.3. カード生成（問題生成）機能**
*   **4.3.1. 生成開始:** ユーザーはデッキ詳細ページ（カード一覧が表示されているページ）で「カード（問題）を作成する」ボタンをクリックする。
*   **4.3.2. 入力形式選択:** ユーザーは「手動で入力する」または「音読から生成する」を選択する。
*   **4.3.3. 手動入力フロー:**
    1.  カード作成フォームが表示される（「表 (Front)」と「裏 (Back)」の入力欄）。
    2.  ユーザーは「表」に問題文や用語などを入力する。
    3.  ユーザーは「裏」に回答や解説を入力する。
        *   補助機能: 「回答を生成する」ボタンをクリックすると、Gemini APIで回答候補を生成・挿入。
    4.  ユーザーは「問題バリエーション生成」ボタンをクリックし、Gemini APIで生成された複数の問題バリエーションをフォームに自動入力された候補から編集・確認する。
    5.  ユーザーは内容を確認後、「保存」ボタンでカードデータと問題バリエーション(`questions`)を同時に保存する。
*   **4.3.4. 音読入力フロー:**
    1.  ユーザーはマイクで音読し、録音。
    2.  音声データをGemini API等に送信し、テキストを取得。
        *   認識結果が空またはエラーの場合は「音声の読み込みに失敗しました」とユーザーに通知し、フローを中断する。
    3.  Gemini APIに「問い（表）」と「答え（裏）」のペアを複数生成させる。
    4.  非同期でカード候補リストを受信・表示。
    5.  ユーザーは候補を編集・削除し、「保存」ボタンで選択したカードデータを保存。
    6.  (Optional/Background) 保存されたカードに対し問題バリエーションを生成・保存。
*   **4.3.5. エラーハンドリング:** APIエラー等をユーザーに通知。

**4.4. 問題演習機能**
*   **4.4.1. 演習開始:** デッキ、演習モード、回答形式を選択して開始。
*   **4.4.2. カード・問題表示:** カードの「表」と、選択された回答形式に応じたUI（フラッシュカード、4択、穴埋め、自由記述）を表示。
*   **4.4.3. 解答入力:** 各形式に応じて解答を入力。
*   **4.4.4. 正誤判定・フィードバック:** 正誤判定と解説（カードの「裏」など）を表示。自由記述は自己採点。
*   **4.4.5. 学習記録の保存:** 結果を`learning_logs`に記録。

**4.5. 復習機能 (間隔反復)**
*   **4.5.1. 次回復習日の計算 (Anki式/SuperMemo2):** 学習記録に基づき、Anki公式アルゴリズム(SuperMemo2)を用いてカードの次回復習推奨日を計算・更新。
*   **4.5.2. 復習対象の提示:** ダッシュボード等で復習対象カードを提示。
*   **4.5.3. 復習演習:** 対象カードで問題演習を行う。

**4.6. ページ管理機能**
*   **4.6.1. ページ作成・編集・削除:** キーワードやトピックに対応したページをTiptapエディタで作成・管理。
*   **4.6.2. ページ一覧表示:** 自身が作成したページ、共有されたページを一元的に一覧表示する。
*   **4.6.3. リンク作成機能:** カード作成・編集時にキーワードを指定して既存ページへのリンクを埋め込む、または新規ページを作成できるようにする。
*   **4.6.4. ページ表示:** リンクされたページの内容を表示し、関連ページ間での内部リンクも可能とする。
*   **4.6.5. ページ共有機能:**
    *   共有リンクを発行し、URLを知るユーザーがアクセス可能（権限: 'editor','viewer'）。
    *   生成した共有リンクは `share_links` テーブルで管理し、有効期限や無効化も考慮。
    *   招待制共有の場合、受信ユーザーを `page_shares` テーブルに追加し、権限を付与する。

**4.7. 学習進捗管理機能**
*   **4.7.1. ダッシュボード表示:** 学習サマリー、復習カード表示。
*   **4.7.2. 学習記録の可視化:** デッキ別、カード別、回答形式別の成績などをグラフ等で可視化。

**5. 非機能要件**

*   **5.1. ユーザビリティ:** シンプルで直感的。レスポンシブ対応。
*   **5.2. パフォーマンス:** ページ表示速度、APIレスポンス。非同期処理とローディング表示。
*   **5.3. セキュリティ:** RLS、APIキー管理、脆弱性対策。Googleログインの安全な実装。
*   **5.4. 拡張性・保守性:** コンポーネントベース、状態管理、可読性。
*   **5.5. 著作権に関する注意喚起:** ユーザー入力コンテンツの著作権遵守の注意喚起。

**6. 画面構成（ページ構成）**

*   **/:** トップページ（未ログイン時はGoogleログインボタン表示、ログイン後はダッシュボードへリダイレクトなど）
*   **/dashboard:** ダッシュボード（学習状況サマリー、復習カード表示）
*   **/decks:** デッキ一覧ページ (My Decks, Shared Decks)
*   **/decks/new:** 新規デッキ作成ページ
*   **/decks/[deckId]:** デッキ詳細ページ（カード一覧、デッキ編集・共有設定、**「カード作成」ボタン配置**）
*   **/decks/[deckId]/cards/new:** 新規カード作成ページ (**手動入力フォーム**)
*   **/decks/[deckId]/cards/generate-audio:** 音読によるカード生成ページ (**録音UI、生成結果リスト表示**)
*   **/decks/[deckId]/cards/[cardId]:** カード詳細・編集ページ
*   **/practice/[deckId]:** デッキ演習**設定**ページ (**演習モード・回答形式選択**)
*   **/practice/session:** 問題演習画面 (カード表示、問題解答)
*   **/review:** 復習専用ページ（復習対象カード一覧、演習開始）
*   **/pages:** ページ一覧ページ (My Pages, Shared Pages)
*   **/pages/new:** 新規ページ作成ページ (Tiptapエディタ)
*   **/pages/[pageId]:** ページ表示ページ
*   **/pages/[pageId]/edit:** ページ編集ページ (Tiptapエディタ)
*   **/settings:** 設定ページ（アカウント情報、Optional: APIキー設定など）
*   **(Optional) /share/[shareId]:** 共有コンテンツ閲覧ページ（非ログインユーザー向け）
*   **(Backend Route - No UI) /auth/callback:** Google認証コールバック処理エンドポイント

**7. 使用技術スタック詳細**

*   **フレームワーク:** Next.js (v14以降, App Router)
*   **BaaS:** Supabase (**Authentication (Google)**, PostgreSQL Database, Storage, Edge Functions)
*   **エディタ:** Tiptap
*   **パッケージ管理:** bun
*   **状態管理:** Jotai
*   **UI:** shadcn/ui + Tailwind CSS
*   **LLM:** **Google Gemini API (例: Gemini 1.5 Pro / Flash等)**
*   **音声認識:** **Google Gemini API (マルチモーダル入力) / Google Cloud Speech-to-Text API**

**8. 備考・考慮事項**

*   **APIコスト:** Gemini API/Google Cloud APIの利用料と制限。
*   **音声認識精度:** 確認・編集ステップが不可欠。
*   **問題生成の質:** プロンプト設計が鍵。
*   **自由記述評価:** 自己評価が基本。
*   **著作権:** ユーザー責任の明確化。
*   **APIキー管理:** セキュリティ。
*   **★詳細定義が必要な項目:** 共有機能の仕様、学習記録の詳細、復習アルゴリズム、進捗可視化、問題バリエーション生成のタイミングとトリガー、演習時の回答形式と問題データの紐付けロジック。
*   **非同期処理のUI:** ユーザーに進捗状況を分かりやすく示すUIが必要。
*   **Googleログイン設定:** SupabaseプロジェクトとGoogle Cloud ConsoleでのOAuthクライアント設定が必要。

---

以上が、Googleログインのみを認証方法とし、その他のご要望を反映した最終版の要件定義書となります。ご確認ください。