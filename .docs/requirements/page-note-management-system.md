# ページ・ノート管理システム 実装要件定義書

## ドキュメント情報
- **作成日**: 2025年07月25日
- **バージョン**: 1.0
- **対象機能**: エクスプローラー風ページ・ノート管理システム
- **関連実装**: デフォルトノート機能（2025-07-25実装済み）

## 1. 概要

### 1.1 目的
現在のノート・ページ管理システムにエクスプローラー風の直感的なUI/UXを導入し、ドラッグ&ドロップによるページの移動・コピー・整理機能を実現する。

### 1.2 背景
- 現在のシステムでは作成時のノート紐付けのみ対応
- 作成後のページ移動・再整理機能が未実装
- 多対多関係のデータベース設計は実装済み
- バックエンドAPI（`linkPageToNote`、`unlinkPageFromNote`）は利用可能

### 1.3 目標
- ファイルエクスプローラーと同様の操作感を実現
- 同名ページ競合を適切に処理
- 移動・コピー・削除の基本操作をサポート
- 複数ページの一括操作に対応

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 エクスプローラー風UI
```
┌─────────────────────────────────────────────────────┐
│ 📁 ノート・ページ管理                                  │
├─────────────────┬───────────────────────────────────┤
│ 🗂️ ノート一覧     │ 📄 ページ一覧                      │
│                 │                                   │
│ 📁 マイノート     │ ┌─────────────────────────────────┐ │
│ 📁 プロジェクト管理 │ │ 📄 会議資料_2024-01-15         │ │
│ 📁 学習ノート     │ │ 📄 TODO リスト                 │ │
│ 📁 アイデア       │ │ 📄 設計書_v1                   │ │
│                 │ └─────────────────────────────────┘ │
├─────────────────┴───────────────────────────────────┤
│ 🗑️ ゴミ箱 | 📋 クリップボード | 🔍 検索結果          │
└─────────────────────────────────────────────────────┘
```

**構成要素**:
- **左パネル**: ノート一覧（ツリー構造）
- **右パネル**: 選択ノートのページ一覧
- **下部パネル**: ゴミ箱、クリップボード、検索結果

#### 2.1.2 ドラッグ&ドロップ操作

| 操作 | 方法 | 結果 | 視覚フィードバック |
|------|------|------|-------------------|
| **移動** | ページを別ノートにドロップ | 元ノートから削除→新ノートに追加 | 🔀 移動アイコン |
| **コピー** | Ctrl+ドラッグでドロップ | 元ノートに残る→新ノートにも追加 | ➕ コピーアイコン |
| **削除** | ゴミ箱にドロップ | すべてのノートから削除 | 🗑️ 削除アイコン |

#### 2.1.3 複数選択操作
- **Ctrl+クリック**: 個別選択
- **Shift+クリック**: 範囲選択
- **Ctrl+A**: 全選択
- **バッチ操作**: 選択した複数ページの一括移動・コピー・削除

### 2.2 同名競合処理

#### 2.2.1 競合検出
```typescript
interface PageConflict {
  existingPage: {
    id: string;
    title: string;
    createdAt: Date;
    updatedAt: Date;
  };
  incomingPage: {
    id: string;
    title: string;
    createdAt: Date;
    updatedAt: Date;
  };
  noteId: string;
}
```

#### 2.2.2 解決オプション
```typescript
interface ConflictResolution {
  action: 'rename' | 'merge' | 'replace' | 'cancel';
  newName?: string;
  showPreview: boolean;
}
```

**解決UI**:
```
┌─────────────────────────────────────┐
│ ⚠️  同名のページが存在します          │
│                                     │
│ 既存: 📄 会議資料 (2024/01/15作成)   │
│ 新規: 📄 会議資料 (2024/02/10作成)   │
│                                     │
│ 処理方法を選択してください:           │
│ ○ 自動リネーム: 会議資料 (2)        │
│ ○ 手動リネーム: [____________]      │
│ ○ 統合する（内容をマージ）          │
│ ○ 上書きする                       │
│ ○ キャンセル                       │
│                                     │
│ [プレビュー] [実行] [キャンセル]     │
└─────────────────────────────────────┘
```

### 2.3 UI/UX詳細仕様

#### 2.3.1 ノート一覧パネル（左）
- **ツリー表示**: 展開/折りたたみ可能
- **ドロップゾーン**: ページ受け入れ時にハイライト表示
- **コンテキストメニュー**: 右クリックでノート管理操作
- **新規作成**: 「+」ボタンで新ノート作成
- **カウント表示**: 各ノートのページ数を表示

#### 2.3.2 ページ一覧パネル（右）
- **表示モード**: リスト表示・グリッド表示の切り替え
- **ソート機能**: 作成日時、更新日時、タイトル順
- **フィルタ機能**: タイトル検索、日付範囲指定
- **プレビュー**: ホバーで内容プレビュー表示
- **ドラッグハンドル**: ページアイテムにドラッグ用アイコン

#### 2.3.3 視覚フィードバック

**ドラッグ中の状態表示**:
```
📄 ドラッグ中のページ
├─ 📁 ターゲットノート ← ✅ ドロップ可能（緑枠）
├─ 📁 同名ページ有り   ← ⚠️  同名警告（黄枠）  
└─ 🗑️ ゴミ箱         ← ❌ 削除警告（赤枠）
```

**アニメーション**:
- **成功**: スムーズな移動アニメーション
- **失敗**: 元位置への戻りアニメーション
- **処理中**: ローディングスピナー表示

## 3. 技術仕様

### 3.1 フロントエンド技術

#### 3.1.1 使用ライブラリ
- **React DnD**: ドラッグ&ドロップ機能
- **React Query**: データフェッチとキャッシュ管理
- **Framer Motion**: アニメーション
- **Tailwind CSS**: スタイリング
- **Radix UI**: アクセシブルなUI コンポーネント

#### 3.1.2 コンポーネント構成
```
NotesExplorer/
├─ NotesTree/                 # ノート一覧
│  ├─ NoteItem/              # 個別ノート表示
│  └─ DropZone/              # ドロップ受け入れ
├─ PagesList/                # ページ一覧
│  ├─ PageItem/              # 個別ページ表示
│  ├─ DragLayer/             # ドラッグ中の表示
│  └─ SelectionManager/      # 複数選択管理
├─ ConflictResolver/         # 同名競合解決
├─ OperationPanel/           # 操作パネル
└─ SearchFilter/             # 検索・フィルタ
```

### 3.2 バックエンド技術

#### 3.2.1 新規API エンドポイント
```typescript
// 同名チェック
POST /api/notes/check-duplicate
{
  noteId: string;
  pageTitle: string;
  excludePageId?: string;
}

// バッチ操作
POST /api/notes/batch-operations
{
  operation: 'move' | 'copy' | 'delete';
  pageIds: string[];
  targetNoteId?: string;
  conflictResolutions?: ConflictResolution[];
}

// ページ検索
GET /api/pages/search
?query=string
&noteId=string
&limit=number
&offset=number
```

#### 3.2.2 既存API活用
- `linkPageToNote(noteId, pageId)`: ページ紐付け
- `unlinkPageFromNote(noteId, pageId)`: 紐付け解除
- `getDefaultNote()`: デフォルトノート取得

### 3.3 データベース拡張

#### 3.3.1 新規テーブル
```sql
-- 操作履歴テーブル
CREATE TABLE page_operation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES accounts(id),
  operation_type VARCHAR(20) NOT NULL, -- 'move', 'copy', 'delete'
  page_id UUID NOT NULL,
  source_note_id UUID REFERENCES notes(id),
  target_note_id UUID REFERENCES notes(id),
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3.3.2 インデックス追加
```sql
-- パフォーマンス向上用インデックス
CREATE INDEX idx_pages_title_search ON pages USING gin(to_tsvector('japanese', title));
CREATE INDEX idx_page_operation_logs_user_created ON page_operation_logs(user_id, created_at DESC);
```

## 4. 実装計画

### 4.1 Phase 1: 基礎機能（2週間）
- ✅ エクスプローラー風UIレイアウト
- ✅ 基本ドラッグ&ドロップ機能
- ✅ 移動・コピー・削除操作
- ✅ 同名競合の基本処理

### 4.2 Phase 2: 拡張機能（2週間）
- 🔄 複数選択とバッチ操作
- 🔄 高度な同名競合解決
- 🔄 操作履歴とアンドゥ機能
- 🔄 検索・フィルタ機能

### 4.3 Phase 3: 最適化（1週間）
- ⏳ パフォーマンス最適化
- ⏳ モバイル対応
- ⏳ アクセシビリティ向上
- ⏳ エラーハンドリング強化

## 5. 品質要件

### 5.1 パフォーマンス
- **ページ読み込み**: 500ms以内
- **ドラッグ&ドロップ応答**: 100ms以内
- **大量データ対応**: 1000ページまで快適動作

### 5.2 ユーザビリティ
- **学習時間**: 初回利用者が5分以内に基本操作を習得
- **エラー率**: 誤操作による意図しない削除を5%以下に抑制
- **満足度**: ユーザーテストで80%以上の満足度

### 5.3 互換性
- **ブラウザ対応**: Chrome, Firefox, Safari, Edge（最新2バージョン）
- **デバイス対応**: デスクトップ優先、タブレット対応
- **既存機能**: 現在のノート・ページ機能との完全互換性

## 6. リスク管理

### 6.1 技術リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| ドラッグ&ドロップのブラウザ互換性 | 中 | React DND使用、フォールバック実装 |
| 大量データでのパフォーマンス低下 | 高 | 仮想化、ページネーション実装 |
| 同名競合処理の複雑化 | 中 | 段階的実装、ユーザーテスト実施 |

### 6.2 UXリスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 操作の学習コスト | 中 | チュートリアル、ヘルプ機能 |
| 誤操作による削除 | 高 | 確認ダイアログ、アンドゥ機能 |
| モバイルでの操作性 | 低 | レスポンシブ設計、タッチ対応 |

## 7. 成功指標

### 7.1 利用状況指標
- **機能利用率**: 月間アクティブユーザーの60%以上が新機能を利用
- **操作効率**: ページ整理作業時間が従来比50%短縮
- **エラー率**: ドラッグ&ドロップ操作の失敗率5%以下

### 7.2 満足度指標
- **NPS**: 40以上を達成
- **機能評価**: 5段階評価で平均4.0以上
- **継続利用率**: 機能利用開始から1ヶ月後の継続率80%以上

## 8. 付録

### 8.1 用語集
- **ノート**: ページをグループ化する単位
- **ページ**: 個別のコンテンツ単位
- **多対多関係**: 1つのページが複数のノートに属する関係
- **同名競合**: 同一ノート内で同じタイトルのページが重複する状況

### 8.2 参考資料
- Windows エクスプローラー UX パターン
- macOS Finder 操作仕様
- Google Drive ファイル管理UI
- Notion データベース管理機能

### 8.3 関連ドキュメント
- `.docs/work-logs/2025-07-25_1045_default-note-implementation.md`
- `app/_actions/notes/README.md`
- データベーススキーマ定義

---

**承認者**: _____________  
**承認日**: _____________