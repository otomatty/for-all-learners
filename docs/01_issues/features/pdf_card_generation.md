# 製品要件書 (PRD) - 過去問PDFからのカード生成機能

## 1. プロジェクト概要

### 1.1 製品名
- 過去問PDF学習カード生成機能 (PDF Card Generator)
- 開発コードネーム: PastExamPDFtoCards

### 1.2 目的
- 過去問PDFファイルから効率的にフラッシュカードを生成し、学習効率を向上させる
- 手動でのカード作成時間を大幅に短縮し、学習時間を最大化する
- PDFの問題と解答を自動で分離・構造化し、学習に最適化されたカード形式に変換する

### 1.3 対象範囲
- **対象PDF**: テキストベースの過去問PDF（画像のみのPDFは除く）
- **対象言語**: 日本語の問題文・解答
- **対象分野**: 資格試験、大学入試、語学検定等の選択式・記述式問題
- **除外範囲**: 手書き問題、複雑な図表を含む問題、数式中心の問題（初期版では）
- **将来拡張**: OCR対応、多言語対応、数式対応

## 2. 製品目標

1. **学習効率の向上**: PDFから10分以内でカード生成を完了し、手動作成と比較して90%以上の時間短縮を実現
2. **高精度な問題分離**: 問題文と解答の分離精度85%以上を達成
3. **ユーザビリティの向上**: 3ステップ以内の簡単な操作でカード生成を完了
4. **既存機能との統合**: 音読・画像機能と同様のUX・データフローで一貫性を保持

各目標の成功指標：
- カード生成完了時間: 平均10分以内
- 問題分離精度: 85%以上（ユーザー修正率15%以下）
- ユーザー満足度: 4.0/5.0以上
- 機能利用率: 既存ユーザーの30%以上が月1回以上利用

## 3. ユーザーストーリー

1. **学習者として**、過去問PDFをアップロードしてフラッシュカードを生成したい。それにより、効率的な復習と記憶定着が実現できる。

2. **資格試験受験者として**、複数年分の過去問から重要問題を抽出してカード化したい。それにより、出題傾向を把握した効率的な学習ができる。

3. **教育者として**、授業で使用する過去問から学生用の練習カードを作成したい。それにより、授業準備時間を短縮し、より多くの問題を提供できる。

優先順位：
- P0: 基本的なPDFアップロード→カード生成フロー
- P1: 問題タイプ別の最適化（選択式・記述式）
- P2: バッチ処理・複数ファイル対応

## 4. 機能要件

### 4.1 コア機能（P0）

#### データモデル
```typescript
interface PdfCardGenerationRequest {
  file: File;                    // アップロードされたPDFファイル
  deckId: string;               // 保存先デッキID
  userId: string;               // ユーザーID
  processingOptions: {
    questionType: 'auto' | 'multiple_choice' | 'descriptive';
    generateMode: 'all' | 'problems_only' | 'key_points';
    chunkSize: number;          // ページ分割サイズ（デフォルト: 5ページ）
  };
}

interface PdfChunk {
  chunkId: string;              // チャンクID
  pageNumbers: number[];        // 含まれるページ番号
  text: string;                 // 抽出されたテキスト
  tokenCount: number;           // 推定トークン数
}

interface PdfProcessingResult {
  chunks: PdfChunk[];           // 分割されたチャンク
  detectedProblems: PdfProblem[]; // 検出された問題
  processingLog: ProcessingLog; // 処理ログ
  totalPages: number;           // 総ページ数
}

interface PdfProblem {
  id: string;
  problemText: string;          // 問題文
  answerText?: string;          // 解答（存在する場合）
  problemType: 'multiple_choice' | 'descriptive' | 'unknown';
  confidence: number;           // 検出精度 (0-1)
  pageNumber: number;           // ページ番号
  chunkId: string;              // 元チャンクID
}

// 既存のカードテーブル構造に合わせる
interface GeneratedPdfCard {
  front_content: JSONContent;   // TiptapJSON形式の問題文
  back_content: JSONContent;    // TiptapJSON形式の解答
  source_pdf_url: string;       // PDFファイルのURL
  source_page: number;          // 元ページ番号
  metadata: {
    problem_id: string;         // 問題ID
    confidence_score: number;   // 生成精度
    chunk_id: string;           // 元チャンクID
    processing_model: string;   // 使用LLMモデル
  };
}

// TiptapJSON形式（既存カードと統一）
interface JSONContent {
  type: 'doc';
  content: Array<{
    type: 'paragraph' | 'heading' | 'blockquote' | 'codeBlock';
    content?: Array<{
      type: 'text';
      text: string;
      marks?: Array<{ type: string; attrs?: any }>;
    }>;
    attrs?: any;
  }>;
}
```

#### 主要機能

**1. PDFアップロード・チャンク分割機能**
- 目的: PDFファイルのアップロード、ページごとのテキスト抽出、適切なサイズでの分割
- 入力: PDFファイル（最大50MB）
- 出力: ページ別テキスト、分割されたチャンク
- 処理フロー:
  1. PDFファイルアップロード（Supabase Storage）
  2. ページ単位でのテキスト抽出（PDF.js またはサーバーサイドライブラリ）
  3. トークン数計算とチャンクサイズ調整（推奨：5ページまたは4000トークン）
  4. 適切な情報量でのチャンク分割
  5. 各チャンクのメタデータ生成
- 制約: 50MB以下、テキストベースPDFのみ、最大チャンク数20個

**2. チャンクベース問題・解答分離機能**
- 目的: 各チャンクから問題文と解答を並列処理で自動分離
- 入力: 分割されたPDFチャンク
- 出力: 構造化された問題・解答ペア
- 処理フロー:
  1. 各チャンクを並列でLLMに送信
  2. パターンマッチングと文脈解析による問題番号検出
  3. 問題・解答の関連性分析とページ跨ぎ対応
  4. 信頼度スコア算出とフィルタリング
  5. チャンク間での重複問題の除去
- 制約: 日本語のみ、並列処理数最大5チャンク

**3. TiptapJSON形式カード生成機能**
- 目的: 分離された問題・解答を既存システム互換のカード形式で生成
- 入力: 構造化された問題・解答ペア
- 出力: TiptapJSON形式の編集可能カード候補
- 処理フロー:
  1. プレーンテキストからTiptapJSON変換
  2. 数式・図表マークアップの適用
  3. カード候補のプレビュー生成
  4. ユーザー選択・編集インターフェース
  5. 既存cardsテーブルへの保存
- 制約: 最大100問まで一度に処理、既存カード形式との完全互換

### 4.2 重要機能（P1）

**1. 問題タイプ別最適化**
- 選択式問題: 選択肢の適切な処理
- 記述式問題: 解答例の抽出・補完
- 実装優先度: 高（ユーザビリティに直結）

**2. バッチ処理機能**
- 複数ページ・複数問題の効率的な処理
- プログレス表示・中断再開機能
- 実装優先度: 中（大きなPDFファイル対応）

**3. プレビュー・修正機能**
- 生成前のテキスト抽出結果プレビュー
- カード生成後の一括編集機能
- 実装優先度: 高（品質向上に重要）

### 4.3 追加機能（P2）

**1. OCR対応**
- 画像ベースPDFからのテキスト抽出
- 実装条件: 基本機能安定後
- 期待効果: 対応PDF範囲の大幅拡張

**2. 出題傾向分析**
- 過去問の出題頻度・重要度分析
- 実装条件: 十分なデータ蓄積後
- 期待効果: 学習効率のさらなる向上

**3. 問題形式テンプレート**
- 特定試験・分野向けの最適化設定
- 実装条件: ユーザーフィードバック収集後
- 期待効果: 特定分野での精度向上

## 5. 技術要件

### 5.1 アーキテクチャ
- **フロントエンド**: Next.js 15 (App Router)、TypeScript、Tailwind CSS
- **バックエンド**: Server Actions、Supabase
- **PDF処理**: PDF.js (クライアント) または pdf-parse (サーバー)
- **LLM**: Gemini 2.5 Flash (既存実装との統合)
- **ストレージ**: Supabase Storage (PDFファイル保存)

### 5.2 パフォーマンス要件
- PDFアップロード: 50MB以下、60秒以内
- チャンク分割・テキスト抽出: 50ページ以下で120秒以内
- 並列問題分離処理: チャンクあたり60秒以内
- カード生成: 100問以下で300秒以内（5分）
- 同時処理: 5ユーザーまで（チャンク並列処理考慮）

### 5.3 セキュリティ要件
- ファイルタイプ検証: PDFのみ許可
- ファイルサイズ制限: 50MB上限
- ユーザー認証: 既存Supabase Auth使用
- データ保護: アップロードファイルの自動削除（24時間後）
- チャンク処理: 並列処理時のメモリ使用量制限

## 6. 開発計画

### 6.1 フェーズ1: MVP（3週間）
- [ ] PDFアップロード・ストレージ保存
- [ ] ページ単位テキスト抽出とチャンク分割機能
- [ ] チャンク並列処理による問題・解答分離
- [ ] TiptapJSON形式カード生成・保存
- [ ] 基本UI実装（プログレス表示含む）

期間: 3週間
成功基準: 20ページ以下の過去問PDFから80%以上の精度でカード生成

### 6.2 フェーズ2: 機能拡張（3週間）
- [ ] LLMによる高精度問題分離
- [ ] 問題タイプ判定・最適化
- [ ] プレビュー・編集機能
- [ ] エラーハンドリング強化
- [ ] UI/UX改善

期間: 3週間
成功基準: 85%以上の問題分離精度、ユーザビリティテスト4.0/5.0以上

### 6.3 フェーズ3: 最適化（2週間）
- [ ] パフォーマンス最適化
- [ ] バッチ処理対応
- [ ] ユーザーフィードバック対応
- [ ] ドキュメント整備

期間: 2週間
成功基準: 平均処理時間の30%短縮、エラー率5%以下

## 7. 制約条件

### 7.1 技術的制約
- PDF処理ライブラリの制限（OCR機能の有無）
- LLM APIのレート制限・コスト
- ブラウザでのファイルサイズ制限
- Supabase Storageの容量制限

### 7.2 ビジネス制約
- 開発期間: 7週間以内
- 追加コスト: LLM API使用料金増加
- 人的リソース: 既存開発体制内での実装

### 7.3 法的制約
- 著作権: 過去問の著作権遵守（個人利用に限定）
- データ保護: アップロードファイルの適切な管理・削除
- 利用規約: PDF使用に関する明確な利用条件

## 8. 成功指標

### 8.1 定量的指標
- 機能利用率: 既存ユーザーの30%以上が月1回以上利用
- 処理時間: 平均10分以内でカード生成完了
- 精度: 問題分離精度85%以上
- エラー率: 5%以下
- ユーザー継続率: 機能利用後1週間以内に再利用50%以上

### 8.2 定性的指標
- ユーザー満足度: 4.0/5.0以上
- 操作の直感性: 初回利用でも迷わず完了できる
- 既存機能との統合感: 音読・画像機能と同レベルのUX
- 学習効果: カード使用による学習効率向上の実感

## 9. リスクと対策

### 9.1 技術リスク

**リスク1: PDF構造の多様性による抽出精度低下**
- 影響度: 高
- 対策: 複数パターンの事前テスト、フォールバック処理の実装

**リスク2: LLM APIコストの増大**
- 影響度: 中
- 対策: 処理量制限、効率的なプロンプト設計、キャッシュ活用

**リスク3: 大容量ファイル処理によるパフォーマンス問題**
- 影響度: 中
- 対策: ファイルサイズ制限、チャンク分割処理、進捗表示

### 9.2 ビジネスリスク

**リスク1: 著作権問題**
- 影響度: 高
- 対策: 利用規約の明確化、個人利用に限定、法的確認

**リスク2: ユーザー期待値とのギャップ**
- 影響度: 中
- 対策: 制限事項の事前説明、段階的機能リリース

## 10. 付録

### 10.1 用語集
- **PDF抽出**: PDFファイルからテキストデータを取得する処理
- **問題分離**: 連続するテキストから問題文と解答を分離する処理
- **カード生成**: 学習用フラッシュカードの作成処理
- **信頼度スコア**: AIによる分離・生成精度の指標（0-1）

### 10.2 参考資料
- [PDF.js Documentation](https://mozilla.github.io/pdf.js/)
- [Gemini API Reference](https://ai.google.dev/docs)
- [Supabase Storage Documentation](https://supabase.com/docs/guides/storage)
- 既存実装: `app/_actions/transcribe.ts`, `app/_actions/transcribeImage.ts`

### 10.3 既存機能との比較

| 機能 | 音読カード生成 | 画像カード生成 | PDF카드生成（新機能） |
|------|--------------|----------------|---------------------|
| 入力形式 | 音声ファイル | 画像ファイル | PDFファイル |
| 前処理 | 音声→テキスト | OCR→テキスト | PDF抽出→問題分離 |
| 生成時間 | 2-3分 | 1-2分 | 5-10分（予想） |
| 精度 | 95%+ | 90%+ | 85%（目標） |
| 複雑度 | 低 | 中 | 高 |
