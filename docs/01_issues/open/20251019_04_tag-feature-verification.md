# Issue: ã‚¿ã‚°ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã®è©³ç´°ç¢ºèªã¨èª¤è§£è§£æ±º

**å„ªå…ˆåº¦**: ğŸŸ¡ Medium  
**æ¨å®šé›£åº¦**: â­ ç°¡å˜ï¼ˆ1-2æ™‚é–“ï¼‰  
**æ¨å¥¨æœŸé™**: 3-4æ—¥ä»¥å†…  
**ä½œæˆæ—¥**: 2025-10-19

---

## æ¦‚è¦

ã‚¿ã‚°ãƒªãƒ³ã‚¯æ©Ÿèƒ½ï¼ˆ`#ã‚¿ã‚°` å½¢å¼ï¼‰ã®å®Ÿè£…ã¯æ­£ç¢ºã«æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ãŒæ¤œè¨¼ã§ç¢ºèªã•ã‚Œã¾ã—ãŸã€‚

ãŸã ã—ã€äº‹å‰ãƒ¬ãƒãƒ¼ãƒˆã«èª¤è§£ãŒã‚ã£ãŸéƒ¨åˆ†ã‚’æ˜ç¢ºã«ã—ã€å®Ÿè£…ãŒæ„å›³é€šã‚Šå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## æ¤œè¨¼çµæœ

### âœ… èª¤è§£ãŒä¿®æ­£ã•ã‚ŒãŸé …ç›®

#### 1. æ­£è¦è¡¨ç¾ã®æœ«å°¾ `$` å•é¡Œ

**äº‹å‰ãƒ¬ãƒãƒ¼ãƒˆ**:
> æ­£è¦è¡¨ç¾ã®æœ«å°¾ `$` ãŒæ–‡ä¸­ã®ã‚¿ã‚°æ¤œå‡ºã‚’é˜»å®³ã™ã‚‹ã“ã¨ãŒã‚ã‚‹

**æ¤œè¨¼çµæœ**: âŒ **èª¤è§£ã§ã™**

**å®Ÿè£…**: `config.ts` Line 47
```typescript
tag: /(?:^|\s)#([a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3400-\u4DBF\uAC00-\uD7AF]{1,50})(?=\s|$|[^\p{Letter}\p{Number}])/u,
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ**:
- `(?:^|\s)` - è¡Œé ­ã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹
- `#` - ãƒãƒƒã‚·ãƒ¥æ–‡å­—
- `([a-zA-Z0-9...]{1,50})` - ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¿ã‚°åï¼‰
- `(?=\s|$|[^\p{Letter}\p{Number}])` - ãƒ«ãƒƒã‚¯ã‚¢ãƒ˜ãƒƒãƒ‰ï¼ˆ3ã¤ã®é¸æŠè‚¢ï¼‰

**æœ«å°¾å‡¦ç†**:
- `$` ã¯ **ãƒ«ãƒƒã‚¯ã‚¢ãƒ˜ãƒƒãƒ‰å†…ã®3ã¤ã®é¸æŠè‚¢ã®1ã¤**
- ã€Œè¡Œæœ« OR ã‚¹ãƒšãƒ¼ã‚¹ OR éè‹±æ•°å­—ã€ã®ã„ãšã‚Œã‹
- æ–‡ä¸­ã®ã‚¿ã‚°ï¼ˆ`"text #tag text"` ãªã©ï¼‰ã‚‚æ­£å¸¸ã«æ¤œå‡ºã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆç¢ºèª**: `config.test.ts:97-107` ã§æ–‡ä¸­ã‚¿ã‚°ãŒæ­£ã—ãæ¤œå‡ºã•ã‚Œã‚‹

---

#### 2. ã‚¿ã‚°ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã®ä¸å®‰å®šæ€§

**äº‹å‰ãƒ¬ãƒãƒ¼ãƒˆ**:
> ã‚¿ã‚°ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºãŒä¸å®‰å®šï¼ˆ`#` ã®æœ‰ç„¡ãŒä¸çµ±ä¸€ï¼‰

**æ¤œè¨¼çµæœ**: âŒ **èª¤è§£ã§ã™**

**å®Ÿè£…**: `input-rules/tag-rule.ts` Line 32
```typescript
export function createTagInputRule(context: { editor: Editor; name: string }) {
  return new InputRule({
    find: PATTERNS.tag,
    handler: ({ state, match, range, chain }) => {
      const raw = match[1];
      const text = `#${raw}`; // Tag displays with # prefix âœ… å¸¸ã«æ­£ç¢º
      const key = normalizeTitleToKey(raw);
```

**çµæœ**: ã‚¿ã‚°ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã¯ **å¸¸ã«** `#` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãã§æ­£ç¢ºã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

---

### âš ï¸ ç¢ºèªãŒä¸ååˆ†ãªé …ç›®

#### ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI å•é¡Œ

**äº‹å‰ãƒ¬ãƒãƒ¼ãƒˆ**:
> ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ãŒç©ºã‚¯ã‚¨ãƒªã§è¡¨ç¤ºã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹

**æ¤œè¨¼çŠ¶æ³**: å…·ä½“çš„ãªæ ¹æ‹ ãŒä¸æ˜ç¢º

**ç¢ºèªãŒå¿…è¦ãªç‚¹**:
1. ç©ºã‚¯ã‚¨ãƒªï¼ˆ`[` ã ã‘ã€`#` ã ã‘ï¼‰ã§ã®å€™è£œè¡¨ç¤º
2. ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ã®æœ€å°æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
3. å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆã®ç¢ºèª

---

## å®Ÿæ–½ã™ã¹ãç¢ºèª

### 1. æ­£è¦è¡¨ç¾ãƒ†ã‚¹ãƒˆã®ç¢ºèª

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/__tests__/config.test.ts`

**ãƒ†ã‚¹ãƒˆé …ç›®** (Lines 97-147):
- âœ… æ–‡ä¸­ã®ã‚¿ã‚°æ¤œå‡º: `"Check this #tag123"`
- âœ… è¤‡æ•°ã‚¿ã‚°æ¤œå‡º
- âœ… é•·ã„ã‚¿ã‚°æ¤œå‡º
- âœ… è¡Œé ­ã®ã‚¿ã‚°æ¤œå‡º

**å®Ÿè¡Œçµæœç¢ºèª**:
```bash
bun test lib/tiptap-extensions/unified-link-mark/__tests__/config.test.ts
# äºˆæƒ³: ã™ã¹ã¦ pass
```

---

### 2. ã‚¿ã‚°å…¥åŠ›ãƒ«ãƒ¼ãƒ«ã®å‹•ä½œç¢ºèª

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/input-rules/tag-rule.ts`

**ç¢ºèªé …ç›®**:
1. ã‚¿ã‚°ãŒæ­£ã—ãæ¤œå‡ºã•ã‚Œã‚‹
2. `#` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹
3. è¤‡æ•°ã®ã‚¿ã‚°ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
bun test lib/tiptap-extensions/unified-link-mark/input-rules/__tests__/tag-rule.test.ts
```

**ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèª**:
1. ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã
2. `" #tag"` ã¨å…¥åŠ›
3. ãƒªãƒ³ã‚¯ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã« `#` ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

### 3. ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ã®è©³ç´°èª¿æŸ»

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/plugins/suggestion-plugin.ts`

**ç¢ºèªé …ç›®**:

```typescript
// ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºã®æ¡ä»¶ã‚’ç¢ºèª
if (props.query.length < 1) {  // â† ã“ã®ãƒã‚§ãƒƒã‚¯ï¼Ÿ
  return [];
}
```

**ç¢ºèªå†…å®¹**:
1. ç©ºã‚¯ã‚¨ãƒªã§ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¹ãã‹è¨­è¨ˆã‚’ç¢ºèª
2. æœ€å°æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ç©ºã‚¯ã‚¨ãƒªãŒãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
bun test lib/tiptap-extensions/unified-link-mark/plugins/__tests__/suggestion-plugin.test.ts
```

**ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèª**:
1. ã‚¨ãƒ‡ã‚£ã‚¿ã§ `[` ã ã‘å…¥åŠ› â†’ ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
2. ã‚¨ãƒ‡ã‚£ã‚¿ã§ `#` ã ã‘å…¥åŠ› â†’ ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
3. ã‚µã‚¸ã‚§ã‚¹ãƒˆå€™è£œãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹

---

## å®Ÿè£…ã‚³ãƒ¼ãƒ‰å‚è€ƒ

### ã‚¿ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/config.ts`

```typescript
// Line 47
const PATTERNS = {
  tag: /(?:^|\s)#([a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3400-\u4DBF\uAC00-\uD7AF]{1,50})(?=\s|$|[^\p{Letter}\p{Number}])/u,
};
```

### ã‚¿ã‚°å…¥åŠ›ãƒ«ãƒ¼ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/input-rules/tag-rule.ts`

```typescript
export function createTagInputRule(context: { editor: Editor; name: string }) {
  return new InputRule({
    find: PATTERNS.tag,
    handler: ({ state, match, range, chain }) => {
      const raw = match[1];
      const text = `#${raw}`;  // âœ… å¸¸ã« # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ã
      const key = normalizeTitleToKey(raw);
      
      const attrs: UnifiedLinkAttributes = {
        variant: "tag",
        raw,
        text,
        key,
        pageId: null,
        href: "#",
        state: "pending",
        exists: false,
        markId: generateMarkId(),
      };
```

---

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°å†…å®¹

### æ›´æ–°å¯¾è±¡

1. **`docs/02_requirements/features/unified-link-mark-spec.md`**
   - ã‚¿ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¬æ˜ã‚’ä¿®æ­£
   - æœ«å°¾ `$` ã®èª¤è§£ã‚’è§£æ±º

2. **`docs/04_implementation/plans/unified-link-mark/`**
   - ã‚¿ã‚°æ©Ÿèƒ½ã®å®Ÿè£…çŠ¶æ³ã‚’ã€Œå®Ÿè£…å®Œäº†ã€ã«æ›´æ–°
   - æ—¢çŸ¥ã®èª¤è§£ã‚’è¨˜è¼‰

3. **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè‡ªä½“**
   - ã‚¿ã‚°æ©Ÿèƒ½ãŒæ­£ç¢ºã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’è¨˜è¼‰
   - ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ã®è©³ç´°ç¢ºèªãŒå¿…è¦ãªã“ã¨ã‚’è¨˜è¼‰

---

## ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å˜ä½“ãƒ†ã‚¹ãƒˆ

- [ ] `config.test.ts` - ã‚¿ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ pass
- [ ] `tag-rule.test.ts` - ã‚¿ã‚°å…¥åŠ›ãƒ«ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ pass
- [ ] `suggestion-plugin.test.ts` - ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ãƒ†ã‚¹ãƒˆ pass

### ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ

- [ ] `" #tag"` å…¥åŠ› â†’ ãƒªãƒ³ã‚¯ä½œæˆ
- [ ] `" #æ—¥æœ¬èª"` å…¥åŠ› â†’ ãƒªãƒ³ã‚¯ä½œæˆï¼ˆæ—¥æœ¬èªå¯¾å¿œç¢ºèªï¼‰
- [ ] ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã« `#` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹è¡¨ç¤º
- [ ] `" #tag1 #tag2"` è¤‡æ•°ã‚¿ã‚°å…¥åŠ›å¯èƒ½
- [ ] ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆæœ€å°æ–‡å­—æ•°ç¢ºèªï¼‰

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

- [ ] `#` ã ã‘ã®å…¥åŠ› â†’ ãƒªãƒ³ã‚¯ä½œæˆã•ã‚Œãªã„
- [ ] `#` + ã‚¹ãƒšãƒ¼ã‚¹ â†’ ãƒªãƒ³ã‚¯ä½œæˆã•ã‚Œãªã„
- [ ] `no#tag` ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãªã—ï¼‰ â†’ ãƒªãƒ³ã‚¯ä½œæˆã•ã‚Œãªã„
- [ ] é•·ã„ã‚¿ã‚°åï¼ˆ50æ–‡å­—ä»¥ä¸Šï¼‰ â†’ æ­£ã—ãåˆ¶é™ã•ã‚Œã‚‹

---

## å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- ğŸ“‹ [æ¤œè¨¼å ±å‘Šæ›¸](20251019_05_verification-report-memo-link-investigation.md)
- ğŸ“ [å…ƒã®ãƒ¬ãƒãƒ¼ãƒˆ](20251018_04_memo-link-feature-investigation.md)
- ğŸ”— [UnifiedLinkMark ä»•æ§˜æ›¸](../../02_requirements/features/unified-link-mark-spec.md)

---

## è£œè¶³: æ­£è¦è¡¨ç¾ã®è©³ç´°

### ãƒ‘ã‚¿ãƒ¼ãƒ³: `/(?:^|\s)#([a-zA-Z0-9...]{1,50})(?=\s|$|[^\p{Letter}\p{Number}])/u`

```
(?:^|\s)              # Non-capturing: start of line OR whitespace
#                     # Literal hash
([a-zA-Z0-9...]1,50)  # Capturing: tag characters, 1-50 length
(?=...)               # Lookahead (doesn't consume)
  \s                  # OR: whitespace
  |                   # OR
  $                   # OR: end of line
  |                   # OR
  [^\p{Letter}\p{Number}]  # OR: non-letter, non-digit
```

**çµæœ**: æ–‡ä¸­ã®ã‚¿ã‚°ï¼ˆ`"text #tag text"`ï¼‰ã‚‚è¡Œæœ«ã®ã‚¿ã‚°ã‚‚æ­£ã—ãæ¤œå‡º

---

**ä½œæˆè€…**: GitHub Copilot  
**ä½œæˆæ—¥**: 2025-10-19  
**æœ€çµ‚æ›´æ–°**: 2025-10-19
