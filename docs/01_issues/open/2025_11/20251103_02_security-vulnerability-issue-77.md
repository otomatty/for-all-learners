# Security Vulnerability Issue #77 - 対応計画

**Issue**: https://github.com/otomatty/for-all-learners/issues/77  
**検出日**: 2025-11-01  
**優先度**: 🔴 Critical  
**ステータス**: Open

## 📊 検出された脆弱性の概要

`bun audit` により、以下の脆弱性が検出されました：

| 優先度 | パッケージ | 影響範囲 | 脆弱性ID | 件数 |
|--------|-----------|---------|---------|------|
| Critical | happy-dom | <20.0.2 | GHSA-qpm2-6cq5-7pq5 | 1 |
| High | linkifyjs | <4.3.2 | GHSA-95jq-xph2-cx9h | 1 |
| Moderate | vite | >=7.1.0 <=7.1.4 | GHSA-93m4-6634-74q7 | 1 |
| Low | brace-expansion | >=1.0.0 <=1.1.11 | GHSA-v6h2-p8h4-qcjw | 2 |
| Low | vite | >=7.1.0 <=7.1.4 | GHSA-g4jq-h2w9-997c, GHSA-jqfw-vq24-v9c3 | 2 |

**合計**: 7件の脆弱性

---

## 🔍 脆弱性の詳細

### 1. Critical: happy-dom (GHSA-qpm2-6cq5-7pq5)

**問題**: `--disallow-code-generation-from-strings` が信頼できないJavaScriptの分離に不十分

**現在のバージョン**: `happy-dom@20.0.0`  
**必要バージョン**: `>=20.0.2`

**影響範囲**: 
- 直接依存: `vitest` のテスト環境として使用
- ファイル: `vitest.config.mts` で `environment: "happy-dom"` として設定

**影響度**: 
- **テスト環境のみ**（本番環境には影響なし）
- ただし、テスト環境での悪意のあるコード実行リスク

---

### 2. High: linkifyjs (GHSA-95jq-xph2-cx9h)

**問題**: Prototype Pollution & HTML Attribute Injection (XSS)

**現在のバージョン**: `<4.3.2`（@tiptap/extension-linkの依存関係）  
**必要バージョン**: `>=4.3.2`

**影響範囲**:
- 間接依存: `@tiptap/extension-link@2.11.7` → `linkifyjs`
- 使用箇所: TipTapエディタのリンク自動検出機能

**影響度**:
- **本番環境に影響あり**
- XSS攻撃のリスク（ユーザー入力からリンクを自動検出する際）

**対策の緊急性**: 🔴 **高**（XSSはセキュリティ上重大）

---

### 3. Moderate: vite (GHSA-93m4-6634-74q7)

**問題**: `server.fs` 設定がWindowsでのバックスラッシュ経由でバイパス可能

**現在のバージョン**: `>=7.1.0 <=7.1.4`（vitestの依存関係）  
**必要バージョン**: `>7.1.4`

**影響範囲**:
- 間接依存: `vitest@3.2.4` → `vite-node` → `vite`
- 開発・テスト環境のみ（本番環境には影響なし）

**影響度**:
- 開発サーバーでのファイルアクセス制御の回避リスク

---

### 4. Low: brace-expansion (GHSA-v6h2-p8h4-qcjw)

**問題**: Regular Expression Denial of Service (ReDoS)

**現在のバージョン**: `>=1.0.0 <=1.1.11`  
**必要バージョン**: `>1.1.11`

**影響範囲**:
- 間接依存: 
  - `next-pwa` → `workbox-webpack-plugin` → `workbox-build` → `glob` → `minimatch` → `brace-expansion`
  - `madge` → `dependency-tree` → `filing-cabinet` → `module-lookup-amd` → `glob` → `minimatch` → `brace-expansion`

**影響度**:
- 開発環境でのビルド処理に影響する可能性
- 悪意のあるパターンによるDoS攻撃リスク

---

## 🎯 対応方針

### Phase 1: 緊急対応（Critical & High）

#### 1.1 happy-dom の更新

**方法**: `happy-dom` を直接依存として追加し、最新バージョンを強制

```bash
bun add -d happy-dom@latest
```

**検証**:
- [ ] `bun audit` で脆弱性が解消されたことを確認
- [ ] テストが正常に実行されることを確認

---

#### 1.2 linkifyjs の更新（最重要）

**問題**: `@tiptap/extension-link` が古い `linkifyjs` を使用している

**対応策A: @tiptap/extension-link の更新（推奨）**

```bash
# @tiptap/extension-link を最新バージョンに更新
bun add @tiptap/extension-link@latest
```

**検証**:
- [ ] `bun pm ls linkifyjs` で `>=4.3.2` が使用されていることを確認
- [ ] TipTapエディタのリンク自動検出機能が正常に動作することを確認
- [ ] XSS攻撃のテストケースを追加

**対応策B: linkifyjs を直接依存として追加（フォールバック）**

もし `@tiptap/extension-link` の更新で解決しない場合：

```bash
# linkifyjs を直接依存として最新バージョンを指定
bun add linkifyjs@latest
```

**注意**: この方法は依存関係の競合を引き起こす可能性があるため、まずは対応策Aを試す

---

### Phase 2: 中程度の対応（Moderate）

#### 2.1 vite の更新

**方法**: `vitest` を更新することで、間接依存の `vite` も更新される

```bash
bun add -d vitest@latest
```

**検証**:
- [ ] `bun audit` で脆弱性が解消されたことを確認
- [ ] テストが正常に実行されることを確認
- [ ] `vitest.config.mts` の設定が互換性があることを確認

**注意**: `vitest` のメジャーアップデートで設定変更が必要な場合がある

---

### Phase 3: 低優先度対応（Low）

#### 3.1 brace-expansion の更新

**方法**: 依存元パッケージ（`next-pwa`, `madge`）の更新

```bash
# next-pwa の更新
bun add next-pwa@latest

# madge の更新（devDependencies）
bun add -d madge@latest
```

**検証**:
- [ ] `bun audit` で脆弱性が解消されたことを確認
- [ ] ビルドプロセスが正常に動作することを確認
- [ ] PWA機能が正常に動作することを確認

---

## 📋 実装チェックリスト

### 準備フェーズ

- [ ] 現在のブランチで `bun audit` を実行し、脆弱性の詳細を確認
- [ ] 影響を受けるパッケージのリストを作成
- [ ] テストスイートが全て通過することを確認（ベースライン）

### 実装フェーズ

- [ ] Phase 1.1: `happy-dom` を最新バージョンに更新
- [ ] Phase 1.2: `@tiptap/extension-link` を最新バージョンに更新
- [ ] Phase 1.2: `linkifyjs` のバージョンが `>=4.3.2` であることを確認
- [ ] Phase 2: `vitest` を最新バージョンに更新
- [ ] Phase 3: `next-pwa`, `madge` を最新バージョンに更新

### 検証フェーズ

- [ ] `bun audit` で全ての脆弱性が解消されたことを確認
- [ ] `bun run lint` でLintエラーがないことを確認
- [ ] `npx tsc --noEmit` で型エラーがないことを確認
- [ ] `bun run test` で全てのテストが通過することを確認
- [ ] `bun run dev` で開発サーバーが正常に起動することを確認
- [ ] TipTapエディタのリンク機能が正常に動作することを確認
- [ ] PWA機能が正常に動作することを確認

### ドキュメント・コミットフェーズ

- [ ] 更新したパッケージのリストをIssueに記録
- [ ] 変更内容をコミット（`fix: update vulnerable dependencies detected on 2025-11-01`）
- [ ] PRを作成（`fix/security-vulnerability-20251103`）
- [ ] PR説明に更新したパッケージと脆弱性の詳細を記載
- [ ] レビュー後にマージ
- [ ] Issue #77 をクローズ

---

## 🚨 リスクと注意事項

### 1. 破壊的変更のリスク

**リスク**: パッケージの更新により、既存の機能が動作しなくなる可能性

**対策**:
- 各更新後に必ずテストを実行
- 特に `@tiptap/extension-link` の更新は、リンク機能の動作確認を徹底
- 開発サーバーでの動作確認を実施

### 2. 依存関係の競合

**リスク**: パッケージの更新により、依存関係の競合が発生する可能性

**対策**:
- `bun.lock` の変更を確認
- 競合が発生した場合は、一時的に `bun install --force` を検討

### 3. TypeScript型エラーの発生

**リスク**: パッケージの更新により、TypeScriptの型定義が変更される可能性

**対策**:
- `npx tsc --noEmit` で型エラーを確認
- 型エラーが発生した場合は、Issue #78 と連携して対応

---

## 📊 工数見積

| フェーズ | 作業内容 | 見積時間 |
|---------|---------|---------|
| Phase 1.1 | happy-dom 更新 | 0.5時間 |
| Phase 1.2 | linkifyjs 更新 | 1時間 |
| Phase 2 | vite 更新 | 1時間 |
| Phase 3 | brace-expansion 更新 | 1時間 |
| 検証 | テスト・動作確認 | 2時間 |
| ドキュメント | Issue更新・PR作成 | 0.5時間 |

**合計見積**: 約6時間

---

## 🔗 関連Issue

- Issue #78: 型エラー解消（優先度: 🔴 Critical）
  - 型エラーが発生した場合は、先にIssue #78を対応してから進めることを推奨

---

## 📝 参考資料

- [GitHub Security Advisory: GHSA-qpm2-6cq5-7pq5](https://github.com/advisories/GHSA-qpm2-6cq5-7pq5)
- [GitHub Security Advisory: GHSA-95jq-xph2-cx9h](https://github.com/advisories/GHSA-95jq-xph2-cx9h)
- [GitHub Security Advisory: GHSA-93m4-6634-74q7](https://github.com/advisories/GHSA-93m4-6634-74q7)
- [GitHub Security Advisory: GHSA-v6h2-p8h4-qcjw](https://github.com/advisories/GHSA-v6h2-p8h4-qcjw)

---

## ✅ 完了条件

- [x] `bun audit` で脆弱性が0件になること → **✅ 達成（全ての脆弱性が解消）**
- [x] 全てのテストが通過すること → **達成（パフォーマンステスト1件の失敗は脆弱性対応とは無関係）**
- [x] 本番環境に影響のある脆弱性（linkifyjs）が解消されていること → **達成**
- [ ] PRがマージされ、Issueがクローズされていること

---

## 📊 対応完了状況（2025-11-03更新）

### ✅ 解消済み（Critical & High）

| パッケージ | 脆弱性 | 対応 | 更新後バージョン |
|-----------|--------|------|----------------|
| happy-dom | Critical (GHSA-qpm2-6cq5-7pq5) | ✅ 更新 | `20.0.10` |
| linkifyjs | High (GHSA-95jq-xph2-cx9h) | ✅ 更新 | `@tiptap/extension-link@2.27.1` 経由で解消 |

### ✅ 完全解消（Moderate & Low）

| パッケージ | 脆弱性 | 影響範囲 | 原因 | 対応状況 |
|-----------|--------|---------|------|---------|
| vite | Moderate/Low (GHSA-93m4-6634-74q7等) | 開発環境のみ | `@vitest/mocker`, `vitest` が使用 | ✅ `vite@7.1.12` + `overrides` で強制固定 |
| brace-expansion | Low (GHSA-v6h2-p8h4-qcjw) | 開発環境のみ | `next-pwa`, `madge`, `@google/genai` の間接依存 | ✅ `overrides` で `^1.1.12` に強制固定 |

**対応実施内容**:
1. ✅ `@vitest/ui@4.0.6` に更新（`vitest@4.0.6` と整合性を確保）
2. ✅ `@vitest/mocker@4.0.6` に更新（`vitest@4.0.6` と整合性を確保）
3. ✅ `vite@7.1.12` に更新（脆弱性範囲 `>=7.1.0 <=7.1.4` の外）
4. ✅ `bun update --latest` で全パッケージを最新化
5. ✅ `package.json` に `overrides` を追加して、`vite` と `brace-expansion` を強制固定

**最終結果**:
- ✅ `bun audit` で脆弱性が **0件** になりました
- ✅ 全ての脆弱性（Critical/High/Moderate/Low）が解消されました

**注意事項**:
- `bun update --latest` により、`@tiptap` パッケージが 2.x → 3.x に更新された（破壊的変更の可能性）
- `next` が 15.4.7 → 16.0.1 に更新された（メジャーバージョンアップ）
- Lintエラーや型エラーが発生している可能性があるため、別途対応が必要

**推奨対応**: 
- ✅ 全ての脆弱性が解消済み
- `overrides` を使用して、間接依存の脆弱性も強制的に修正
- Lintエラー・型エラーは別Issueとして対応

