# Mastraã‚’ä½¿ç”¨ã—ãŸAIæ©Ÿèƒ½åŸºç›¤ã¨APIã‚­ãƒ¼ç®¡ç†ã®å®Ÿè£…è¦ä»¶å®šç¾©

**ä½œæˆæ—¥**: 2025-10-30
**å¯¾è±¡**: å…¨é–‹ç™ºè€…
**ã‚«ãƒ†ã‚´ãƒª**: è¦ä»¶å®šç¾©ãƒ»è¨­è¨ˆæ›¸
**å„ªå…ˆåº¦**: Critical

---

## ğŸ“‹ æ¦‚è¦

AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®åŸºç›¤ã¨ã—ã¦ã€**Mastra**ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’å°å…¥ã—ã¾ã™ã€‚ã¾ãŸã€AIæ©Ÿèƒ½ã¯å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®LLM APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ä½¿ç”¨å¯èƒ½ã«ã—ã¾ã™ã€‚

### ä¸»è¦ãªå¤‰æ›´ç‚¹
- âœ… Mastra ã‚’ä½¿ç”¨ã—ãŸãƒãƒ«ãƒLLMå¯¾å¿œ
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®APIã‚­ãƒ¼ç®¡ç†æ©Ÿèƒ½
- âœ… APIã‚­ãƒ¼æœªè¨­å®šæ™‚ã®UIå¯¾å¿œ
- âœ… è¤‡æ•°LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚µãƒãƒ¼ãƒˆ

---

## ğŸ¯ Mastraã®é¸å®šç†ç”±

### Mastraã¨ã¯
Mastraã¯ã€AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã®ãŸã‚ã®TypeScriptãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

**å…¬å¼ã‚µã‚¤ãƒˆ**: https://mastra.dev/

### ä¸»ãªæ©Ÿèƒ½
1. **ãƒãƒ«ãƒLLMå¯¾å¿œ**: Gemini, OpenAI, Claude, Llamaç­‰ã‚’çµ±ä¸€APIã§åˆ©ç”¨
2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ **: è¤‡é›‘ãªAIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ§‹ç¯‰
3. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–
4. **ãƒ„ãƒ¼ãƒ«é€£æº**: ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã®ç°¡å˜ãªè¿½åŠ 
5. **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹

### ãªãœMastraã‚’ä½¿ã†ã‹
- çµ±ä¸€ã•ã‚ŒãŸAPIã§LLMã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¥½ããªLLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠå¯èƒ½
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½ã§é«˜åº¦ãªAIæ©Ÿèƒ½ã‚’å®Ÿè£…å¯èƒ½
- TypeScript ãƒã‚¤ãƒ†ã‚£ãƒ–ã§å‹å®‰å…¨

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - AICommandBar (ãƒãƒ£ãƒƒãƒˆUI)                                â”‚
â”‚  - APIKeySettings (APIã‚­ãƒ¼è¨­å®šç”»é¢)                         â”‚
â”‚  - LLMProviderSelector (LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é¸æŠ)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Server Actions                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - chatWithAI (ãƒãƒ£ãƒƒãƒˆå®Ÿè¡Œ)                                 â”‚
â”‚  - saveAPIKey (APIã‚­ãƒ¼ä¿å­˜)                                  â”‚
â”‚  - getAPIKeyStatus (APIã‚­ãƒ¼è¨­å®šçŠ¶æ…‹å–å¾—)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mastra Engine                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  lib/mastra/                                                â”‚
â”‚  â”œâ”€â”€ client.ts          (MastraåˆæœŸåŒ–)                      â”‚
â”‚  â”œâ”€â”€ agents/            (AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©)                 â”‚
â”‚  â”‚   â”œâ”€â”€ chat-agent.ts                                      â”‚
â”‚  â”‚   â”œâ”€â”€ summarize-agent.ts                                 â”‚
â”‚  â”‚   â””â”€â”€ search-agent.ts                                    â”‚
â”‚  â”œâ”€â”€ tools/             (ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«)                     â”‚
â”‚  â”‚   â”œâ”€â”€ page-tool.ts                                       â”‚
â”‚  â”‚   â””â”€â”€ search-tool.ts                                     â”‚
â”‚  â””â”€â”€ prompts/           (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)             â”‚
â”‚      â””â”€â”€ templates.ts                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - user_api_keys (æš—å·åŒ–ã•ã‚ŒãŸAPIã‚­ãƒ¼)                       â”‚
â”‚  - ai_usage_logs (ä½¿ç”¨ãƒ­ã‚°)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LLM Providers                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - Google Gemini                                            â”‚
â”‚  - OpenAI GPT                                               â”‚
â”‚  - Anthropic Claude                                         â”‚
â”‚  - etc.                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### user_api_keys ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼APIã‚­ãƒ¼ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE public.user_api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.accounts(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL, -- 'gemini', 'openai', 'claude', etc.
  encrypted_api_key TEXT NOT NULL, -- æš—å·åŒ–ã•ã‚ŒãŸAPIã‚­ãƒ¼
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_used_at TIMESTAMPTZ,
  
  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã«1ã¤ã®ã¿
  UNIQUE(user_id, provider)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_api_keys_user_id ON public.user_api_keys(user_id);
CREATE INDEX idx_user_api_keys_provider ON public.user_api_keys(provider);

-- RLS ãƒãƒªã‚·ãƒ¼
ALTER TABLE public.user_api_keys ENABLE ROW LEVEL SECURITY;

CREATE POLICY select_own_api_keys
  ON public.user_api_keys
  FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY insert_own_api_keys
  ON public.user_api_keys
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY update_own_api_keys
  ON public.user_api_keys
  FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY delete_own_api_keys
  ON public.user_api_keys
  FOR DELETE
  USING (auth.uid() = user_id);
```

### ai_usage_logs ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```sql
-- AIä½¿ç”¨ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ±è¨ˆãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
CREATE TABLE public.ai_usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.accounts(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL,
  model VARCHAR(100) NOT NULL,
  prompt_tokens INTEGER,
  completion_tokens INTEGER,
  total_tokens INTEGER,
  cost_usd DECIMAL(10, 6), -- æ¨å®šã‚³ã‚¹ãƒˆ
  response_time_ms INTEGER,
  success BOOLEAN NOT NULL,
  error_message TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_ai_usage_logs_user_id ON public.ai_usage_logs(user_id);
CREATE INDEX idx_ai_usage_logs_created_at ON public.ai_usage_logs(created_at);

-- RLS ãƒãƒªã‚·ãƒ¼
ALTER TABLE public.ai_usage_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY select_own_ai_usage_logs
  ON public.ai_usage_logs
  FOR SELECT
  USING (auth.uid() = user_id);
```

---

## ğŸ” APIã‚­ãƒ¼æš—å·åŒ–

### æš—å·åŒ–æ–¹å¼

**æ¨å¥¨**: Supabase Vault ã‚’ä½¿ç”¨

```typescript
// lib/encryption/api-key-vault.ts
import { createClient } from "@/lib/supabase/server";

export async function encryptAPIKey(apiKey: string): Promise<string> {
  const supabase = await createClient();
  
  // Supabase Vault ã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–
  const { data, error } = await supabase.rpc('vault.encrypt', {
    secret: apiKey
  });
  
  if (error) throw error;
  return data;
}

export async function decryptAPIKey(encryptedKey: string): Promise<string> {
  const supabase = await createClient();
  
  // Supabase Vault ã‚’ä½¿ç”¨ã—ã¦å¾©å·åŒ–
  const { data, error } = await supabase.rpc('vault.decrypt', {
    encrypted: encryptedKey
  });
  
  if (error) throw error;
  return data;
}
```

**ä»£æ›¿æ¡ˆ**: ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–ã‚­ãƒ¼ã‚’ä½¿ç”¨

```typescript
import crypto from 'crypto';

const ENCRYPTION_KEY = process.env.API_KEY_ENCRYPTION_KEY!;
const ALGORITHM = 'aes-256-gcm';

export function encryptAPIKey(apiKey: string): string {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'hex'), iv);
  
  let encrypted = cipher.update(apiKey, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
}

export function decryptAPIKey(encryptedKey: string): string {
  const parts = encryptedKey.split(':');
  const iv = Buffer.from(parts[0], 'hex');
  const authTag = Buffer.from(parts[1], 'hex');
  const encrypted = parts[2];
  
  const decipher = crypto.createDecipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'hex'), iv);
  decipher.setAuthTag(authTag);
  
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}
```

---

## ğŸ› ï¸ Mastraçµ±åˆ

### Mastraã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
bun add @mastra/core @mastra/agent @mastra/llm
```

### Mastra ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–

```typescript
// lib/mastra/client.ts
import { Mastra } from '@mastra/core';
import { GeminiLLM } from '@mastra/llm/gemini';
import { OpenAILLM } from '@mastra/llm/openai';
import { ClaudeLLM } from '@mastra/llm/claude';

interface MastraClientOptions {
  provider: 'gemini' | 'openai' | 'claude';
  apiKey: string;
  model?: string;
}

export function createMastraClient(options: MastraClientOptions): Mastra {
  let llm;
  
  switch (options.provider) {
    case 'gemini':
      llm = new GeminiLLM({
        apiKey: options.apiKey,
        model: options.model || 'gemini-1.5-pro'
      });
      break;
    
    case 'openai':
      llm = new OpenAILLM({
        apiKey: options.apiKey,
        model: options.model || 'gpt-4'
      });
      break;
    
    case 'claude':
      llm = new ClaudeLLM({
        apiKey: options.apiKey,
        model: options.model || 'claude-3-opus'
      });
      break;
    
    default:
      throw new Error(`Unsupported provider: ${options.provider}`);
  }
  
  return new Mastra({
    llm,
    // ãã®ä»–ã®è¨­å®š
  });
}
```

### ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®šç¾©

```typescript
// lib/mastra/agents/chat-agent.ts
import { Agent } from '@mastra/agent';
import { createMastraClient } from '../client';

export async function createChatAgent(
  provider: string,
  apiKey: string,
  systemPrompt: string
) {
  const mastra = createMastraClient({
    provider: provider as any,
    apiKey
  });
  
  return new Agent({
    name: 'chat-assistant',
    instructions: systemPrompt,
    llm: mastra.llm,
    tools: [
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ 
    ]
  });
}
```

---

## ğŸ“± UIå®Ÿè£…

### APIã‚­ãƒ¼è¨­å®šç”»é¢

**ãƒ•ã‚¡ã‚¤ãƒ«:**
```
components/settings/
â”œâ”€â”€ APIKeySettings.tsx
â”œâ”€â”€ APIKeyForm.tsx
â””â”€â”€ ProviderSelector.tsx
```

**UIä¾‹:**
```tsx
// components/settings/APIKeySettings.tsx
export function APIKeySettings() {
  const [provider, setProvider] = useState<'gemini' | 'openai' | 'claude'>('gemini');
  const [apiKey, setApiKey] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  
  const handleSave = async () => {
    setIsSaving(true);
    
    try {
      await saveAPIKey({ provider, apiKey });
      toast.success('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (error) {
      toast.error('APIã‚­ãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsSaving(false);
    }
  };
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>AI APIã‚­ãƒ¼è¨­å®š</CardTitle>
        <CardDescription>
          AIæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div>
            <Label>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</Label>
            <Select value={provider} onValueChange={setProvider}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="gemini">Google Gemini</SelectItem>
                <SelectItem value="openai">OpenAI GPT</SelectItem>
                <SelectItem value="claude">Anthropic Claude</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          <div>
            <Label>APIã‚­ãƒ¼</Label>
            <Input
              type="password"
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="sk-..."
            />
            <p className="text-xs text-muted-foreground mt-1">
              APIã‚­ãƒ¼ã¯æš—å·åŒ–ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
            </p>
          </div>
          
          <Alert>
            <Info className="h-4 w-4" />
            <AlertTitle>APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</AlertTitle>
            <AlertDescription>
              {provider === 'gemini' && (
                <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener noreferrer">
                  Google AI Studio ã§APIã‚­ãƒ¼ã‚’å–å¾—
                </a>
              )}
              {provider === 'openai' && (
                <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer">
                  OpenAI Platform ã§APIã‚­ãƒ¼ã‚’å–å¾—
                </a>
              )}
              {provider === 'claude' && (
                <a href="https://console.anthropic.com/" target="_blank" rel="noopener noreferrer">
                  Anthropic Console ã§APIã‚­ãƒ¼ã‚’å–å¾—
                </a>
              )}
            </AlertDescription>
          </Alert>
        </div>
      </CardContent>
      <CardFooter>
        <Button onClick={handleSave} disabled={isSaving}>
          {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
        </Button>
      </CardFooter>
    </Card>
  );
}
```

### APIã‚­ãƒ¼æœªè¨­å®šæ™‚ã®UI

```tsx
// components/ai-command-bar/APIKeyPrompt.tsx
export function APIKeyPrompt() {
  return (
    <div className="p-4 text-center">
      <Bot className="w-12 h-12 mx-auto mb-4 text-muted-foreground" />
      <h3 className="font-semibold mb-2">AIæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯</h3>
      <p className="text-sm text-muted-foreground mb-4">
        LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„
      </p>
      <Button asChild>
        <Link href="/settings/api-keys">
          APIã‚­ãƒ¼ã‚’è¨­å®š
        </Link>
      </Button>
    </div>
  );
}
```

---

## ğŸ¯ å®Ÿè£…ã‚¿ã‚¹ã‚¯

### Phase 0: MastraåŸºç›¤æ§‹ç¯‰ï¼ˆå„ªå…ˆåº¦: Criticalï¼‰

**æœŸé–“**: 3-4æ—¥

#### Task 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰
- [ ] `user_api_keys` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `ai_usage_logs` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] RLS ãƒãƒªã‚·ãƒ¼è¨­å®š
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

#### Task 2: APIã‚­ãƒ¼æš—å·åŒ–
- [ ] Supabase Vault è¨­å®š or æš—å·åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å®Ÿè£…
- [ ] æš—å·åŒ–é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

#### Task 3: Mastraã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] Mastra ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] åŸºæœ¬çš„ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…
- [ ] ãƒãƒ«ãƒLLMå¯¾å¿œã®ç¢ºèª

#### Task 4: Server Actionså®Ÿè£…
- [ ] `saveAPIKey` - APIã‚­ãƒ¼ä¿å­˜
- [ ] `getAPIKeyStatus` - APIã‚­ãƒ¼è¨­å®šçŠ¶æ…‹å–å¾—
- [ ] `deleteAPIKey` - APIã‚­ãƒ¼å‰Šé™¤
- [ ] `testAPIKey` - APIã‚­ãƒ¼ã®æ¤œè¨¼

#### Task 5: UIå®Ÿè£…
- [ ] APIã‚­ãƒ¼è¨­å®šç”»é¢
- [ ] ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é¸æŠUI
- [ ] APIã‚­ãƒ¼æœªè¨­å®šæ™‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- [ ] è¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 

---

## âœ… å®Œäº†æ¡ä»¶

- [ ] Mastra ãŒæ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] APIã‚­ãƒ¼ãŒæš—å·åŒ–ã—ã¦ä¿å­˜ã§ãã‚‹
- [ ] APIã‚­ãƒ¼è¨­å®šç”»é¢ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹
- [ ] APIã‚­ãƒ¼æœªè¨­å®šæ™‚ã«é©åˆ‡ãªUIãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šéã—ã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
- [ ] APIã‚­ãƒ¼æš—å·åŒ–ãƒ»å¾©å·åŒ–
- [ ] Mastraã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
- [ ] Server Actions

### çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] APIã‚­ãƒ¼ä¿å­˜ãƒ•ãƒ­ãƒ¼
- [ ] APIã‚­ãƒ¼å–å¾—ãƒ•ãƒ­ãƒ¼
- [ ] ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- [ ] APIã‚­ãƒ¼ãŒå¹³æ–‡ã§ä¿å­˜ã•ã‚Œã¦ã„ãªã„ã“ã¨
- [ ] ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®APIã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨
- [ ] RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨

---

## ğŸ“š å‚è€ƒè³‡æ–™

- Mastra å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://mastra.dev/docs
- Supabase Vault: https://supabase.com/docs/guides/database/vault
- Node.js Crypto: https://nodejs.org/api/crypto.html

---

## ğŸ”— é–¢é€£ Issue

- #70 (Phase 1): åŸºæœ¬å®Ÿè£… - **ã“ã®åŸºç›¤ã®ä¸Šã«æ§‹ç¯‰**
- #71 (Phase 2): ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”
- #72 (Phase 3): ãƒšãƒ¼ã‚¸è¦ç´„

---

**æœ€çµ‚æ›´æ–°**: 2025-10-30
**ä½œæˆè€…**: AI (Claude)
