# Phase 1.4: LLM Provider Selection UI Specification

**作成日**: 2025-11-03
**フェーズ**: Phase 1.4 - Frontend UI for Provider Selection

---

## 概要

ユーザーがフロントエンドUI（設定画面）で、問題生成に使用するLLMプロバイダー（Google Gemini, OpenAI, Anthropic）とモデルを選択できる機能を実装します。

選択されたプロバイダーとモデルは、ユーザー設定として保存され、`useGenerateQuestions` hook を通じて API に渡されます。

---

## 要件定義

### R-001: プロバイダー選択UI
- 設定画面（`/settings/api-keys`）にプロバイダー選択UIを追加
- ドロップダウンまたはラジオボタンで選択可能
- 選択肢: Google Gemini, OpenAI, Anthropic Claude
- デフォルト: Google Gemini

### R-002: モデル選択UI
- 選択したプロバイダーに応じて、利用可能なモデルを表示
- テキスト入力またはドロップダウンで選択可能
- プロバイダー別のデフォルトモデル:
  - Google Gemini: `gemini-2.5-flash`
  - OpenAI: `gpt-4o-mini`
  - Anthropic: `claude-3-5-haiku-latest`

### R-003: ユーザー設定の永続化
- 選択したプロバイダーとモデルを永続化
- オプション1: localStorage（クライアント側）
- オプション2: Supabase user_preferences テーブル（サーバー側）
- **推奨**: localStorage（実装が簡単、ページロード時に即座にアクセス可能）

### R-004: グローバルコンテキスト
- React Context または Zustand で、アプリ全体で選択されたプロバイダー/モデルにアクセス
- `useLLMProvider()` hook を提供
- デフォルト値: `{ provider: "google", model: "gemini-2.5-flash" }`

### R-005: useGenerateQuestions hook 拡張
- `useGenerateQuestions(cardIds, type, options?)` の形式に拡張
- `options.provider` と `options.model` をサポート
- 指定がない場合は、グローバルコンテキストから取得

### R-006: APIキー設定との連携
- プロバイダー選択UIは、APIキー設定の近くに配置
- 選択したプロバイダーのAPIキーが設定されていない場合、警告を表示
- "APIキーを設定する" ボタンで該当プロバイダーのAPIキー入力欄にスクロール

---

## UI設計

### 1. 設定画面レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ APIキー設定                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ [Google Gemini API Key]  ✅ 設定済み                         │
│ [OpenAI API Key]         ⚠️ 未設定                          │
│ [Anthropic API Key]      ⚠️ 未設定                          │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│ 問題生成の設定                                               │
│                                                              │
│ デフォルトプロバイダー                                        │
│ ● Google Gemini                                             │
│ ○ OpenAI                                                    │
│ ○ Anthropic Claude                                          │
│                                                              │
│ モデル                                                       │
│ [gemini-2.5-flash ▼]                                        │
│                                                              │
│ ℹ️ 問題生成時にこのプロバイダーとモデルが使用されます          │
│ ⚠️ OpenAI APIキーが設定されていません [設定する]             │
│                                                              │
│ [保存]                                                       │
└─────────────────────────────────────────────────────────────┘
```

### 2. コンポーネント構造

```
app/(protected)/settings/api-keys/page.tsx
  ├─ APIKeySettings (既存)
  └─ LLMProviderSettings (新規)
      ├─ ProviderSelector (新規)
      ├─ ModelSelector (新規)
      └─ SaveButton (新規)
```

---

## 実装ファイル

### 1. コンテキスト/Store

**ファイル**: `lib/contexts/LLMProviderContext.tsx`

```typescript
import { createContext, useContext, useEffect, useState } from "react";

type LLMProvider = "google" | "openai" | "anthropic";

interface LLMProviderConfig {
  provider: LLMProvider;
  model: string;
}

interface LLMProviderContextValue {
  config: LLMProviderConfig;
  setConfig: (config: LLMProviderConfig) => void;
}

const LLMProviderContext = createContext<LLMProviderContextValue | null>(null);

export function LLMProviderProvider({ children }: { children: React.ReactNode }) {
  const [config, setConfigState] = useState<LLMProviderConfig>({
    provider: "google",
    model: "gemini-2.5-flash",
  });

  // Load from localStorage on mount
  useEffect(() => {
    const saved = localStorage.getItem("llm-provider-config");
    if (saved) {
      try {
        setConfigState(JSON.parse(saved));
      } catch (err) {
        console.error("Failed to parse LLM provider config:", err);
      }
    }
  }, []);

  // Save to localStorage on change
  const setConfig = (newConfig: LLMProviderConfig) => {
    setConfigState(newConfig);
    localStorage.setItem("llm-provider-config", JSON.stringify(newConfig));
  };

  return (
    <LLMProviderContext.Provider value={{ config, setConfig }}>
      {children}
    </LLMProviderContext.Provider>
  );
}

export function useLLMProvider() {
  const context = useContext(LLMProviderContext);
  if (!context) {
    throw new Error("useLLMProvider must be used within LLMProviderProvider");
  }
  return context;
}
```

### 2. 設定UIコンポーネント

**ファイル**: `components/settings/LLMProviderSettings.tsx`

```typescript
"use client";

import { useLLMProvider } from "@/lib/contexts/LLMProviderContext";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { InfoIcon, AlertTriangleIcon } from "lucide-react";

const MODEL_OPTIONS = {
  google: [
    { value: "gemini-2.5-flash", label: "Gemini 2.5 Flash (推奨)" },
    { value: "gemini-2.0-pro", label: "Gemini 2.0 Pro" },
    { value: "gemini-1.5-pro", label: "Gemini 1.5 Pro" },
  ],
  openai: [
    { value: "gpt-4o-mini", label: "GPT-4o Mini (推奨)" },
    { value: "gpt-4o", label: "GPT-4o" },
    { value: "gpt-4-turbo", label: "GPT-4 Turbo" },
  ],
  anthropic: [
    { value: "claude-3-5-haiku-latest", label: "Claude 3.5 Haiku (推奨)" },
    { value: "claude-3-5-sonnet-latest", label: "Claude 3.5 Sonnet" },
    { value: "claude-3-opus-latest", label: "Claude 3 Opus" },
  ],
};

export function LLMProviderSettings() {
  const { config, setConfig } = useLLMProvider();
  const [isSaving, setIsSaving] = useState(false);

  const handleProviderChange = (provider: "google" | "openai" | "anthropic") => {
    // Set default model for selected provider
    const defaultModel = MODEL_OPTIONS[provider][0].value;
    setConfig({ provider, model: defaultModel });
  };

  const handleModelChange = (model: string) => {
    setConfig({ ...config, model });
  };

  const handleSave = () => {
    setIsSaving(true);
    // Config is already saved to localStorage via setConfig
    setTimeout(() => setIsSaving(false), 500);
  };

  return (
    <div className="space-y-6 rounded-lg border p-6">
      <div className="space-y-2">
        <h2 className="text-xl font-semibold">問題生成の設定</h2>
        <p className="text-sm text-muted-foreground">
          問題生成時に使用するAIプロバイダーとモデルを選択します
        </p>
      </div>

      <div className="space-y-4">
        {/* Provider Selection */}
        <div className="space-y-3">
          <Label>デフォルトプロバイダー</Label>
          <RadioGroup
            value={config.provider}
            onValueChange={handleProviderChange}
            className="space-y-2"
          >
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="google" id="provider-google" />
              <Label htmlFor="provider-google" className="cursor-pointer">
                Google Gemini
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="openai" id="provider-openai" />
              <Label htmlFor="provider-openai" className="cursor-pointer">
                OpenAI
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="anthropic" id="provider-anthropic" />
              <Label htmlFor="provider-anthropic" className="cursor-pointer">
                Anthropic Claude
              </Label>
            </div>
          </RadioGroup>
        </div>

        {/* Model Selection */}
        <div className="space-y-3">
          <Label htmlFor="model-select">モデル</Label>
          <Select value={config.model} onValueChange={handleModelChange}>
            <SelectTrigger id="model-select">
              <SelectValue placeholder="モデルを選択" />
            </SelectTrigger>
            <SelectContent>
              {MODEL_OPTIONS[config.provider].map((option) => (
                <SelectItem key={option.value} value={option.value}>
                  {option.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Info Alert */}
        <Alert>
          <InfoIcon className="h-4 w-4" />
          <AlertDescription>
            問題生成時にこのプロバイダーとモデルが使用されます
          </AlertDescription>
        </Alert>

        {/* API Key Warning */}
        {/* TODO: Check if API key is configured */}
        {config.provider !== "google" && (
          <Alert variant="destructive">
            <AlertTriangleIcon className="h-4 w-4" />
            <AlertDescription>
              {config.provider === "openai" ? "OpenAI" : "Anthropic"}{" "}
              APIキーが設定されていません
              <Button variant="link" className="ml-2 h-auto p-0">
                設定する
              </Button>
            </AlertDescription>
          </Alert>
        )}

        {/* Save Button */}
        <Button onClick={handleSave} disabled={isSaving} className="w-full">
          {isSaving ? "保存中..." : "設定を保存"}
        </Button>
      </div>
    </div>
  );
}
```

### 3. useGenerateQuestions hook 拡張

**ファイル**: `hooks/useGenerateQuestions.ts` (修正)

```typescript
import { useEffect, useState } from "react";
import type { QuestionData, QuestionType } from "@/lib/gemini";
import { useLLMProvider } from "@/lib/contexts/LLMProviderContext";

interface QuestionResponse {
  cardId: string;
  question: QuestionData;
}

interface GenerateQuestionsOptions {
  provider?: "google" | "openai" | "anthropic";
  model?: string;
}

interface UseGenerateQuestionsResult {
  questions: QuestionResponse[] | null;
  isLoading: boolean;
  error: Error | null;
}

export function useGenerateQuestions(
  cardIds: string[] | null,
  type: QuestionType,
  options?: GenerateQuestionsOptions,
): UseGenerateQuestionsResult {
  const [questions, setQuestions] = useState<QuestionResponse[] | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<Error | null>(null);
  const { config } = useLLMProvider();

  useEffect(() => {
    if (!cardIds || cardIds.length === 0) {
      setQuestions(null);
      return;
    }

    setIsLoading(true);
    setError(null);

    // Use provided options or fallback to global config
    const provider = options?.provider || config.provider;
    const model = options?.model || config.model;

    fetch("/api/practice/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        cardIds,
        type,
        provider,
        model,
      }),
    })
      .then(async (res) => {
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Failed to generate questions");
        }
        return data.questions as QuestionResponse[];
      })
      .then((qs) => {
        setQuestions(qs);
      })
      .catch((err: Error) => {
        setError(err);
      })
      .finally(() => {
        setIsLoading(false);
      });
  }, [cardIds, type, options?.provider, options?.model, config]);

  return { questions, isLoading, error };
}
```

---

## テスト計画

### TC-001: Provider Context
- Context が正しく初期化される
- localStorage から設定が読み込まれる
- setConfig で localStorage に保存される

### TC-002: LLMProviderSettings UI
- プロバイダー選択時にモデルがデフォルトに変更される
- モデル選択が正しく動作する
- 保存ボタンが設定を永続化する

### TC-003: useGenerateQuestions hook
- グローバルコンテキストからプロバイダー/モデルを取得
- options で上書き可能
- API呼び出し時に provider/model が含まれる

### TC-004: API Key Warning
- 選択したプロバイダーのAPIキーが未設定の場合、警告が表示される
- "設定する" ボタンでAPIキー入力欄にスクロール

---

## 実装ステップ

1. ✅ LLMProviderContext の作成
2. ✅ LLMProviderSettings コンポーネントの作成
3. ✅ app/layout.tsx に LLMProviderProvider を追加
4. ✅ settings/api-keys/page.tsx に LLMProviderSettings を配置
5. ✅ useGenerateQuestions hook の拡張
6. ✅ テストの作成
7. ✅ UIテスト（手動）
8. ✅ ドキュメント作成

---

## セキュリティ考慮事項

### 1. localStorage の使用
- APIキー自体は localStorage に保存しない（既存の暗号化機構を使用）
- プロバイダー/モデル選択のみ localStorage に保存（機密情報ではない）

### 2. API呼び出し
- provider/model パラメータは検証済み（route.ts でバリデーション）
- 不正な値が送信されても 400 エラーで拒否される

---

## パフォーマンス考慮事項

### 1. Context の再レンダリング
- config が変更されたときのみ再レンダリング
- useMemo/useCallback で最適化

### 2. localStorage アクセス
- 初回マウント時のみ読み込み
- 設定変更時のみ書き込み

---

## 関連ドキュメント

- **API Route仕様**: `app/api/practice/generate/route.spec.md`
- **Phase 1.3 ログ**: `docs/05_logs/2025_11/20251103/01_practice-generate-route-integration.md`
- **実装計画**: `docs/03_plans/ai-integration/phase1-implementation-plan.md`

---

**最終更新**: 2025-11-03
**作成者**: AI (Grok Code Fast 1.5)
