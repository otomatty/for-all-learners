# ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—UIå®Ÿè£…è¨ˆç”»

**å¯¾è±¡:** Phase 2 - Link Group UI
**ä½œæˆæ—¥:** 2025-10-27
**æœ€çµ‚æ›´æ–°:** 2025-10-27

---

## æ¦‚è¦

è¤‡æ•°ç®‡æ‰€ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯ï¼ˆãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã‚’ã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç›´ä¸‹ã«ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### ç›®çš„

- Wiki ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ç®¡ç†ã‚’å®Ÿç¾
- ãƒšãƒ¼ã‚¸ãŒæœªä½œæˆã®ãƒªãƒ³ã‚¯ã§ã‚‚ã€è¤‡æ•°ç®‡æ‰€ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å¯è¦–åŒ–
- ãƒšãƒ¼ã‚¸ä½œæˆã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å®Ÿè¡Œå¯èƒ½ã«
- ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®é–¢é€£ãƒšãƒ¼ã‚¸ã‚’ä¸€è¦§è¡¨ç¤º

---

## UIè¨­è¨ˆ

### å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚ â”‚æ–°è¦  â”‚ â”‚Page Aâ”‚ â”‚Page Bâ”‚  â† React Hooks ã‚’å‚ç…§       â”‚
â”‚ â”‚ä½œæˆ  â”‚ â”‚      â”‚ â”‚      â”‚                              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚Type  â”‚ â”‚Page Eâ”‚ â”‚Page Fâ”‚ â”‚Page Gâ”‚  â† TypeScript ã‚’å‚ç…§â”‚
â”‚ â”‚Scriptâ”‚ â”‚      â”‚ â”‚      â”‚ â”‚      â”‚                     â”‚
â”‚ â”‚â­æœ¬ä½“â”‚ â”‚      â”‚ â”‚      â”‚ â”‚      â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ æœªè¨­å®šãƒªãƒ³ã‚¯ä¸€è¦§ï¼ˆlinkCount = 1 ã®ã‚‚ã®ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨ç¤ºãƒ«ãƒ¼ãƒ«

#### ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã—ã¦è¡¨ç¤º
- **æ¡ä»¶**: `link_count > 1`
- **ã‚°ãƒ«ãƒ¼ãƒ—å**: ãƒªãƒ³ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ­£è¦åŒ–å‰ï¼‰
- **å…ˆé ­ã‚«ãƒ¼ãƒ‰**:
  - ãƒšãƒ¼ã‚¸æœªä½œæˆ: æ–°è¦ä½œæˆã‚«ãƒ¼ãƒ‰
  - ãƒšãƒ¼ã‚¸ä½œæˆæ¸ˆã¿: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ï¼ˆâ­æœ¬ä½“ãƒãƒƒã‚¸ä»˜ãï¼‰
- **æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰**: ã“ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ï¼ˆæ›´æ–°æ—¥æ™‚é™é †ï¼‰

#### æœªè¨­å®šãƒªãƒ³ã‚¯ä¸€è¦§ã¨ã—ã¦è¡¨ç¤º
- **æ¡ä»¶**: `link_count = 1` ã‹ã¤ `page_id = null`
- **å¾“æ¥ã®å‹•ä½œã‚’ç¶­æŒ**

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### LinkGroup å‹

```typescript
type LinkGroup = {
  key: string;                      // ãƒªãƒ³ã‚¯ã‚­ãƒ¼ï¼ˆæ­£è¦åŒ–æ¸ˆã¿ï¼‰
  displayText: string;              // è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åï¼‰
  linkGroupId: string;              // link_groups.id
  pageId: string | null;            // å¯¾å¿œã™ã‚‹ãƒšãƒ¼ã‚¸ID
  linkCount: number;                // å‚ç…§ç®‡æ‰€æ•°ï¼ˆå¿…ãš > 1ï¼‰
  targetPage: LinkGroupPage | null; // ã‚°ãƒ«ãƒ¼ãƒ—åã®ãƒšãƒ¼ã‚¸æœ¬ä½“ï¼ˆpageId ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  referencingPages: LinkGroupPage[]; // ã“ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ä¸€è¦§
};

type LinkGroupPage = {
  id: string;
  title: string;
  thumbnail_url: string | null;
  content_tiptap: JSONContent;
  updated_at: string;
};
```

---

## å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Phase 2-1: ãƒ‡ãƒ¼ã‚¿å–å¾—å±¤

#### ãƒ•ã‚¡ã‚¤ãƒ«: `app/_actions/linkGroups.ts`

æ–°è¦è¿½åŠ ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š

```typescript
/**
 * ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
 * @param pageId - ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ID
 * @returns ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ï¼ˆlinkCount > 1ï¼‰
 */
export async function getLinkGroupsForPage(pageId: string): Promise<{
  data: LinkGroup[];
  error: string | null;
}>;
```

**å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯**:

1. ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã® `content_tiptap` ã‹ã‚‰ä½¿ç”¨ä¸­ã®ãƒªãƒ³ã‚¯ã‚’æŠ½å‡º
   - `extractLinksFromContent()` ã‚’ä½¿ç”¨
   - ãƒªãƒ³ã‚¯ã‚­ãƒ¼ã®é…åˆ—ã‚’å–å¾—

2. `link_groups` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è©²å½“ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
   ```sql
   SELECT id, key, page_id, link_count
   FROM link_groups
   WHERE key IN (keys)
     AND link_count > 1
   ```

3. å„ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦ä»¥ä¸‹ã‚’å–å¾—:
   
   **3-1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ï¼ˆ`page_id` ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰**
   ```sql
   SELECT id, title, thumbnail_url, content_tiptap, updated_at
   FROM pages
   WHERE id = group.page_id
   ```
   
   **3-2. å‚ç…§ã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ä¸€è¦§**
   ```sql
   -- link_occurrences ã‹ã‚‰ page_id ã‚’å–å¾—
   SELECT page_id
   FROM link_occurrences
   WHERE link_group_id = group.id
   
   -- pages ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è©³ç´°ã‚’å–å¾—
   SELECT id, title, thumbnail_url, content_tiptap, updated_at
   FROM pages
   WHERE id IN (page_ids)
     AND id != current_page_id  -- ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’é™¤å¤–
     AND id != group.page_id    -- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ã‚’é™¤å¤–
   ORDER BY updated_at DESC
   ```

4. ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦è¿”å´

---

### Phase 2-2: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

#### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
app/(protected)/pages/[id]/_components/
â”œâ”€â”€ link-groups-section.tsx      ï¼ˆæ–°è¦ï¼‰ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³
â”œâ”€â”€ target-page-card.tsx         ï¼ˆæ–°è¦ï¼‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰
â”œâ”€â”€ grouped-page-card.tsx        ï¼ˆæ–°è¦ï¼‰å‚ç…§ãƒšãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰
â”œâ”€â”€ create-page-card.tsx         ï¼ˆæ–°è¦ï¼‰æ–°è¦ä½œæˆã‚«ãƒ¼ãƒ‰
â””â”€â”€ page-links-grid.tsx          ï¼ˆä¿®æ­£ï¼‰æœªè¨­å®šãƒªãƒ³ã‚¯ã®ã¿è¡¨ç¤º
```

---

#### 2.2.1 link-groups-section.tsxï¼ˆæ–°è¦ï¼‰

**è²¬å‹™**: ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º

```typescript
"use client";

import { CreatePageCard } from "./create-page-card";
import { GroupedPageCard } from "./grouped-page-card";
import { TargetPageCard } from "./target-page-card";

interface LinkGroupsSectionProps {
  linkGroups: LinkGroup[];
  noteSlug?: string;
}

export function LinkGroupsSection({ 
  linkGroups, 
  noteSlug 
}: LinkGroupsSectionProps) {
  if (linkGroups.length === 0) return null;
  
  return (
    <div className="my-8 space-y-6">
      {linkGroups.map(group => (
        <section key={group.linkGroupId} className="max-w-5xl mx-auto">
          
          {/* Gridãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆpages-list.tsx ã¨åŒã˜ï¼‰ */}
          <div className="grid gap-2 md:gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
            {/* å…ˆé ­ã‚«ãƒ¼ãƒ‰: ãƒšãƒ¼ã‚¸å­˜åœ¨ â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ / æœªä½œæˆ â†’ æ–°è¦ä½œæˆ */}
            {group.targetPage ? (
              <TargetPageCard 
                page={group.targetPage}
                noteSlug={noteSlug}
              />
            ) : (
              <CreatePageCard
                linkKey={group.key}
                displayText={group.displayText}
                linkGroupId={group.linkGroupId}
                noteSlug={noteSlug}
              />
            )}
            
            {/* å‚ç…§ã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ä¸€è¦§ */}
            {group.referencingPages.map(page => (
              <GroupedPageCard 
                key={page.id} 
                page={page}
                noteSlug={noteSlug}
              />
            ))}
          </div>
        </section>
      ))}
    </div>
  );
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- ã‚°ãƒ«ãƒ¼ãƒ—åã¯ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆãã®ã‚‚ã®
- ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¤‡æ•°è¡Œè¡¨ç¤ºå¯èƒ½
- `pages-list.tsx` ã¨åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š

---

#### 2.2.2 target-page-card.tsxï¼ˆæ–°è¦ï¼‰

**è²¬å‹™**: ã‚°ãƒ«ãƒ¼ãƒ—åã«å¯¾å¿œã™ã‚‹ãƒšãƒ¼ã‚¸æœ¬ä½“ã®ã‚«ãƒ¼ãƒ‰

```typescript
"use client";

import Image from "next/image";
import Link from "next/link";
import { Star } from "lucide-react";
import type { JSONContent } from "@tiptap/core";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";

/**
 * Extracts plain text from Tiptap JSON content.
 */
function extractTextFromTiptap(node: JSONContent): string {
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(extractTextFromTiptap).join("");
  if (node !== null && typeof node === "object") {
    const obj = node as Record<string, unknown>;
    if ("text" in obj && typeof obj.text === "string") return obj.text;
    if ("content" in obj && Array.isArray(obj.content)) {
      return obj.content.map(extractTextFromTiptap).join("");
    }
  }
  return "";
}

interface TargetPageCardProps {
  page: {
    id: string;
    title: string;
    thumbnail_url: string | null;
    content_tiptap: JSONContent;
  };
  noteSlug?: string;
}

export function TargetPageCard({ page, noteSlug }: TargetPageCardProps) {
  const href = noteSlug
    ? `/notes/${encodeURIComponent(noteSlug)}/${page.id}`
    : `/pages/${page.id}`;
    
  return (
    <Link href={href}>
      <Card className="h-full overflow-hidden transition-all hover:shadow-md py-4 gap-2 ring-2 ring-primary/20">
        <CardHeader className="px-4 py-2">
          <div className="flex items-start gap-2">
            <CardTitle className="flex-1 text-sm">{page.title}</CardTitle>
          </div>
        </CardHeader>
        <CardContent className="px-4">
          {page.thumbnail_url ? (
            <Image
              src={page.thumbnail_url}
              alt={page.title}
              width={400}
              height={200}
              className="w-full h-32 object-contain"
            />
          ) : (
            (() => {
              const text = extractTextFromTiptap(page.content_tiptap)
                .replace(/\s+/g, " ")
                .trim();
              if (!text) return null;
              return (
                <p className="line-clamp-5 text-sm text-muted-foreground">
                  {text}
                </p>
              );
            })()
          )}
        </CardContent>
      </Card>
    </Link>
  );
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- `ring-2 ring-primary/20` ã§è–„ã„æ ç·š
- `â­ æœ¬ä½“` ãƒãƒƒã‚¸ã§è¦–è¦šçš„ã«åŒºåˆ¥
- `pages-list.tsx` ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¸è¥²

---

#### 2.2.3 grouped-page-card.tsxï¼ˆæ–°è¦ï¼‰

**è²¬å‹™**: ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å‚ç…§ãƒšãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰

```typescript
"use client";

import Image from "next/image";
import Link from "next/link";
import type { JSONContent } from "@tiptap/core";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

/**
 * Extracts plain text from Tiptap JSON content.
 */
function extractTextFromTiptap(node: JSONContent): string {
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(extractTextFromTiptap).join("");
  if (node !== null && typeof node === "object") {
    const obj = node as Record<string, unknown>;
    if ("text" in obj && typeof obj.text === "string") return obj.text;
    if ("content" in obj && Array.isArray(obj.content)) {
      return obj.content.map(extractTextFromTiptap).join("");
    }
  }
  return "";
}

interface GroupedPageCardProps {
  page: {
    id: string;
    title: string;
    thumbnail_url: string | null;
    content_tiptap: JSONContent;
  };
  noteSlug?: string;
}

export function GroupedPageCard({ page, noteSlug }: GroupedPageCardProps) {
  const href = noteSlug
    ? `/notes/${encodeURIComponent(noteSlug)}/${page.id}`
    : `/pages/${page.id}`;
    
  return (
    <Link href={href}>
      <Card className="h-full overflow-hidden transition-all hover:shadow-md py-4 gap-2">
        <CardHeader className="px-4 py-2">
          <CardTitle className="text-sm">{page.title}</CardTitle>
        </CardHeader>
        <CardContent className="px-4">
          {page.thumbnail_url ? (
            <Image
              src={page.thumbnail_url}
              alt={page.title}
              width={400}
              height={200}
              className="w-full h-32 object-contain"
            />
          ) : (
            (() => {
              const text = extractTextFromTiptap(page.content_tiptap)
                .replace(/\s+/g, " ")
                .trim();
              if (!text) return null;
              return (
                <p className="line-clamp-5 text-sm text-muted-foreground">
                  {text}
                </p>
              );
            })()
          )}
        </CardContent>
      </Card>
    </Link>
  );
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- `pages-list.tsx` ã¨å®Œå…¨ã«åŒã˜ãƒ‡ã‚¶ã‚¤ãƒ³
- é€šå¸¸ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«

---

#### 2.2.4 create-page-card.tsxï¼ˆæ–°è¦ï¼‰

**è²¬å‹™**: æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆã‚«ãƒ¼ãƒ‰

```typescript
"use client";

import { PlusCircle } from "lucide-react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { Card } from "@/components/ui/card";
import { createClient } from "@/lib/supabase/client";

interface CreatePageCardProps {
  linkKey: string;
  displayText: string;
  linkGroupId: string;
  noteSlug?: string;
}

export function CreatePageCard({ 
  linkKey, 
  displayText, 
  linkGroupId,
  noteSlug 
}: CreatePageCardProps) {
  const router = useRouter();
  
  const handleClick = async () => {
    const supabase = createClient();
    
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
      toast.error("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      return;
    }
    
    // 1. ãƒšãƒ¼ã‚¸ä½œæˆ
    const { data: page, error: insertError } = await supabase
      .from("pages")
      .insert({
        user_id: user.id,
        title: displayText,
        content_tiptap: { type: "doc", content: [] },
        is_public: false,
      })
      .select("id")
      .single();
    
    if (insertError || !page) {
      console.error("ãƒšãƒ¼ã‚¸ä½œæˆå¤±æ•—:", insertError);
      toast.error("ãƒšãƒ¼ã‚¸ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
      return;
    }
    
    // 2. link_groups ã® page_id ã‚’æ›´æ–°
    const { error: updateError } = await supabase
      .from("link_groups")
      .update({ page_id: page.id })
      .eq("id", linkGroupId);
    
    if (updateError) {
      console.error("link_groups æ›´æ–°å¤±æ•—:", updateError);
      // ã‚¨ãƒ©ãƒ¼ã ãŒãƒšãƒ¼ã‚¸ã¯ä½œæˆã•ã‚ŒãŸã®ã§ç¶šè¡Œ
    }
    
    // 3. noteSlug ãŒã‚ã‚Œã°é–¢é€£ä»˜ã‘
    if (noteSlug) {
      const { data: note } = await supabase
        .from("notes")
        .select("id")
        .eq("slug", noteSlug)
        .single();
        
      if (note) {
        await supabase
          .from("note_page_links")
          .insert({ note_id: note.id, page_id: page.id });
      }
    }
    
    // 4. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    const redirectUrl = noteSlug 
      ? `/notes/${encodeURIComponent(noteSlug)}/${page.id}?newPage=true`
      : `/pages/${page.id}?newPage=true`;
    
    router.push(redirectUrl);
  };
  
  return (
    <Card 
      className="h-full border-dashed border-2 hover:border-primary 
                 hover:bg-accent cursor-pointer transition-all
                 flex flex-col items-center justify-center py-8 gap-3"
      onClick={handleClick}
      role="button"
      tabIndex={0}
      onKeyDown={(e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          handleClick();
        }
      }}
    >
      <PlusCircle className="w-10 h-10 text-muted-foreground" />
      <p className="text-sm font-medium text-center px-3">
        ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
      </p>
    </Card>
  );
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- ç ´ç·šãƒœãƒ¼ãƒ€ãƒ¼ã§ãƒšãƒ¼ã‚¸æœªä½œæˆã‚’è¦–è¦šçš„ã«è¡¨ç¾
- ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒšãƒ¼ã‚¸ä½œæˆ + link_groups æ›´æ–°
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰

---

#### 2.2.5 page-links-grid.tsxï¼ˆä¿®æ­£ï¼‰

**å¤‰æ›´å†…å®¹**:
- ã€Œãƒªãƒ³ã‚¯ã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
- `missingLinks` ã¯ `linkCount = 1` ã®ãƒªãƒ³ã‚¯ã®ã¿è¡¨ç¤º

```typescript
// ä¿®æ­£å‰: outgoingPages, incomingPages ã‚’è¡¨ç¤º
// ä¿®æ­£å¾Œ: missingLinks ã®ã¿è¡¨ç¤ºï¼ˆä»–ã¯ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¡¨ç¤ºï¼‰

export default function PageLinksGrid({
  missingLinks,  // linkCount = 1 ã®ãƒªãƒ³ã‚¯ã®ã¿
  nestedLinks,
  noteSlug,
}: PageLinksGridProps) {
  // ...
  
  return (
    <div className="my-8 space-y-8 min-h-[300px]">
      {/* æœªè¨­å®šãƒªãƒ³ã‚¯ä¸€è¦§ï¼ˆlinkCount = 1ï¼‰ */}
      {missingLinks && missingLinks.length > 0 && (
        <section className="max-w-5xl mx-auto">
          <h2 className="text-lg font-semibold mb-2">æœªè¨­å®šãƒªãƒ³ã‚¯ä¸€è¦§</h2>
          {/* ... æ—¢å­˜ã®å®Ÿè£… */}
        </section>
      )}
    </div>
  );
}
```

---

### Phase 2-3: page.tsx çµ±åˆ

#### ãƒ•ã‚¡ã‚¤ãƒ«: `app/(protected)/pages/[id]/page.tsx`

```typescript
import { LinkGroupsSection } from "./_components/link-groups-section";
import { getLinkGroupsForPage } from "@/app/_actions/linkGroups";

export default async function PageDetailPage({ params }: PageProps) {
  const { id: pageId } = await params;
  
  // ... æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿å–å¾— ...
  
  // ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—å–å¾—ï¼ˆæ–°è¦ï¼‰
  const { data: linkGroups } = await getLinkGroupsForPage(pageId);
  
  // missingLinks ã¯ linkCount = 1 ã®ãƒªãƒ³ã‚¯ã®ã¿ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const missingLinksFiltered = missingLinks.filter(link => {
    const group = linkGroups?.find(g => g.key === link.key);
    return !group; // linkCount > 1 ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯å«ã¾ã‚Œã¦ã„ãªã„
  });
  
  return (
    <div>
      {/* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ */}
      <EditPageForm page={page} noteSlug={noteSlug} />
      
      {/* ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ–°è¦ï¼‰ */}
      <LinkGroupsSection 
        linkGroups={linkGroups || []} 
        noteSlug={noteSlug} 
      />
      
      {/* æœªè¨­å®šãƒªãƒ³ã‚¯ä¸€è¦§ï¼ˆä¿®æ­£ï¼‰ */}
      <PageLinksGrid
        missingLinks={missingLinksFiltered}
        nestedLinks={nestedLinks}
        noteSlug={noteSlug}
      />
    </div>
  );
}
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### 2.3.1 ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/_actions/__tests__/getLinkGroupsForPage.test.ts`

```typescript
describe("getLinkGroupsForPage", () => {
  test("linkCount > 1 ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿å–å¾—", async () => {
    // Arrange: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    // Act: getLinkGroupsForPage() å®Ÿè¡Œ
    // Assert: linkCount > 1 ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿è¿”å´
  });
  
  test("targetPage ãŒæ­£ã—ãå–å¾—ã•ã‚Œã‚‹", async () => {
    // page_id ãŒå­˜åœ¨ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã§ targetPage ãŒå–å¾—ã•ã‚Œã‚‹ã“ã¨
  });
  
  test("referencingPages ã‹ã‚‰ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒé™¤å¤–ã•ã‚Œã‚‹", async () => {
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ãŒé™¤å¤–ã•ã‚Œã‚‹ã“ã¨
  });
  
  test("referencingPages ãŒæ›´æ–°æ—¥æ™‚é™é †ã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹", async () => {
    // updated_at DESC ã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ã“ã¨
  });
});
```

### 2.3.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/(protected)/pages/[id]/_components/__tests__/link-groups-section.test.tsx`

```typescript
describe("LinkGroupsSection", () => {
  test("linkGroups ãŒç©ºã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„", () => {
    // linkGroups = [] ã§ null ã‚’è¿”ã™ã“ã¨
  });
  
  test("ãƒšãƒ¼ã‚¸æœªä½œæˆã®å ´åˆã¯ CreatePageCard ã‚’è¡¨ç¤º", () => {
    // targetPage = null ã®å ´åˆã« CreatePageCard ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
  });
  
  test("ãƒšãƒ¼ã‚¸ä½œæˆæ¸ˆã¿ã®å ´åˆã¯ TargetPageCard ã‚’è¡¨ç¤º", () => {
    // targetPage ãŒå­˜åœ¨ã™ã‚‹å ´åˆã« TargetPageCard ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
  });
  
  test("referencingPages ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹", () => {
    // GroupedPageCard ãŒ referencingPages ã®æ•°ã ã‘è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
  });
});
```

---

## ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°

### CSSï¼ˆglobals.css ã«è¿½åŠ æ¸ˆã¿ï¼‰

```css
/* UnifiedLinkMark - Link Group State Styles */

/* exists: ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ â†’ é’è‰²ãƒªãƒ³ã‚¯ */
.ProseMirror a.unilink[data-group-state="exists"] {
  color: #2563eb; /* blue-600 */
}
.dark .ProseMirror a.unilink[data-group-state="exists"] {
  color: #60a5fa; /* blue-400 */
}

/* grouped: ãƒšãƒ¼ã‚¸æœªä½œæˆã ãŒè¤‡æ•°ç®‡æ‰€ã§å‚ç…§ â†’ é’è‰²ãƒªãƒ³ã‚¯ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ */
.ProseMirror a.unilink[data-group-state="grouped"] {
  color: #2563eb; /* blue-600 */
}
.dark .ProseMirror a.unilink[data-group-state="grouped"] {
  color: #60a5fa; /* blue-400 */
}

/* missing: ãƒšãƒ¼ã‚¸æœªä½œæˆã‹ã¤å˜ç‹¬å‚ç…§ â†’ èµ¤è‰²ãƒªãƒ³ã‚¯ */
.ProseMirror a.unilink[data-group-state="missing"] {
  color: #dc2626; /* red-600 */
}
.dark .ProseMirror a.unilink[data-group-state="missing"] {
  color: #f87171; /* red-400 */
}
```

---

## å®Ÿè£…é †åº

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿å–å¾—å±¤
1. `getLinkGroupsForPage` ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
2. ãƒ†ã‚¹ãƒˆä½œæˆãƒ»å®Ÿè¡Œ

### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
1. `target-page-card.tsx` ä½œæˆ
2. `grouped-page-card.tsx` ä½œæˆ
3. `create-page-card.tsx` ä½œæˆ
4. `link-groups-section.tsx` ä½œæˆ
5. å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆä½œæˆãƒ»å®Ÿè¡Œ

### ã‚¹ãƒ†ãƒƒãƒ—3: çµ±åˆ
1. `page-links-grid.tsx` ä¿®æ­£
2. `page.tsx` çµ±åˆ
3. å‹•ä½œç¢ºèª

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ¼ã‚¿å–å¾—
- [ ] `getLinkGroupsForPage` å®Ÿè£…å®Œäº†
- [ ] `linkCount > 1` ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿å–å¾—
- [ ] `targetPage` ãŒæ­£ã—ãå–å¾—ã•ã‚Œã‚‹
- [ ] `referencingPages` ã‹ã‚‰ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒé™¤å¤–ã•ã‚Œã‚‹
- [ ] `referencingPages` ãŒæ›´æ–°æ—¥æ™‚é™é †ã§ã‚½ãƒ¼ãƒˆ
- [ ] ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] `TargetPageCard` å®Ÿè£…å®Œäº†
- [ ] `GroupedPageCard` å®Ÿè£…å®Œäº†
- [ ] `CreatePageCard` å®Ÿè£…å®Œäº†
- [ ] `LinkGroupsSection` å®Ÿè£…å®Œäº†
- [ ] `pages-list.tsx` ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¸è¥²
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
- [ ] ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹

### çµ±åˆ
- [ ] `page-links-grid.tsx` ä¿®æ­£å®Œäº†
- [ ] `page.tsx` çµ±åˆå®Œäº†
- [ ] ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç›´ä¸‹ã«é…ç½®
- [ ] æœªè¨­å®šãƒªãƒ³ã‚¯ãŒé‡è¤‡ã—ã¦ã„ãªã„
- [ ] å‹•ä½œç¢ºèªå®Œäº†

### UI/UX
- [ ] ã‚°ãƒ«ãƒ¼ãƒ—åãŒãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒšãƒ¼ã‚¸æœªä½œæˆæ™‚ã«æ–°è¦ä½œæˆã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒšãƒ¼ã‚¸ä½œæˆæ¸ˆã¿æ™‚ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ãŒå…ˆé ­ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] ãƒ›ãƒãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **Phase 1 å®Ÿè£…**: `docs/05_logs/2025_10/20251027_01_link-group-phase1-complete.md`
- **ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ä»•æ§˜**: `lib/tiptap-extensions/unified-link-mark/link-group-state.ts`
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ**: `database/schema.sql` (link_groups, link_occurrences)
- **ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `app/_actions/linkGroups.ts`

---

**æœ€çµ‚æ›´æ–°**: 2025-10-27
**ä½œæˆè€…**: AI (Claude 3.5 Sonnet)
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨ˆç”»å®Œäº† - å®Ÿè£…é–‹å§‹å¾…ã¡
