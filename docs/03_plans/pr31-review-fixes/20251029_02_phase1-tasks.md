# Phase 1: エラーログ追加 - タスクリスト

**開始日**: 2025-10-29  
**ブランチ**: `fix/pr31-review-phase1-error-logging`  
**所要時間（予定）**: 15-20分  
**優先度**: 🔴 High

---

## 📋 実装タスク

### Task 1: EditPageForm.tsx - Logger Import 追加

**ファイル**: `app/(protected)/pages/[id]/_components/EditPageForm.tsx`

- [ ] ファイル先頭部分を確認
- [ ] `import logger from "@/lib/logger";` を追加
- [ ] 他のimport文と位置を揃える

**確認コマンド**:
```bash
# Import が正しく追加されているか確認
grep "import logger" app/\(protected\)/pages/\[id\]/_components/EditPageForm.tsx
```

---

### Task 2: EditPageForm.tsx - サムネイル自動設定エラーログ

**ファイル**: `app/(protected)/pages/[id]/_components/EditPageForm.tsx`  
**対象行**: 111-113

#### 修正前
```typescript
} catch {
    // サムネイル自動設定でエラーが発生
}
```

#### 修正後
```typescript
} catch (error) {
    logger.error({ error, pageId: page.id }, "サムネイル自動設定でエラーが発生");
}
```

- [ ] catch ブロックに `error` パラメータを追加
- [ ] logger.error でエラーログを追加
- [ ] pageId を含める（デバッグ情報）
- [ ] コメントを削除（ログで代替）

**確認ポイント**:
- error オブジェクトが catch でキャプチャされている
- logger.error の第1引数にオブジェクト、第2引数にメッセージ
- pageId が含まれている

---

### Task 3: EditPageForm.tsx - ページ削除エラーログ

**ファイル**: `app/(protected)/pages/[id]/_components/EditPageForm.tsx`  
**対象行**: 186-190

#### 修正前
```typescript
} catch {
    toast.dismiss();
    toast.error("ページの削除に失敗しました");
    throw new Error("ページ削除エラー");
}
```

#### 修正後
```typescript
} catch (error) {
    logger.error({ error, pageId: page.id, title }, "ページ削除エラー");
    toast.dismiss();
    toast.error("ページの削除に失敗しました");
    throw new Error("ページ削除エラー", { cause: error });
}
```

- [ ] catch ブロックに `error` パラメータを追加
- [ ] logger.error でエラーログを追加
- [ ] pageId と title を含める（デバッグ情報）
- [ ] `{ cause: error }` オプションを追加（元のエラーを保持）

**確認ポイント**:
- error オブジェクトが catch でキャプチャされている
- logger.error が toast.dismiss() の前にある
- Error の第2引数に `{ cause: error }` がある
- スタックトレースが保持される

---

### Task 4: page-links-grid.tsx - Logger Import 追加

**ファイル**: `app/(protected)/pages/[id]/_components/page-links-grid.tsx`

- [ ] ファイル先頭部分を確認
- [ ] `import logger from "@/lib/logger";` を追加
- [ ] 他のimport文と位置を揃える

**確認コマンド**:
```bash
# Import が正しく追加されているか確認
grep "import logger" app/\(protected\)/pages/\[id\]/_components/page-links-grid.tsx
```

---

### Task 5: page-links-grid.tsx - ページ作成失敗エラーログ

**ファイル**: `app/(protected)/pages/[id]/_components/page-links-grid.tsx`  
**対象行**: 41-44

#### 修正前
```typescript
if (insertError || !insertedPage) {
    toast.error("ページ作成に失敗しました");
    return;
}
```

#### 修正後
```typescript
if (insertError || !insertedPage) {
    logger.error({ error: insertError, name, noteSlug }, "ページ作成失敗");
    toast.error("ページ作成に失敗しました");
    return;
}
```

- [ ] logger.error でエラーログを追加
- [ ] insertError, name, noteSlug を含める（デバッグ情報）
- [ ] logger.error を toast.error の前に配置

**確認ポイント**:
- logger.error の第1引数に error と コンテキスト情報
- name（ページ名）が含まれている
- noteSlug が含まれている（どのノートへの作成か）

---

## 🧪 テスト・確認タスク

### 1. Lint チェック

- [ ] `bun lint` を実行
- [ ] エラーが0件であることを確認
- [ ] Warning があれば対応

```bash
bun lint
```

### 2. TypeScript コンパイルチェック

- [ ] TypeScript エラーがないことを確認

```bash
bun run type-check
```

### 3. 既存テストの実行

- [ ] `bun test` を実行
- [ ] 既存テストが全てパスすることを確認
- [ ] 失敗があれば原因を調査

```bash
bun test
```

### 4. ローカル環境での動作確認

#### 4-1. サムネイル自動設定のエラー確認

- [ ] 開発サーバーを起動 (`bun dev`)
- [ ] ページ編集画面を開く
- [ ] ブラウザコンソールでエラーを確認
- [ ] サーバーログでエラーログが出力されているか確認

#### 4-2. ページ削除のエラー確認

- [ ] テストページを作成
- [ ] ページ削除を実行（正常系）
- [ ] データベースエラーを意図的に発生させて確認（異常系）
- [ ] サーバーログでエラーログが出力されているか確認

#### 4-3. ページ作成のエラー確認

- [ ] リンクからページ作成を実行（正常系）
- [ ] 権限エラーなどを意図的に発生させて確認（異常系）
- [ ] サーバーログでエラーログが出力されているか確認

---

## 📊 完了基準

### 必須条件
- [x] 全タスクが完了している
- [x] `bun lint` がエラーなし
- [x] `bun test` が全てパス
- [x] ローカル環境で動作確認済み
- [x] エラーログが適切に出力される

### 推奨条件
- [ ] コードレビューで問題なし
- [ ] ログが構造化されている（JSON形式）
- [ ] ログレベルが適切（error を使用）

---

## 🚀 次のステップ

### Phase 1 完了後
1. [ ] 変更をコミット
2. [ ] ブランチをプッシュ
3. [ ] PR#31 (develop → main) に追加コミット
   - または、develop ブランチに直接マージ
4. [ ] Phase 2 の準備

### コミットメッセージ例
```bash
git add app/(protected)/pages/[id]/_components/EditPageForm.tsx
git add app/(protected)/pages/[id]/_components/page-links-grid.tsx
git commit -m "fix: Add error logging for better debugging

- Add logger import to EditPageForm.tsx and page-links-grid.tsx
- Add error logging for thumbnail auto-set failures
- Add error logging for page deletion with error cause preservation
- Add error logging for page creation failures
- Include context information (pageId, title, name, noteSlug) in logs

Fixes Gemini Code Assist review comments in PR#31"
```

---

## 📝 作業ログ

### 2025-10-29

#### 開始時刻: __:__

- [ ] Task 1: EditPageForm.tsx - Logger Import
- [ ] Task 2: サムネイル自動設定エラーログ
- [ ] Task 3: ページ削除エラーログ
- [ ] Task 4: page-links-grid.tsx - Logger Import
- [ ] Task 5: ページ作成失敗エラーログ
- [ ] Lint チェック
- [ ] テスト実行
- [ ] ローカル動作確認

#### 完了時刻: __:__

#### 所要時間: __ 分

#### 気づき・メモ
```
（作業中の気づきや問題点を記録）
```

---

## 🔗 関連ドキュメント

- **実装計画**: `docs/03_plans/pr31-review-fixes/20251029_01_implementation-plan.md`
- **PR#31**: https://github.com/otomatty/for-all-learners/pull/31
- **Logger実装**: `lib/logger.ts`

---

**最終更新**: 2025-10-29  
**ステータス**: 準備完了 ✅
