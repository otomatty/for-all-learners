# Phase 2: パフォーマンス改善 - タスクリスト

**予定実施日**: Phase 1完了後  
**ブランチ**: `fix/pr31-review-phase2-performance` (新規作成予定)  
**所要時間（予定）**: 30-45分  
**優先度**: 🟡 Medium

---

## 📋 実装タスク

### Task 1: notes-sidebar.tsx - 重複除去の最適化

**ファイル**: `app/(protected)/notes/_components/notes-sidebar.tsx`  
**対象行**: 65-70

#### 現在の実装（O(n²)）
```typescript
const uniqueNotes = notes.reduce((acc, note) => {
    if (!acc.find((n) => n.id === note.id)) {
        acc.push(note);
    }
    return acc;
}, [] as Note[]);
```

#### 最適化案（O(n)）

**推奨: Map を使用**
```typescript
const uniqueNotes = Array.from(
    new Map(notes.map((note) => [note.id, note])).values()
);
```

**代替案: Set を使用**
```typescript
const seenIds = new Set<string>();
const uniqueNotes = notes.filter((note) => {
    if (seenIds.has(note.id)) return false;
    seenIds.add(note.id);
    return true;
});
```

#### 実装手順

- [ ] 現在のコメント（CRITICAL FIX）を保持
- [ ] reduce + find を Map 実装に置き換え
- [ ] TypeScript の型エラーがないか確認
- [ ] 結果が同じことを確認

---

## 🧪 テスト・確認タスク

### 1. ユニットテスト

- [ ] 既存のテストが全てパス
- [ ] 結果が同じことを確認するテストを追加（推奨）

```typescript
// 追加推奨テスト
describe('uniqueNotes deduplication', () => {
    it('should remove duplicates correctly', () => {
        const duplicateNotes = [
            { id: '1', title: 'Note 1' },
            { id: '2', title: 'Note 2' },
            { id: '1', title: 'Note 1' }, // duplicate
        ];
        const result = uniqueNotesLogic(duplicateNotes);
        expect(result).toHaveLength(2);
        expect(result.map(n => n.id)).toEqual(['1', '2']);
    });
});
```

### 2. パフォーマンステスト

#### 小規模データ（10件）
- [ ] 重複なしデータで実行時間を測定
- [ ] 重複ありデータで実行時間を測定

#### 中規模データ（100件）
- [ ] 重複なしデータで実行時間を測定
- [ ] 重複ありデータで実行時間を測定

#### 大規模データ（1000件）
- [ ] 重複なしデータで実行時間を測定
- [ ] 重複ありデータで実行時間を測定

**測定コマンド例**:
```typescript
console.time('uniqueNotes');
const uniqueNotes = Array.from(
    new Map(notes.map((note) => [note.id, note])).values()
);
console.timeEnd('uniqueNotes');
```

### 3. ローカル環境での動作確認

- [ ] サイドバーが正常に表示される
- [ ] 重複したノートが表示されない
- [ ] ノートの順序が保持される
- [ ] 大量のノート（100件以上）でもスムーズに動作

---

## 📊 パフォーマンス目標

| ノート数 | 目標改善率 | 許容実行時間 |
|----------|------------|--------------|
| 10件 | 2倍以上 | < 0.1ms |
| 50件 | 10倍以上 | < 0.5ms |
| 100件 | 20倍以上 | < 1ms |
| 500件 | 100倍以上 | < 5ms |
| 1000件 | 200倍以上 | < 10ms |

---

## 📊 完了基準

### 必須条件
- [ ] Map を使った実装に変更
- [ ] `bun lint` がエラーなし
- [ ] `bun test` が全てパス
- [ ] ローカル環境で動作確認済み
- [ ] 100件以上のノートで動作確認済み

### 推奨条件
- [ ] パフォーマンステスト実施
- [ ] Before/After の測定結果を記録
- [ ] 10倍以上の改善を確認

---

## 🚀 コミット

```bash
git add app/(protected)/notes/_components/notes-sidebar.tsx
git commit -m "perf: Optimize duplicate removal in notes sidebar

- Replace O(n²) reduce+find with O(n) Map implementation
- Improve performance by 20-200x for large note lists
- Maintain existing CRITICAL FIX comment
- Preserve original behavior and results

Performance improvements:
- 10 notes: 2x faster
- 100 notes: 20x faster
- 1000 notes: 200x faster

Addresses Gemini Code Assist review comment in PR#31"
```

---

## 🔗 関連ドキュメント

- **実装計画**: `docs/03_plans/pr31-review-fixes/20251029_01_implementation-plan.md`
- **Phase 1**: `docs/03_plans/pr31-review-fixes/20251029_02_phase1-tasks.md`

---

**最終更新**: 2025-10-29  
**ステータス**: 準備中 ⏳
