# Phase 3: N+1ã‚¯ã‚¨ãƒªæœ€é©åŒ– - ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ

**äºˆå®šå®Ÿæ–½æ—¥**: Phase 2å®Œäº†å¾Œï¼ˆåˆ¥PRæ¨å¥¨ï¼‰  
**ãƒ–ãƒ©ãƒ³ãƒ**: `fix/pr31-review-phase3-n-plus-one` (æ–°è¦ä½œæˆäºˆå®š)  
**æ‰€è¦æ™‚é–“ï¼ˆäºˆå®šï¼‰**: 1-2æ™‚é–“  
**å„ªå…ˆåº¦**: ğŸ”´ Highï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰

---

## âš ï¸ é‡è¦äº‹é …

### åˆ¥PRã§ã®å®Ÿæ–½ã‚’å¼·ãæ¨å¥¨

**ç†ç”±**:
1. **ãƒ†ã‚¹ãƒˆå½±éŸ¿ãŒå¤§ãã„**: 327ä»¶ã®å˜ä½“ãƒ†ã‚¹ãƒˆã®ç¢ºèªãŒå¿…è¦
2. **å®Ÿè£…ãŒè¤‡é›‘**: ãƒãƒƒãƒã‚¯ã‚¨ãƒªã¨Mapãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
3. **ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚é–“**: å¤§è¦æ¨¡ãªå¤‰æ›´ã®ãŸã‚ä¸å¯§ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦
4. **ãƒªã‚¹ã‚¯ç®¡ç†**: åˆ†é›¢ã™ã‚‹ã“ã¨ã§å•é¡Œç™ºç”Ÿæ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®¹æ˜“

---

## ğŸ“‹ äº‹å‰æº–å‚™ã‚¿ã‚¹ã‚¯

### 1. è©³ç´°è¨­è¨ˆæ›¸ã®ä½œæˆ

- [ ] ç¾åœ¨ã®ã‚¯ã‚¨ãƒªãƒ•ãƒ­ãƒ¼ã‚’å›³è§£
- [ ] æœ€é©åŒ–å¾Œã®ã‚¯ã‚¨ãƒªãƒ•ãƒ­ãƒ¼ã‚’å›³è§£
- [ ] å„ã‚¯ã‚¨ãƒªã®å½¹å‰²ã‚’æ–‡æ›¸åŒ–
- [ ] ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆMap/Setï¼‰ã®è¨­è¨ˆæ›¸ä½œæˆ

### 2. æ—¢å­˜ãƒ†ã‚¹ãƒˆã®ç¢ºèª

- [ ] æ—¢å­˜ã®å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ327ä»¶ï¼‰ã‚’å…¨ã¦ç¢ºèª
- [ ] ãƒ†ã‚¹ãƒˆãŒä½•ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã‹ç†è§£
- [ ] ä¿®æ­£å¾Œã«ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‹äº‹å‰æ¤œè¨

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æº–å‚™

- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆ10, 20, 50å€‹ã®ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
- [ ] æ¸¬å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ
- [ ] Before/After ã®æ¯”è¼ƒæ–¹æ³•ã®ç¢ºç«‹

---

## ğŸ“‹ å®Ÿè£…ã‚¿ã‚¹ã‚¯

### Task 1: ãƒãƒƒãƒã‚¯ã‚¨ãƒªãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/_actions/linkGroups.ts`  
**é–¢æ•°**: `getLinkGroupsForPage`

#### Step 1: IDã®åé›†

```typescript
// 4-1. Collect all target page IDs
const targetPageIds = linkGroupsData
    .map(g => g.page_id)
    .filter((id): id is string => id !== null);

// 4-2. Collect all link group IDs
const linkGroupIds = linkGroupsData.map(g => g.id);
```

- [ ] targetPageIds ã®åé›†ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
- [ ] linkGroupIds ã®åé›†ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
- [ ] å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ï¼ˆfilter ã§ null ã‚’é™¤å¤–ï¼‰

#### Step 2: ãƒãƒƒãƒãƒ•ã‚§ãƒƒãƒã®å®Ÿè£…

```typescript
// 4-3. Fetch all target pages in one query
const { data: allTargetPages } = await supabase
    .from("pages")
    .select("id, title, thumbnail_url, content_tiptap, updated_at")
    .in("id", targetPageIds);

// 4-4. Fetch all occurrences in one query
const { data: allOccurrences } = await supabase
    .from("link_occurrences")
    .select("link_group_id, source_page_id")
    .in("link_group_id", linkGroupIds);
```

- [ ] å…¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ¼ã‚¸ã‚’1å›ã®ã‚¯ã‚¨ãƒªã§å–å¾—
- [ ] å…¨ã‚ªã‚«ãƒ¬ãƒ³ã‚¹ã‚’1å›ã®ã‚¯ã‚¨ãƒªã§å–å¾—
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 

#### Step 3: å‚ç…§ãƒšãƒ¼ã‚¸IDã®åé›†

```typescript
// 4-5. Collect all referencing page IDs
const allReferencingPageIds = [
    ...new Set(
        (allOccurrences || [])
            .map(o => o.source_page_id)
            .filter(id => id !== pageId && !targetPageIds.includes(id))
    ),
];

// 4-6. Fetch all referencing pages in one query
const { data: allReferencingPages } = await supabase
    .from("pages")
    .select("id, title, thumbnail_url, content_tiptap, updated_at")
    .in("id", allReferencingPageIds)
    .order("updated_at", { ascending: false });
```

- [ ] å‚ç…§ãƒšãƒ¼ã‚¸IDã®åé›†ï¼ˆé‡è¤‡é™¤å»ï¼‰
- [ ] å…¨å‚ç…§ãƒšãƒ¼ã‚¸ã‚’1å›ã®ã‚¯ã‚¨ãƒªã§å–å¾—
- [ ] ã‚½ãƒ¼ãƒˆé †ã‚’ä¿æŒ

---

### Task 2: Mapãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

#### Step 1: Mapã®æ§‹ç¯‰

```typescript
// 5. Build lookup maps for O(1) access
const targetPagesMap = new Map(
    (allTargetPages || []).map(p => [p.id, p])
);

const occurrencesByGroupId = new Map<string, string[]>();
for (const occ of allOccurrences || []) {
    if (!occurrencesByGroupId.has(occ.link_group_id)) {
        occurrencesByGroupId.set(occ.link_group_id, []);
    }
    occurrencesByGroupId.get(occ.link_group_id)!.push(occ.source_page_id);
}

const referencingPagesMap = new Map(
    (allReferencingPages || []).map(p => [p.id, p])
);
```

- [ ] targetPagesMap ã®å®Ÿè£…
- [ ] occurrencesByGroupId ã®å®Ÿè£…
- [ ] referencingPagesMap ã®å®Ÿè£…
- [ ] å‹å®šç¾©ã‚’æ­£ç¢ºã«è¨˜è¿°

#### Step 2: çµæœã®æ§‹ç¯‰

```typescript
// 6. Build result using maps (O(n) instead of O(nÂ²))
const result: LinkGroupForUI[] = linkGroupsData.map(group => {
    // Get target page from map
    const targetPage = group.page_id 
        ? targetPagesMap.get(group.page_id) 
        : null;

    // Get referencing page IDs from map
    const referencingPageIds = (occurrencesByGroupId.get(group.id) || [])
        .filter(id => id !== pageId && id !== group.page_id);

    // Get referencing pages from map
    const referencingPages = referencingPageIds
        .map(id => referencingPagesMap.get(id))
        .filter((p): p is NonNullable<typeof p> => p !== undefined);

    return {
        key: group.key,
        displayText: group.raw_text,
        linkGroupId: group.id,
        pageId: group.page_id,
        linkCount: group.link_count ?? 0,
        targetPage: targetPage ? {
            ...targetPage,
            content_tiptap: targetPage.content_tiptap as Record<string, unknown>,
            updated_at: targetPage.updated_at ?? "",
        } : null,
        referencingPages: referencingPages.map(p => ({
            ...p,
            content_tiptap: p.content_tiptap as Record<string, unknown>,
            updated_at: p.updated_at ?? "",
        })),
    };
});
```

- [ ] Map ã‚’ä½¿ã£ãŸãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè£…
- [ ] å‹å®‰å…¨æ€§ã®ç¢ºä¿
- [ ] æ—¢å­˜ã®å‹å®šç¾©ã¨ã®æ•´åˆæ€§ç¢ºèª

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»ç¢ºèªã‚¿ã‚¹ã‚¯

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆã®ç¢ºèªï¼ˆ327ä»¶ï¼‰

- [ ] æ—¢å­˜ã®å˜ä½“ãƒ†ã‚¹ãƒˆå…¨ã¦ã‚’å®Ÿè¡Œ
- [ ] å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒãªã„ã‹ç¢ºèª
- [ ] å¤±æ•—ã™ã‚‹å ´åˆã€åŸå› ã‚’èª¿æŸ»ãƒ»ä¿®æ­£

```bash
bun test app/_actions/__tests__/linkGroups.test.ts
```

### 2. çµæœã®ä¸€è‡´ç¢ºèªãƒ†ã‚¹ãƒˆ

- [ ] æœ€é©åŒ–å‰å¾Œã§çµæœãŒåŒã˜ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆè¿½åŠ 

```typescript
describe('getLinkGroupsForPage - optimization', () => {
    it('should return same results as before', async () => {
        // Test with various scenarios
        // - 10 link groups
        // - 20 link groups
        // - 50 link groups
    });
});
```

### 3. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

- [ ] ç©ºé…åˆ—ã®ã‚±ãƒ¼ã‚¹
- [ ] page_id ãŒ null ã®ã‚±ãƒ¼ã‚¹
- [ ] occurrences ãŒ0ä»¶ã®ã‚±ãƒ¼ã‚¹
- [ ] ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ãŒ1ä»¶ã®ã‚±ãƒ¼ã‚¹
- [ ] ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ãŒ100ä»¶ã®ã‚±ãƒ¼ã‚¹

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

#### æ¸¬å®šé …ç›®
- [ ] ã‚¯ã‚¨ãƒªå®Ÿè¡Œå›æ•°ï¼ˆBefore/Afterï¼‰
- [ ] å®Ÿè¡Œæ™‚é–“ï¼ˆBefore/Afterï¼‰
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆBefore/Afterï¼‰

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

| ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—æ•° | ç›®æ¨™ã‚¯ã‚¨ãƒªæ•° | ç›®æ¨™å®Ÿè¡Œæ™‚é–“ |
|------------------|--------------|--------------|
| 5å€‹ | 4å› | < 100ms |
| 10å€‹ | 4å› | < 150ms |
| 20å€‹ | 4å› | < 200ms |
| 50å€‹ | 4å› | < 300ms |

**æ¸¬å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹**:
```typescript
console.time('getLinkGroupsForPage');
const result = await getLinkGroupsForPage(pageId);
console.timeEnd('getLinkGroupsForPage');
console.log('Total queries:', queryCount);
```

---

## ğŸ“Š å®Œäº†åŸºæº–

### å¿…é ˆæ¡ä»¶
- [ ] ãƒãƒƒãƒã‚¯ã‚¨ãƒªå®Ÿè£…å®Œäº†
- [ ] Map ãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè£…å®Œäº†
- [ ] æ—¢å­˜ã®å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ327ä»¶ï¼‰å…¨ã¦ãƒ‘ã‚¹
- [ ] çµæœã®ä¸€è‡´ç¢ºèªãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»ãƒ‘ã‚¹
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆå…¨ã¦ãƒ‘ã‚¹
- [ ] `bun lint` ãŒã‚¨ãƒ©ãƒ¼ãªã—
- [ ] `bun test` ãŒå…¨ã¦ãƒ‘ã‚¹

### æ¨å¥¨æ¡ä»¶
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿæ–½
- [ ] Before/After ã®æ¸¬å®šçµæœã‚’è¨˜éŒ²
- [ ] ã‚¯ã‚¨ãƒªæ•°ãŒ75%ä»¥ä¸Šå‰Šæ¸›
- [ ] å®Ÿè¡Œæ™‚é–“ãŒ5å€ä»¥ä¸Šæ”¹å–„

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ

### ã‚¯ã‚¨ãƒªæ•°ã®å‰Šæ¸›

| ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—æ•° | Before | After | å‰Šæ¸›ç‡ |
|------------------|--------|-------|--------|
| 5å€‹ | 15-20å› | 4å› | 75-80% |
| 10å€‹ | 30-40å› | 4å› | 87-90% |
| 20å€‹ | 60-80å› | 4å› | 93-95% |
| 50å€‹ | 150-200å› | 4å› | 97-98% |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

- ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚é–“: 500-1000ms â†’ 50-100msï¼ˆ**10å€é«˜é€ŸåŒ–**ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·: **75-90%å‰Šæ¸›**
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£: ãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã«é–¢ã‚ã‚‰ãšå®‰å®š

---

## ğŸš€ PRä½œæˆ

### PR ã‚¿ã‚¤ãƒˆãƒ«
```
perf: Optimize N+1 query issue in getLinkGroupsForPage
```

### PR èª¬æ˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```markdown
## æ¦‚è¦
`getLinkGroupsForPage` é–¢æ•°ã®N+1ã‚¯ã‚¨ãƒªå•é¡Œã‚’ä¿®æ­£ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å¤§å¹…ã«æ”¹å–„ã—ã¾ã—ãŸã€‚

## å¤‰æ›´å†…å®¹
- ãƒ«ãƒ¼ãƒ—å†…ã®å€‹åˆ¥ã‚¯ã‚¨ãƒªã‚’ãƒãƒƒãƒã‚¯ã‚¨ãƒªã«å¤‰æ›´
- Map ã‚’ä½¿ã£ãŸO(1)ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å®Ÿè£…
- ã‚¯ã‚¨ãƒªæ•°ã‚’4å›ã«å›ºå®šï¼ˆãƒªãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã«é–¢ã‚ã‚‰ãšï¼‰

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
- ã‚¯ã‚¨ãƒªæ•°: 30-40å› â†’ 4å›ï¼ˆ87-90%å‰Šæ¸›ï¼‰
- å®Ÿè¡Œæ™‚é–“: 500-1000ms â†’ 50-100msï¼ˆ10å€é«˜é€ŸåŒ–ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·: 75-90%å‰Šæ¸›

## ãƒ†ã‚¹ãƒˆ
- æ—¢å­˜ã®å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ327ä»¶ï¼‰å…¨ã¦ãƒ‘ã‚¹
- çµæœã®ä¸€è‡´ã‚’ç¢ºèªã™ã‚‹çµ±åˆãƒ†ã‚¹ãƒˆè¿½åŠ 
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆBefore/Afteræ¸¬å®šï¼‰

## é–¢é€£
- Addresses Gemini Code Assist review comment in PR#31
- Related to: #31
```

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **å®Ÿè£…è¨ˆç”»**: `docs/03_plans/pr31-review-fixes/20251029_01_implementation-plan.md`
- **Phase 1**: `docs/03_plans/pr31-review-fixes/20251029_02_phase1-tasks.md`
- **Phase 2**: `docs/03_plans/pr31-review-fixes/20251029_03_phase2-tasks.md`
- **æ—¢å­˜ãƒ†ã‚¹ãƒˆ**: `app/_actions/__tests__/linkGroups.test.ts`

---

**æœ€çµ‚æ›´æ–°**: 2025-10-29  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æº–å‚™ä¸­ï¼ˆPhase 1, 2å®Œäº†å¾Œã«å®Ÿæ–½ï¼‰â³
