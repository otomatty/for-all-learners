# çµ±åˆãƒªãƒ³ã‚¯ãƒãƒ¼ã‚¯å®Œå…¨ç§»è¡Œå®Ÿè£…è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025 å¹´ 10 æœˆ 11 æ—¥  
**å¯¾è±¡**: ãƒ¡ãƒ¢æ©Ÿèƒ½ã®ãƒªãƒ³ã‚¯å®Ÿè£…çµ±åˆ  
**ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ**: `fix/preserve-bold-in-links`

---

## ç›®æ¬¡

1. [ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼](#ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼)
2. [ç¾çŠ¶åˆ†æ](#ç¾çŠ¶åˆ†æ)
3. [å®Ÿè£…çŠ¶æ³ãƒãƒˆãƒªãƒƒã‚¯ã‚¹](#å®Ÿè£…çŠ¶æ³ãƒãƒˆãƒªãƒƒã‚¯ã‚¹)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦³](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦³)
5. [æ®µéšçš„ç§»è¡Œè¨ˆç”»](#æ®µéšçš„ç§»è¡Œè¨ˆç”»)
6. [ãƒªã‚¹ã‚¯åˆ†æã¨å¯¾ç­–](#ãƒªã‚¹ã‚¯åˆ†æã¨å¯¾ç­–)
7. [ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å„ªå…ˆé †ä½](#ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å„ªå…ˆé †ä½)
8. [å®Œäº†æ¡ä»¶](#å®Œäº†æ¡ä»¶)

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### èƒŒæ™¯

å­¦ç¿’ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒ¢æ©Ÿèƒ½ã§ã¯ã€ãƒšãƒ¼ã‚¸é–“ãƒªãƒ³ã‚¯ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã« 3 ã¤ã®å®Ÿè£…ãŒæ··åœ¨ã—ã¦ã„ã¾ã™ï¼š

1. **UnifiedLinkMark** (unilink) - æœ€æ–°ã®çµ±åˆ Mark å®Ÿè£…
2. **PageLinkMark** (pageLinkMark) - éæ¸¡æœŸã® Mark å®Ÿè£…
3. **PageLink Extension** - Legacy Decoration ãƒ™ãƒ¼ã‚¹å®Ÿè£…

ç¾åœ¨ã€UnifiedLinkMark ã¸ã®ç§»è¡ŒãŒé€²è¡Œä¸­ã§ã‚ã‚Šã€æœ€çµ‚çš„ã«ã¯å˜ä¸€å®Ÿè£…ã¸ã®çµ±åˆã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

### ç›®æ¨™

- **ä¸»ç›®æ¨™**: UnifiedLinkMark ã«å®Œå…¨çµ±åˆã—ã€ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘æ€§ã‚’å‰Šæ¸›
- **å‰¯ç›®æ¨™**: æ©Ÿèƒ½ã®ä¸€è²«æ€§å‘ä¸Šã€ä¿å®ˆæ€§ã®æ”¹å–„ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- **åˆ¶ç´„**: æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®äº’æ›æ€§ç¶­æŒã€æ®µéšçš„ç§»è¡Œã«ã‚ˆã‚‹å®‰å…¨æ€§ç¢ºä¿

### ç¾åœ¨ã®é€²æ—

- âœ… **P1**: UnifiedLinkMark åŸºæœ¬å®Ÿè£…å®Œäº†
- âœ… **P2**: éåŒæœŸè§£æ±ºã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹å®Ÿè£…å®Œäº†
- âœ… **P3**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•å†è§£æ±ºå®Ÿè£…å®Œäº†
- â³ **P4**: Legacy å®Ÿè£…ã®å‰Šé™¤ï¼ˆç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

---

## ç¾çŠ¶åˆ†æ

### 1. UnifiedLinkMark (`unilink`) - âœ… å®Œå…¨å®Ÿè£…æ¸ˆã¿

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark.ts`

#### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

| æ©Ÿèƒ½               | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  | è©³ç´°                           |
| ------------------ | ----------- | ------------------------------ |
| InputRule ([text]) | âœ… å®Ÿè£…æ¸ˆã¿ | ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¨˜æ³•ã®è‡ªå‹•å¤‰æ›       |
| å¤–éƒ¨ãƒªãƒ³ã‚¯æ¤œå‡º     | âœ… å®Ÿè£…æ¸ˆã¿ | http/https URL ã®è‡ªå‹•åˆ¤å®š      |
| éåŒæœŸãƒšãƒ¼ã‚¸è§£æ±º   | âœ… å®Ÿè£…æ¸ˆã¿ | searchPages API ã«ã‚ˆã‚‹å­˜åœ¨ç¢ºèª |
| çŠ¶æ…‹ç®¡ç†           | âœ… å®Ÿè£…æ¸ˆã¿ | pending â†’ exists/missing/error |
| ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½       | âœ… å®Ÿè£…æ¸ˆã¿ | æœ€å¤§ 2 å›ã®æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•      |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥         | âœ… å®Ÿè£…æ¸ˆã¿ | 30 ç§’ TTLã€ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹        |
| ãƒãƒƒãƒå‡¦ç†         | âœ… å®Ÿè£…æ¸ˆã¿ | 10 ä»¶ãšã¤ã®åŠ¹ç‡çš„è§£æ±º          |
| BroadcastChannel   | âœ… å®Ÿè£…æ¸ˆã¿ | ã‚¯ãƒ­ã‚¹ã‚¿ãƒ–åŒæœŸ                 |
| Realtime é€£æº      | âœ… å®Ÿè£…æ¸ˆã¿ | Supabase Realtime çµ±åˆ         |
| AutoReconciler     | âœ… å®Ÿè£…æ¸ˆã¿ | è‡ªå‹•å†è§£æ±ºã‚·ã‚¹ãƒ†ãƒ              |
| MarkIndex          | âœ… å®Ÿè£…æ¸ˆã¿ | åŠ¹ç‡çš„ãªãƒãƒ¼ã‚¯æ¤œç´¢             |
| ãƒ¡ãƒˆãƒªã‚¯ã‚¹         | âœ… å®Ÿè£…æ¸ˆã¿ | å°‚ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹å®Ÿè£…             |
| ã‚¯ãƒªãƒƒã‚¯å‡¦ç†       | âœ… å®Ÿè£…æ¸ˆã¿ | exists/missing åˆ¥ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°  |

#### æœªå®Ÿè£…æ©Ÿèƒ½

| æ©Ÿèƒ½                 | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  | å„ªå…ˆåº¦ | å‚™è€ƒ                             |
| -------------------- | ----------- | ------ | -------------------------------- |
| #ã‚¿ã‚°è¨˜æ³•            | âŒ æœªå®Ÿè£…   | P5     | ä»•æ§˜ã¯ç­–å®šæ¸ˆã¿ã€InputRule æœªå®Ÿè£… |
| ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½       | âŒ æœªå®Ÿè£…   | P4     | PageLink ã‹ã‚‰ç§»æ¤äºˆå®š            |
| ãƒšãƒ¼ã‚¸ä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚° | âš ï¸ éƒ¨åˆ†å®Ÿè£… | P4     | resolver.ts ã«åŸºæœ¬æ©Ÿèƒ½ã‚ã‚Š       |
| IndexedDB æ°¸ç¶šåŒ–     | âŒ æœªå®Ÿè£…   | P6     | ç¾åœ¨ã¯ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿       |
| å·®åˆ†åŒæœŸ             | âŒ æœªå®Ÿè£…   | P7     | Collaboration å¯¾å¿œ               |

#### ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

```
lib/unilink/
â”œâ”€â”€ index.ts                   # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé›†ç´„
â”œâ”€â”€ utils.ts                   # æ­£è¦åŒ–ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥
â”œâ”€â”€ resolver.ts                # ãƒšãƒ¼ã‚¸ä½œæˆã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ metrics.ts                 # UnifiedLinkå°‚ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹
â”œâ”€â”€ broadcast-channel.ts       # ã‚¯ãƒ­ã‚¹ã‚¿ãƒ–é€šä¿¡
â”œâ”€â”€ realtime-listener.ts       # Realtimeé€£æº
â”œâ”€â”€ auto-reconciler.ts         # è‡ªå‹•å†è§£æ±ºçµ±åˆãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ mark-index.ts              # åŠ¹ç‡çš„ãƒãƒ¼ã‚¯æ¤œç´¢
â””â”€â”€ reconcile-queue.ts         # ãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãã‚­ãƒ¥ãƒ¼
```

---

### 2. PageLinkMark (`pageLinkMark`) - âš ï¸ éæ¸¡æœŸå®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/page-link-mark.ts`

#### ç¾åœ¨ã®å½¹å‰²

- UnifiedLinkMark ç§»è¡Œå‰ã®äº’æ›æ€§ç¶­æŒ
- æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ‘ãƒ¼ã‚¹å¯¾å¿œ
- ä¸€éƒ¨ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã®äº’æ›æ€§

#### å®Ÿè£…æ©Ÿèƒ½

| æ©Ÿèƒ½               | åˆ©ç”¨çŠ¶æ³              | å‚™è€ƒ                    |
| ------------------ | --------------------- | ----------------------- |
| InputRule ([text]) | ğŸ”„ UnifiedLink ã¨é‡è¤‡ | å„ªå…ˆåº¦ 1000 ã§ä¸¡æ–¹ç™»éŒ²  |
| éåŒæœŸè§£æ±º         | ğŸ”„ UnifiedLink ã¨é‡è¤‡ | ç‹¬è‡ªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä½¿ç”¨    |
| ã‚³ãƒãƒ³ãƒ‰ç¾¤         | âš ï¸ ä¸€éƒ¨åˆ©ç”¨           | UI å±¤ã§ç›´æ¥å‚ç…§ã®å¯èƒ½æ€§ |
| ä½ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹   | âœ… ç‹¬è‡ªå®Ÿè£…           | UnifiedLink ã¯åˆ¥å®Ÿè£…    |

#### å»ƒæ­¢æ–¹é‡

- **Phase 1**: ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®æ–°è¦ä½¿ç”¨åœæ­¢ï¼ˆUnifiedLink å„ªå…ˆï¼‰
- **Phase 2**: æ—¢å­˜ãƒãƒ¼ã‚¯ã®æ®µéšçš„å¤‰æ›
- **Phase 3**: ã‚³ãƒãƒ³ãƒ‰äº’æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æä¾›
- **Phase 4**: å®Œå…¨å‰Šé™¤

---

### 3. PageLink Extension - â³ Legacy Decoration å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/page-link.ts`

#### æ§‹æˆè¦ç´ ã®çŠ¶æ…‹

| ãƒ—ãƒ©ã‚°ã‚¤ãƒ³       | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  | è©³ç´°                           |
| ---------------- | ----------- | ------------------------------ |
| bracketPlugin    | ğŸ”„ æ®‹å­˜     | è‡ªå‹•ãƒ–ãƒ©ã‚±ãƒƒãƒˆé–‰ã˜æ©Ÿèƒ½         |
| suggestionPlugin | ğŸ”„ æ®‹å­˜     | ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI è¡¨ç¤ºï¼ˆtippy.jsï¼‰ |
| existencePlugin  | âœ… å‰Šé™¤å®Œäº† | Mark ç‰ˆã«çµ±åˆæ¸ˆã¿              |
| previewPlugin    | âœ… å‰Šé™¤å®Œäº† | Mark ç‰ˆã«ç§»è¡Œæ¸ˆã¿              |
| Decoration ç”Ÿæˆ  | ğŸ”„ æ®‹å­˜     | Mark å„ªå…ˆã€æœªãƒãƒ¼ã‚¯é ˜åŸŸã®ã¿    |

#### å‰Šé™¤è¨ˆç”»ï¼ˆpage-link-legacy-removal-plan.mdï¼‰

```
Phase A: æ©Ÿèƒ½åŒç­‰æ€§ç¢ºä¿ âœ… å®Œäº†
Phase B: Legacyä¾å­˜ç¸®å° â³ é€²è¡Œä¸­
  â”œâ”€â”€ âœ… existencePluginå‰Šé™¤å®Œäº†
  â”œâ”€â”€ âœ… previewPluginå‰Šé™¤å®Œäº†
  â””â”€â”€ â³ bracketPluginå‰Šé™¤äºˆå®š
Phase C: å®‰å…¨ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° â³ æº–å‚™ä¸­
Phase D: ã‚³ãƒ¼ãƒ‰é™¤å» â³ æœªç€æ‰‹
```

#### æ®‹å­˜ç†ç”±

1. **suggestionPlugin**: å…¥åŠ›è£œå®Œ UI ãŒ UnifiedLink ã«æœªå®Ÿè£…
2. **bracketPlugin**: è‡ªå‹•ãƒ–ãƒ©ã‚±ãƒƒãƒˆé–‰ã˜æ©Ÿèƒ½ã®ç§»è¡Œå…ˆæœªæ±ºå®š
3. **noteSlug çµ±åˆ**: ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¨ã®é€£æºãƒ­ã‚¸ãƒƒã‚¯
4. **äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼**: æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ®µéšçš„ç§»è¡Œ

---

## å®Ÿè£…çŠ¶æ³ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

### æ©Ÿèƒ½åˆ¥å®Ÿè£…çŠ¶æ³

| æ©Ÿèƒ½ã‚«ãƒ†ã‚´ãƒª           | UnifiedLink | PageLinkMark | PageLink   | çµ±åˆçŠ¶æ³        |
| ---------------------- | ----------- | ------------ | ---------- | --------------- |
| **å…¥åŠ›å¤‰æ›**           |
| [text] InputRule       | âœ… å®Ÿè£…     | ğŸ”„ é‡è¤‡      | ğŸ”„ é‡è¤‡    | âš ï¸ å„ªå…ˆåº¦ã§è§£æ±º |
| è‡ªå‹•ãƒ–ãƒ©ã‚±ãƒƒãƒˆé–‰ã˜     | âŒ          | âŒ           | âœ… bracket | â³ ç§»è¡Œå¿…è¦     |
| å¤–éƒ¨ãƒªãƒ³ã‚¯åˆ¤å®š         | âœ… å®Ÿè£…     | âœ… å®Ÿè£…      | âœ… å®Ÿè£…    | âœ… çµ±åˆå¯èƒ½     |
| **ãƒšãƒ¼ã‚¸è§£æ±º**         |
| éåŒæœŸæ¤œç´¢             | âœ… å®Ÿè£…     | ğŸ”„ é‡è¤‡      | ğŸ”„ é‡è¤‡    | âš ï¸ çµ±åˆå¿…è¦     |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥             | âœ… 30s TTL  | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| ãƒªãƒˆãƒ©ã‚¤               | âœ… æŒ‡æ•° BO  | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| ãƒãƒƒãƒå‡¦ç†             | âœ… 10 ä»¶    | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| **çŠ¶æ…‹ç®¡ç†**           |
| pending/exists/missing | âœ… å®Œå…¨     | âœ… ç°¡æ˜“      | âŒ         | âš ï¸ çµ±åˆå¿…è¦     |
| error çŠ¶æ…‹             | âœ… å®Ÿè£…     | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| created å±æ€§           | âœ… å®Ÿè£…     | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| **UI æ©Ÿèƒ½**            |
| ã‚µã‚¸ã‚§ã‚¹ãƒˆ             | âŒ          | âŒ           | âœ… tippy   | â³ ç§»è¡Œå¿…è¦     |
| ãƒšãƒ¼ã‚¸ä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°   | âš ï¸ éƒ¨åˆ†     | âš ï¸ éƒ¨åˆ†      | âœ… å®Œå…¨    | â³ ç§»è¡Œå¿…è¦     |
| ãƒ›ãƒãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼       | âœ… Mark ç‰ˆ  | âœ… Mark ç‰ˆ   | âœ… å‰Šé™¤æ¸ˆ  | âœ… çµ±åˆæ¸ˆã¿     |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **       |
| BroadcastChannel       | âœ… å®Ÿè£…     | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| Realtime é€£æº          | âœ… å®Ÿè£…     | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| AutoReconciler         | âœ… å®Ÿè£…     | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**         |
| åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹         | âœ… äº’æ›     | âœ… äº’æ›      | âŒ         | âœ… ä¸¡æ–¹å¯¾å¿œ     |
| è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹         | âœ… å°‚ç”¨     | âŒ           | âŒ         | âœ… Unified ã®ã¿ |
| **ãã®ä»–**             |
| noteSlug çµ±åˆ          | âŒ          | âŒ           | âœ… å®Ÿè£…    | â³ ç§»è¡Œå¿…è¦     |
| .icon è¨˜æ³•             | âŒ          | âŒ           | âœ… å®Ÿè£…    | â³ åˆ¤æ–­å¿…è¦     |

### ä¾å­˜é–¢ä¿‚ãƒãƒƒãƒ—

```
TipTapEditor (components/tiptap-editor.tsx)
  â”‚
  â”œâ”€â†’ UnifiedLinkMark (å„ªå…ˆåº¦1000)
  â”‚     â”œâ”€â†’ lib/unilink/* (å…¨ã‚µãƒãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«)
  â”‚     â”œâ”€â†’ searchPages API
  â”‚     â””â”€â†’ page-link-preview-mark-plugin
  â”‚
  â”œâ”€â†’ PageLinkMark (å„ªå…ˆåº¦1000)
  â”‚     â”œâ”€â†’ searchPages API
  â”‚     â””â”€â†’ åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  â”‚
  â””â”€â†’ PageLink Extension (configure: { noteSlug })
        â”œâ”€â†’ bracketPlugin
        â”œâ”€â†’ suggestionPlugin (tippy.js)
        â”œâ”€â†’ PageLinkMark (InputRuleå§”è­²)
        â””â”€â†’ page-link-preview-mark-plugin
```

### å‰Šé™¤äºˆå®šã‚³ãƒ¼ãƒ‰ã®å½±éŸ¿ç¯„å›²

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ    | å‰Šé™¤äºˆå®š | ä»£æ›¿å®Ÿè£…        | å½±éŸ¿ç¯„å›²            |
| ----------------- | -------- | --------------- | ------------------- |
| PageLinkMark å…¨ä½“ | Phase 4  | UnifiedLink     | ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®šã€UI å±¤ |
| suggestionPlugin  | Phase 3  | Unified å®Ÿè£…    | å…¥åŠ›è£œå®Œ UI         |
| bracketPlugin     | Phase 3  | InputRule æ‹¡å¼µ  | è‡ªå‹•é–‰ã˜æ©Ÿèƒ½        |
| Decoration ç”Ÿæˆ   | Phase 3  | ãªã—            | Legacy äº’æ›æ€§       |
| noteSlug çµ±åˆ     | Phase 2  | Unified å®Ÿè£…    | ãƒãƒ¼ãƒˆæ©Ÿèƒ½          |
| .icon è¨˜æ³•        | è¦æ¤œè¨   | å°‚ç”¨ Extension? | ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º        |

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦³

### ç›®æ¨™ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆPhase 4 å®Œäº†å¾Œï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TipTap Editor                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    UnifiedLinkMark (unilink)               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ InputRules:                                â”‚   â”‚
â”‚  â”‚  - [text]  â†’ bracket variant               â”‚   â”‚
â”‚  â”‚  - #tag    â†’ tag variant (Phase 5)         â”‚   â”‚
â”‚  â”‚  - auto-close brackets                     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ State Machine:                             â”‚   â”‚
â”‚  â”‚  pending â†’ exists / missing / error        â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Commands:                                  â”‚   â”‚
â”‚  â”‚  - insertUnifiedLink                       â”‚   â”‚
â”‚  â”‚  - refreshUnifiedLinks                     â”‚   â”‚
â”‚  â”‚  - createPageFromMissingLink               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Suggestion Plugin (Phase 3å®Ÿè£…)         â”‚   â”‚
â”‚  â”‚  - Floating UI ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼          â”‚   â”‚
â”‚  â”‚  - æ¤œç´¢çµæœãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Resolver Queue (éåŒæœŸãƒãƒƒãƒå‡¦ç†)       â”‚   â”‚
â”‚  â”‚  - 10ä»¶ãƒãƒƒãƒã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Cache Layer (30s TTL)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    searchPages API (Supabase)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Mark State Update                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    AutoReconciler (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•æ›´æ–°)    â”‚   â”‚
â”‚  â”‚  - BroadcastChannel (ã‚¯ãƒ­ã‚¹ã‚¿ãƒ–)           â”‚   â”‚
â”‚  â”‚  - Realtime Listener (Supabase)            â”‚   â”‚
â”‚  â”‚  - Visibility/Onlineå¾©å¸°                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨çµ±åˆå¾Œï¼‰

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: [Page Title]
   â†“
2. InputRuleæ¤œå‡º (UnifiedLinkMark)
   â†“
3. Markç”Ÿæˆ (state: "pending")
   - markId: ä¸€æ„è­˜åˆ¥å­ç”Ÿæˆ
   - key: normalizeTitleToKey()
   - variant: "bracket"
   â†“
4. Resolver Queueè¿½åŠ 
   â†“
5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ (30s TTL)
   - Hit â†’ state: "exists" (å³åº§ã«æ›´æ–°)
   - Miss â†’ æ¬¡ã¸
   â†“
6. searchPages(key) ãƒãƒƒãƒå®Ÿè¡Œ
   â†“
7. çµæœåˆ¤å®š
   - å®Œå…¨ä¸€è‡´ â†’ state: "exists", pageIdè¨­å®š
   - ä¸ä¸€è‡´   â†’ state: "missing"
   - ã‚¨ãƒ©ãƒ¼   â†’ state: "error"
   â†“
8. Mark Stateæ›´æ–°
   â†“
9. ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
   â†“
10. BroadcastChannelé€šçŸ¥ (ä»–ã‚¿ãƒ–åŒæœŸ)
```

---

## æ®µéšçš„ç§»è¡Œè¨ˆç”»

### Phase 1: äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºç«‹ âœ… å®Œäº†

**ç›®æ¨™**: UnifiedLinkMark ã¨ PageLinkMark ã®å…±å­˜ç’°å¢ƒæ§‹ç¯‰

#### å®Œäº†ã‚¿ã‚¹ã‚¯

- [x] UnifiedLinkMark åŸºæœ¬å®Ÿè£…ï¼ˆP1ï¼‰
- [x] éåŒæœŸè§£æ±ºã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆP2ï¼‰
- [x] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•å†è§£æ±ºï¼ˆP3ï¼‰
- [x] priority: 1000 è¨­å®šï¼ˆMark é †åºåˆ¶å¾¡ï¼‰
- [x] ä¸¡ Mark ã®åŒæ™‚ç™»éŒ²

#### æ¤œè¨¼çµæœ

- âœ… ä¸¡ Mark å…±å­˜æ™‚ã®å‹•ä½œç¢ºèª
- âœ… priority è¨­å®šã«ã‚ˆã‚‹é †åºåˆ¶å¾¡
- âœ… bold/italic ã¨ã®çµ„ã¿åˆã‚ã›

---

### Phase 2: æ©Ÿèƒ½ç§»æ¤ï¼ˆç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

**ç›®æ¨™**: PageLink Extension ã‹ã‚‰ UnifiedLinkMark ã¸ã®æ©Ÿèƒ½ç§»æ¤

#### ã‚¿ã‚¹ã‚¯ä¸€è¦§

##### 2.1 ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ã®ç§»æ¤ â³ å„ªå…ˆåº¦: é«˜

**ç¾çŠ¶**: PageLink ã® suggestionPlugin ãŒ tippy.js ä¾å­˜

**å®Ÿè£…è¨ˆç”»**:

```typescript
// lib/tiptap-extensions/unified-link-suggestion.ts (æ–°è¦)

import { Plugin, PluginKey } from "prosemirror-state";
import Tippy from "tippy.js";
import { searchPages } from "@/lib/utils/searchPages";

interface SuggestionState {
  active: boolean;
  range: { from: number; to: number } | null;
  query: string;
  results: Array<{ id: string; title: string }>;
  selectedIndex: number;
}

export const unifiedLinkSuggestionPlugin = new Plugin<SuggestionState>({
  key: new PluginKey("unifiedLinkSuggestion"),

  state: {
    init: () => ({
      active: false,
      range: null,
      query: "",
      results: [],
      selectedIndex: 0,
    }),

    apply: (tr, prev) => {
      // 1. ãƒ–ãƒ©ã‚±ãƒƒãƒˆæ¤œå‡º
      // 2. debounceæ¤œç´¢
      // 3. çµæœæ›´æ–°
    },
  },

  view: (editorView) => {
    // Tippy.js UIã®åˆ¶å¾¡
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    // é¸æŠæ™‚ã®MarkæŒ¿å…¥
  },
});
```

**ç§»è¡Œã‚¹ãƒ†ãƒƒãƒ—**:

1. æ–°ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè£…
2. UnifiedLinkMark ã¸ã®çµ±åˆ
3. PageLink suggestionPlugin ã¨ã®ä¸¦è¡Œç¨¼åƒ
4. æ©Ÿèƒ½æ¤œè¨¼å®Œäº†å¾Œã€PageLink ç‰ˆå‰Šé™¤

**å·¥æ•°è¦‹ç©**: 2-3 æ—¥

---

##### 2.2 è‡ªå‹•ãƒ–ãƒ©ã‚±ãƒƒãƒˆé–‰ã˜æ©Ÿèƒ½ã®ç§»æ¤ â³ å„ªå…ˆåº¦: ä¸­

**ç¾çŠ¶**: PageLink ã® bracketPlugin ãŒå®Ÿè£…

**å®Ÿè£…è¨ˆç”»**:

```typescript
// UnifiedLinkMarkå†…ã«çµ±åˆ

addInputRules() {
  return [
    // æ—¢å­˜ã® [text] å¤‰æ›ãƒ«ãƒ¼ãƒ«
    bracketRule,

    // æ–°è¦: è‡ªå‹•é–‰ã˜ãƒ«ãƒ¼ãƒ«
    new InputRule({
      find: /\[$/,
      handler: ({ state, range, match }) => {
        const $pos = state.selection.$from;
        const paraEnd = $pos.end($pos.depth);
        const after = state.doc.textBetween(range.to, paraEnd);

        if (/^\s*$/.test(after)) {
          // æœ«å°¾ãªã‚‰è‡ªå‹•é–‰ã˜
          const tr = state.tr.insertText("[]", range.from, range.to);
          tr.setSelection(TextSelection.create(tr.doc, range.from + 1));
          return tr;
        }
      },
    }),
  ];
}
```

**å·¥æ•°è¦‹ç©**: 0.5 æ—¥

---

##### 2.3 ãƒšãƒ¼ã‚¸ä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å®Œå…¨å®Ÿè£… â³ å„ªå…ˆåº¦: é«˜

**ç¾çŠ¶**: resolver.ts ã«åŸºæœ¬æ©Ÿèƒ½ã‚ã‚Šã€UI ãŒä¸å®Œå…¨

**å®Ÿè£…è¨ˆç”»**:

```typescript
// components/create-page-dialog.tsx (æ–°è¦ã¾ãŸã¯æ‹¡å¼µ)

interface CreatePageDialogProps {
  title: string;
  onCreated: (pageId: string) => void;
  onCancel: () => void;
}

export function CreatePageDialog({
  title,
  onCreated,
  onCancel,
}: CreatePageDialogProps) {
  // 1. ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†UI
  // 2. åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„é¸æŠ
  // 3. å…¬é–‹/éå…¬é–‹è¨­å®š
  // 4. ãƒãƒ¼ãƒˆã¸ã®é–¢é€£ä»˜ã‘ï¼ˆnoteSlugçµ±åˆï¼‰
  // 5. ä½œæˆå®Ÿè¡Œ
}
```

**çµ±åˆå…ˆ**: `lib/unilink/resolver.ts`ã®`handleMissingLinkClick`

**å·¥æ•°è¦‹ç©**: 1-2 æ—¥

---

##### 2.4 noteSlug æ©Ÿèƒ½ã®çµ±åˆ â³ å„ªå…ˆåº¦: ä¸­

**ç¾çŠ¶**: PageLink Extension ã® configure ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ noteSlug ã‚’å—ã‘å–ã‚Š

**å®Ÿè£…è¨ˆç”»**:

```typescript
// UnifiedLinkMarkã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ‹¡å¼µ

export interface UnifiedLinkMarkOptions {
  HTMLAttributes: Record<string, any>;
  autoReconciler?: AutoReconciler | null;
  noteSlug?: string | null; // æ–°è¦è¿½åŠ 
}

// resolver.tsã§noteSlugè€ƒæ…®

export async function createPageFromMark(
  editor: Editor,
  markId: string,
  title: string,
  userId?: string,
  noteSlug?: string // æ–°è¦è¿½åŠ 
): Promise<string | null> {
  // ãƒšãƒ¼ã‚¸ä½œæˆæ™‚ã«noteSlugãŒã‚ã‚Œã°note_pagesãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ä»˜ã‘
}
```

**å·¥æ•°è¦‹ç©**: 1 æ—¥

---

##### 2.5 .icon è¨˜æ³•ã®ã‚µãƒãƒ¼ãƒˆåˆ¤æ–­ â³ å„ªå…ˆåº¦: ä½

**ç¾çŠ¶**: PageLink ãŒ`[title.icon]`ã‚’ã‚µãƒãƒ¼ãƒˆ

**é¸æŠè‚¢**:

1. **UnifiedLinkMark ã«çµ±åˆ**: `variant: "icon"`ã‚’è¿½åŠ 
2. **å°‚ç”¨ Extension åŒ–**: åˆ¥ extension ã¨ã—ã¦åˆ†é›¢
3. **å»ƒæ­¢**: ä½¿ç”¨é »åº¦ãŒä½ã‘ã‚Œã°å‰Šé™¤

**æ¨å¥¨**: ä½¿ç”¨é »åº¦èª¿æŸ»å¾Œã«åˆ¤æ–­

**å·¥æ•°è¦‹ç©**: èª¿æŸ» 0.5 æ—¥ + å®Ÿè£… 1-2 æ—¥ï¼ˆçµ±åˆã®å ´åˆï¼‰

---

### Phase 3: PageLinkMark å»ƒæ­¢æº–å‚™

**ç›®æ¨™**: PageLinkMark ã¸ã®æ–°è¦ä¾å­˜ã‚’åœæ­¢

#### ã‚¿ã‚¹ã‚¯ä¸€è¦§

##### 3.1 ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®šã®æ›´æ–° â³

```typescript
// components/tiptap-editor.tsx

extensions: [
  // PageLinkMarkã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
  // PageLinkMark,

  UnifiedLinkMark.configure({
    noteSlug, // Phase 2.4ã§è¿½åŠ 
  }),

  // PageLink Extensionã¯Phase 4ã¾ã§æ®‹ã™
  PageLink.configure({
    noteSlug,
  }),
];
```

**å·¥æ•°è¦‹ç©**: 0.5 æ—¥

---

##### 3.2 UI å±¤ã®æ›´æ–° â³

æ—¢å­˜ã® PageLinkMark ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’èª¿æŸ»ãƒ»æ›´æ–°

```bash
# èª¿æŸ»ã‚³ãƒãƒ³ãƒ‰
grep -r "setPageLink\|togglePageLink\|refreshPageLinkMarks" components/
```

**å·¥æ•°è¦‹ç©**: èª¿æŸ» 0.5 æ—¥ + ä¿®æ­£ 1 æ—¥

---

##### 3.3 æ—¢å­˜ãƒãƒ¼ã‚¯ã®å¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â³

```typescript
// scripts/migrate-page-link-marks.ts (æ–°è¦)

import { createClient } from "@/lib/supabase/client";

async function migratePageLinkMarks() {
  // 1. å…¨ãƒšãƒ¼ã‚¸ã®content_tiptapã‚’å–å¾—
  // 2. pageLinkMarkã‚’unilinkã«å¤‰æ›
  // 3. æ›´æ–°
}
```

**å·¥æ•°è¦‹ç©**: 1 æ—¥ï¼ˆå®Ÿè£…ï¼‰ + ãƒ†ã‚¹ãƒˆæœŸé–“

---

### Phase 4: Legacy Extension å‰Šé™¤

**ç›®æ¨™**: PageLink Extension ã®å®Œå…¨å‰Šé™¤

#### å‰Šé™¤å¯èƒ½æ¡ä»¶

- [ ] Phase 2 ã®å…¨æ©Ÿèƒ½ç§»æ¤å®Œäº†
- [ ] Phase 3 ã®æ—¢å­˜ãƒãƒ¼ã‚¯å¤‰æ›å®Œäº†
- [ ] æœ¬ç•ªç’°å¢ƒã§ 1 é€±é–“ã®å®‰å®šç¨¼åƒ
- [ ] ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ missing æ¯”ç‡ < 5%

#### ã‚¿ã‚¹ã‚¯ä¸€è¦§

##### 4.1 suggestionPlugin å‰Šé™¤ â³

- UnifiedLink ç‰ˆå®Ÿè£…å®Œäº†å¾Œ
- ä¸¦è¡Œç¨¼åƒæœŸé–“: 2 é€±é–“
- å‰Šé™¤å‰ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª

##### 4.2 bracketPlugin å‰Šé™¤ â³

- UnifiedLinkMark ã¸ã®çµ±åˆå®Œäº†å¾Œ
- è‡ªå‹•é–‰ã˜æ©Ÿèƒ½ã®å‹•ä½œæ¤œè¨¼

##### 4.3 Decoration ç”Ÿæˆã‚³ãƒ¼ãƒ‰å‰Šé™¤ â³

- Mark å¤‰æ›å®Œäº†å¾Œ
- Legacy äº’æ›æ€§ãŒä¸è¦ã«ãªã£ãŸæ™‚ç‚¹

##### 4.4 PageLink Extension å®Œå…¨å‰Šé™¤ â³

- ä¸Šè¨˜ã™ã¹ã¦å®Œäº†å¾Œ
- ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã®ç™»éŒ²å‰Šé™¤
- ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

**å·¥æ•°è¦‹ç©**: 1 æ—¥

---

### Phase 5: æ‹¡å¼µæ©Ÿèƒ½å®Ÿè£…ï¼ˆå°†æ¥ï¼‰

**ç›®æ¨™**: æ–°æ©Ÿèƒ½ã®è¿½åŠ 

#### 5.1 #ã‚¿ã‚°è¨˜æ³•ã®ã‚µãƒãƒ¼ãƒˆ

- `#ã‚¿ã‚°` InputRule ã®å®Ÿè£…
- `variant: "tag"`ã®å®Œå…¨ã‚µãƒãƒ¼ãƒˆ

#### 5.2 IndexedDB æ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥

- ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’IndexedDB ã¸ã®æ‹¡å¼µ
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œå¼·åŒ–

#### 5.3 Collaboration å¯¾å¿œ

- Yjs çµ±åˆ
- å·®åˆ†åŒæœŸå®Ÿè£…

---

## ãƒªã‚¹ã‚¯åˆ†æã¨å¯¾ç­–

### é«˜ãƒªã‚¹ã‚¯é …ç›®

#### R1: æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®äº’æ›æ€§å–ªå¤±

**ãƒªã‚¹ã‚¯**: PageLinkMark å‰Šé™¤æ™‚ã«ãƒ‘ãƒ¼ã‚¹ä¸å¯

**å¯¾ç­–**:

- æ®µéšçš„å¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- å¤‰æ›å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

**æ¤œè¨¼æ–¹æ³•**:

```typescript
// ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
const oldContent = {
  type: "doc",
  content: [
    {
      type: "paragraph",
      content: [
        {
          type: "text",
          text: "Link",
          marks: [
            {
              type: "pageLinkMark",
              attrs: {
                /* ... */
              },
            },
          ],
        },
      ],
    },
  ],
};

// å¤‰æ›å¾Œã‚‚ãƒ‘ãƒ¼ã‚¹å¯èƒ½ã‹æ¤œè¨¼
expect(editor.setContent(oldContent)).not.toThrow();
```

---

#### R2: ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ã®æ€§èƒ½åŠ£åŒ–

**ãƒªã‚¹ã‚¯**: æ–°å®Ÿè£…ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹é…å»¶ã‚’èµ·ã“ã™

**å¯¾ç­–**:

- debounce æ™‚é–“ã®èª¿æ•´ï¼ˆ300ms æ¨å¥¨ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨
- ãƒãƒƒãƒæ¤œç´¢ã®å®Ÿè£…

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹**:

- ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºæ™‚é–“ < 500ms
- ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é…å»¶ < 50ms

---

#### R3: Mark å„ªå…ˆé †ä½ã®ç«¶åˆ

**ãƒªã‚¹ã‚¯**: bold/italic ç­‰ã¨ã®çµ„ã¿åˆã‚ã›ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸å…·åˆ

**ç¾çŠ¶**: priority: 1000 ã§è§£æ±ºæ¸ˆã¿

**ç¶™ç¶šç›£è¦–**: æ–° Extension è¿½åŠ æ™‚ã«å†è©•ä¾¡

---

### ä¸­ãƒªã‚¹ã‚¯é …ç›®

#### R4: noteSlug çµ±åˆã®ä¸å®Œå…¨å®Ÿè£…

**ãƒªã‚¹ã‚¯**: ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¨ã®é€£æºä¸å…·åˆ

**å¯¾ç­–**:

- æ—¢å­˜ã® PageLink å®Ÿè£…ã‚’å‚è€ƒã«æ…é‡ã«ç§»æ¤
- ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ

---

#### R5: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ¬ è½

**ãƒªã‚¹ã‚¯**: ç§»è¡Œå¾Œã®å•é¡Œæ¤œå‡ºãŒé…ã‚Œã‚‹

**å¯¾ç­–**:

- ä¸¡å®Ÿè£…ã§å…±é€šãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¶™ç¶š
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®ç¶™ç¶šç›£è¦–

---

## ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å„ªå…ˆé †ä½

### æ¨å¥¨å®Ÿè£…é †åº

```
Week 1-2: Phase 2.1 ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ç§»æ¤
  â”œâ”€ å®Ÿè£…: 5æ—¥
  â”œâ”€ ãƒ†ã‚¹ãƒˆ: 2æ—¥
  â””â”€ ä¸¦è¡Œç¨¼åƒé–‹å§‹

Week 3: Phase 2.2, 2.3, 2.4 ä¸¦è¡Œå®Ÿè£…
  â”œâ”€ è‡ªå‹•é–‰ã˜: 0.5æ—¥
  â”œâ”€ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°: 2æ—¥
  â””â”€ noteSlug: 1æ—¥

Week 4: Phase 2.5èª¿æŸ» + Phase 3.1-3.2
  â”œâ”€ .iconèª¿æŸ»: 0.5æ—¥
  â”œâ”€ ã‚¨ãƒ‡ã‚£ã‚¿æ›´æ–°: 0.5æ—¥
  â””â”€ UIå±¤æ›´æ–°: 1.5æ—¥

Week 5: Phase 3.3 ãƒãƒ¼ã‚¯å¤‰æ›
  â”œâ”€ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…: 1æ—¥
  â”œâ”€ ãƒ†ã‚¹ãƒˆ: 2æ—¥
  â””â”€ æ®µéšçš„å®Ÿè¡Œ

Week 6-7: Phase 4æº–å‚™æœŸé–“
  â”œâ”€ æœ¬ç•ªç›£è¦–: 1é€±é–“
  â”œâ”€ ãƒ¡ãƒˆãƒªã‚¯ã‚¹è©•ä¾¡
  â””â”€ å‰Šé™¤åˆ¤æ–­

Week 8: Phase 4 å‰Šé™¤å®Ÿè¡Œ
  â”œâ”€ Pluginå‰Šé™¤: 0.5æ—¥
  â”œâ”€ Extensionå‰Šé™¤: 0.5æ—¥
  â”œâ”€ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°: 1æ—¥
  â””â”€ ãƒªãƒªãƒ¼ã‚¹
```

### ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

| ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³         | å®Œäº†æ¡ä»¶                             | ç›®æ¨™æ—¥        |
| ---------------------- | ------------------------------------ | ------------- |
| M1: ã‚µã‚¸ã‚§ã‚¹ãƒˆç§»æ¤å®Œäº† | æ–° UI ãŒå‹•ä½œã€ä¸¦è¡Œç¨¼åƒé–‹å§‹           | Week 2 çµ‚äº†æ™‚ |
| M2: å…¨æ©Ÿèƒ½ç§»æ¤å®Œäº†     | Phase 2 å®Œäº†ã€UnifiedLink ãŒæ©Ÿèƒ½å®Œå…¨ | Week 4 çµ‚äº†æ™‚ |
| M3: PageLinkMark å»ƒæ­¢  | Phase 3 å®Œäº†ã€æ–°è¦ä¾å­˜ãªã—           | Week 5 çµ‚äº†æ™‚ |
| M4: Legacy å‰Šé™¤å®Œäº†    | Phase 4 å®Œäº†ã€å˜ä¸€å®Ÿè£…åŒ–             | Week 8 çµ‚äº†æ™‚ |

---

## å®Œäº†æ¡ä»¶ï¼ˆDefinition of Doneï¼‰

### æŠ€è¡“çš„è¦ä»¶

- [ ] UnifiedLinkMark ãŒå…¨æ©Ÿèƒ½ã‚’å®Ÿè£…
- [ ] PageLinkMark ã¸ã®æ–°è¦ä¾å­˜ã‚¼ãƒ­
- [ ] PageLink Extension å®Œå…¨å‰Šé™¤
- [ ] ã‚¨ãƒ‡ã‚£ã‚¿ãŒ UnifiedLinkMark ã®ã¿ç™»éŒ²
- [ ] æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ­£å¸¸ã«ãƒ‘ãƒ¼ã‚¹
- [ ] TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­
- [ ] ESLint ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­

### æ©Ÿèƒ½çš„è¦ä»¶

- [ ] [text]å½¢å¼ã®å…¥åŠ›å¤‰æ›ãŒå‹•ä½œ
- [ ] å¤–éƒ¨ãƒªãƒ³ã‚¯ã®è‡ªå‹•åˆ¤å®šãŒå‹•ä½œ
- [ ] ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ãŒè¡¨ç¤ºã•ã‚Œé¸æŠå¯èƒ½
- [ ] ãƒšãƒ¼ã‚¸ä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‹•ä½œ
- [ ] missingâ†’exists ã®è‡ªå‹•æ›´æ–°ãŒå‹•ä½œ
- [ ] ã‚¯ãƒ­ã‚¹ã‚¿ãƒ–åŒæœŸãŒå‹•ä½œ
- [ ] ãƒ›ãƒãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤º

### å“è³ªè¦ä»¶

- [ ] ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º < 500ms
- [ ] ãƒšãƒ¼ã‚¸è§£æ±º < 2 ç§’ï¼ˆ90 ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ï¼‰
- [ ] missing æ¯”ç‡ < 5%
- [ ] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ < 1%
- [ ] ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚¼ãƒ­

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦ä»¶

- [ ] å®Ÿè£…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
- [ ] API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ä½œæˆ
- [ ] CHANGELOG æ›´æ–°
- [ ] ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆå……å®Ÿ

### ãƒ†ã‚¹ãƒˆè¦ä»¶

- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: ã‚«ãƒãƒ¬ãƒƒã‚¸ > 80%
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ: ä¸»è¦ãƒ•ãƒ­ãƒ¼å…¨ã‚«ãƒãƒ¼
- [ ] E2E ãƒ†ã‚¹ãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ªæ¤œè¨¼
- [ ] æ€§èƒ½ãƒ†ã‚¹ãƒˆ: ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯é”æˆ
- [ ] äº’æ›æ€§ãƒ†ã‚¹ãƒˆ: æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œè¨¼

---

## ä»˜éŒ²

### A. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [çµ±åˆãƒªãƒ³ã‚¯ãƒãƒ¼ã‚¯ä»•æ§˜æ›¸](../03_design/specifications/unified-link-mark-spec.md)
- [Legacy å‰Šé™¤è¨ˆç”»](../03_design/features/page-link-legacy-removal-plan.md)
- [P3 å®Ÿè£…ã‚µãƒãƒªãƒ¼](./unified-link-mark-p3-summary.md)
- [ãƒªãƒ³ã‚¯å®Ÿè£…èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ](../../07_research/2025_10/20251010/link-implementation-investigation.md)

### B. ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ

```
å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:
â”œâ”€â”€ lib/tiptap-extensions/
â”‚   â”œâ”€â”€ unified-link-mark.ts          # ãƒ¡ã‚¤ãƒ³å®Ÿè£…
â”‚   â”œâ”€â”€ page-link-mark.ts             # å»ƒæ­¢äºˆå®š
â”‚   â”œâ”€â”€ page-link.ts                  # å»ƒæ­¢äºˆå®š
â”‚   â””â”€â”€ page-link-preview-mark-plugin.ts
â”œâ”€â”€ lib/unilink/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ utils.ts
â”‚   â”œâ”€â”€ resolver.ts
â”‚   â”œâ”€â”€ metrics.ts
â”‚   â”œâ”€â”€ broadcast-channel.ts
â”‚   â”œâ”€â”€ realtime-listener.ts
â”‚   â”œâ”€â”€ auto-reconciler.ts
â”‚   â”œâ”€â”€ mark-index.ts
â”‚   â””â”€â”€ reconcile-queue.ts
â””â”€â”€ components/
    â””â”€â”€ tiptap-editor.tsx

ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä½œæˆäºˆå®šï¼‰:
â”œâ”€â”€ __tests__/
â”‚   â”œâ”€â”€ unified-link-mark.test.ts
â”‚   â”œâ”€â”€ unilink-resolver.test.ts
â”‚   â””â”€â”€ unilink-integration.test.ts

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:
â””â”€â”€ scripts/
    â””â”€â”€ migrate-page-link-marks.ts
```

### C. ãƒ¡ãƒˆãƒªã‚¯ã‚¹å®šç¾©

```typescript
// åé›†ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹

interface LinkMetrics {
  // è§£æ±ºãƒ¡ãƒˆãƒªã‚¯ã‚¹
  resolutionTime: number; // è§£æ±ºæ™‚é–“ï¼ˆmsï¼‰
  cacheHitRate: number; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ï¼ˆ%ï¼‰
  missingRate: number; // missingæ¯”ç‡ï¼ˆ%ï¼‰
  errorRate: number; // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ï¼ˆ%ï¼‰

  // ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹
  suggestionLatency: number; // ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºæ™‚é–“ï¼ˆmsï¼‰
  suggestionAcceptRate: number; // å—ã‘å…¥ã‚Œç‡ï¼ˆ%ï¼‰

  // ãƒšãƒ¼ã‚¸ä½œæˆãƒ¡ãƒˆãƒªã‚¯ã‚¹
  pageCreationRate: number; // missingã‹ã‚‰ã®ä½œæˆç‡ï¼ˆ%ï¼‰
  creationSuccessRate: number; // ä½œæˆæˆåŠŸç‡ï¼ˆ%ï¼‰

  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  markUpdateLatency: number; // ãƒãƒ¼ã‚¯æ›´æ–°æ™‚é–“ï¼ˆmsï¼‰
  editorLagTime: number; // ã‚¨ãƒ‡ã‚£ã‚¿é…å»¶æ™‚é–“ï¼ˆmsï¼‰
}
```

---

## æ”¹è¨‚å±¥æ­´

| ç‰ˆ  | æ—¥ä»˜       | å¤‰æ›´å†…å®¹ | ä½œæˆè€…       |
| --- | ---------- | -------- | ------------ |
| 1.0 | 2025-10-11 | åˆç‰ˆä½œæˆ | AI Assistant |

---

## æ‰¿èª

| å½¹å‰²               | æ°å | æ‰¿èªæ—¥ | ç½²å |
| ------------------ | ---- | ------ | ---- |
| æŠ€è¡“ãƒªãƒ¼ãƒ‰         | -    | -      | -    |
| ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ | -    | -      | -    |
| QA ãƒªãƒ¼ãƒ‰          | -    | -      | -    |

---

**END OF DOCUMENT**
