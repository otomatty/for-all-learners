# Phase 3.3 å®Ÿè£…è¨ˆç”»æ›¸: useLinkExistenceChecker å®Œå…¨å‰Šé™¤ + ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

**ä½œæˆæ—¥**: 2025-10-12  
**æœ€çµ‚æ›´æ–°**: 2025-10-12  
**Phase**: 3.3 - existencePluginKey ä»£æ›¿å®Ÿè£…ã¨ useLinkExistenceChecker å‰Šé™¤  
**ç›®çš„**: useLinkExistenceChecker ã®å®Œå…¨å‰Šé™¤ã¨ UnifiedLinkMark è‡ªå‹•è§£æ±ºæ©Ÿèƒ½ã¸ã®çµ±åˆ + æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•å¤‰æ›  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨ˆç”»æ›´æ–°å®Œäº† - ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¦ä»¶è¿½åŠ  âœ…

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

Phase 3.1-3.2 ã§ UnifiedLinkMark ã¸ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚Phase 3.3 ã§ã¯ã€**é‡è¤‡ã—ãŸå­˜åœ¨ç¢ºèªæ©Ÿèƒ½**ã§ã‚ã‚‹ `useLinkExistenceChecker` ã‚’å‰Šé™¤ã—ã€UnifiedLinkMark ã®è‡ªå‹•è§£æ±ºæ©Ÿèƒ½ã«å®Œå…¨çµ±åˆã—ã¾ã™ã€‚

### âš ï¸ é‡è¦ãªè¿½åŠ è¦ä»¶: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

èª¿æŸ»ã®çµæœã€**æ—¢å­˜ã® PageLinkMark ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å¤‰æ›ã•ã‚Œãªã„**ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚Phase 3.3 ã§ã¯ã€ä»¥ä¸‹ã‚’**å„ªå…ˆçš„ã«å®Ÿè£…**ã—ã¾ã™ï¼š

1. **UnifiedLinkMark ã® parseHTML() æ‹¡å¼µ** - æ—§å½¢å¼ã®è‡ªå‹•èªè­˜
2. **å±æ€§ã®è‡ªå‹•å¤‰æ›** - PageLinkMark â†’ UnifiedLinkMark
3. **å¤‰æ›å¾Œã®æ¤œè¨¼** - ãƒ‡ãƒ¼ã‚¿æå¤±ã®é˜²æ­¢

### ä¸»è¦ãªåˆ¤æ–­

- **èª¿æŸ»çµæœ**: useLinkExistenceChecker ã¯ UnifiedLinkMark ã¨æ©Ÿèƒ½ãŒé‡è¤‡
- **ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§å•é¡Œç™ºè¦‹**: PageLinkMark ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒèªè­˜ã•ã‚Œãªã„ âš ï¸
- **å®‰å…¨æ€§**: 339 ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§æ¤œè¨¼æ¸ˆã¿ã€ä¸¦è¡Œç¨¼åƒæœŸé–“ã§å•é¡Œãªã—
- **ãƒ¡ãƒªãƒƒãƒˆ**: ã‚³ãƒ¼ãƒ‰å‰Šæ¸›ï¼ˆ93 è¡Œï¼‰ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã€çŠ¶æ…‹ç®¡ç†ã®çµ±åˆ
- **è¿½åŠ ä½œæ¥­**: parseHTML() æ‹¡å¼µï¼ˆ+30 åˆ†ï¼‰+ ãƒ†ã‚¹ãƒˆï¼ˆ+20 åˆ†ï¼‰
- **ãƒªã‚¹ã‚¯**: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å…ˆã«å®Ÿæ–½ã™ã‚Œã°æ¥µå°

---

## ç›®æ¬¡

1. [èƒŒæ™¯ã¨ç›®çš„](#èƒŒæ™¯ã¨ç›®çš„)
2. [ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§å•é¡Œã®ç™ºè¦‹](#ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§å•é¡Œã®ç™ºè¦‹) âš ï¸ **NEW**
3. [ç¾çŠ¶åˆ†æ](#ç¾çŠ¶åˆ†æ)
4. [å‰Šé™¤ã®æ ¹æ‹ ](#å‰Šé™¤ã®æ ¹æ‹ )
5. [å®Ÿè£…è¨ˆç”»](#å®Ÿè£…è¨ˆç”») - **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å„ªå…ˆ**
6. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
7. [ãƒªã‚¹ã‚¯ç®¡ç†](#ãƒªã‚¹ã‚¯ç®¡ç†)
8. [æˆåŠŸåŸºæº–](#æˆåŠŸåŸºæº–)

---

## ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§å•é¡Œã®ç™ºè¦‹

### å•é¡Œã®æ¦‚è¦

èª¿æŸ»ã®çµæœã€**UnifiedLinkMark ã¯ PageLinkMark ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èªè­˜ã§ããªã„**ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚

#### ç¾åœ¨ã® parseHTML() å®Ÿè£…

```typescript
// UnifiedLinkMark - rendering.ts
export function parseHTML() {
  return [
    {
      tag: "a[data-variant]",  // â† data-variantå±æ€§ãŒå¿…é ˆ
    },
  ];
}

// PageLinkMark - page-link-mark.ts
parseHTML() {
  return [
    {
      tag: "a[data-page-id], a[data-page-title], a[data-external]",
    },
  ];
}
```

### äº’æ›æ€§ãƒãƒˆãƒªã‚¯ã‚¹

| å±æ€§              | PageLinkMark | UnifiedLinkMark | äº’æ›æ€§ | å½±éŸ¿                       |
| ----------------- | ------------ | --------------- | ------ | -------------------------- |
| `data-variant`    | âŒ ãªã—      | âœ… å¿…é ˆ         | âœ—      | **æ—§ãƒ‡ãƒ¼ã‚¿ãŒèªè­˜ã•ã‚Œãªã„** |
| `data-page-id`    | âœ… ä½¿ç”¨      | âœ… ä½¿ç”¨         | â—‹      | äº’æ›æ€§ã‚ã‚Š                 |
| `data-page-title` | âœ… ä½¿ç”¨      | âŒ ãªã—         | âœ—      | æœªä½œæˆãƒšãƒ¼ã‚¸ã®æƒ…å ±æå¤±     |
| `data-external`   | âœ… ä½¿ç”¨      | âŒ ãªã—         | âœ—      | å¤–éƒ¨ãƒªãƒ³ã‚¯åˆ¤å®šä¸å¯         |
| `data-state`      | âœ… ä½¿ç”¨      | âœ… ä½¿ç”¨         | â—‹      | äº’æ›æ€§ã‚ã‚Š                 |
| `data-exists`     | âœ… ä½¿ç”¨      | âœ… ä½¿ç”¨         | â—‹      | äº’æ›æ€§ã‚ã‚Š                 |

### å½±éŸ¿ç¯„å›²

#### ã‚·ãƒŠãƒªã‚ª 1: æ—¢å­˜ãƒšãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰

```json
// æ—¢å­˜ã®PageLinkMarkãƒ‡ãƒ¼ã‚¿
{
  "type": "text",
  "text": "æ—¢å­˜ãƒªãƒ³ã‚¯",
  "marks": [
    {
      "type": "pageLinkMark",
      "attrs": {
        "pageId": "abc-123",
        "pageTitle": "æ—¢å­˜ãƒšãƒ¼ã‚¸",
        "href": "/pages/abc-123",
        "state": "exists"
      }
    }
  ]
}
```

**HTML å‡ºåŠ›**:

```html
<a data-page-id="abc-123" data-state="exists" href="/pages/abc-123"
  >æ—¢å­˜ãƒªãƒ³ã‚¯</a
>
```

**å†ãƒ­ãƒ¼ãƒ‰æ™‚ã®å•é¡Œ**:

1. `data-variant` å±æ€§ãŒãªã„
2. UnifiedLinkMark ã® parseHTML() ãŒèªè­˜ã—ãªã„
3. **ãƒªãƒ³ã‚¯ãŒãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã‚‹å¯èƒ½æ€§** âš ï¸

#### ã‚·ãƒŠãƒªã‚ª 2: æœªä½œæˆãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯

```html
<a data-page-title="æ–°è¦ãƒšãƒ¼ã‚¸" data-state="missing">æ–°è¦ãƒšãƒ¼ã‚¸</a>
```

**å•é¡Œ**:

- `data-page-title` ã¯ UnifiedLinkMark ã«å­˜åœ¨ã—ãªã„
- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«æƒ…å ±ãŒå¤±ã‚ã‚Œã‚‹

### è§£æ±ºæ–¹é‡

âœ… **UnifiedLinkMark ã® parseHTML() ã‚’æ‹¡å¼µã—ã€æ—§å½¢å¼ã‚’è‡ªå‹•çš„ã«æ–°å½¢å¼ã«å¤‰æ›**

1. æ—§å½¢å¼ã® `<a>` ã‚¿ã‚°ã‚’èªè­˜
2. å±æ€§ã‚’è‡ªå‹•çš„ã« UnifiedLinkMark å½¢å¼ã«å¤‰æ›
3. `data-variant` å±æ€§ã‚’è‡ªå‹•ä»˜ä¸
4. å¤‰æ›å¾Œã¯ UnifiedLinkMark ã¨ã—ã¦å‹•ä½œ

---

## èƒŒæ™¯ã¨ç›®çš„

### Phase 3.3 ã®ä½ç½®ã¥ã‘

```
Phase 3: PageLink Extension å®Œå…¨å‰Šé™¤
â”œâ”€â”€ Phase 3.1: ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç§»è¡Œ âœ… å®Œäº†
â”œâ”€â”€ Phase 3.2: DOM ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼çµ±åˆ âœ… å®Œäº†
â”œâ”€â”€ Phase 3.3: useLinkExistenceChecker å‰Šé™¤ â† **ä»Šã“ã“**
â””â”€â”€ Phase 3.4: PageLink Extension å‰Šé™¤
```

### ç›®çš„

1. **é‡è¤‡æ©Ÿèƒ½ã®å‰Šé™¤**: useLinkExistenceChecker ã¨ UnifiedLinkMark ã®é‡è¤‡è§£æ¶ˆ
2. **çŠ¶æ…‹ç®¡ç†ã®çµ±ä¸€**: Plugin Meta ã¨ Mark å±æ€§ã®äºŒé‡ç®¡ç†ã‚’è§£æ¶ˆ
3. **ã‚³ãƒ¼ãƒ‰ã®ç°¡æ½”åŒ–**: 93 è¡Œã®ã‚³ãƒ¼ãƒ‰å‰Šæ¸›
4. **ä¿å®ˆæ€§ã®å‘ä¸Š**: å˜ä¸€ã®è‡ªå‹•è§£æ±ºã‚·ã‚¹ãƒ†ãƒ ã¸ã®çµ±åˆ

---

## ç¾çŠ¶åˆ†æ

### 1. useLinkExistenceChecker ã®æ¦‚è¦

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/(protected)/pages/[id]/_hooks/useLinkExistenceChecker.ts` (78 è¡Œ)

**ä¸»ãªæ©Ÿèƒ½**:

```typescript
export function useLinkExistenceChecker(
  editor: Editor | null,
  supabase: SupabaseClient
) {
  // 1. ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒªãƒ³ã‚¯ã‚’æ¤œå‡º
  const bracketMatches = fullText.matchAll(/\[([^\[\]]+)\]/g);
  const tagMatches = fullText.matchAll(/#([^\s\[\]]+)/g);

  // 2. Supabase ã§ãƒšãƒ¼ã‚¸å­˜åœ¨ç¢ºèª
  const { data: pages } = await supabase
    .from("pages")
    .select("title,id")
    .in("title", titles);

  // 3. existencePluginKey ã«çµæœã‚’è¨­å®š
  const tr = editor.state.tr.setMeta(existencePluginKey, existMap);
  editor.view.dispatch(tr);
}
```

**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**:

- ã‚¨ãƒ‡ã‚£ã‚¿ã® `update` ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ 500msï¼‰
- åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰

### 2. ä½¿ç”¨ç®‡æ‰€ã®å®Œå…¨ãƒãƒƒãƒ”ãƒ³ã‚°

#### â‘  `usePageEditorLogic.ts` - Import

**è¡Œæ•°**: 29, 35

```typescript
// 29è¡Œç›®
import { existencePluginKey } from "@/lib/tiptap-extensions/page-link";

// 35è¡Œç›®
import { useLinkExistenceChecker } from "./useLinkExistenceChecker";
```

#### â‘¡ `usePageEditorLogic.ts` - Hook å‘¼ã³å‡ºã—

**è¡Œæ•°**: 471

```typescript
// Link existence check hook
useLinkExistenceChecker(editor, supabase);
```

#### â‘¢ `usePageEditorLogic.ts` - savePage é–¢æ•°å†…

**è¡Œæ•°**: 375-385

```typescript
// 3. existence mapã‚’å¼·åˆ¶æ›´æ–°
try {
  const result = await ensurePageLinksSync(page.id);
  const existMap = new Map<string, string | null>(
    Object.entries(result.existMap)
  );
  const tr = editor.state.tr.setMeta(existencePluginKey, existMap);
  editor.view.dispatch(tr);
} catch (syncError) {
  console.warn("ãƒªãƒ³ã‚¯å­˜åœ¨ç¢ºèªã®æ›´æ–°ã«å¤±æ•—:", syncError);
  // é‡è¦ã§ã¯ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„
}
```

### 3. ä¾å­˜é–¢ä¿‚

```
useLinkExistenceChecker.ts
â”œâ”€â”€ import: existencePluginKey (from page-link.ts)
â”œâ”€â”€ ä½¿ç”¨: usePageEditorLogic.ts (471è¡Œ)
â””â”€â”€ å‚ç…§: usePageEditorLogic.ts savePage (375-385è¡Œ)

existencePluginKey
â”œâ”€â”€ å®šç¾©: page-link.ts
â”œâ”€â”€ ä½¿ç”¨: useLinkExistenceChecker.ts
â””â”€â”€ ä½¿ç”¨: usePageEditorLogic.ts (savePage é–¢æ•°)
```

---

## å‰Šé™¤ã®æ ¹æ‹ 

### 1. æ©Ÿèƒ½ã®å®Œå…¨é‡è¤‡

| æ©Ÿèƒ½                 | useLinkExistenceChecker | UnifiedLinkMark                 | çµè«–                     |
| -------------------- | ----------------------- | ------------------------------- | ------------------------ |
| **ãƒªãƒ³ã‚¯æ¤œå‡º**       | æ­£è¦è¡¨ç¾ã§å…¨æ–‡æ¤œç´¢      | Input Rules ã§è‡ªå‹•æ¤œå‡º          | UnifiedLinkMark ãŒåŠ¹ç‡çš„ |
| **å­˜åœ¨ç¢ºèª**         | Supabase ã‚¯ã‚¨ãƒª         | resolver-queue ã§éåŒæœŸå‡¦ç†     | UnifiedLinkMark ãŒé«˜æ©Ÿèƒ½ |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**       | âŒ ãªã—                 | âœ… 30 ç§’ TTL                    | UnifiedLinkMark ã®ã¿     |
| **çŠ¶æ…‹ç®¡ç†**         | Plugin Metaï¼ˆæ®ç™ºæ€§ï¼‰   | Mark å±æ€§ï¼ˆæ°¸ç¶šçš„ï¼‰             | UnifiedLinkMark ãŒå„ªã‚Œã‚‹ |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°** | âŒ ãªã—                 | âœ… BroadcastChannel             | UnifiedLinkMark ã®ã¿     |
| **ãƒãƒƒãƒå‡¦ç†**       | âŒ ãªã—                 | âœ… æœ€å¤§ 10 ä»¶                   | UnifiedLinkMark ã®ã¿     |
| **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**     | âŒ ãªã—                 | âœ… æœ€å¤§ 2 å›                    | UnifiedLinkMark ã®ã¿     |
| **ãƒ‡ãƒã‚¦ãƒ³ã‚¹**       | 500ms                   | å†…è”µ                            | åŒç­‰                     |
| **ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†**   | âŒ ãªã—                 | âœ… pageLinkMetrics + uniMetrics | UnifiedLinkMark ã®ã¿     |

**çµè«–**: UnifiedLinkMark ãŒ**ã™ã¹ã¦ã®é¢ã§å„ªã‚Œã¦ã„ã‚‹**

### 2. ç•°ãªã‚‹çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### useLinkExistenceChecker ã®çŠ¶æ…‹ç®¡ç†

```typescript
// Plugin Meta ã«ä¿å­˜ï¼ˆæ®ç™ºæ€§ï¼‰
const tr = editor.state.tr.setMeta(existencePluginKey, existMap);
editor.view.dispatch(tr);
```

**å•é¡Œç‚¹**:

- Plugin Meta ã¯ä¸€æ™‚çš„ãªçŠ¶æ…‹
- ã‚¨ãƒ‡ã‚£ã‚¿ã®å†ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¤±ã‚ã‚Œã‚‹
- UnifiedLinkMark ã¯**å‚ç…§ã—ãªã„**

#### UnifiedLinkMark ã®çŠ¶æ…‹ç®¡ç†

```typescript
// Mark å±æ€§ã«ä¿å­˜ï¼ˆæ°¸ç¶šçš„ï¼‰
updateMarkState(editor, markId, {
  state: "exists" | "missing" | "pending",
  exists: true | false,
  pageId: "...",
  href: "/pages/...",
});
```

**åˆ©ç‚¹**:

- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ°¸ç¶šåŒ–
- JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ™‚ã‚‚ä¿æŒ
- ã‚¨ãƒ‡ã‚£ã‚¿ã®å†ãƒ­ãƒ¼ãƒ‰å¾Œã‚‚ç¶­æŒ

### 3. PageLink Extension ã¸ã®ä¾å­˜

```typescript
// useLinkExistenceChecker.ts
import { existencePluginKey } from "@/lib/tiptap-extensions/page-link";
```

**å•é¡Œ**:

- Phase 3.4 ã§ PageLink Extension å‰Šé™¤å¾Œã¯å‹•ä½œä¸å¯
- existencePluginKey ã®ä»£æ›¿å®Ÿè£…ãŒå¿…è¦ã«ãªã‚‹

**è§£æ±ºç­–**:

- Phase 3.3 ã§å‰Šé™¤ â†’ Phase 3.4 ã®ä½œæ¥­ã‚’ç°¡ç•¥åŒ–

### 4. ç„¡é§„ãªå‡¦ç†ã®ç™ºè¦‹

#### savePage é–¢æ•°å†…ã®å‡¦ç†ï¼ˆ375-385 è¡Œï¼‰

```typescript
try {
  const result = await ensurePageLinksSync(page.id);
  const existMap = new Map<string, string | null>(
    Object.entries(result.existMap)
  );
  const tr = editor.state.tr.setMeta(existencePluginKey, existMap);
  editor.view.dispatch(tr);
} catch (syncError) {
  console.warn("ãƒªãƒ³ã‚¯å­˜åœ¨ç¢ºèªã®æ›´æ–°ã«å¤±æ•—:", syncError);
}
```

**å•é¡Œ**:

1. `ensurePageLinksSync` ã®çµæœã‚’ `existMap` ã«å¤‰æ›
2. `existencePluginKey` ã«è¨­å®š
3. ã—ã‹ã—ã€UnifiedLinkMark ã¯**Plugin Meta ã‚’å‚ç…§ã—ãªã„**
4. ã¤ã¾ã‚Šã€**ã“ã®å‡¦ç†å…¨ä½“ãŒç„¡é§„**

**çµè«–**: å‰Šé™¤ã—ã¦ã‚‚å½±éŸ¿ãªã— âœ…

---

## å®Ÿè£…è¨ˆç”»

### å®Ÿè£…ã®å…¨ä½“åƒã¨å„ªå…ˆé †ä½

```
Phase 3.3 å®Ÿè£…ãƒ•ãƒ­ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
â”‚
â”œâ”€ [å„ªå…ˆåº¦: æœ€é«˜] Step 0: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å®Ÿè£… âš ï¸ NEW
â”‚   â”œâ”€ 0.1: UnifiedLinkMark parseHTML() æ‹¡å¼µ
â”‚   â”œâ”€ 0.2: å±æ€§å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
â”‚   â”œâ”€ 0.3: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ†ã‚¹ãƒˆã®è¿½åŠ 
â”‚   â””â”€ 0.4: å¤‰æ›å‹•ä½œã®æ¤œè¨¼
â”‚
â”œâ”€ [å„ªå…ˆåº¦: é«˜] Step 1: usePageEditorLogic.ts ã®ä¿®æ­£
â”‚   â”œâ”€ 1.1: import æ–‡ã®å‰Šé™¤
â”‚   â”œâ”€ 1.2: Hook å‘¼ã³å‡ºã—å‰Šé™¤
â”‚   â””â”€ 1.3: savePage å†…ã®å‡¦ç†å‰Šé™¤
â”‚
â”œâ”€ [å„ªå…ˆåº¦: é«˜] Step 2: useLinkExistenceChecker.ts ã®å‰Šé™¤
â”‚   â””â”€ 2.1: ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
â”‚
â””â”€ [å„ªå…ˆåº¦: é«˜] Step 3: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆ
    â”œâ”€ 3.1: TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
    â”œâ”€ 3.2: è‡ªå‹•ãƒ†ã‚¹ãƒˆï¼ˆ339 + æ–°è¦ï¼‰
    â””â”€ 3.3: æ‰‹å‹•å‹•ä½œç¢ºèª

åˆè¨ˆä½œæ¥­æ™‚é–“: ç´„ 72 åˆ†ï¼ˆå¾“æ¥ 42 åˆ† + ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ 30 åˆ†ï¼‰
```

---

## Step 0: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å®Ÿè£…ï¼ˆå„ªå…ˆå®Ÿæ–½ï¼‰âš ï¸

### 0.1 UnifiedLinkMark parseHTML() ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/rendering.ts`

**ç›®çš„**: æ—§ PageLinkMark å½¢å¼ã® `<a>` ã‚¿ã‚°ã‚’è‡ªå‹•èªè­˜ã—ã€UnifiedLinkMark å½¢å¼ã«å¤‰æ›

#### å®Ÿè£…å†…å®¹

```typescript
// rendering.ts - parseHTML() ã®æ‹¡å¼µ

/**
 * Parse HTML to mark
 * Supports both new UnifiedLinkMark format and legacy PageLinkMark format
 * @returns HTML parsing specification
 */
export function parseHTML() {
  return [
    // â‘  æ–°å½¢å¼: UnifiedLinkMark (data-variantå¿…é ˆ)
    {
      tag: "a[data-variant]",
      // å±æ€§ã¯ãã®ã¾ã¾ä½¿ç”¨
    },

    // â‘¡ æ—§å½¢å¼: PageLinkMark (data-page-id) - è‡ªå‹•å¤‰æ›
    {
      tag: "a[data-page-id]:not([data-variant])",
      getAttrs: (node) => {
        if (!(node instanceof HTMLElement)) return false;

        // PageLinkMark â†’ UnifiedLinkMark ã¸ã®å¤‰æ›
        const pageId = node.getAttribute("data-page-id");
        const state = node.getAttribute("data-state") || "pending";
        const exists = node.getAttribute("data-exists") === "true";
        const href = node.getAttribute("href") || "#";
        const external = node.getAttribute("data-external") === "true";

        // å¤–éƒ¨ãƒªãƒ³ã‚¯ã®å ´åˆã¯å¤‰æ›å¯¾è±¡å¤–ï¼ˆå°†æ¥çš„ã«å¯¾å¿œï¼‰
        if (external) {
          console.warn(
            "[UnifiedLinkMark] External link migration not yet supported:",
            node
          );
          return false;
        }

        // UnifiedLinkMarkå½¢å¼ã®å±æ€§ã‚’ç”Ÿæˆ
        return {
          variant: "bracket",
          pageId,
          state,
          exists,
          href,
          key: "", // å¾Œã§ resolver ãŒè§£æ±º
          raw: node.textContent || "",
          text: node.textContent || "",
          markId: `migrated-${Date.now()}-${Math.random()
            .toString(36)
            .slice(2, 8)}`,
          created: false,
        };
      },
    },

    // â‘¢ æ—§å½¢å¼: PageLinkMark (data-page-title) - æœªä½œæˆãƒšãƒ¼ã‚¸
    {
      tag: "a[data-page-title]:not([data-variant])",
      getAttrs: (node) => {
        if (!(node instanceof HTMLElement)) return false;

        const pageTitle = node.getAttribute("data-page-title");
        const state = node.getAttribute("data-state") || "missing";

        // UnifiedLinkMarkå½¢å¼ã®å±æ€§ã‚’ç”Ÿæˆ
        return {
          variant: "bracket",
          pageId: null,
          state,
          exists: false,
          href: "#",
          key: pageTitle?.toLowerCase() || "",
          raw: pageTitle || "",
          text: pageTitle || "",
          markId: `migrated-${Date.now()}-${Math.random()
            .toString(36)
            .slice(2, 8)}`,
          created: false,
        };
      },
    },
  ];
}
```

#### å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®èª¬æ˜

| æ—§å½¢å¼ï¼ˆPageLinkMarkï¼‰    | æ–°å½¢å¼ï¼ˆUnifiedLinkMarkï¼‰      | å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯           |
| ------------------------- | ------------------------------ | ---------------------- |
| `data-page-id="abc-123"`  | `data-page-id="abc-123"`       | ãã®ã¾ã¾å¼•ãç¶™ã       |
| `data-page-title="Title"` | `text="Title"` + `raw="Title"` | ã‚¿ã‚¤ãƒˆãƒ«ã‚’ text/raw ã« |
| ï¼ˆãªã—ï¼‰                  | `variant="bracket"`            | è‡ªå‹•ä»˜ä¸               |
| `data-state="exists"`     | `state="exists"`               | ãã®ã¾ã¾å¼•ãç¶™ã       |
| `data-exists="true"`      | `exists=true`                  | ãã®ã¾ã¾å¼•ãç¶™ã       |
| `href="/pages/abc-123"`   | `href="/pages/abc-123"`        | ãã®ã¾ã¾å¼•ãç¶™ã       |
| ï¼ˆãªã—ï¼‰                  | `markId="migrated-..."`        | æ–°è¦ç”Ÿæˆ               |

#### å¤‰æ›å¾Œã®å‹•ä½œ

```typescript
// å¤‰æ›å‰ï¼ˆPageLinkMarkï¼‰
<a data-page-id="abc-123" data-state="exists" href="/pages/abc-123">
  æ—¢å­˜ãƒªãƒ³ã‚¯
</a>

// å¤‰æ›å¾Œï¼ˆUnifiedLinkMarkï¼‰
<a
  data-variant="bracket"
  data-page-id="abc-123"
  data-state="exists"
  data-key="æ—¢å­˜ãƒªãƒ³ã‚¯"
  data-text="æ—¢å­˜ãƒªãƒ³ã‚¯"
  data-raw="æ—¢å­˜ãƒªãƒ³ã‚¯"
  data-mark-id="migrated-..."
  href="/pages/abc-123"
>
  æ—¢å­˜ãƒªãƒ³ã‚¯
</a>
```

### 0.2 å¤‰æ›ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/__tests__/migration.test.ts` (æ–°è¦ä½œæˆ)

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import { createEditor } from "@tiptap/core";
import { UnifiedLinkMark } from "../index";

describe("UnifiedLinkMark - Legacy Data Migration", () => {
  let editor: ReturnType<typeof createEditor>;

  beforeEach(() => {
    editor = createEditor({
      extensions: [UnifiedLinkMark],
    });
  });

  describe("PageLinkMark Migration", () => {
    it("should migrate data-page-id links to UnifiedLinkMark", () => {
      const html =
        '<a data-page-id="abc-123" data-state="exists" href="/pages/abc-123">Test Link</a>';

      editor.commands.setContent(html);
      const json = editor.getJSON();

      // Mark ãŒ unilink ã¨ã—ã¦èªè­˜ã•ã‚Œã¦ã„ã‚‹ã‹
      const mark = json.content?.[0]?.content?.[0]?.marks?.[0];
      expect(mark?.type).toBe("unilink");
      expect(mark?.attrs.variant).toBe("bracket");
      expect(mark?.attrs.pageId).toBe("abc-123");
      expect(mark?.attrs.state).toBe("exists");
    });

    it("should migrate data-page-title links (missing pages)", () => {
      const html =
        '<a data-page-title="New Page" data-state="missing">New Page</a>';

      editor.commands.setContent(html);
      const json = editor.getJSON();

      const mark = json.content?.[0]?.content?.[0]?.marks?.[0];
      expect(mark?.type).toBe("unilink");
      expect(mark?.attrs.variant).toBe("bracket");
      expect(mark?.attrs.text).toBe("New Page");
      expect(mark?.attrs.state).toBe("missing");
      expect(mark?.attrs.exists).toBe(false);
    });

    it("should preserve href attribute during migration", () => {
      const html =
        '<a data-page-id="xyz" href="/pages/xyz" data-state="exists">Link</a>';

      editor.commands.setContent(html);
      const mark = editor.getJSON().content?.[0]?.content?.[0]?.marks?.[0];

      expect(mark?.attrs.href).toBe("/pages/xyz");
    });

    it("should not migrate links with data-variant (already migrated)", () => {
      const html =
        '<a data-variant="bracket" data-page-id="abc">Already Migrated</a>';

      editor.commands.setContent(html);
      const mark = editor.getJSON().content?.[0]?.content?.[0]?.marks?.[0];

      // data-variant ãŒã‚ã‚‹å ´åˆã¯é€šå¸¸ã®ãƒ‘ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯
      expect(mark?.type).toBe("unilink");
      expect(mark?.attrs.variant).toBe("bracket");
    });

    it("should generate unique markId for migrated links", () => {
      const html1 = '<a data-page-id="abc-1">Link 1</a>';
      const html2 = '<a data-page-id="abc-2">Link 2</a>';

      editor.commands.setContent(`${html1} ${html2}`);
      const json = editor.getJSON();

      const mark1 = json.content?.[0]?.content?.[0]?.marks?.[0];
      const mark2 = json.content?.[0]?.content?.[1]?.marks?.[0];

      expect(mark1?.attrs.markId).toBeTruthy();
      expect(mark2?.attrs.markId).toBeTruthy();
      expect(mark1?.attrs.markId).not.toBe(mark2?.attrs.markId);
    });
  });

  describe("Edge Cases", () => {
    it("should handle links without state attribute", () => {
      const html = '<a data-page-id="abc">No State</a>';

      editor.commands.setContent(html);
      const mark = editor.getJSON().content?.[0]?.content?.[0]?.marks?.[0];

      expect(mark?.attrs.state).toBe("pending"); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    });

    it("should handle links without exists attribute", () => {
      const html = '<a data-page-id="abc" data-state="exists">No Exists</a>';

      editor.commands.setContent(html);
      const mark = editor.getJSON().content?.[0]?.content?.[0]?.marks?.[0];

      expect(mark?.attrs.exists).toBe(false); // data-exists ãŒãªã‘ã‚Œã° false
    });

    it("should skip external links (not yet supported)", () => {
      const html =
        '<a data-page-id="abc" data-external="true" href="https://example.com">External</a>';

      editor.commands.setContent(html);
      const json = editor.getJSON();

      // å¤–éƒ¨ãƒªãƒ³ã‚¯ã¯å¤‰æ›ã•ã‚Œãªã„ï¼ˆå°†æ¥å¯¾å¿œï¼‰
      const marks = json.content?.[0]?.content?.[0]?.marks || [];
      const unilinkMark = marks.find((m) => m.type === "unilink");
      expect(unilinkMark).toBeUndefined();
    });
  });
});
```

### 0.3 å¤‰æ›å‹•ä½œã®æ‰‹å‹•ç¢ºèª

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 1: æ—¢å­˜ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã®ç§»è¡Œ

```
1. æ—§å½¢å¼ã®HTMLã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ã‚¨ãƒ‡ã‚£ã‚¿ãŒè‡ªå‹•çš„ã«UnifiedLinkMarkå½¢å¼ã«å¤‰æ›
3. ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œ
4. ä¿å­˜å¾Œã€data-variantå±æ€§ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹
```

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 2: æœªä½œæˆãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã®ç§»è¡Œ

```
1. data-page-title ã‚’æŒã¤ãƒªãƒ³ã‚¯ã‚’ãƒ­ãƒ¼ãƒ‰
2. missing çŠ¶æ…‹ã¨ã—ã¦è¡¨ç¤ºï¼ˆèµ¤è‰²ï¼‰
3. ã‚¯ãƒªãƒƒã‚¯ã§æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆ
4. ä½œæˆå¾Œã€exists çŠ¶æ…‹ã«æ›´æ–°
```

### 0.4 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆStep 0ï¼‰

| ã‚µãƒ–ã‚¹ãƒ†ãƒƒãƒ— | ä½œæ¥­å†…å®¹                         | æ‰€è¦æ™‚é–“  |
| ------------ | -------------------------------- | --------- |
| 0.1          | rendering.ts ã® parseHTML() æ‹¡å¼µ | 15 åˆ†     |
| 0.2          | migration.test.ts ã®ä½œæˆ         | 15 åˆ†     |
| 0.3          | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ä¿®æ­£                 | 10 åˆ†     |
| 0.4          | æ‰‹å‹•å‹•ä½œç¢ºèª                     | 10 åˆ†     |
| **åˆè¨ˆ**     | **Step 0**                       | **50 åˆ†** |

---

## Step 1: usePageEditorLogic.ts ã®ä¿®æ­£

### å‰Šé™¤å¯¾è±¡ã®å…¨ä½“åƒ

```
å‰Šé™¤å¯¾è±¡:
â”œâ”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ (78è¡Œ)
â”‚   â””â”€â”€ app/(protected)/pages/[id]/_hooks/useLinkExistenceChecker.ts
â”‚
â””â”€â”€ usePageEditorLogic.ts ã®3ç®‡æ‰€ (ç´„15è¡Œ)
    â”œâ”€â”€ 29è¡Œ: import { existencePluginKey } from "..."
    â”œâ”€â”€ 35è¡Œ: import { useLinkExistenceChecker } from "..."
    â”œâ”€â”€ 471è¡Œ: useLinkExistenceChecker(editor, supabase);
    â””â”€â”€ 375-385è¡Œ: ensurePageLinksSync + Plugin Meta æ›´æ–°

åˆè¨ˆå‰Šé™¤è¡Œæ•°: ç´„93è¡Œ
```

#### 1.1 Import æ–‡ã®å‰Šé™¤

**å‰Šé™¤ç®‡æ‰€**: 29 è¡Œã€35 è¡Œ

```typescript
// å‰Šé™¤å‰
import { ensurePageLinksSync } from "@/app/_actions/ensurePageLinksSync";
import { updatePage } from "@/app/_actions/updatePage";
import { updatePageLinks } from "@/app/_actions/updatePageLinks";
import { existencePluginKey } from "@/lib/tiptap-extensions/page-link"; // â† å‰Šé™¤
import { extractLinkData } from "@/lib/utils/linkUtils";
import { transformMarkdownTables } from "@/lib/utils/transformMarkdownTables";
import { useUserIconRenderer } from "@/lib/utils/user-icon-renderer";
import { useAutoSave } from "./useAutoSave";
import { useGenerateContent } from "./useGenerateContent";
import { useLinkExistenceChecker } from "./useLinkExistenceChecker"; // â† å‰Šé™¤
import { useSmartThumbnailSync } from "./useSmartThumbnailSync";
import { useSplitPage } from "./useSplitPage";

// å‰Šé™¤å¾Œ
import { ensurePageLinksSync } from "@/app/_actions/ensurePageLinksSync";
import { updatePage } from "@/app/_actions/updatePage";
import { updatePageLinks } from "@/app/_actions/updatePageLinks";
import { extractLinkData } from "@/lib/utils/linkUtils";
import { transformMarkdownTables } from "@/lib/utils/transformMarkdownTables";
import { useUserIconRenderer } from "@/lib/utils/user-icon-renderer";
import { useAutoSave } from "./useAutoSave";
import { useGenerateContent } from "./useGenerateContent";
import { useSmartThumbnailSync } from "./useSmartThumbnailSync";
import { useSplitPage } from "./useSplitPage";
```

#### 1.2 Hook å‘¼ã³å‡ºã—ã®å‰Šé™¤

**å‰Šé™¤ç®‡æ‰€**: 471 è¡Œä»˜è¿‘

```typescript
// å‰Šé™¤å‰
  // Autosave hook
  useAutoSave(editor, savePage, isDirty);

  // Link existence check hook
  useLinkExistenceChecker(editor, supabase); // â† ã“ã®è¡Œã‚’å‰Šé™¤

  // Smart thumbnail sync hook
  const { manualSync: manualThumbnailSync } = useSmartThumbnailSync({

// å‰Šé™¤å¾Œ
  // Autosave hook
  useAutoSave(editor, savePage, isDirty);

  // Smart thumbnail sync hook
  const { manualSync: manualThumbnailSync } = useSmartThumbnailSync({
```

#### 1.3 savePage é–¢æ•°å†…ã® Plugin Meta æ›´æ–°å‰Šé™¤

**å‰Šé™¤ç®‡æ‰€**: 375-385 è¡Œ

```typescript
// å‰Šé™¤å‰
      // 2. ãƒªãƒ³ã‚¯åŒæœŸï¼ˆç¢ºå®Ÿã«å®Œäº†ã‚’å¾…ã¤ï¼‰
      const { outgoingIds } = extractLinkData(content);
      await updatePageLinks({ pageId: page.id, outgoingIds });

      // 3. existence mapã‚’å¼·åˆ¶æ›´æ–°
      try {
        const result = await ensurePageLinksSync(page.id);
        const existMap = new Map<string, string | null>(
          Object.entries(result.existMap)
        );
        const tr = editor.state.tr.setMeta(existencePluginKey, existMap);
        editor.view.dispatch(tr);
      } catch (syncError) {
        console.warn("ãƒªãƒ³ã‚¯å­˜åœ¨ç¢ºèªã®æ›´æ–°ã«å¤±æ•—:", syncError);
        // é‡è¦ã§ã¯ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„
      }
    } catch (err) {
      console.error("SavePage error:", err);

// å‰Šé™¤å¾Œ
      // 2. ãƒªãƒ³ã‚¯åŒæœŸï¼ˆç¢ºå®Ÿã«å®Œäº†ã‚’å¾…ã¤ï¼‰
      const { outgoingIds } = extractLinkData(content);
      await updatePageLinks({ pageId: page.id, outgoingIds });

    } catch (err) {
      console.error("SavePage error:", err);
```

**æ³¨æ„**: ç•ªå·ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆã‚’èª¿æ•´ï¼ˆ"3. existence map..." ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€ä»¥é™ã®ç•ªå·ã¯ä¸è¦ï¼‰

### Step 2: useLinkExistenceChecker.ts ã®å‰Šé™¤

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm app/(protected)/pages/[id]/_hooks/useLinkExistenceChecker.ts
```

**å‰Šé™¤å†…å®¹**:

- ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“: 78 è¡Œ
- ä¾å­˜: `existencePluginKey`ï¼ˆPhase 3.4 ã§å‰Šé™¤äºˆå®šï¼‰

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. è‡ªå‹•ãƒ†ã‚¹ãƒˆ

#### 1.1 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ†ã‚¹ãƒˆã®è¿½åŠ ï¼ˆæ–°è¦ï¼‰âš ï¸

```bash
# æ–°è¦ä½œæˆã—ãŸmigration.test.tsã‚’å®Ÿè¡Œ
bun test lib/tiptap-extensions/unified-link-mark/__tests__/migration.test.ts
```

**æœŸå¾…çµæœ**:

- âœ… PageLinkMark â†’ UnifiedLinkMark å¤‰æ›ãƒ†ã‚¹ãƒˆæˆåŠŸ
- âœ… data-page-id å±æ€§ã®èªè­˜
- âœ… data-page-title å±æ€§ã®èªè­˜
- âœ… markId ã®è‡ªå‹•ç”Ÿæˆ
- âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®å‡¦ç†

**è¿½åŠ ãƒ†ã‚¹ãƒˆæ•°**: ç´„ 10-15 ãƒ†ã‚¹ãƒˆ

#### 1.2 æ—¢å­˜ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ339 + æ–°è¦ 10-15 = ç´„350ãƒ†ã‚¹ãƒˆï¼‰
bun test

# UnifiedLinkMark é–¢é€£ãƒ†ã‚¹ãƒˆã®ã¿
bun test lib/tiptap-extensions/unified-link-mark
```

**æœŸå¾…çµæœ**:

- âœ… å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ350/350ï¼‰
- âŒ å¤±æ•—ãƒ†ã‚¹ãƒˆãŒã‚ã‚Œã°åŸå› èª¿æŸ»

#### 1.3 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

UnifiedLinkMark ã¯ 350+ ã®ãƒ†ã‚¹ãƒˆã§ã‚«ãƒãƒ¼æ¸ˆã¿ï¼š

| ã‚«ãƒ†ã‚´ãƒª           | ãƒ†ã‚¹ãƒˆæ•° | ãƒ•ã‚¡ã‚¤ãƒ«                                       |
| ------------------ | -------- | ---------------------------------------------- |
| **Plugins**        | 166      | click-handler, auto-bracket, suggestion, index |
| **Input Rules**    | 57       | bracket-rule, tag-rule, utils, index           |
| **Core**           | 91       | attributes, config, lifecycle, rendering       |
| **State/Resolver** | 16       | state-manager, resolver-queue                  |
| **Commands**       | 27       | insert-unified-link, refresh-unified-links     |
| **Migration** âš ï¸   | **12**   | **migration.test.ts (æ–°è¦)**                   |
| **åˆè¨ˆ**           | **351**  | **17 ãƒ•ã‚¡ã‚¤ãƒ«**                                |

### 2. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

#### 2.1 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å‹•ä½œç¢ºèªï¼ˆå„ªå…ˆï¼‰âš ï¸

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 0a**: æ—¢å­˜ PageLinkMark ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿

```
å‰ææ¡ä»¶: æ—§å½¢å¼ã®ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨

1. æ—§å½¢å¼ã®ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’é–‹ã
   HTML: <a data-page-id="abc-123" data-state="exists">æ—¢å­˜ãƒªãƒ³ã‚¯</a>

2. æœŸå¾…: UnifiedLinkMark ã¨ã—ã¦èªè­˜
   - ãƒªãƒ³ã‚¯ãŒé’è‰²ã§è¡¨ç¤ºï¼ˆexistsçŠ¶æ…‹ï¼‰
   - ã‚¯ãƒªãƒƒã‚¯ã§æ­£å¸¸ã«ãƒšãƒ¼ã‚¸é·ç§»
   - data-variant="bracket" ãŒè‡ªå‹•ä»˜ä¸

3. ãƒšãƒ¼ã‚¸ä¿å­˜å¾Œã€HTMLã‚’ç¢ºèª
   - data-variant å±æ€§ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
   - ä»–ã®å±æ€§ã‚‚ä¿æŒã•ã‚Œã¦ã„ã‚‹
```

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 0b**: æœªä½œæˆãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã®ç§»è¡Œ

```
å‰ææ¡ä»¶: data-page-title ã‚’æŒã¤ãƒªãƒ³ã‚¯ãŒå­˜åœ¨

1. æœªä½œæˆãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’é–‹ã
   HTML: <a data-page-title="æ–°è¦ãƒšãƒ¼ã‚¸" data-state="missing">æ–°è¦ãƒšãƒ¼ã‚¸</a>

2. æœŸå¾…: UnifiedLinkMark ã¨ã—ã¦èªè­˜
   - ãƒªãƒ³ã‚¯ãŒèµ¤è‰²ã§è¡¨ç¤ºï¼ˆmissingçŠ¶æ…‹ï¼‰
   - textå±æ€§ã« "æ–°è¦ãƒšãƒ¼ã‚¸" ãŒè¨­å®š

3. missing ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒšãƒ¼ã‚¸ä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤º
   - ä½œæˆå¾Œã€exists çŠ¶æ…‹ã«æ›´æ–°
```

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 0c**: å¤‰æ›å¾Œã®ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šæ€§

```
1. æ—§å½¢å¼ãƒªãƒ³ã‚¯ã‚’é–‹ãã€è‡ªå‹•å¤‰æ›ã‚’ç¢ºèª
2. ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
3. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
4. æœŸå¾…:
   - å¤‰æ›å¾Œã®å½¢å¼ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹
   - å†åº¦æ—§å½¢å¼ã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚Œãªã„
   - data-variant å±æ€§ãŒå­˜åœ¨
```

#### 2.2 ãƒªãƒ³ã‚¯è§£æ±ºã®å‹•ä½œç¢ºèª

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 1**: ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ã®å…¥åŠ›

```
1. ã‚¨ãƒ‡ã‚£ã‚¿ã§ `[æ–°ã—ã„ãƒšãƒ¼ã‚¸]` ã¨å…¥åŠ›
2. æœŸå¾…: pending çŠ¶æ…‹ã§è¡¨ç¤ºï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
3. æ•°ç§’å¾Œ: missing çŠ¶æ…‹ã«é·ç§»ï¼ˆèµ¤è‰²ï¼‰
```

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 2**: æ—¢å­˜ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯

```
1. æ—¢å­˜ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ `[æ—¢å­˜ãƒšãƒ¼ã‚¸]` ã¨ã—ã¦å…¥åŠ›
2. æœŸå¾…: pending â†’ exists ã«é·ç§»ï¼ˆé’è‰²ãƒªãƒ³ã‚¯ï¼‰
3. ã‚¯ãƒªãƒƒã‚¯: ãƒšãƒ¼ã‚¸ã«é·ç§»
```

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 3**: ã‚¿ã‚°è¨˜æ³•

```
1. `#ã‚¿ã‚°å` ã¨å…¥åŠ›
2. æœŸå¾…: pending â†’ exists/missing ã«é·ç§»
3. åŒæ§˜ã«å‹•ä½œç¢ºèª
```

#### 2.2 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ç¢ºèª

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 4**: ä»–ã‚¿ãƒ–ã§ã®ãƒšãƒ¼ã‚¸ä½œæˆ

```
1. ã‚¿ãƒ– A ã§ `[æ–°è¦ãƒšãƒ¼ã‚¸X]` ã¨å…¥åŠ›ï¼ˆmissing çŠ¶æ…‹ï¼‰
2. ã‚¿ãƒ– B ã§ã€Œæ–°è¦ãƒšãƒ¼ã‚¸Xã€ã‚’ä½œæˆ
3. æœŸå¾…: ã‚¿ãƒ– A ã§è‡ªå‹•çš„ã« missing â†’ exists ã«é·ç§»
```

#### 2.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ç¢ºèª

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 5**: å¤šæ•°ã®ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒšãƒ¼ã‚¸

```
1. 20å€‹ä»¥ä¸Šã®ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ç¢ºèª: ã‚¨ãƒ‡ã‚£ã‚¿ã®å¿œç­”æ€§ãŒè‰¯å¥½
3. ç¢ºèª: ãƒªãƒ³ã‚¯è§£æ±ºãŒæ®µéšçš„ã«å®Œäº†
4. ç¢ºèª: é‡è¤‡ã—ãŸæ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç™ºç”Ÿã—ãªã„
```

### 3. å›å¸°ãƒ†ã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ `[Title]` ã®å…¥åŠ›ã¨è§£æ±º
- [ ] ã‚¿ã‚°ãƒªãƒ³ã‚¯ `#tag` ã®å…¥åŠ›ã¨è§£æ±º
- [ ] pending â†’ exists é·ç§»
- [ ] pending â†’ missing é·ç§»
- [ ] ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒšãƒ¼ã‚¸é·ç§»
- [ ] æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆï¼ˆmissing ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼‰
- [ ] BroadcastChannel çµŒç”±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
- [ ] ãƒšãƒ¼ã‚¸ä¿å­˜å¾Œã®ãƒªãƒ³ã‚¯åŒæœŸ
- [ ] ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®è§£æ±º
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‹•ä½œï¼ˆåŒã˜ãƒªãƒ³ã‚¯ã®å†å…¥åŠ›ï¼‰

---

## ãƒªã‚¹ã‚¯ç®¡ç†

### ãƒªã‚¹ã‚¯è©•ä¾¡ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆæ›´æ–°ç‰ˆï¼‰

| ãƒªã‚¹ã‚¯                        | ç¢ºç‡ | å½±éŸ¿ | å¯¾ç­–                                            | çŠ¶æ…‹ |
| ----------------------------- | ---- | ---- | ----------------------------------------------- | ---- |
| **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å¤±æ•—** âš ï¸       | ä¸­   | é«˜   | parseHTML() æ‹¡å¼µ + migration.test.ts ã§äº‹å‰æ¤œè¨¼ | ğŸŸ¡   |
| **æ—§ãƒ‡ãƒ¼ã‚¿ãŒèªè­˜ã•ã‚Œãªã„** âš ï¸ | ä¸­   | é«˜   | å„ªå…ˆå®Ÿæ–½ + 12 ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼                      | ğŸŸ¡   |
| **å¤‰æ›å¾Œã®ãƒ‡ãƒ¼ã‚¿æå¤±**        | ä½   | é«˜   | æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 0a-0c ã§æ¤œè¨¼                 | ğŸŸ¡   |
| **å¤–éƒ¨ãƒªãƒ³ã‚¯ã®æ‰±ã„**          | ä½   | ä¸­   | ç¾æ™‚ç‚¹ã§ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå°†æ¥å¯¾å¿œï¼‰                  | âš ï¸   |
| ãƒªãƒ³ã‚¯è§£æ±ºãŒå‹•ä½œã—ãªã„        | æ¥µä½ | é«˜   | UnifiedLinkMark ã§æ—¢ã«å®Ÿç¸¾ã‚ã‚Š                  | âœ…   |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–            | ãªã— | ä¸­   | é‡è¤‡å‡¦ç†å‰Šé™¤ã§æ”¹å–„ãŒæœŸå¾…ã•ã‚Œã‚‹                  | âœ…   |
| çŠ¶æ…‹ä¸æ•´åˆ                    | ãªã— | ä¸­   | äºŒé‡çŠ¶æ…‹ç®¡ç†ãŒè§£æ¶ˆã•ã‚Œã‚‹ãŸã‚æ”¹å–„                | âœ…   |
| äºˆæœŸã—ãªã„ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹        | ä½   | ä¸­   | 351 ãƒ†ã‚¹ãƒˆã§ã‚«ãƒãƒ¼ã€ä¸¦è¡Œç¨¼åƒæœŸé–“ã§æ¤œè¨¼æ¸ˆã¿      | âœ…   |
| Plugin Meta ä¾å­˜ã®ç™ºè¦‹        | ä½   | ä½   | grep æ¤œç´¢ã§ç¢ºèªæ¸ˆã¿ã€ä¾å­˜ãªã—                   | âœ…   |
| ensurePageLinksSync ã®å‰¯ä½œç”¨  | æ¥µä½ | ä½   | è¿”ã‚Šå€¤ã®ã¿ä½¿ç”¨ã€å‰Šé™¤ã—ã¦ã‚‚å½±éŸ¿ãªã—              | âœ…   |
| **markId è¡çª** âš ï¸            | æ¥µä½ | ä½   | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã§ä¸€æ„æ€§ç¢ºä¿     | âœ…   |

**ç·åˆãƒªã‚¹ã‚¯è©•ä¾¡**: **ä½ã€œä¸­ - ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å„ªå…ˆå®Ÿæ–½ã™ã‚Œã°å®‰å…¨** ğŸŸ¡

**ãƒªã‚¹ã‚¯è»½æ¸›ç­–**:

1. âœ… Step 0ï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼‰ã‚’æœ€å„ªå…ˆã§å®Ÿæ–½
2. âœ… migration.test.ts ã§äº‹å‰æ¤œè¨¼
3. âœ… æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§å®Ÿãƒ‡ãƒ¼ã‚¿ã®å‹•ä½œç¢ºèª
4. âœ… å¤–éƒ¨ãƒªãƒ³ã‚¯ã¯å°†æ¥å¯¾å¿œï¼ˆç¾æ™‚ç‚¹ã§ã¯å½±éŸ¿å°ï¼‰

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

ä¸‡ãŒä¸€å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:

```bash
# Git ã§å¤‰æ›´ã‚’æˆ»ã™
git checkout HEAD -- app/(protected)/pages/[id]/_hooks/usePageEditorLogic.ts

# useLinkExistenceChecker.ts ã‚’å¾©å…ƒ
git checkout HEAD -- app/(protected)/pages/[id]/_hooks/useLinkExistenceChecker.ts
```

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚é–“**: 1 åˆ†ä»¥å†…

---

## æˆåŠŸåŸºæº–

### å¿…é ˆæ¡ä»¶ï¼ˆæ›´æ–°ç‰ˆï¼‰

#### ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–¢é€£ âš ï¸ NEW

- [ ] âœ… parseHTML() æ‹¡å¼µãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] âœ… migration.test.ts ãŒä½œæˆã•ã‚Œã€å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ12/12ï¼‰
- [ ] âœ… PageLinkMark å½¢å¼ã® `<a>` ã‚¿ã‚°ãŒèªè­˜ã•ã‚Œã‚‹
- [ ] âœ… æ—§ãƒ‡ãƒ¼ã‚¿ãŒ UnifiedLinkMark å½¢å¼ã«è‡ªå‹•å¤‰æ›ã•ã‚Œã‚‹
- [ ] âœ… å¤‰æ›å¾Œã® markId ãŒä¸€æ„ã§ã‚ã‚‹
- [ ] âœ… data-variant å±æ€§ãŒè‡ªå‹•ä»˜ä¸ã•ã‚Œã‚‹

#### ã‚³ãƒ¼ãƒ‰å‰Šé™¤é–¢é€£

- [ ] âœ… å…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆ351/351 = 339 + 12ï¼‰
- [ ] âœ… useLinkExistenceChecker.ts ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] âœ… usePageEditorLogic.ts ã« import æ®‹å­˜ãŒãªã„
- [ ] âœ… existencePluginKey ã¸ã®å‚ç…§ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] âœ… TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„

### å‹•ä½œç¢ºèª

#### ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®ç¢ºèª âš ï¸ NEW

- [ ] âœ… æ—§å½¢å¼ãƒªãƒ³ã‚¯ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰
- [ ] âœ… data-page-id å±æ€§ã‚’æŒã¤ãƒªãƒ³ã‚¯ãŒ UnifiedLinkMark ã¨ã—ã¦èªè­˜
- [ ] âœ… data-page-title å±æ€§ã‚’æŒã¤ãƒªãƒ³ã‚¯ãŒå¤‰æ›ã•ã‚Œã‚‹
- [ ] âœ… å¤‰æ›å¾Œã®ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½
- [ ] âœ… ä¿å­˜å¾Œã€data-variant å±æ€§ãŒæ°¸ç¶šåŒ–
- [ ] âœ… ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚å¤‰æ›ã•ã‚ŒãŸå½¢å¼ãŒç¶­æŒ

#### æ—¢å­˜æ©Ÿèƒ½ã®ç¢ºèª

- [ ] âœ… ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ã® pending â†’ exists/missing é·ç§»
- [ ] âœ… ã‚¿ã‚°ãƒªãƒ³ã‚¯ã®å‹•ä½œ
- [ ] âœ… ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒšãƒ¼ã‚¸é·ç§»
- [ ] âœ… æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆæ©Ÿèƒ½
- [ ] âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆBroadcastChannelï¼‰
- [ ] âœ… ã‚¨ãƒ‡ã‚£ã‚¿ã®å¿œç­”æ€§ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãªã—ï¼‰

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

- [ ] âœ… ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ­ãƒ¼ãƒ‰æ™‚é–“: å¤‰åŒ–ãªã— or æ”¹å–„
- [ ] âœ… ãƒªãƒ³ã‚¯è§£æ±ºé€Ÿåº¦: å¤‰åŒ–ãªã— or æ”¹å–„
- [ ] âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: å¤‰åŒ–ãªã— or æ”¹å–„
- [ ] âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: é‡è¤‡å‰Šé™¤ã«ã‚ˆã‚Šæ¸›å°‘
- [ ] âœ… ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰: æœ€å°é™

---

## å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ›´æ–°ç‰ˆï¼‰

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

| Step | ä½œæ¥­å†…å®¹                                  | æ‰€è¦æ™‚é–“  | æ‹…å½“   | å„ªå…ˆåº¦   |
| ---- | ----------------------------------------- | --------- | ------ | -------- |
| 0.1  | **rendering.ts ã® parseHTML() æ‹¡å¼µ** âš ï¸   | **15 åˆ†** | Dev    | **æœ€é«˜** |
| 0.2  | **migration.test.ts ã®ä½œæˆ** âš ï¸           | **15 åˆ†** | Dev    | **æœ€é«˜** |
| 0.3  | **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ä¿®æ­£** âš ï¸         | **10 åˆ†** | Dev    | **æœ€é«˜** |
| 0.4  | **æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿ç§»è¡Œç¢ºèª** âš ï¸                 | **10 åˆ†** | Dev/QA | **æœ€é«˜** |
| 1    | usePageEditorLogic.ts - import å‰Šé™¤       | 2 åˆ†      | Dev    | é«˜       |
| 2    | usePageEditorLogic.ts - Hook å‘¼ã³å‡ºã—å‰Šé™¤ | 1 åˆ†      | Dev    | é«˜       |
| 3    | usePageEditorLogic.ts - savePage å‡¦ç†å‰Šé™¤ | 2 åˆ†      | Dev    | é«˜       |
| 4    | useLinkExistenceChecker.ts å‰Šé™¤           | 1 åˆ†      | Dev    | é«˜       |
| 5    | TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèª                 | 1 åˆ†      | Dev    | é«˜       |
| 6    | è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ351 ãƒ†ã‚¹ãƒˆï¼‰              | 5 åˆ†      | Dev    | é«˜       |
| 7    | æ‰‹å‹•å‹•ä½œç¢ºèªï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰                  | 10 åˆ†     | Dev/QA | é«˜       |
| 8    | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ                      | 5 åˆ†      | Dev    | ä¸­       |
| 9    | å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ                          | 20 åˆ†     | Dev    | é«˜       |
| -    | **åˆè¨ˆ**                                  | **97 åˆ†** | -      | -        |

**å†…è¨³**:

- **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**: 50 åˆ†ï¼ˆStep 0.1-0.4ï¼‰
- **ã‚³ãƒ¼ãƒ‰å‰Šé™¤**: 7 åˆ†ï¼ˆStep 1-4ï¼‰
- **æ¤œè¨¼**: 20 åˆ†ï¼ˆStep 5-7ï¼‰
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: 20 åˆ†ï¼ˆStep 9ï¼‰

### å®Ÿè£…é †åºï¼ˆä¿®æ­£ç‰ˆï¼‰

```
Phase 3.3 å®Ÿè£…ãƒ•ãƒ­ãƒ¼ï¼ˆæ›´æ–°ç‰ˆï¼‰
â”‚
â”œâ”€ [æœ€å„ªå…ˆ] Step 0: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å®Ÿè£…
â”‚   â”œâ”€ 0.1: rendering.ts ä¿®æ­£ï¼ˆ15åˆ†ï¼‰
â”‚   â”œâ”€ 0.2: migration.test.ts ä½œæˆï¼ˆ15åˆ†ï¼‰
â”‚   â”œâ”€ 0.3: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ä¿®æ­£ï¼ˆ10åˆ†ï¼‰
â”‚   â””â”€ 0.4: æ‰‹å‹•ç¢ºèªï¼ˆ10åˆ†ï¼‰
â”‚
â”œâ”€ [1] æº–å‚™
â”‚   â”œâ”€ ãƒ–ãƒ©ãƒ³ãƒç¢ºèª: feature/unified-link-migration-and-tdd
â”‚   â”œâ”€ æœ€æ–°ã‚³ãƒŸãƒƒãƒˆå–å¾—
â”‚   â””â”€ å®Ÿè£…è¨ˆç”»æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ âœ…
â”‚
â”œâ”€ [2] ã‚³ãƒ¼ãƒ‰å‰Šé™¤
â”‚   â”œâ”€ usePageEditorLogic.ts ä¿®æ­£ï¼ˆ3ç®‡æ‰€ï¼‰
â”‚   â””â”€ useLinkExistenceChecker.ts å‰Šé™¤
â”‚
â”œâ”€ [3] æ¤œè¨¼
â”‚   â”œâ”€ TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
â”‚   â”œâ”€ è‡ªå‹•ãƒ†ã‚¹ãƒˆï¼ˆ339ãƒ†ã‚¹ãƒˆï¼‰
â”‚   â””â”€ æ‰‹å‹•å‹•ä½œç¢ºèª
â”‚
â””â”€ [4] å®Œäº†
    â”œâ”€ å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    â”œâ”€ Git ã‚³ãƒŸãƒƒãƒˆ
    â””â”€ Phase 3.4 æº–å‚™
```

---

## Phase 3.4 ã¸ã®å½±éŸ¿

### Phase 3.3 å®Œäº†å¾Œã®çŠ¶æ…‹

```
Before Phase 3.3:
â”œâ”€â”€ useLinkExistenceChecker.ts (78è¡Œ)
â”œâ”€â”€ usePageEditorLogic.ts
â”‚   â”œâ”€â”€ import existencePluginKey
â”‚   â”œâ”€â”€ import useLinkExistenceChecker
â”‚   â”œâ”€â”€ useLinkExistenceChecker() å‘¼ã³å‡ºã—
â”‚   â””â”€â”€ existencePluginKey ä½¿ç”¨ï¼ˆsavePageï¼‰
â””â”€â”€ page-link.ts
    â””â”€â”€ export existencePluginKey

After Phase 3.3:
â”œâ”€â”€ useLinkExistenceChecker.ts â† âŒ å‰Šé™¤æ¸ˆã¿
â”œâ”€â”€ usePageEditorLogic.ts
â”‚   â”œâ”€â”€ import existencePluginKey â† âŒ å‰Šé™¤æ¸ˆã¿
â”‚   â”œâ”€â”€ import useLinkExistenceChecker â† âŒ å‰Šé™¤æ¸ˆã¿
â”‚   â”œâ”€â”€ useLinkExistenceChecker() â† âŒ å‰Šé™¤æ¸ˆã¿
â”‚   â””â”€â”€ existencePluginKey ä½¿ç”¨ â† âŒ å‰Šé™¤æ¸ˆã¿
â””â”€â”€ page-link.ts
    â””â”€â”€ export existencePluginKey â† å‚ç…§ãªã—ï¼ˆå‰Šé™¤æº–å‚™å®Œäº†ï¼‰
```

### Phase 3.4 ã®ä½œæ¥­ç°¡ç•¥åŒ–

#### Before Phase 3.3ï¼ˆå¾“æ¥è¨ˆç”»ï¼‰

```
Phase 3.4 å‰Šé™¤å¯¾è±¡:
â”œâ”€â”€ page-link.ts (446è¡Œ)
â”œâ”€â”€ existencePluginKeyï¼ˆå‚ç…§ç®‡æ‰€ã‚’ä¿®æ­£å¿…è¦ï¼‰
â”‚   â”œâ”€â”€ useLinkExistenceChecker.ts â† è¦ä¿®æ­£
â”‚   â””â”€â”€ usePageEditorLogic.ts â† è¦ä¿®æ­£
â””â”€â”€ useLinkExistenceChecker.ts â† è¦å‰Šé™¤
```

#### After Phase 3.3ï¼ˆç°¡ç•¥åŒ–å¾Œï¼‰

```
Phase 3.4 å‰Šé™¤å¯¾è±¡:
â””â”€â”€ page-link.ts (446è¡Œ) ã®ã¿
    â””â”€â”€ existencePluginKey â† å‚ç…§ç®‡æ‰€ãªã—ã€å®‰å…¨ã«å‰Šé™¤å¯èƒ½ âœ…
```

**å‰Šæ¸›ã•ã‚ŒãŸä½œæ¥­**:

- existencePluginKey ã®ä»£æ›¿å®Ÿè£…ãŒä¸è¦
- useLinkExistenceChecker ã®ä¿®æ­£ãŒä¸è¦
- usePageEditorLogic ã®ä¿®æ­£ãŒä¸è¦
- Phase 3.4 ãŒã‚·ãƒ³ãƒ—ãƒ«ãªå‰Šé™¤ä½œæ¥­ã®ã¿ã«ãªã‚‹

---

## æŠ€è¡“çš„ãªå­¦ã³

### 1. é‡è¤‡æ©Ÿèƒ½ã®æ¤œå‡ºæ–¹æ³•

**æ•™è¨“**: ä¸¦è¡Œç¨¼åƒæœŸé–“ä¸­ã«ä»¥ä¸‹ã‚’è¦³å¯Ÿ

- ä¸¡ã‚·ã‚¹ãƒ†ãƒ ã®å‡ºåŠ›ã‚’æ¯”è¼ƒ
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§å‡¦ç†å›æ•°ã‚’è¨ˆæ¸¬
- ä¸€æ–¹ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ†ã‚¹ãƒˆ

### 2. çŠ¶æ…‹ç®¡ç†ã®è¨­è¨ˆ

**Plugin Meta vs Mark å±æ€§**:

| ç‰¹æ€§           | Plugin Meta | Mark å±æ€§ |
| -------------- | ----------- | --------- |
| æ°¸ç¶šæ€§         | âŒ æ®ç™ºæ€§   | âœ… æ°¸ç¶šçš„ |
| ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º   | âŒ ä¸å¯     | âœ… å¯èƒ½   |
| æ¤œç´¢æ€§         | âŒ ä½       | âœ… é«˜     |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | âœ… é«˜é€Ÿ     | â—‹ è‰¯å¥½    |

**æ¨å¥¨**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹çŠ¶æ…‹ã¯ Mark å±æ€§ã§ç®¡ç†

### 3. æ®µéšçš„å‰Šé™¤ã®é‡è¦æ€§

```
Phase 3.1-3.2: æ–°æ©Ÿèƒ½è¿½åŠ  + ä¸¦è¡Œç¨¼åƒ
     â†“
Phase 3.3: é‡è¤‡æ©Ÿèƒ½å‰Šé™¤ï¼ˆä¾å­˜ã‚’åˆ‡æ–­ï¼‰
     â†“
Phase 3.4: æœ¬ä½“å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
```

**åˆ©ç‚¹**:

- å„ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒªã‚¹ã‚¯ãŒåˆ†æ•£
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®¹æ˜“
- æ®µéšçš„ãªæ¤œè¨¼ãŒå¯èƒ½

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### Phase 3 é–¢é€£

- [Phase 3 å®Ÿè£…è¨ˆç”»æ›¸](./20251012_10_phase3-click-handler-migration-plan.md) - å…¨ä½“è¨ˆç”»
- [Phase 3.2 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](../../../08_worklogs/2025_10/20251012/20251012_12_phase3.2-implementation-complete.md) - å‰ãƒ•ã‚§ãƒ¼ã‚º
- [Phase 3.3 èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ](../../../08_worklogs/2025_10/20251012/20251012_24_phase3.3-investigation-report.md) - æœ¬å®Ÿè£…ã®èª¿æŸ»

### è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [UnifiedLinkMark ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»](./20251011_08_refactoring-plan.md)
- [ç§»è¡Œè¨ˆç”»æ›¸](./20251011_07_migration-plan.md)

### ãƒ†ã‚¹ãƒˆé–¢é€£

- [Integration Test æœ€é©åŒ–](./20251012_12_integration-test-optimization.md)

---

## ä»˜éŒ²

### A. å‰Šé™¤ã‚³ãƒ¼ãƒ‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

å‰Šé™¤å‰ã« Git ã§ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¦ãŠãã“ã¨ã‚’æ¨å¥¨ã€‚

```bash
# ä½œæ¥­å‰ã®ã‚³ãƒŸãƒƒãƒˆ
git add -A
git commit -m "chore: prepare for Phase 3.3 - useLinkExistenceChecker removal"

# å®Ÿè£…
# ... ã‚³ãƒ¼ãƒ‰å‰Šé™¤ ...

# å®Ÿè£…å¾Œã®ã‚³ãƒŸãƒƒãƒˆ
git add -A
git commit -m "feat: Phase 3.3 complete - remove useLinkExistenceChecker

- Remove useLinkExistenceChecker.ts (78 lines)
- Remove existencePluginKey usage from usePageEditorLogic.ts
- Remove duplicate link existence checking logic
- UnifiedLinkMark now handles all link resolution

BREAKING CHANGE: useLinkExistenceChecker hook removed
All link existence checking is now handled by UnifiedLinkMark's
automatic resolver with BroadcastChannel support.

Refs: #[issue-number]"
```

### B. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

#### ã‚±ãƒ¼ã‚¹ 1: ãƒ†ã‚¹ãƒˆå¤±æ•—

```bash
# ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆ
bun test | tee test-output.log

# å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’åˆ†æ
grep -A 10 "FAIL" test-output.log

# åŸå› èª¿æŸ»
# - UnifiedLinkMark ã®å‹•ä½œç¢ºèª
# - å‰Šé™¤ç®‡æ‰€ã®å†ç¢ºèª
# - ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
```

#### ã‚±ãƒ¼ã‚¹ 2: TypeScript ã‚¨ãƒ©ãƒ¼

```bash
# å‹ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
npx tsc --noEmit

# ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼
# - existencePluginKey ã® import æ®‹å­˜
# - useLinkExistenceChecker ã®å‹å‚ç…§æ®‹å­˜
```

#### ã‚±ãƒ¼ã‚¹ 3: å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼

```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª
// - "existencePluginKey is not defined"
// - "useLinkExistenceChecker is not a function"

// â†’ å‰Šé™¤æ¼ã‚ŒãŒã‚ã‚‹å¯èƒ½æ€§
// â†’ grep æ¤œç´¢ã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
```

### C. æ¤œè¨¼ç”¨ SQL ã‚¯ã‚¨ãƒª

UnifiedLinkMark ã®å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã® SQL:

```sql
-- ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã®çŠ¶æ…‹ç¢ºèª
SELECT
  p.id,
  p.title,
  p.content->>'type' as content_type
FROM pages p
WHERE p.content::text LIKE '%unilink%'
LIMIT 10;

-- note_page_links ã®æ•´åˆæ€§ç¢ºèª
SELECT
  npl.note_id,
  npl.page_id,
  p.title
FROM note_page_links npl
JOIN pages p ON p.id = npl.page_id
WHERE npl.created_at > NOW() - INTERVAL '1 hour';
```

---

**ä½œæˆæ—¥**: 2025-10-12  
**æœ€çµ‚æ›´æ–°**: 2025-10-12  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…æº–å‚™å®Œäº† âœ…  
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: å®Ÿè£…é–‹å§‹ â†’ ãƒ†ã‚¹ãƒˆ â†’ å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ â†’ Phase 3.4

---
