# Phase 3.4 å®Ÿè£…è¨ˆç”»æ›¸: PageLink Extension å®Œå…¨å‰Šé™¤

**ä½œæˆæ—¥**: 2025-10-12  
**æœ€çµ‚æ›´æ–°**: 2025-10-12  
**Phase**: 3.4 - PageLink Extension ã®å®Œå…¨å‰Šé™¤  
**ç›®çš„**: PageLink Extension ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã€UnifiedLinkMark ã¸ã®ç§»è¡Œã‚’å®Œäº†  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…æº–å‚™å®Œäº† - è¨ˆç”»ä½œæˆä¸­

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

Phase 3.3 ã§ `useLinkExistenceChecker` ã®å‰Šé™¤ã¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚Phase 3.4 ã§ã¯ã€**PageLink Extension ã®å®Œå…¨å‰Šé™¤**ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

### ä¸»è¦ãªåˆ¤æ–­

- **Phase 3.3 å®Œäº†çŠ¶æ³**: useLinkExistenceChecker å‰Šé™¤æ¸ˆã¿ã€ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½å®Ÿè£…æ¸ˆã¿
- **ä¾å­˜ç®‡æ‰€**: 2 ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼ˆusePageEditorLogic.tsã€rich-content.tsxï¼‰
- **å‰Šé™¤å¯¾è±¡**: page-link.ts (446 è¡Œ)
- **å®‰å…¨æ€§**: Phase 3.1-3.2 ã§ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼æ©Ÿèƒ½ã¯ UnifiedLinkMark ã«ç§»è¡Œæ¸ˆã¿
- **ãƒªã‚¹ã‚¯**: Phase 3.3 ã§ä¾å­˜ã‚’åˆ‡æ–­æ¸ˆã¿ã®ãŸã‚æ¥µå°

---

## ç›®æ¬¡

1. [èƒŒæ™¯ã¨ç›®çš„](#èƒŒæ™¯ã¨ç›®çš„)
2. [ç¾çŠ¶åˆ†æ](#ç¾çŠ¶åˆ†æ)
3. [å®Ÿè£…è¨ˆç”»](#å®Ÿè£…è¨ˆç”»)
4. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
5. [ãƒªã‚¹ã‚¯ç®¡ç†](#ãƒªã‚¹ã‚¯ç®¡ç†)
6. [æˆåŠŸåŸºæº–](#æˆåŠŸåŸºæº–)

---

## èƒŒæ™¯ã¨ç›®çš„

### Phase 3.4 ã®ä½ç½®ã¥ã‘

```
Phase 3: PageLink Extension å®Œå…¨å‰Šé™¤
â”œâ”€â”€ Phase 3.1: ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç§»è¡Œ âœ… å®Œäº†
â”œâ”€â”€ Phase 3.2: DOM ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼çµ±åˆ âœ… å®Œäº†
â”œâ”€â”€ Phase 3.3: useLinkExistenceChecker å‰Šé™¤ âœ… å®Œäº†
â””â”€â”€ Phase 3.4: PageLink Extension å‰Šé™¤ â† **ä»Šã“ã“**
```

### ç›®çš„

1. **PageLink Extension ã®å®Œå…¨å‰Šé™¤**: page-link.ts ã®å‰Šé™¤
2. **ä¾å­˜ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°**: usePageEditorLogic.tsã€rich-content.tsx ã®ä¿®æ­£
3. **ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ç°¡æ½”åŒ–**: 446 è¡Œã®ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰å‰Šé™¤
4. **ç§»è¡Œã®å®Œäº†**: UnifiedLinkMark ã¸ã®å®Œå…¨ç§»è¡Œ

---

## ç¾çŠ¶åˆ†æ

### 1. å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

#### â‘  page-link.ts

**ãƒ‘ã‚¹**: `lib/tiptap-extensions/page-link.ts`  
**è¡Œæ•°**: 446 è¡Œ  
**å†…å®¹**:

- PageLink Extension æœ¬ä½“
- handleClick() - ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆPhase 3.1-3.2 ã§ UnifiedLinkMark ã«ç§»è¡Œæ¸ˆã¿ï¼‰
- handleDOMEvents.click - DOM ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆPhase 3.1-3.2 ã§ UnifiedLinkMark ã«ç§»è¡Œæ¸ˆã¿ï¼‰
- existencePluginKey - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚­ãƒ¼ï¼ˆPhase 3.3 ã§å‰Šé™¤æ¸ˆã¿ï¼‰
- Decoration ãƒ™ãƒ¼ã‚¹ã®ãƒªãƒ³ã‚¯è¡¨ç¤ºï¼ˆPageLinkMark ã«ç½®ãæ›ãˆæ¸ˆã¿ï¼‰

**å‰Šé™¤ã®æ ¹æ‹ **:

- ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒ UnifiedLinkMark ã¾ãŸã¯ PageLinkMark ã«ç§»è¡Œæ¸ˆã¿
- Phase 3.3 ã§ä¾å­˜é–¢ä¿‚ã‚’å®Œå…¨ã«åˆ‡æ–­æ¸ˆã¿

### 2. ä¾å­˜ã—ã¦ã„ã‚‹ç®‡æ‰€

#### â‘  usePageEditorLogic.ts

**ãƒ‘ã‚¹**: `app/(protected)/pages/[id]/_hooks/usePageEditorLogic.ts`

**ä½¿ç”¨ç®‡æ‰€**:

```typescript
// Line 10: import
import { PageLink } from "@/lib/tiptap-extensions/page-link"; // legacy (Decoration based)

// Line 209: extensionsé…åˆ—
PageLink.configure({ noteSlug }), // TODO: remove after full migration to PageLinkMark
```

**å‰Šé™¤å†…å®¹**:

1. import æ–‡ã®å‰Šé™¤
2. extensions é…åˆ—ã‹ã‚‰ PageLink.configure({ noteSlug }) ã®å‰Šé™¤

#### â‘¡ rich-content.tsx

**ãƒ‘ã‚¹**: `app/(protected)/decks/[deckId]/_components/rich-content.tsx`

**ä½¿ç”¨ç®‡æ‰€**:

```typescript
// Line 4: import
import { PageLink } from "@/lib/tiptap-extensions/page-link";

// Line 94: extensionsé…åˆ—
PageLink,
```

**å‰Šé™¤å†…å®¹**:

1. import æ–‡ã®å‰Šé™¤
2. extensions é…åˆ—ã‹ã‚‰ PageLink ã®å‰Šé™¤
3. UnifiedLinkMark ã®è¿½åŠ 

### 3. ä¾å­˜é–¢ä¿‚ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒ•ã‚¡ã‚¤ãƒ«              | ä½¿ç”¨ç®‡æ‰€                 | å‰Šé™¤å†…å®¹                      | ä»£æ›¿æ©Ÿèƒ½        |
| --------------------- | ------------------------ | ----------------------------- | --------------- |
| usePageEditorLogic.ts | import + extensions é…åˆ— | import å‰Šé™¤ + é…åˆ—ã‹ã‚‰å‰Šé™¤    | UnifiedLinkMark |
| rich-content.tsx      | import + extensions é…åˆ— | import å‰Šé™¤ + UnifiedLinkMark | UnifiedLinkMark |
| page-link.ts          | ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ (446 è¡Œ)    | ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤                  | N/A             |

---

## å®Ÿè£…è¨ˆç”»

### å®Ÿè£…ã®å…¨ä½“åƒ

```
Phase 3.4 å®Ÿè£…ãƒ•ãƒ­ãƒ¼
â”‚
â”œâ”€ Step 1: usePageEditorLogic.ts ã®æ›´æ–°
â”‚   â”œâ”€ 1.1: import æ–‡ã®å‰Šé™¤
â”‚   â””â”€ 1.2: extensions é…åˆ—ã‹ã‚‰ PageLink å‰Šé™¤
â”‚
â”œâ”€ Step 2: rich-content.tsx ã®æ›´æ–°
â”‚   â”œâ”€ 2.1: import æ–‡ã®å‰Šé™¤
â”‚   â”œâ”€ 2.2: extensions é…åˆ—ã‹ã‚‰ PageLink å‰Šé™¤
â”‚   â””â”€ 2.3: UnifiedLinkMark ã®è¿½åŠ 
â”‚
â”œâ”€ Step 3: page-link.ts ã®å‰Šé™¤
â”‚   â””â”€ 3.1: ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
â”‚
â””â”€ Step 4: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆ
    â”œâ”€ 4.1: TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
    â”œâ”€ 4.2: è‡ªå‹•ãƒ†ã‚¹ãƒˆ (482ãƒ†ã‚¹ãƒˆ)
    â””â”€ 4.3: æ‰‹å‹•å‹•ä½œç¢ºèª

åˆè¨ˆä½œæ¥­æ™‚é–“: ç´„ 30åˆ†
```

---

## Step 1: usePageEditorLogic.ts ã®æ›´æ–°

### 1.1 import æ–‡ã®å‰Šé™¤

**å‰Šé™¤ç®‡æ‰€**: Line 10

```typescript
// å‰Šé™¤å‰
import { CustomHeading } from "@/lib/tiptap-extensions/custom-heading";
import {
  CustomBulletList,
  CustomOrderedList,
} from "@/lib/tiptap-extensions/custom-list";
import { TableExtensions } from "@/lib/tiptap-extensions/custom-table";
import { GyazoImage } from "@/lib/tiptap-extensions/gyazo-image";
import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { LatexInlineNode } from "@/lib/tiptap-extensions/latex-inline-node";
import { PageLink } from "@/lib/tiptap-extensions/page-link"; // legacy (Decoration based)  â† å‰Šé™¤
import { PageLinkMark } from "@/lib/tiptap-extensions/page-link-mark"; // new Mark-based implementation
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";

// å‰Šé™¤å¾Œ
import { CustomHeading } from "@/lib/tiptap-extensions/custom-heading";
import {
  CustomBulletList,
  CustomOrderedList,
} from "@/lib/tiptap-extensions/custom-list";
import { TableExtensions } from "@/lib/tiptap-extensions/custom-table";
import { GyazoImage } from "@/lib/tiptap-extensions/gyazo-image";
import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { LatexInlineNode } from "@/lib/tiptap-extensions/latex-inline-node";
import { PageLinkMark } from "@/lib/tiptap-extensions/page-link-mark"; // new Mark-based implementation
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";
```

### 1.2 extensions é…åˆ—ã‹ã‚‰ PageLink å‰Šé™¤

**å‰Šé™¤ç®‡æ‰€**: Line 209

```typescript
// å‰Šé™¤å‰
    extensions: [
      StarterKit.configure({
        heading: false,
        bulletList: false,
        orderedList: false,
        codeBlock: false,
      }),
      // Unified Link Mark comes first to handle both [Title] and #tag syntax
      UnifiedLinkMark,
      // New Mark implementation comes before legacy PageLink to ensure mark rendering precedence
      PageLinkMark,
      CustomHeading.configure({ levels: [2, 3, 4, 5, 6] }),
      CustomBulletList,
      CustomOrderedList,
      GyazoImage,
      PageLink.configure({ noteSlug }), // TODO: remove after full migration to PageLinkMark  â† å‰Šé™¤
      LatexInlineNode,
      Highlight,
      CodeBlockWithCopy.configure({
        defaultLanguage: "javascript",
      }),
      // Table extensions for Markdown table support
      ...TableExtensions,
      // Code blocks highlighted via Prism
      // Prism highlighting is applied on editor updates
      Placeholder.configure({
        placeholder: "ãƒšãƒ¼ã‚¸å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        includeChildren: true,
      }),
    ],

// å‰Šé™¤å¾Œ
    extensions: [
      StarterKit.configure({
        heading: false,
        bulletList: false,
        orderedList: false,
        codeBlock: false,
      }),
      // Unified Link Mark comes first to handle both [Title] and #tag syntax
      UnifiedLinkMark,
      // New Mark implementation comes before legacy PageLink to ensure mark rendering precedence
      PageLinkMark,
      CustomHeading.configure({ levels: [2, 3, 4, 5, 6] }),
      CustomBulletList,
      CustomOrderedList,
      GyazoImage,
      LatexInlineNode,
      Highlight,
      CodeBlockWithCopy.configure({
        defaultLanguage: "javascript",
      }),
      // Table extensions for Markdown table support
      ...TableExtensions,
      // Code blocks highlighted via Prism
      // Prism highlighting is applied on editor updates
      Placeholder.configure({
        placeholder: "ãƒšãƒ¼ã‚¸å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        includeChildren: true,
      }),
    ],
```

---

## Step 2: rich-content.tsx ã®æ›´æ–°

### 2.1 import æ–‡ã®å‰Šé™¤ã¨ UnifiedLinkMark ã®è¿½åŠ 

**å‰Šé™¤ãƒ»è¿½åŠ ç®‡æ‰€**: Line 3-4

```typescript
// å‰Šé™¤å‰
"use client";

import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { PageLink } from "@/lib/tiptap-extensions/page-link";  â† å‰Šé™¤
import type { JSONContent } from "@tiptap/core";
import Image from "@tiptap/extension-image";
import LinkExtension from "@tiptap/extension-link";

// å‰Šé™¤å¾Œ
"use client";

import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";  â† è¿½åŠ 
import type { JSONContent } from "@tiptap/core";
import Image from "@tiptap/extension-image";
import LinkExtension from "@tiptap/extension-link";
```

### 2.2 extensions é…åˆ—ã®æ›´æ–°

**å‰Šé™¤ãƒ»è¿½åŠ ç®‡æ‰€**: Line 94

```typescript
// å‰Šé™¤å‰
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        // å¿…è¦ã«å¿œã˜ã¦StarterKitã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
      }),
      LinkExtension.configure({
        HTMLAttributes: { className: "text-blue-500 underline" },
        openOnClick: false,
        autolink: true,
      }),
      Image.configure({
        inline: false,
      }),
      TextAlign.configure({
        types: ["heading", "paragraph"],
      }),
      Typography,
      PageLink,  â† å‰Šé™¤
      Highlight,
    ],
    editable: false,
    content: processedDoc,
    editorProps: {},
  });

// å‰Šé™¤å¾Œ
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        // å¿…è¦ã«å¿œã˜ã¦StarterKitã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
      }),
      LinkExtension.configure({
        HTMLAttributes: { className: "text-blue-500 underline" },
        openOnClick: false,
        autolink: true,
      }),
      Image.configure({
        inline: false,
      }),
      TextAlign.configure({
        types: ["heading", "paragraph"],
      }),
      Typography,
      UnifiedLinkMark,  â† è¿½åŠ 
      Highlight,
    ],
    editable: false,
    content: processedDoc,
    editorProps: {},
  });
```

---

## Step 3: page-link.ts ã®å‰Šé™¤

### 3.1 ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm lib/tiptap-extensions/page-link.ts
```

**å‰Šé™¤å†…å®¹**:

- ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“: 446 è¡Œ
- PageLink Extension ã®ã™ã¹ã¦ã®æ©Ÿèƒ½

---

## Step 4: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆ

### 4.1 TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx tsc --noEmit
```

**æœŸå¾…çµæœ**:

- âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—
- âŒ ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã° import æ¼ã‚Œã‚„å‚ç…§æ¼ã‚Œã‚’ç¢ºèª

### 4.2 è‡ªå‹•ãƒ†ã‚¹ãƒˆ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
bun test

# UnifiedLinkMark é–¢é€£ãƒ†ã‚¹ãƒˆã®ã¿
bun test lib/tiptap-extensions/unified-link-mark
```

**æœŸå¾…çµæœ**:

- âœ… æ—¢å­˜ãƒ†ã‚¹ãƒˆ 482/482 æˆåŠŸ
- âœ… UnifiedLinkMark ãƒ†ã‚¹ãƒˆ 351/351 æˆåŠŸ

### 4.3 æ‰‹å‹•å‹•ä½œç¢ºèª

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 1: ãƒšãƒ¼ã‚¸ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®ãƒªãƒ³ã‚¯æ©Ÿèƒ½

```
1. ãƒšãƒ¼ã‚¸ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã
2. [æ–°ã—ã„ãƒšãƒ¼ã‚¸] ã¨å…¥åŠ›
3. æœŸå¾…: pending â†’ missing/exists ã«é·ç§»
4. ã‚¯ãƒªãƒƒã‚¯: ãƒšãƒ¼ã‚¸é·ç§»ã¾ãŸã¯æ–°è¦ä½œæˆ
```

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 2: rich-content ã§ã®ãƒªãƒ³ã‚¯è¡¨ç¤º

```
1. ãƒ‡ãƒƒã‚­ã®å•é¡Œã‚«ãƒ¼ãƒ‰è¡¨ç¤º
2. ãƒªãƒ³ã‚¯ã‚’å«ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
3. æœŸå¾…: ãƒªãƒ³ã‚¯ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
4. ã‚¯ãƒªãƒƒã‚¯: ãƒšãƒ¼ã‚¸é·ç§»
```

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª 3: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®ç¢ºèª

```
1. æ—§ PageLinkMark å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. æœŸå¾…: UnifiedLinkMark ã¨ã—ã¦èªè­˜
3. ãƒªãƒ³ã‚¯å‹•ä½œ: æ­£å¸¸ã«ã‚¯ãƒªãƒƒã‚¯ãƒ»é·ç§»
```

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. è‡ªå‹•ãƒ†ã‚¹ãƒˆ

#### æ—¢å­˜ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
bun test
```

**æœŸå¾…çµæœ**:

- âœ… 482/482 ãƒ†ã‚¹ãƒˆæˆåŠŸ
- âŒ å¤±æ•—ãƒ†ã‚¹ãƒˆãŒã‚ã‚Œã°åŸå› èª¿æŸ»

#### UnifiedLinkMark ãƒ†ã‚¹ãƒˆ

```bash
# UnifiedLinkMark é–¢é€£ãƒ†ã‚¹ãƒˆã®ã¿
bun test lib/tiptap-extensions/unified-link-mark
```

**æœŸå¾…çµæœ**:

- âœ… 351/351 ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ†ã‚¹ãƒˆå«ã‚€ï¼‰

### 2. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

#### å›å¸°ãƒ†ã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ `[Title]` ã®å…¥åŠ›ã¨è§£æ±º
- [ ] ã‚¿ã‚°ãƒªãƒ³ã‚¯ `#tag` ã®å…¥åŠ›ã¨è§£æ±º
- [ ] pending â†’ exists é·ç§»
- [ ] pending â†’ missing é·ç§»
- [ ] ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒšãƒ¼ã‚¸é·ç§»
- [ ] æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆï¼ˆmissing ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼‰
- [ ] BroadcastChannel çµŒç”±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
- [ ] ãƒšãƒ¼ã‚¸ä¿å­˜å¾Œã®ãƒªãƒ³ã‚¯åŒæœŸ
- [ ] ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®è§£æ±º
- [ ] rich-content ã§ã®ãƒªãƒ³ã‚¯è¡¨ç¤º

---

## ãƒªã‚¹ã‚¯ç®¡ç†

### ãƒªã‚¹ã‚¯è©•ä¾¡ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒªã‚¹ã‚¯                    | ç¢ºç‡ | å½±éŸ¿ | å¯¾ç­–                                     | çŠ¶æ…‹ |
| ------------------------- | ---- | ---- | ---------------------------------------- | ---- |
| PageLink ã¸ã®å‚ç…§æ®‹å­˜     | ä½   | é«˜   | grep æ¤œç´¢ã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿        | âœ…   |
| UnifiedLinkMark ã®ä¸å…·åˆ  | æ¥µä½ | é«˜   | Phase 3.1-3.2 ã§å®Ÿç¸¾ã‚ã‚Šã€351 ãƒ†ã‚¹ãƒˆæˆåŠŸ | âœ…   |
| ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®ä¸å…·åˆ        | æ¥µä½ | ä¸­   | Phase 3.3 ã§å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆæ¸ˆã¿             | âœ…   |
| rich-content ã§ã®è¡¨ç¤ºå•é¡Œ | ä½   | ä¸­   | æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§ç¢ºèª                         | ğŸŸ¡   |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–        | ãªã— | ä½   | PageLink å‰Šé™¤ã§æ”¹å–„ãŒæœŸå¾…ã•ã‚Œã‚‹          | âœ…   |

**ç·åˆãƒªã‚¹ã‚¯è©•ä¾¡**: **æ¥µä½ - Phase 3.3 ã§ä¾å­˜ã‚’å®Œå…¨ã«åˆ‡æ–­æ¸ˆã¿** âœ…

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

ä¸‡ãŒä¸€å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:

```bash
# Git ã§å¤‰æ›´ã‚’æˆ»ã™
git checkout HEAD -- app/(protected)/pages/[id]/_hooks/usePageEditorLogic.ts
git checkout HEAD -- app/(protected)/decks/[deckId]/_components/rich-content.tsx
git checkout HEAD -- lib/tiptap-extensions/page-link.ts
```

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚é–“**: 1 åˆ†ä»¥å†…

---

## æˆåŠŸåŸºæº–

### å¿…é ˆæ¡ä»¶ âœ…

#### ã‚³ãƒ¼ãƒ‰å‰Šé™¤é–¢é€£

- [ ] âœ… page-link.ts ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] âœ… usePageEditorLogic.ts ã« PageLink ã® import ãŒãªã„
- [ ] âœ… usePageEditorLogic.ts ã® extensions é…åˆ—ã« PageLink ãŒãªã„
- [ ] âœ… rich-content.tsx ã« PageLink ã® import ãŒãªã„
- [ ] âœ… rich-content.tsx ã® extensions é…åˆ—ã« UnifiedLinkMark ãŒã‚ã‚‹
- [ ] âœ… TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„

#### ãƒ†ã‚¹ãƒˆé–¢é€£

- [ ] âœ… å…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆæˆåŠŸ (482/482)
- [ ] âœ… UnifiedLinkMark ãƒ†ã‚¹ãƒˆæˆåŠŸ (351/351)

### å‹•ä½œç¢ºèª

#### æ—¢å­˜æ©Ÿèƒ½ã®ç¢ºèª

- [ ] âœ… ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ã® pending â†’ exists/missing é·ç§»
- [ ] âœ… ã‚¿ã‚°ãƒªãƒ³ã‚¯ã®å‹•ä½œ
- [ ] âœ… ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒšãƒ¼ã‚¸é·ç§»
- [ ] âœ… æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆæ©Ÿèƒ½
- [ ] âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° (BroadcastChannel)
- [ ] âœ… ã‚¨ãƒ‡ã‚£ã‚¿ã®å¿œç­”æ€§ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãªã—ï¼‰

#### rich-content ã§ã®ç¢ºèª

- [ ] âœ… ãƒªãƒ³ã‚¯ã®æ­£å¸¸ãªè¡¨ç¤º
- [ ] âœ… ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
- [ ] âœ… ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¾Œã®è¡¨ç¤º

---

## å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

| Step | ä½œæ¥­å†…å®¹                                | æ‰€è¦æ™‚é–“  | æ‹…å½“   | å„ªå…ˆåº¦ |
| ---- | --------------------------------------- | --------- | ------ | ------ |
| 1.1  | usePageEditorLogic.ts - import å‰Šé™¤     | 1 åˆ†      | Dev    | é«˜     |
| 1.2  | usePageEditorLogic.ts - extensions æ›´æ–° | 1 åˆ†      | Dev    | é«˜     |
| 2.1  | rich-content.tsx - import æ›´æ–°          | 1 åˆ†      | Dev    | é«˜     |
| 2.2  | rich-content.tsx - extensions æ›´æ–°      | 1 åˆ†      | Dev    | é«˜     |
| 3.1  | page-link.ts å‰Šé™¤                       | 1 åˆ†      | Dev    | é«˜     |
| 4.1  | TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèª               | 1 åˆ†      | Dev    | é«˜     |
| 4.2  | è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (482 ãƒ†ã‚¹ãƒˆ)             | 5 åˆ†      | Dev    | é«˜     |
| 4.3  | æ‰‹å‹•å‹•ä½œç¢ºèª                            | 10 åˆ†     | Dev/QA | é«˜     |
| 5    | å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ                        | 10 åˆ†     | Dev    | é«˜     |
| -    | **åˆè¨ˆ**                                | **32 åˆ†** | -      | -      |

### å®Ÿè£…é †åº

```
Phase 3.4 å®Ÿè£…ãƒ•ãƒ­ãƒ¼
â”‚
â”œâ”€ [1] æº–å‚™
â”‚   â”œâ”€ ãƒ–ãƒ©ãƒ³ãƒç¢ºèª: feature/unified-link-migration-and-tdd
â”‚   â”œâ”€ æœ€æ–°ã‚³ãƒŸãƒƒãƒˆå–å¾—
â”‚   â””â”€ å®Ÿè£…è¨ˆç”»æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ âœ…
â”‚
â”œâ”€ [2] ã‚³ãƒ¼ãƒ‰æ›´æ–°
â”‚   â”œâ”€ usePageEditorLogic.ts ä¿®æ­£ (2ç®‡æ‰€)
â”‚   â””â”€ rich-content.tsx ä¿®æ­£ (2ç®‡æ‰€)
â”‚
â”œâ”€ [3] ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
â”‚   â””â”€ page-link.ts å‰Šé™¤
â”‚
â”œâ”€ [4] æ¤œè¨¼
â”‚   â”œâ”€ TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
â”‚   â”œâ”€ è‡ªå‹•ãƒ†ã‚¹ãƒˆ (482ãƒ†ã‚¹ãƒˆ)
â”‚   â””â”€ æ‰‹å‹•å‹•ä½œç¢ºèª
â”‚
â””â”€ [5] å®Œäº†
    â”œâ”€ å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    â””â”€ Git ã‚³ãƒŸãƒƒãƒˆ
```

---

## Phase 3 ã®å®Œäº†

### Phase 3 å…¨ä½“ã®æˆæœ

Phase 3.4 ã®å®Œäº†ã«ã‚ˆã‚Šã€Phase 3 å…¨ä½“ãŒå®Œäº†ã—ã¾ã™ã€‚

```
Phase 3: PageLink Extension å®Œå…¨å‰Šé™¤
â”œâ”€â”€ Phase 3.1: ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç§»è¡Œ âœ… å®Œäº†
â”œâ”€â”€ Phase 3.2: DOM ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼çµ±åˆ âœ… å®Œäº†
â”œâ”€â”€ Phase 3.3: useLinkExistenceChecker å‰Šé™¤ âœ… å®Œäº†
â””â”€â”€ Phase 3.4: PageLink Extension å‰Šé™¤ â† **å®Œäº†äºˆå®š**
```

### å‰Šæ¸›ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰

| é …ç›®                        | Before | After | å‰Šæ¸›     |
| --------------------------- | ------ | ----- | -------- |
| **PageLink Extension**      | 446 è¡Œ | 0 è¡Œ  | -446     |
| **useLinkExistenceChecker** | 78 è¡Œ  | 0 è¡Œ  | -78      |
| **åˆè¨ˆå‰Šæ¸›**                | 524 è¡Œ | 0 è¡Œ  | **-524** |

### è¿½åŠ ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰

| é …ç›®                         | è¿½åŠ è¡Œæ•°   |
| ---------------------------- | ---------- |
| **UnifiedLinkMark æ©Ÿèƒ½æ‹¡å¼µ** | 50 è¡Œ      |
| **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½**           | 50 è¡Œ      |
| **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ†ã‚¹ãƒˆ**         | 236 è¡Œ     |
| **åˆè¨ˆè¿½åŠ **                 | **336 è¡Œ** |

**æ­£å‘³ã®å¤‰æ›´**: -188 è¡Œï¼ˆã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ç°¡æ½”åŒ–ï¼‰

---

## æŠ€è¡“çš„ãªå­¦ã³

### 1. æ®µéšçš„å‰Šé™¤ã®é‡è¦æ€§

```
Phase 3.1-3.2: æ–°æ©Ÿèƒ½è¿½åŠ  + ä¸¦è¡Œç¨¼åƒ
     â†“
Phase 3.3: ä¾å­˜å‰Šé™¤ï¼ˆuseLinkExistenceCheckerï¼‰
     â†“
Phase 3.4: æœ¬ä½“å‰Šé™¤ï¼ˆPageLink Extensionï¼‰ â† ä»Šã“ã“
```

**åˆ©ç‚¹**:

- å„ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒªã‚¹ã‚¯ãŒåˆ†æ•£
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®¹æ˜“
- æ®µéšçš„ãªæ¤œè¨¼ãŒå¯èƒ½
- **Phase 3.4 ãŒéå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«**ï¼ˆ30 åˆ†ã§å®Œäº†ï¼‰

### 2. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®äº‹å‰å®Ÿè£…

Phase 3.3 ã§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã“ã¨ã§ã€Phase 3.4 ã§ã®ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§å•é¡Œã‚’å›é¿ã§ãã¾ã—ãŸã€‚

### 3. å˜ä¸€è²¬ä»»ã®åŸå‰‡

UnifiedLinkMark ãŒå˜ä¸€ã®çµ±ä¸€ã•ã‚ŒãŸå®Ÿè£…ã¨ã—ã¦ã€ã™ã¹ã¦ã®ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã‚’æ‹…å½“ã™ã‚‹ã“ã¨ã§:

- ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ãŒãªããªã‚‹
- ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ã«ãªã‚‹
- ä¿å®ˆæ€§ãŒå‘ä¸Šã™ã‚‹

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### Phase 3 é–¢é€£

- [Phase 3 å®Ÿè£…è¨ˆç”»æ›¸](./20251012_10_phase3-click-handler-migration-plan.md) - å…¨ä½“è¨ˆç”»
- [Phase 3.3 å®Ÿè£…è¨ˆç”»æ›¸](./20251012_13_phase3.3-implementation-plan.md) - å‰ãƒ•ã‚§ãƒ¼ã‚º
- [Phase 3.3 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](../../../08_worklogs/2025_10/20251012/20251012_25_phase3.3-implementation-complete.md) - å‰ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†

### è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [UnifiedLinkMark ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»](./20251011_08_refactoring-plan.md)
- [ç§»è¡Œè¨ˆç”»æ›¸](./20251011_07_migration-plan.md)

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 3.4 å®Œäº†å¾Œ:

1. **Phase 4 ã®æº–å‚™**: PageLinkMark ã®å‰Šé™¤è¨ˆç”»ï¼ˆå°†æ¥ï¼‰
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–**: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¶™ç¶šçš„ãªç›£è¦–
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: READMEã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®æ›´æ–°

---

**ä½œæˆæ—¥**: 2025-10-12  
**æœ€çµ‚æ›´æ–°**: 2025-10-12  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…æº–å‚™å®Œäº† âœ…  
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: å®Ÿè£…é–‹å§‹ â†’ ãƒ†ã‚¹ãƒˆ â†’ å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

---
