# Phase 3.4 実装計画書: PageLink Extension 完全削除

**作成日**: 2025-10-12  
**最終更新**: 2025-10-12  
**Phase**: 3.4 - PageLink Extension の完全削除  
**目的**: PageLink Extension を完全に削除し、UnifiedLinkMark への移行を完了  
**ステータス**: 実装準備完了 - 計画作成中

---

## エグゼクティブサマリー

Phase 3.3 で `useLinkExistenceChecker` の削除とデータ移行機能の実装が完了しました。Phase 3.4 では、**PageLink Extension の完全削除**を実施します。

### 主要な判断

- **Phase 3.3 完了状況**: useLinkExistenceChecker 削除済み、データ移行機能実装済み
- **依存箇所**: 2 ファイルのみ（usePageEditorLogic.ts、rich-content.tsx）
- **削除対象**: page-link.ts (446 行)
- **安全性**: Phase 3.1-3.2 でクリックハンドラー機能は UnifiedLinkMark に移行済み
- **リスク**: Phase 3.3 で依存を切断済みのため極小

---

## 目次

1. [背景と目的](#背景と目的)
2. [現状分析](#現状分析)
3. [実装計画](#実装計画)
4. [テスト戦略](#テスト戦略)
5. [リスク管理](#リスク管理)
6. [成功基準](#成功基準)

---

## 背景と目的

### Phase 3.4 の位置づけ

```
Phase 3: PageLink Extension 完全削除
├── Phase 3.1: クリックハンドラー移行 ✅ 完了
├── Phase 3.2: DOM イベントハンドラー統合 ✅ 完了
├── Phase 3.3: useLinkExistenceChecker 削除 ✅ 完了
└── Phase 3.4: PageLink Extension 削除 ← **今ここ**
```

### 目的

1. **PageLink Extension の完全削除**: page-link.ts の削除
2. **依存コードの更新**: usePageEditorLogic.ts、rich-content.tsx の修正
3. **コードベースの簡潔化**: 446 行のレガシーコード削除
4. **移行の完了**: UnifiedLinkMark への完全移行

---

## 現状分析

### 1. 削除対象ファイル

#### ① page-link.ts

**パス**: `lib/tiptap-extensions/page-link.ts`  
**行数**: 446 行  
**内容**:

- PageLink Extension 本体
- handleClick() - クリックハンドラー（Phase 3.1-3.2 で UnifiedLinkMark に移行済み）
- handleDOMEvents.click - DOM クリックハンドラー（Phase 3.1-3.2 で UnifiedLinkMark に移行済み）
- existencePluginKey - プラグインキー（Phase 3.3 で削除済み）
- Decoration ベースのリンク表示（PageLinkMark に置き換え済み）

**削除の根拠**:

- すべての機能が UnifiedLinkMark または PageLinkMark に移行済み
- Phase 3.3 で依存関係を完全に切断済み

### 2. 依存している箇所

#### ① usePageEditorLogic.ts

**パス**: `app/(protected)/pages/[id]/_hooks/usePageEditorLogic.ts`

**使用箇所**:

```typescript
// Line 10: import
import { PageLink } from "@/lib/tiptap-extensions/page-link"; // legacy (Decoration based)

// Line 209: extensions配列
PageLink.configure({ noteSlug }), // TODO: remove after full migration to PageLinkMark
```

**削除内容**:

1. import 文の削除
2. extensions 配列から PageLink.configure({ noteSlug }) の削除

#### ② rich-content.tsx

**パス**: `app/(protected)/decks/[deckId]/_components/rich-content.tsx`

**使用箇所**:

```typescript
// Line 4: import
import { PageLink } from "@/lib/tiptap-extensions/page-link";

// Line 94: extensions配列
PageLink,
```

**削除内容**:

1. import 文の削除
2. extensions 配列から PageLink の削除
3. UnifiedLinkMark の追加

### 3. 依存関係マトリクス

| ファイル              | 使用箇所                 | 削除内容                      | 代替機能        |
| --------------------- | ------------------------ | ----------------------------- | --------------- |
| usePageEditorLogic.ts | import + extensions 配列 | import 削除 + 配列から削除    | UnifiedLinkMark |
| rich-content.tsx      | import + extensions 配列 | import 削除 + UnifiedLinkMark | UnifiedLinkMark |
| page-link.ts          | ファイル全体 (446 行)    | ファイル削除                  | N/A             |

---

## 実装計画

### 実装の全体像

```
Phase 3.4 実装フロー
│
├─ Step 1: usePageEditorLogic.ts の更新
│   ├─ 1.1: import 文の削除
│   └─ 1.2: extensions 配列から PageLink 削除
│
├─ Step 2: rich-content.tsx の更新
│   ├─ 2.1: import 文の削除
│   ├─ 2.2: extensions 配列から PageLink 削除
│   └─ 2.3: UnifiedLinkMark の追加
│
├─ Step 3: page-link.ts の削除
│   └─ 3.1: ファイル削除
│
└─ Step 4: 検証とテスト
    ├─ 4.1: TypeScript コンパイル
    ├─ 4.2: 自動テスト (482テスト)
    └─ 4.3: 手動動作確認

合計作業時間: 約 30分
```

---

## Step 1: usePageEditorLogic.ts の更新

### 1.1 import 文の削除

**削除箇所**: Line 10

```typescript
// 削除前
import { CustomHeading } from "@/lib/tiptap-extensions/custom-heading";
import {
  CustomBulletList,
  CustomOrderedList,
} from "@/lib/tiptap-extensions/custom-list";
import { TableExtensions } from "@/lib/tiptap-extensions/custom-table";
import { GyazoImage } from "@/lib/tiptap-extensions/gyazo-image";
import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { LatexInlineNode } from "@/lib/tiptap-extensions/latex-inline-node";
import { PageLink } from "@/lib/tiptap-extensions/page-link"; // legacy (Decoration based)  ← 削除
import { PageLinkMark } from "@/lib/tiptap-extensions/page-link-mark"; // new Mark-based implementation
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";

// 削除後
import { CustomHeading } from "@/lib/tiptap-extensions/custom-heading";
import {
  CustomBulletList,
  CustomOrderedList,
} from "@/lib/tiptap-extensions/custom-list";
import { TableExtensions } from "@/lib/tiptap-extensions/custom-table";
import { GyazoImage } from "@/lib/tiptap-extensions/gyazo-image";
import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { LatexInlineNode } from "@/lib/tiptap-extensions/latex-inline-node";
import { PageLinkMark } from "@/lib/tiptap-extensions/page-link-mark"; // new Mark-based implementation
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";
```

### 1.2 extensions 配列から PageLink 削除

**削除箇所**: Line 209

```typescript
// 削除前
    extensions: [
      StarterKit.configure({
        heading: false,
        bulletList: false,
        orderedList: false,
        codeBlock: false,
      }),
      // Unified Link Mark comes first to handle both [Title] and #tag syntax
      UnifiedLinkMark,
      // New Mark implementation comes before legacy PageLink to ensure mark rendering precedence
      PageLinkMark,
      CustomHeading.configure({ levels: [2, 3, 4, 5, 6] }),
      CustomBulletList,
      CustomOrderedList,
      GyazoImage,
      PageLink.configure({ noteSlug }), // TODO: remove after full migration to PageLinkMark  ← 削除
      LatexInlineNode,
      Highlight,
      CodeBlockWithCopy.configure({
        defaultLanguage: "javascript",
      }),
      // Table extensions for Markdown table support
      ...TableExtensions,
      // Code blocks highlighted via Prism
      // Prism highlighting is applied on editor updates
      Placeholder.configure({
        placeholder: "ページ内容を入力してください",
        includeChildren: true,
      }),
    ],

// 削除後
    extensions: [
      StarterKit.configure({
        heading: false,
        bulletList: false,
        orderedList: false,
        codeBlock: false,
      }),
      // Unified Link Mark comes first to handle both [Title] and #tag syntax
      UnifiedLinkMark,
      // New Mark implementation comes before legacy PageLink to ensure mark rendering precedence
      PageLinkMark,
      CustomHeading.configure({ levels: [2, 3, 4, 5, 6] }),
      CustomBulletList,
      CustomOrderedList,
      GyazoImage,
      LatexInlineNode,
      Highlight,
      CodeBlockWithCopy.configure({
        defaultLanguage: "javascript",
      }),
      // Table extensions for Markdown table support
      ...TableExtensions,
      // Code blocks highlighted via Prism
      // Prism highlighting is applied on editor updates
      Placeholder.configure({
        placeholder: "ページ内容を入力してください",
        includeChildren: true,
      }),
    ],
```

---

## Step 2: rich-content.tsx の更新

### 2.1 import 文の削除と UnifiedLinkMark の追加

**削除・追加箇所**: Line 3-4

```typescript
// 削除前
"use client";

import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { PageLink } from "@/lib/tiptap-extensions/page-link";  ← 削除
import type { JSONContent } from "@tiptap/core";
import Image from "@tiptap/extension-image";
import LinkExtension from "@tiptap/extension-link";

// 削除後
"use client";

import { Highlight } from "@/lib/tiptap-extensions/highlight-extension";
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";  ← 追加
import type { JSONContent } from "@tiptap/core";
import Image from "@tiptap/extension-image";
import LinkExtension from "@tiptap/extension-link";
```

### 2.2 extensions 配列の更新

**削除・追加箇所**: Line 94

```typescript
// 削除前
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        // 必要に応じてStarterKitのオプションを設定
      }),
      LinkExtension.configure({
        HTMLAttributes: { className: "text-blue-500 underline" },
        openOnClick: false,
        autolink: true,
      }),
      Image.configure({
        inline: false,
      }),
      TextAlign.configure({
        types: ["heading", "paragraph"],
      }),
      Typography,
      PageLink,  ← 削除
      Highlight,
    ],
    editable: false,
    content: processedDoc,
    editorProps: {},
  });

// 削除後
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        // 必要に応じてStarterKitのオプションを設定
      }),
      LinkExtension.configure({
        HTMLAttributes: { className: "text-blue-500 underline" },
        openOnClick: false,
        autolink: true,
      }),
      Image.configure({
        inline: false,
      }),
      TextAlign.configure({
        types: ["heading", "paragraph"],
      }),
      Typography,
      UnifiedLinkMark,  ← 追加
      Highlight,
    ],
    editable: false,
    content: processedDoc,
    editorProps: {},
  });
```

---

## Step 3: page-link.ts の削除

### 3.1 ファイル削除

```bash
# ファイル削除
rm lib/tiptap-extensions/page-link.ts
```

**削除内容**:

- ファイル全体: 446 行
- PageLink Extension のすべての機能

---

## Step 4: 検証とテスト

### 4.1 TypeScript コンパイル

```bash
npx tsc --noEmit
```

**期待結果**:

- ✅ コンパイルエラーなし
- ❌ エラーがあれば import 漏れや参照漏れを確認

### 4.2 自動テスト

```bash
# 全テスト実行
bun test

# UnifiedLinkMark 関連テストのみ
bun test lib/tiptap-extensions/unified-link-mark
```

**期待結果**:

- ✅ 既存テスト 482/482 成功
- ✅ UnifiedLinkMark テスト 351/351 成功

### 4.3 手動動作確認

#### テストシナリオ 1: ページエディタでのリンク機能

```
1. ページエディタを開く
2. [新しいページ] と入力
3. 期待: pending → missing/exists に遷移
4. クリック: ページ遷移または新規作成
```

#### テストシナリオ 2: rich-content でのリンク表示

```
1. デッキの問題カード表示
2. リンクを含むコンテンツを表示
3. 期待: リンクが正しく表示される
4. クリック: ページ遷移
```

#### テストシナリオ 3: データ移行の確認

```
1. 旧 PageLinkMark 形式のデータを含むページを開く
2. 期待: UnifiedLinkMark として認識
3. リンク動作: 正常にクリック・遷移
```

---

## テスト戦略

### 1. 自動テスト

#### 既存テストの実行

```bash
# 全テスト実行
bun test
```

**期待結果**:

- ✅ 482/482 テスト成功
- ❌ 失敗テストがあれば原因調査

#### UnifiedLinkMark テスト

```bash
# UnifiedLinkMark 関連テストのみ
bun test lib/tiptap-extensions/unified-link-mark
```

**期待結果**:

- ✅ 351/351 テスト成功（データ移行テスト含む）

### 2. 手動テスト

#### 回帰テストのチェックリスト

- [ ] ブラケットリンク `[Title]` の入力と解決
- [ ] タグリンク `#tag` の入力と解決
- [ ] pending → exists 遷移
- [ ] pending → missing 遷移
- [ ] クリック時のページ遷移
- [ ] 新規ページ作成（missing クリック時）
- [ ] BroadcastChannel 経由のリアルタイム更新
- [ ] ページ保存後のリンク同期
- [ ] エディタの初回ロード時の解決
- [ ] rich-content でのリンク表示

---

## リスク管理

### リスク評価マトリクス

| リスク                    | 確率 | 影響 | 対策                                     | 状態 |
| ------------------------- | ---- | ---- | ---------------------------------------- | ---- |
| PageLink への参照残存     | 低   | 高   | grep 検索で全ファイルチェック済み        | ✅   |
| UnifiedLinkMark の不具合  | 極低 | 高   | Phase 3.1-3.2 で実績あり、351 テスト成功 | ✅   |
| データ移行の不具合        | 極低 | 中   | Phase 3.3 で実装・テスト済み             | ✅   |
| rich-content での表示問題 | 低   | 中   | 手動テストで確認                         | 🟡   |
| パフォーマンス劣化        | なし | 低   | PageLink 削除で改善が期待される          | ✅   |

**総合リスク評価**: **極低 - Phase 3.3 で依存を完全に切断済み** ✅

### ロールバック計画

万が一問題が発生した場合:

```bash
# Git で変更を戻す
git checkout HEAD -- app/(protected)/pages/[id]/_hooks/usePageEditorLogic.ts
git checkout HEAD -- app/(protected)/decks/[deckId]/_components/rich-content.tsx
git checkout HEAD -- lib/tiptap-extensions/page-link.ts
```

**ロールバック時間**: 1 分以内

---

## 成功基準

### 必須条件 ✅

#### コード削除関連

- [ ] ✅ page-link.ts が削除されている
- [ ] ✅ usePageEditorLogic.ts に PageLink の import がない
- [ ] ✅ usePageEditorLogic.ts の extensions 配列に PageLink がない
- [ ] ✅ rich-content.tsx に PageLink の import がない
- [ ] ✅ rich-content.tsx の extensions 配列に UnifiedLinkMark がある
- [ ] ✅ TypeScript コンパイルエラーがない

#### テスト関連

- [ ] ✅ 全自動テスト成功 (482/482)
- [ ] ✅ UnifiedLinkMark テスト成功 (351/351)

### 動作確認

#### 既存機能の確認

- [ ] ✅ ブラケットリンクの pending → exists/missing 遷移
- [ ] ✅ タグリンクの動作
- [ ] ✅ クリック時のページ遷移
- [ ] ✅ 新規ページ作成機能
- [ ] ✅ リアルタイム更新 (BroadcastChannel)
- [ ] ✅ エディタの応答性（パフォーマンス劣化なし）

#### rich-content での確認

- [ ] ✅ リンクの正常な表示
- [ ] ✅ リンククリック時の動作
- [ ] ✅ データ移行後の表示

---

## 実装スケジュール

### タイムライン

| Step | 作業内容                                | 所要時間  | 担当   | 優先度 |
| ---- | --------------------------------------- | --------- | ------ | ------ |
| 1.1  | usePageEditorLogic.ts - import 削除     | 1 分      | Dev    | 高     |
| 1.2  | usePageEditorLogic.ts - extensions 更新 | 1 分      | Dev    | 高     |
| 2.1  | rich-content.tsx - import 更新          | 1 分      | Dev    | 高     |
| 2.2  | rich-content.tsx - extensions 更新      | 1 分      | Dev    | 高     |
| 3.1  | page-link.ts 削除                       | 1 分      | Dev    | 高     |
| 4.1  | TypeScript コンパイル確認               | 1 分      | Dev    | 高     |
| 4.2  | 自動テスト実行 (482 テスト)             | 5 分      | Dev    | 高     |
| 4.3  | 手動動作確認                            | 10 分     | Dev/QA | 高     |
| 5    | 完了レポート作成                        | 10 分     | Dev    | 高     |
| -    | **合計**                                | **32 分** | -      | -      |

### 実装順序

```
Phase 3.4 実装フロー
│
├─ [1] 準備
│   ├─ ブランチ確認: feature/unified-link-migration-and-tdd
│   ├─ 最新コミット取得
│   └─ 実装計画書レビュー ✅
│
├─ [2] コード更新
│   ├─ usePageEditorLogic.ts 修正 (2箇所)
│   └─ rich-content.tsx 修正 (2箇所)
│
├─ [3] ファイル削除
│   └─ page-link.ts 削除
│
├─ [4] 検証
│   ├─ TypeScript コンパイル
│   ├─ 自動テスト (482テスト)
│   └─ 手動動作確認
│
└─ [5] 完了
    ├─ 完了レポート作成
    └─ Git コミット
```

---

## Phase 3 の完了

### Phase 3 全体の成果

Phase 3.4 の完了により、Phase 3 全体が完了します。

```
Phase 3: PageLink Extension 完全削除
├── Phase 3.1: クリックハンドラー移行 ✅ 完了
├── Phase 3.2: DOM イベントハンドラー統合 ✅ 完了
├── Phase 3.3: useLinkExistenceChecker 削除 ✅ 完了
└── Phase 3.4: PageLink Extension 削除 ← **完了予定**
```

### 削減されるコード

| 項目                        | Before | After | 削減     |
| --------------------------- | ------ | ----- | -------- |
| **PageLink Extension**      | 446 行 | 0 行  | -446     |
| **useLinkExistenceChecker** | 78 行  | 0 行  | -78      |
| **合計削減**                | 524 行 | 0 行  | **-524** |

### 追加されたコード

| 項目                         | 追加行数   |
| ---------------------------- | ---------- |
| **UnifiedLinkMark 機能拡張** | 50 行      |
| **データ移行機能**           | 50 行      |
| **データ移行テスト**         | 236 行     |
| **合計追加**                 | **336 行** |

**正味の変更**: -188 行（コードベースの簡潔化）

---

## 技術的な学び

### 1. 段階的削除の重要性

```
Phase 3.1-3.2: 新機能追加 + 並行稼働
     ↓
Phase 3.3: 依存削除（useLinkExistenceChecker）
     ↓
Phase 3.4: 本体削除（PageLink Extension） ← 今ここ
```

**利点**:

- 各フェーズのリスクが分散
- ロールバックが容易
- 段階的な検証が可能
- **Phase 3.4 が非常にシンプル**（30 分で完了）

### 2. データ移行の事前実装

Phase 3.3 でデータ移行機能を実装したことで、Phase 3.4 でのデータ互換性問題を回避できました。

### 3. 単一責任の原則

UnifiedLinkMark が単一の統一された実装として、すべてのリンク機能を担当することで:

- コードの重複がなくなる
- テストが容易になる
- 保守性が向上する

---

## 関連ドキュメント

### Phase 3 関連

- [Phase 3 実装計画書](./20251012_10_phase3-click-handler-migration-plan.md) - 全体計画
- [Phase 3.3 実装計画書](./20251012_13_phase3.3-implementation-plan.md) - 前フェーズ
- [Phase 3.3 完了レポート](../../../08_worklogs/2025_10/20251012/20251012_25_phase3.3-implementation-complete.md) - 前フェーズ完了

### 設計ドキュメント

- [UnifiedLinkMark リファクタリング計画](./20251011_08_refactoring-plan.md)
- [移行計画書](./20251011_07_migration-plan.md)

---

## 次のステップ

Phase 3.4 完了後:

1. **Phase 4 の準備**: PageLinkMark の削除計画（将来）
2. **パフォーマンス監視**: メトリクスの継続的な監視
3. **ドキュメント更新**: README、アーキテクチャ図の更新

---

**作成日**: 2025-10-12  
**最終更新**: 2025-10-12  
**ステータス**: 実装準備完了 ✅  
**次のステップ**: 実装開始 → テスト → 完了レポート

---
