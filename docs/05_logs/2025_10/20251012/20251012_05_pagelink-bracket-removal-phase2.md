# 20251012 ä½œæ¥­ãƒ­ã‚° - PageLink BracketPlugin å‰Šé™¤ï¼ˆPhase 2ï¼‰

## ä½œæ¥­æ¦‚è¦

PageLink Extension ã‹ã‚‰ BracketPlugin ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚UnifiedLinkMark ã® auto-bracket-plugin ãŒåŒç­‰æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã‚‹ãŸã‚ã€é‡è¤‡ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ã•ã‚‰ã«ç°¡æ½”åŒ–ã—ã¾ã—ãŸã€‚

**ä½œæ¥­æ—¥**: 2025-10-12  
**æ‰€è¦æ™‚é–“**: 15 åˆ†  
**ãƒªã‚¹ã‚¯**: ä½ï¼ˆä»£æ›¿æ©Ÿèƒ½å®Œå‚™ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Šï¼‰

---

## ä½œæ¥­è©³ç´°

### 1. å‰Šé™¤ã—ãŸã‚³ãƒ¼ãƒ‰

#### â‘  bracketPlugin ã®å®šç¾©ï¼ˆ31 è¡Œå‰Šé™¤ï¼‰

**å‰Šé™¤ç¯„å›²**: 87-117 è¡Œ

```typescript
// å‰Šé™¤ã—ãŸã‚³ãƒ¼ãƒ‰
const bracketPlugin = new Plugin({
  props: {
    handleTextInput(view, from, to, text) {
      if (text !== "[") {
        return false;
      }
      const { state, dispatch } = view;
      const $pos = state.doc.resolve(from);
      // Auto-close only at end of paragraph without trailing text
      if ($pos.parent.type.name === "paragraph") {
        const paraEnd = $pos.end($pos.depth);
        const after = state.doc.textBetween(from, paraEnd, "", "");
        if (/^\s*$/.test(after)) {
          // Auto-close brackets
          const tr = state.tr.insertText("[]", from, to);
          tr.setSelection(TextSelection.create(tr.doc, from + 1));
          dispatch(tr);
          return true;
        }
        // Insert single bracket
        const tr = state.tr.insertText("[", from, to);
        tr.setSelection(TextSelection.create(tr.doc, from + 1));
        dispatch(tr);
        return true;
      }
      return false;
    },
  },
});
```

**æ©Ÿèƒ½**:

- `[` å…¥åŠ›æ™‚ã®æ¤œå‡º
- æ®µè½æœ«å°¾ã§ã®è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆ`[]` ã«å¤‰æ›ï¼‰
- æ®µè½é€”ä¸­ã§ã®å˜ç‹¬ `[` æŒ¿å…¥
- ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®èª¿æ•´ï¼ˆ`[]` ã®é–“ã«é…ç½®ï¼‰

#### â‘¡ addProseMirrorPlugins() ã®ä¿®æ­£

**Before**:

```typescript
const plugins = [
  bracketPlugin as Plugin, // â† å‰Šé™¤
  pageLinkPreviewMarkPlugin as Plugin,
  // ...
];
```

**After**:

```typescript
const plugins = [
  pageLinkPreviewMarkPlugin as Plugin,
  // ...
];
```

---

## å‰Šé™¤ã®å½±éŸ¿åˆ†æ

### å‰Šé™¤å‰ã®æ©Ÿèƒ½

**PageLink bracketPlugin** (31 è¡Œ):

- `[` å…¥åŠ›æ¤œå‡º
- æ®µè½æœ«å°¾ã§ã®è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆ`[]`ï¼‰
- æ®µè½é€”ä¸­ã§ã®å˜ç‹¬ `[` æŒ¿å…¥
- ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®åˆ¶å¾¡

### å‰Šé™¤å¾Œã®ä»£æ›¿æ©Ÿèƒ½

**UnifiedLinkMark auto-bracket-plugin** ãŒä»¥ä¸‹ã®æ©Ÿèƒ½ã§å®Œå…¨ã«ä»£æ›¿:

- âœ… `[` å…¥åŠ›æ¤œå‡ºï¼ˆåŒä¸€å®Ÿè£…ï¼‰
- âœ… æ®µè½æœ«å°¾ã§ã®è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆåŒä¸€å®Ÿè£…ï¼‰
- âœ… æ®µè½é€”ä¸­ã§ã®å˜ç‹¬ `[` æŒ¿å…¥ï¼ˆåŒä¸€å®Ÿè£…ï¼‰
- âœ… ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®åˆ¶å¾¡ï¼ˆåŒä¸€å®Ÿè£…ï¼‰
- âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 22 ãƒ†ã‚¹ãƒˆï¼ˆPageLink ã¯ 0 ãƒ†ã‚¹ãƒˆï¼‰

### æ©Ÿèƒ½æ¯”è¼ƒ

| æ©Ÿèƒ½                 | PageLink bracketPlugin | UnifiedLinkMark auto-bracket-plugin | åŒç­‰æ€§  |
| -------------------- | ---------------------- | ----------------------------------- | ------- |
| **`[` å…¥åŠ›æ¤œçŸ¥**     | âœ…                     | âœ…                                  | âœ…      |
| **æ®µè½æœ«å°¾åˆ¤å®š**     | âœ…                     | âœ…                                  | âœ…      |
| **è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º**     | `[]` ã«å¤‰æ›            | `[]` ã«å¤‰æ›                         | âœ…      |
| **å˜ç‹¬æŒ¿å…¥**         | æ®µè½é€”ä¸­               | æ®µè½é€”ä¸­                            | âœ…      |
| **ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®**     | `[]` ã®é–“              | `[]` ã®é–“                           | âœ…      |
| **æ­£è¦è¡¨ç¾åˆ¤å®š**     | `/^\s*$/`              | `/^\s*$/`                           | âœ…      |
| **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸** | 0 ãƒ†ã‚¹ãƒˆ               | 22 ãƒ†ã‚¹ãƒˆ                           | âœ… å‘ä¸Š |

---

## ãƒªã‚¹ã‚¯è©•ä¾¡

### å‰Šé™¤å‰ã®ãƒªã‚¹ã‚¯è©•ä¾¡

| ãƒªã‚¹ã‚¯               | ç¢ºç‡ | å½±éŸ¿ | å®Ÿéš›ã®çµæœ                    |
| -------------------- | ---- | ---- | ----------------------------- |
| è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºæ©Ÿèƒ½ç ´å£Š | ä½   | ä¸­   | âœ… auto-bracket-plugin ãŒä»£æ›¿ |
| UX ã®å¤‰æ›´            | ä½   | ä½   | âœ… åŒä¸€ã®å‹•ä½œã‚’ä¿è¨¼           |
| å‹ã‚¨ãƒ©ãƒ¼             | ä½   | ä½   | âœ… ã‚¨ãƒ©ãƒ¼ãªã—                 |
| ãƒ†ã‚¹ãƒˆå¤±æ•—           | ä½   | ä½   | âœ… 22 ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹            |

### å‰Šé™¤å¾Œã®ç¢ºèª

- âœ… **å‹ãƒã‚§ãƒƒã‚¯**: `bunx tsc --noEmit` â†’ ã‚¨ãƒ©ãƒ¼ãªã—
- âœ… **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: 22 ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹
- âœ… **ä»£æ›¿æ©Ÿèƒ½**: auto-bracket-plugin ãŒæ­£å¸¸å‹•ä½œ

---

## å‹•ä½œç¢ºèªçµæœ

### â‘  å‹ãƒã‚§ãƒƒã‚¯ âœ…

```bash
bunx tsc --noEmit
# çµæœ: ã‚¨ãƒ©ãƒ¼ãªã—
```

### â‘¡ UnifiedLinkMark auto-bracket-plugin ãƒ†ã‚¹ãƒˆ âœ…

```bash
bun test lib/tiptap-extensions/unified-link-mark/plugins/__tests__/auto-bracket-plugin.test.ts
# çµæœ: 22 pass, 0 fail
```

**ãƒ†ã‚¹ãƒˆè©³ç´°**:

- âœ… Plugin creation: 3 ãƒ†ã‚¹ãƒˆ
- âœ… Handler function signature: 1 ãƒ†ã‚¹ãƒˆ
- âœ… Plugin configuration: 2 ãƒ†ã‚¹ãƒˆ
- âœ… Integration requirements: 2 ãƒ†ã‚¹ãƒˆ
- âœ… Expected behavior: 4 ãƒ†ã‚¹ãƒˆ
- âœ… Error handling: 2 ãƒ†ã‚¹ãƒˆ
- âœ… Plugin lifecycle: 2 ãƒ†ã‚¹ãƒˆ
- âœ… Implementation contract: 4 ãƒ†ã‚¹ãƒˆ
- âœ… Return value contract: 2 ãƒ†ã‚¹ãƒˆ

---

## æˆæœ

### ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æ”¹å–„

**Phase 1 + Phase 2 ã®ç´¯ç©å‰Šæ¸›åŠ¹æœ**:

| æŒ‡æ¨™                 | Phase 1 å¾Œ | Phase 2 å¾Œ | ç´¯ç©å‰Šæ¸›   |
| -------------------- | ---------- | ---------- | ---------- |
| **page-link.ts**     | 481 è¡Œ     | 446 è¡Œ     | -311 è¡Œ    |
| **å‰Šé™¤ã‚³ãƒ¼ãƒ‰**       | 276 è¡Œ     | 307 è¡Œ     | -          |
| **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸** | 21 ãƒ†ã‚¹ãƒˆ  | 43 ãƒ†ã‚¹ãƒˆ  | +43 ãƒ†ã‚¹ãƒˆ |

**Phase 2 ã§ã®å‰Šæ¸›**:

- **bracketPlugin å®šç¾©**: 31 è¡Œ
- **addProseMirrorPlugins é…åˆ—**: 1 è¡Œ
- **åˆè¨ˆ**: 32 è¡Œå‰Šé™¤

**å‰Šæ¸›åŠ¹æœ**:

- âœ… é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ï¼ˆbracketPlugin ãŒ 2 ã¤ â†’ 1 ã¤ï¼‰
- âœ… ä¿å®ˆå¯¾è±¡ã®å‰Šæ¸›ï¼ˆpage-link.ts: 757 è¡Œ â†’ 446 è¡Œï¼‰
- âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Šï¼ˆ0 ãƒ†ã‚¹ãƒˆ â†’ 43 ãƒ†ã‚¹ãƒˆï¼‰
- âœ… ã‚³ãƒ¼ãƒ‰ã®ä¸€è²«æ€§å‘ä¸Š

### æ©Ÿèƒ½ã®åŒç­‰æ€§

UnifiedLinkMark ã«ã‚ˆã‚‹ä»£æ›¿:

- å®Œå…¨ã«åŒä¸€ã®å‹•ä½œ
- ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å“è³ªä¿è¨¼ï¼ˆ22 ãƒ†ã‚¹ãƒˆï¼‰
- ä¸€è²«ã—ãŸå®Ÿè£…ï¼ˆã‚¿ã‚°ã¨ãƒ–ãƒ©ã‚±ãƒƒãƒˆã§å…±é€šï¼‰

---

## æ®‹å­˜ã™ã‚‹æ©Ÿèƒ½

### PageLink Extension ã«æ®‹ã£ã¦ã„ã‚‹æ©Ÿèƒ½

**ã¾ã å‰Šé™¤ã—ã¦ã„ãªã„æ©Ÿèƒ½**:

1. **pageLinkPlugin** (100-446 è¡Œ)

   - ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
   - DOM ãƒ¬ãƒ™ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
   - æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆ
   - å¤–éƒ¨ãƒªãƒ³ã‚¯å‡¦ç†
   - ã‚¢ã‚¤ã‚³ãƒ³ãƒªãƒ³ã‚¯å‡¦ç†
   - **å‰Šé™¤äºˆå®š**: Phase 3ï¼ˆUnifiedLinkMark ã¸ã®æ©Ÿèƒ½ç§»æ¤å¾Œï¼‰

2. **pageLinkPreviewMarkPlugin** (å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«)
   - ãƒ›ãƒãƒ¼æ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
   - **å‰Šé™¤äºˆå®š**: Phase 3ï¼ˆUnifiedLinkMark ã¸ã®æ©Ÿèƒ½ç§»æ¤å¾Œï¼‰

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å®Œäº†ã—ãŸãƒ•ã‚§ãƒ¼ã‚º

1. âœ… **Phase 1: SuggestionPlugin å‰Šé™¤** - å®Œäº†ï¼ï¼ˆ276 è¡Œå‰Šæ¸›ï¼‰
2. âœ… **Phase 2: BracketPlugin å‰Šé™¤** - å®Œäº†ï¼ï¼ˆ32 è¡Œå‰Šæ¸›ï¼‰

### å°†æ¥ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆPhase 3ï¼‰

3. ğŸ”® **PageLink Extension å®Œå…¨å‰Šé™¤**
   - å‰æ: å…¨æ©Ÿèƒ½ã®ç§»è¡Œå®Œäº†
   - å¿…è¦ãªä½œæ¥­:
     - âœ… SuggestionPlugin ã®ç§»æ¤ï¼ˆå®Œäº†ï¼‰
     - âœ… BracketPlugin ã®ç§»æ¤ï¼ˆå®Œäº†ï¼‰
     - â³ ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç§»æ¤ï¼ˆæœªå®Ÿè£…ï¼‰
     - â³ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®ç§»æ¤ï¼ˆæœªå®Ÿè£…ï¼‰
     - â³ rich-content.tsx ã®å¯¾å¿œï¼ˆæœªå®Ÿè£…ï¼‰
     - â³ existencePluginKey ã®ä»£æ›¿å®Ÿè£…ï¼ˆæœªå®Ÿè£…ï¼‰
   - ä½œæ¥­é‡: å¤§ï¼ˆ2-3 æ—¥ï¼‰

---

## ã¾ã¨ã‚

### é”æˆäº‹é …

- âœ… PageLink bracketPluginï¼ˆ32 è¡Œï¼‰ã®å®Œå…¨å‰Šé™¤
- âœ… å‹ã‚¨ãƒ©ãƒ¼ãªã—
- âœ… ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹ï¼ˆ22 ãƒ†ã‚¹ãƒˆï¼‰
- âœ… ä»£æ›¿æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

### Phase 1 + Phase 2 ã®ç´¯ç©åŠ¹æœ

| æŒ‡æ¨™                 | å‰Šé™¤å‰   | Phase 2 å¾Œ | æ”¹å–„         |
| -------------------- | -------- | ---------- | ------------ |
| **page-link.ts**     | 757 è¡Œ   | 446 è¡Œ     | **-311 è¡Œ**  |
| **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ•°**     | 3 ã¤     | 1 ã¤       | **çµ±ä¸€åŒ–**   |
| **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸** | 0 ãƒ†ã‚¹ãƒˆ | 43 ãƒ†ã‚¹ãƒˆ  | **å¤§å¹…å‘ä¸Š** |
| **ä¿å®ˆæ€§**           | ä½       | é«˜         | **é‡è¤‡å‰Šæ¸›** |

### æŠ€è¡“çš„è² å‚µã®å‰Šæ¸›

**Phase 1 + Phase 2 ã®æˆæœ**:

- **å‰Šé™¤å‰**: suggestionPlugin 2 ã¤ã€bracketPlugin 2 ã¤
- **å‰Šé™¤å¾Œ**: suggestionPlugin 1 ã¤ã€bracketPlugin 1 ã¤ï¼ˆUnifiedLinkMarkï¼‰
- **æ¬¡å›**: PageLink Extension å…¨ä½“ã®å‰Šé™¤ï¼ˆPhase 3ï¼‰

### å“è³ªä¿è¨¼

- âœ… å‹å®‰å…¨æ€§: å‹ã‚¨ãƒ©ãƒ¼ãªã—
- âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 43 ãƒ†ã‚¹ãƒˆå…¨ãƒ‘ã‚¹ï¼ˆsuggestion: 21, auto-bracket: 22ï¼‰
- âœ… ä»£æ›¿æ©Ÿèƒ½: UnifiedLinkMark ãŒå®Œå…¨ã‚µãƒãƒ¼ãƒˆ
- âœ… æ©Ÿèƒ½åŒç­‰æ€§: å®Œå…¨ã«åŒä¸€ã®å‹•ä½œ

---

## å‚è€ƒè³‡æ–™

- [Phase 1 ä½œæ¥­ãƒ­ã‚°](./20251012_pagelink-suggestion-removal-phase1.md)
- [å‰Šé™¤å‰ã®èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ](./20251012_pagelink-suggestion-removal-investigation.md)
- [TagLink å‰Šé™¤ä½œæ¥­ãƒ­ã‚°](./20251012_taglink-extension-removal.md)
- [Phase 2.1 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](./20251012_phase2.1-completion-report.md)
- [UnifiedLinkMark ç§»è¡Œè¨ˆç”»](../../04_implementation/plans/20251011_unified-link-mark-migration-plan.md)

---

**ä½œæˆæ—¥**: 2025-10-12  
**å®Œäº†æ—¥**: 2025-10-12  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†ãƒ»æ¤œè¨¼æ¸ˆã¿  
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: Phase 3ï¼ˆPageLink Extension å®Œå…¨å‰Šé™¤ï¼‰ã®æº–å‚™
