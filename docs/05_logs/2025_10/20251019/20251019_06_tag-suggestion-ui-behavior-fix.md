# Issue: ã‚¿ã‚°æ©Ÿèƒ½ã®ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI å‹•ä½œä¿®æ­£

**å„ªå…ˆåº¦**: ğŸ”´ High  
**æ¨å®šé›£åº¦**: â­â­ ä¸­ç¨‹åº¦ï¼ˆ3-4æ™‚é–“ï¼‰  
**æ¨å¥¨æœŸé™**: æœ¬æ—¥ä¸­  
**ä½œæˆæ—¥**: 2025-10-19  
**ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ**: ç¢ºèªæ¸ˆã¿

---

## æ¦‚è¦

ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã§ã‚¿ã‚°æ©Ÿèƒ½ã®ä»¥ä¸‹ã®å•é¡ŒãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼š

1. **ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ã®è¡¨ç¤ºã‚¿ã‚¤ãƒŸãƒ³ã‚°**: ç¾åœ¨ `#` å…¥åŠ›å¾Œã«è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„
2. **åˆæœŸé¸æŠçŠ¶æ…‹**: è¡¨ç¤ºæ™‚ã«æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ãŒè‡ªå‹•é¸æŠã•ã‚Œã¦ã„ã‚‹ï¼ˆæ”¹å–„ãŒå¿…è¦ï¼‰
3. **Enter ã‚­ãƒ¼æŒ™å‹•**: å…¥åŠ›æ–‡å­—ã‚’ãã®ã¾ã¾ãƒªãƒ³ã‚¯åŒ–ã™ã‚‹å‹•ä½œãŒä¸å®‰å®š

---

## ç¾åœ¨ã®ä»•æ§˜ï¼ˆä¿®æ­£å‰ï¼‰

### å®Ÿè£…çŠ¶æ³
- `#` å…¥åŠ›å¾Œã€ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ãŒè¡¨ç¤ºã•ã‚Œãªã„
- å…¥åŠ›æ™‚ã«æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ãŒè‡ªå‹•é¸æŠã•ã‚Œã‚‹
- Enter ã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã®å‹•ä½œãŒä¸æ˜ç¢º

**é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `lib/tiptap-extensions/unified-link-mark/plugins/suggestion-plugin.ts` - Line 155
- `lib/tiptap-extensions/unified-link-mark/input-rules/tag-rule.ts` - Tag InputRule

---

## æ–°ã—ã„ä»•æ§˜ï¼ˆä¿®æ­£å¾Œï¼‰

### è¦ä»¶ 1: `#` å…¥åŠ›æ™‚ç‚¹ã§ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ã‚’è¡¨ç¤º

**æ¡ä»¶**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `#` ã‚’å…¥åŠ›ã—ãŸç›´å¾Œã«ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ã‚’è¡¨ç¤ºé–‹å§‹
- ã‚µã‚¸ã‚§ã‚¹ãƒˆå†…å®¹ã¯**æ›´æ–°é †ãŒæ–°ã—ã„ã‚‚ã®**ã‹ã‚‰è¡¨ç¤ºï¼ˆæœ€æ–°é †ï¼‰

**å®Ÿè£…ç®‡æ‰€**:
- `suggestion-plugin.ts` - ã‚µã‚¸ã‚§ã‚¹ãƒˆæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯
- ç©ºã‚¯ã‚¨ãƒªï¼ˆ`query.length === 0`ï¼‰ã®å ´åˆã‚‚è¡¨ç¤º

**ãƒ†ã‚¹ãƒˆé …ç›®**:
```
âœ… " #" å…¥åŠ›å¾Œã€ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI ãŒè¡¨ç¤ºã•ã‚Œã‚‹
âœ… ã‚µã‚¸ã‚§ã‚¹ãƒˆå†…å®¹ãŒæ›´æ–°é †ã§ä¸¦ã¶ï¼ˆæ–°ã—ã„é †ï¼‰
âœ… " #a" å…¥åŠ›å¾Œã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¡¨ç¤º
```

### è¦ä»¶ 2: åˆæœŸé¸æŠçŠ¶æ…‹ã‚’å»ƒæ­¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§é¸æŠï¼‰

**ç¾åœ¨ã®å•é¡Œ**:
- ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºæ™‚ã«æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ãŒè‡ªå‹•é¸æŠã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«é¸æŠã™ã‚‹ã¾ã§ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ãŒåˆ†ã‹ã‚Šã¥ã‚‰ã„

**ä¿®æ­£å†…å®¹**:
- ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºæ™‚ã¯ **ä½•ã‚‚é¸æŠã—ãªã„**ï¼ˆ`selectedIndex: -1` ã¾ãŸã¯ `null`ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ **çŸ¢å°ã‚­ãƒ¼ â†‘â†“** ã§æ‰‹å‹•é¸æŠ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ **Enter ã‚­ãƒ¼** ã§é¸æŠç¢ºå®š

**å®Ÿè£…ç®‡æ‰€**:
- `suggestion-plugin.ts` - State åˆæœŸåŒ–æ™‚ã® `selectedIndex`
- `suggestion-plugin.ts` - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

**ãƒ†ã‚¹ãƒˆé …ç›®**:
```
âœ… ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºæ™‚ã€é¸æŠçŠ¶æ…‹ãŒãªã„ï¼ˆ-1ï¼‰
âœ… â†“ ã‚­ãƒ¼ã§æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠå¯èƒ½
âœ… â†‘ ã‚­ãƒ¼ã§å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ç§»å‹•
âœ… é¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹
```

### è¦ä»¶ 3: Enter ã‚­ãƒ¼æŒ™å‹•ã®æ˜ç¢ºåŒ–

**å…¥åŠ› â†’ Enter ã‚­ãƒ¼ã®ãƒ•ãƒ­ãƒ¼**:

1. **ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ**:
   - å…¥åŠ›ã—ãŸæ–‡å­—ã‚’ãã®ã¾ã¾**ãƒªãƒ³ã‚¯åŒ–**
   - ã‚¿ã‚°åã¨ã—ã¦ä½¿ç”¨ï¼ˆä¾‹: `#MyTag` â†’ `MyTag` ã§æœªè¨­å®šãƒªãƒ³ã‚¯ä½œæˆï¼‰

2. **ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ**:
   - é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã«ãƒªãƒ³ã‚¯
   - æ—¢å­˜ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã¾ãŸã¯æœªè¨­å®šãƒªãƒ³ã‚¯ã«å¿œã˜ã¦å‡¦ç†

**ãƒ•ãƒ­ãƒ¼å›³**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: " #MyTag"
    â†“
ã‚µã‚¸ã‚§ã‚¹ãƒˆ UI è¡¨ç¤ºï¼ˆä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„ï¼‰
    â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Enter ã‚­ãƒ¼ã‚’æŠ¼ã™
    â†“
é¸æŠçŠ¶æ…‹ â†’ -1 ã¾ãŸã¯ null ?
    â”œâ”€ YES â†’ "MyTag" ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ãƒªãƒ³ã‚¯åŒ–
    â””â”€ NO â†’ é¸æŠã‚¢ã‚¤ãƒ†ãƒ ã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ³ã‚¯
```

**å®Ÿè£…ç®‡æ‰€**:
- `suggestion-plugin.ts` - `handleKeyDown` ã® Enter ã‚­ãƒ¼å‡¦ç†
- ã‚¿ã‚°å…¥åŠ›ãƒ«ãƒ¼ãƒ«ã¾ãŸã¯ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã®æœ€çµ‚ç¢ºå®šå‡¦ç†

**ãƒ†ã‚¹ãƒˆé …ç›®**:
```
âœ… " #Test" å…¥åŠ›å¾Œã€Enter ã‚­ãƒ¼ â†’ "Test" ã§ãƒªãƒ³ã‚¯åŒ–
âœ… " #Test" å…¥åŠ›å¾Œã€â†“ ã§ã‚¢ã‚¤ãƒ†ãƒ é¸æŠã€Enter ã‚­ãƒ¼ â†’ é¸æŠã‚¢ã‚¤ãƒ†ãƒ ã«ãƒªãƒ³ã‚¯
âœ… æ—¢å­˜ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯ exists ãƒ•ãƒ©ã‚°ãŒ true
âœ… æ—¢å­˜ãƒšãƒ¼ã‚¸ãŒãªã„å ´åˆã¯ missing ãƒ•ãƒ©ã‚°
```

---

## ãƒ†ã‚¹ãƒˆä¿®æ­£ãƒãƒƒãƒ—

### ä¿®æ­£ã™ã¹ããƒ†ã‚¹ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆ | ä¿®æ­£å†…å®¹ |
|---------|--------|--------|
| `suggestion-plugin.test.ts` | Bracket input pattern | `query.length === 0` ã§ã‚‚è¡¨ç¤ºãƒ†ã‚¹ãƒˆè¿½åŠ  |
| `suggestion-plugin.test.ts` | Suggestion list UI | åˆæœŸ `selectedIndex` ãŒ `0` ã§ã¯ãªã `-1` ã« |
| `suggestion-plugin.test.ts` | Keyboard handling | Enter ã‚­ãƒ¼æ™‚ã®é¸æŠçŠ¶æ…‹åˆ¥ãƒ†ã‚¹ãƒˆè¿½åŠ  |
| `tag-rule.test.ts` | Tag input handling | å…¥åŠ›æ–‡å­—ãã®ã¾ã¾ã®ãƒªãƒ³ã‚¯åŒ–ãƒ†ã‚¹ãƒˆ |

### æ–°è¦ãƒ†ã‚¹ãƒˆ

```typescript
describe("Tag Suggestion Behavior", () => {
  describe("Empty query handling", () => {
    it("should show suggestions when query is empty (#)", () => {
      // query.length === 0 ã§è¡¨ç¤ºç¢ºèª
    });

    it("should display results in latest-first order", () => {
      // æ›´æ–°é †ãŒæ–°ã—ã„ã‚‚ã® â†’ å¤ã„ã‚‚ã®
    });
  });

  describe("Selection state", () => {
    it("should not select any item initially", () => {
      // selectedIndex === -1
    });

    it("should allow arrow key selection", () => {
      // â†“ ã‚­ãƒ¼ã§ items[0] ã‚’é¸æŠ
    });

    it("should not auto-select on display", () => {
      // è¡¨ç¤ºæ™‚ã« self-selection ãŒãªã„
    });
  });

  describe("Enter key behavior", () => {
    it("should use input text when nothing selected", () => {
      // selectedIndex === -1 ã®å ´åˆã€å…¥åŠ›æ–‡å­—ã‚’ãã®ã¾ã¾ä½¿ç”¨
    });

    it("should use selected item when selected", () => {
      // selectedIndex >= 0 ã®å ´åˆã€é¸æŠã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨
    });

    it("should create link with input text", () => {
      // " #MyTag" + Enter â†’ MyTag ã§ãƒªãƒ³ã‚¯åŒ–
    });
  });
});
```

---

## å®Ÿè£…ä¿®æ­£ã®æµã‚Œ

### ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/plugins/__tests__/suggestion-plugin.test.ts`

ä¿®æ­£é …ç›®:
- [ ] ç©ºã‚¯ã‚¨ãƒªãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆ`query.length === 0` ã§è¡¨ç¤ºï¼‰
- [ ] åˆæœŸé¸æŠçŠ¶æ…‹ãƒ†ã‚¹ãƒˆä¿®æ­£ï¼ˆ`selectedIndex: 0` â†’ `-1`ï¼‰
- [ ] Enter ã‚­ãƒ¼å‹•ä½œãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆé¸æŠçŠ¶æ…‹åˆ¥ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ— 2: å®Ÿè£…ã‚’ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/plugins/suggestion-plugin.ts`

ä¿®æ­£é …ç›®:
- [ ] ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºæ¡ä»¶ã‚’ `query.length > 0` â†’ `query.length >= 0` ã«å¤‰æ›´
- [ ] åˆæœŸ `selectedIndex` ã‚’ `0` â†’ `-1` ã«å¤‰æ›´
- [ ] Enter ã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§é¸æŠçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/input-rules/tag-rule.ts`

ä¿®æ­£é …ç›®:
- [ ] ã‚µã‚¸ã‚§ã‚¹ãƒˆéé¸æŠæ™‚ã®å‡¦ç†ã‚’æ˜ç¢ºåŒ–

### ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ç¢ºèª

```bash
bun test lib/tiptap-extensions/unified-link-mark/plugins/__tests__/suggestion-plugin.test.ts
bun test lib/tiptap-extensions/unified-link-mark/input-rules/__tests__/tag-rule.test.ts
```

### ã‚¹ãƒ†ãƒƒãƒ— 4: ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèª

- [ ] `" #"` å…¥åŠ› â†’ ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
- [ ] `" #a"` å…¥åŠ› â†’ ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤º
- [ ] `" #MyTag"` + Enter â†’ MyTag ã§ãƒªãƒ³ã‚¯åŒ–
- [ ] â†“ ã‚­ãƒ¼ã§é¸æŠ â†’ Enter â†’ é¸æŠã‚¢ã‚¤ãƒ†ãƒ ã«ãƒªãƒ³ã‚¯

---

## è£œè¶³: ã‚µã‚¸ã‚§ã‚¹ãƒˆçµæœã®é †åº

**ç¾åœ¨**: ãŠãã‚‰ãä½œæˆé †ï¼ˆå¤ã„é †ï¼‰
**ä¿®æ­£å¾Œ**: æ›´æ–°é †ï¼ˆæ–°ã—ã„é †ï¼‰

**å®Ÿè£…ç®‡æ‰€**:
- `searchPages()` ã®æˆ»ã‚Šå€¤é †åº
- `lib/utils/searchPages.ts` ã‚’ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- ğŸ“‹ [å…ƒã®ãƒ¬ãƒãƒ¼ãƒˆ](20251019_04_tag-feature-verification.md)
- ğŸ”— [UnifiedLinkMark ä»•æ§˜æ›¸](../../02_requirements/features/unified-link-mark-spec.md)
- ğŸ”§ [å®Ÿè£…è¨ˆç”»](../../04_implementation/plans/unified-link-mark/)

---

**ä½œæˆè€…**: GitHub Copilot  
**ä½œæˆæ—¥**: 2025-10-19  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¦å¯¾å¿œ
