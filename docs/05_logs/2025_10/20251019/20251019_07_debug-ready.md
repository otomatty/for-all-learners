# タグ入力重複問題のデバッグ準備完了

**作成日**: 2025-10-19  
**ステータス**: 🔧 デバッグコード追加完了、ブラウザテスト待機中

---

## ✅ 完了した準備

### 1. デバッグコード追加

以下の 2 つのファイルにデバッグログを追加しました：

#### `lib/tiptap-extensions/unified-link-mark/plugins/suggestion-plugin.ts`

```typescript
// デバッグフラグ（1行目付近）
const DEBUG_TAG_DUPLICATION = true;

// デバッグログ関数（追加済み）
function debugLog(context, message, data?) { ... }

// 追加されたログ出力
- [KeyHandler] Enter/Tab/Space キー処理
- [insertUnifiedLinkWithQuery] リンク挿入処理
- [insertUnifiedLinkWithSpaceKey] スペース処理
```

#### `lib/tiptap-extensions/unified-link-mark/input-rules/tag-rule.ts`

```typescript
// デバッグフラグ（先頭）
const DEBUG_TAG_DUPLICATION = true;

// デバッグログ関数（追加済み）
function debugLog(context, message, data?) { ... }

// 追加されたログ出力
- [handler] TagInputRule が実行される全タイミング
- [handler] マッチした内容
- [handler] チェーン操作の実行状況
```

---

## 🚀 これからのテスト手順

### 最速でテストを開始するコマンド

```bash
# ターミナルで実行
cd /Users/sugaiakimasa/apps/for-all-learners
bun dev
```

その後、`http://localhost:3000` をブラウザで開き、デバッグコンソール（F12）を見ながらエディタで以下を実行：

### テストパターン

**テスト 1: Enter キー**
```
1. エディタに " #テスト" と入力（スペース必須）
2. Enter キーを押す
3. コンソールに以下のログが表示されることを確認:
   - [KeyHandler] Enter key pressed
   - [insertUnifiedLinkWithQuery] Starting insertion
   - 問題がなければ [TagRule] は表示されない
```

**テスト 2: Space キー**
```
1. 新しい段落を開く
2. " #テスト2" と入力
3. Space キーを押す
4. コンソール出力を確認
```

---

## 📊 予想される結果と問題診断

### シナリオ A: 正常な場合（期待値）

```
[16:45:23.100] [UnifiedLinkMark] [KeyHandler] Enter key pressed | {...}
[16:45:23.101] [UnifiedLinkMark] [KeyHandler] Clearing suggestion state immediately
[16:45:23.102] [UnifiedLinkMark] [KeyHandler] Creating link with input text | {"query":"テスト"}
[16:45:23.103] [UnifiedLinkMark] [insertUnifiedLinkWithQuery] Starting insertion | {...}
[16:45:23.104] [UnifiedLinkMark] [insertUnifiedLinkWithQuery] Inserting text with mark | {...}
[16:45:23.105] [UnifiedLinkMark] [insertUnifiedLinkWithQuery] Dispatching transaction

✅ エディタ: #テスト（# は 1 個）
```

### シナリオ B: 二重実行の問題（現在の症状）

```
[16:45:23.100] [UnifiedLinkMark] [KeyHandler] Enter key pressed | {...}
[16:45:23.101] [UnifiedLinkMark] [KeyHandler] Clearing suggestion state immediately
[16:45:23.102] [UnifiedLinkMark] [insertUnifiedLinkWithQuery] Starting insertion | {...}
[16:45:23.104] [UnifiedLinkMark] [insertUnifiedLinkWithQuery] Dispatching transaction
[16:45:23.105] [TagRule] [handler] Tag InputRule triggered | {
  "match":" #テスト",
  "raw":"テスト"
}
[16:45:23.106] [TagRule] [handler] Processing tag | {...}

❌ エディタ: ##テスト（# は 2 個）
```

### シナリオ C: 他の予期しない動作

その場合は、ログ全体をコピーして以下にまとめてください:

```markdown
## コンソール出力全文

[paste here]

## 観測された症状

[describe what you see]

## エディタの表示

[before/after の状態を記述]
```

---

## 📝 ブラウザテスト完了後にやることリスト

1. **ログ解析** → コンソール出力から原因を特定
2. **修正実装** → 原因に応じて comment/条件分岐などを修正
3. **テスト追加** → 重複を防ぐテストケースを追加
4. **再テスト** → ブラウザで再確認
5. **ドキュメント更新** → 修正内容と結果をドキュメント化

---

## 💡 デバッグのコツ

- **コンソール出力をフィルタリング**: 「UnifiedLinkMark」で検索すると、関連ログだけを表示できます
- **タイムスタンプで処理順序を把握**: ログの時刻から処理がどんな順序で実行されたか確認できます
- **Data 部分を展開**: ログの JSON データを開いて、具体的な値を確認できます
- **複数回実行**: 2 回、3 回実行することで、一貫性があるか確認できます

---

## 🔗 関連ドキュメント

- `docs/issues/open/20251019_07_tag-duplication-on-enter-space-keys.md` - 問題の詳細説明
- `docs/issues/open/20251019_07_debug-execution-guide.md` - デバッグ実行ガイド（詳細版）

---

**準備状態**: ✅ 完了  
**次のステップ**: ブラウザテストでログを確認
