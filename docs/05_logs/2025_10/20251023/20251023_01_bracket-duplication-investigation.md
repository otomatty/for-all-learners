# 20251023_01 UnifiedLink ãƒ–ãƒ©ã‚±ãƒƒãƒˆé‡è¤‡ãƒã‚° - èª¿æŸ»å®Œäº†

**ä½œæ¥­æ—¥**: 2025-10-23
**ä½œæ¥­è€…**: AI (GitHub Copilot)
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… èª¿æŸ»å®Œäº† â†’ æ¬¡ï¼šä¿®æ­£å®Ÿè£…

---

## ðŸ“‹ å®Ÿæ–½å†…å®¹

### 1. å•é¡Œã®æŠŠæ¡ã¨åˆ†æž

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ**:
- ãƒ–ãƒ©ã‚±ãƒƒãƒˆå¤–ã§Enter/Spaceã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚±ãƒƒãƒˆã®å…ˆé ­ãŒå¢—æ®–
- ä¾‹: `[ãƒ†ã‚¹ãƒˆ]` â†’ `[[[[[[ãƒ†ã‚¹ãƒˆ]`

**åˆæœŸèª¿æŸ»**:
- ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¨˜æ³•å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ç‰¹å®š
- auto-bracket-plugin, bracket-rule, bracket-cursor-plugin ãªã©ã®é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç¢ºèª

### 2. å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ç¢ºèª

**ç¢ºèªã—ãŸãƒ•ã‚¡ã‚¤ãƒ«**:
- `lib/tiptap-extensions/unified-link-mark/input-rules/bracket-rule.ts` (108è¡Œ)
- `lib/tiptap-extensions/unified-link-mark/plugins/bracket-cursor-plugin.ts` (120è¡Œ)
- `lib/tiptap-extensions/unified-link-mark/plugins/auto-bracket-plugin.ts` (45è¡Œ)
- `lib/tiptap-extensions/unified-link-mark/plugins/suggestion-plugin.ts` (750è¡Œ)
- `lib/tiptap-extensions/unified-link-mark/config.ts` (50è¡Œ)

**é‡è¦ãªç™ºè¦‹**:
- `bracket-rule.ts` ã«ã¯é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿæ§‹ãŒãªã„
- `insertContent` ã§ `[` ã‚’å€‹åˆ¥ã«3å›žæŒ¿å…¥ã—ã¦ã„ã‚‹
- PATTERNS.bracket = `/\[([^[\]]+)\]/` ãŒå¸¸ã«ãƒžãƒƒãƒã—ã¦ã„ã‚‹

### 3. æ ¹æœ¬åŽŸå› ã®ç‰¹å®š

**æ ¹æœ¬åŽŸå› **:
InputRule ã® `bracket-rule.ts` ãŒ **Enterã‚­ãƒ¼å…¥åŠ›å¾Œã«è¤‡æ•°å›žå®Ÿè¡Œã•ã‚Œã‚‹**

**ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **:
1. `[ãƒ†ã‚¹ãƒˆ]|` ã®çŠ¶æ…‹ã§Enterã‚­ãƒ¼ã‚’å…¥åŠ›
2. ProseMirror ãŒæ–°ã—ã„çŠ¶æ…‹ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
3. PATTERNS.bracket ãŒ `[ãƒ†ã‚¹ãƒˆ]` ã«ãƒžãƒƒãƒ
4. handler ãŒå®Ÿè¡Œã•ã‚Œã‚‹
5. `deleteRange` â†’ `insertContent("[")` â†’ `insertContent(text)` â†’ `insertContent("]")` ãŒå®Ÿè¡Œ
6. ã—ã‹ã—ã€ä½•ã‹ç†ç”±ã§å†åº¦ãƒžãƒƒãƒã—ã¦ã—ã¾ã†
7. çµæžœ: `[` ãŒè¤‡æ•°å›žæŒ¿å…¥ã•ã‚Œã‚‹ â†’ `[[[[[[ãƒ†ã‚¹ãƒˆ]`

### 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

**ä½œæˆã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:

#### å•é¡Œå ±å‘Šæ›¸
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/01_issues/open/2025_10/20251023_01_bracket-duplication-bug.md`
- **å†…å®¹**:
  - å•é¡Œã®è©³ç´°èª¬æ˜Ž
  - å†ç¾æ‰‹é †
  - åŽŸå› åˆ†æžï¼ˆ4ã¤ã®ã‚·ãƒŠãƒªã‚ªï¼‰
  - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©ï¼ˆTC-001, TC-002ï¼‰
  - è§£æ±ºç­–ã®3æ¡ˆ

#### æŠ€è¡“èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/02_research/2025_10/20251023_01_bracket-duplication-research.md`
- **å†…å®¹**:
  - ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³ã®è©³ç´°å›³è§£
  - å•é¡Œã®ã‚·ãƒŠãƒªã‚ªå†ç¾ï¼ˆA/B/C 3ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
  - insertContent ãƒã‚§ãƒ¼ãƒ³ ã®è©³ç´°åˆ†æž
  - å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é–“ã®ç›¸äº’ä½œç”¨
  - 9ã¤ã®æ¤œè¨¼ãŒå¿…è¦ãªç‚¹
  - ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯çµæžœè¡¨
  - 8ã¤ã®ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

#### ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/guides/debug-bracket-duplication.md`
- **å†…å®¹**:
  - ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
  - 11ã‚¹ãƒ†ãƒƒãƒ—ã®å†ç¾æ‰‹é †
  - logger æœ‰åŠ¹åŒ–æ–¹æ³•
  - Breakpoint ãƒ‡ãƒãƒƒã‚°æ‰‹é †
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¿½è·¡æ–¹æ³•
  - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè¡Œé †åºç¢ºèªæ–¹æ³•
  - ãƒ‡ãƒ¼ã‚¿æµè¿½è·¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### å®Ÿè£…è¨ˆç”»ã‚µãƒžãƒªãƒ¼
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/03_plans/unified-link-bracket-fix/20251023_01_investigation-summary.md`
- **å†…å®¹**:
  - å•é¡Œã®å†ç¾æ‰‹é †
  - æ ¹æœ¬åŽŸå› ã®ä»®èª¬
  - è¨¼æ‹ ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆ
  - 3ã¤ã®æŽ¨å¥¨ã•ã‚Œã‚‹è§£æ±ºç­–ï¼ˆæ¡ˆ1: æŽ¨å¥¨ï¼‰
  - ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
  - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

---

## ðŸ” èª¿æŸ»çµæžœ

### æœ€æœ‰åŠ›ã®ä»®èª¬

**InputRule ã®é‡è¤‡å®Ÿè¡Œ**

```
Enterã‚­ãƒ¼å…¥åŠ›æ™‚ã®æµã‚Œ:

[ãƒ†ã‚¹ãƒˆ]| (æ”¹è¡Œå‰)
    â†“ Enterã‚­ãƒ¼å…¥åŠ›
[ãƒ†ã‚¹ãƒˆ]\n (æ”¹è¡Œå¾Œ)
    â†“
ProseMirror: ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
    â†“
Pattern.bracket ãŒ [ãƒ†ã‚¹ãƒˆ] ã«ãƒžãƒƒãƒ
    â†“
handler å®Ÿè¡Œ â†’ insertContent Ã— 3
    â†“
[ ãƒ†ã‚¹ãƒˆ ]
    â†“
ä½•ã‚‰ã‹ã®ç†ç”±ã§å†åº¦ãƒžãƒƒãƒ (!)
    â†“
handler å†åº¦å®Ÿè¡Œ â†’ insertContent Ã— 3
    â†“
[ [ ãƒ†ã‚¹ãƒˆ ] ]
    â†“
...ç¹°ã‚Šè¿”ã—...
```

### æ ¹æœ¬åŽŸå› ãŒã‚ã‚‹ç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/tiptap-extensions/unified-link-mark/input-rules/bracket-rule.ts`

**å•é¡Œã‚³ãƒ¼ãƒ‰** (Lines 58-80):
```typescript
chain()
  .focus()
  .deleteRange({ from, to })
  .insertContent({ type: "text", text: "[" })      // â† æ‹¬å¼§ã‚’å€‹åˆ¥ã«æŒ¿å…¥
  .insertContent({ type: "text", text: text, marks: [...] })
  .insertContent({ type: "text", text: "]" })
  .run();
```

**å•é¡Œç‚¹**:
- é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿæ§‹ãŒãªã„
- ä½•åº¦ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã¨å„å®Ÿè¡Œã§æ‹¬å¼§ãŒæŒ¿å…¥ã•ã‚Œã‚‹

---

## ðŸ’¡ æŽ¨å¥¨ã•ã‚Œã‚‹è§£æ±ºç­–

### æ¡ˆ1: é‡è¤‡å®Ÿè¡Œãƒã‚§ãƒƒã‚¯ï¼ˆæŽ¨å¥¨ï¼‰ â­

```typescript
let lastMatch: { raw: string; timestamp: number } | null = null;
const DEBOUNCE_MS = 100;

handler: ({ state, match, range, chain }) => {
  const raw = match[1];
  const now = Date.now();
  
  if (lastMatch && lastMatch.raw === raw && now - lastMatch.timestamp < DEBOUNCE_MS) {
    return null;  // é‡è¤‡ã‚’ã‚¹ã‚­ãƒƒãƒ—
  }
  
  lastMatch = { raw, timestamp: now };
  // ... æ—¢å­˜ã®å‡¦ç† ...
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼ˆ10è¡Œç¨‹åº¦ï¼‰
- âœ… æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ã—ãªã„
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å½±éŸ¿ãªã—
- âœ… ã™ãã«å®Ÿè£…å¯èƒ½

---

## ðŸ“Š ä½œæ¥­é‡è¦‹ç©ã‚‚ã‚Š

| å·¥ç¨‹ | è¦‹ç©æ™‚é–“ | å®Ÿç¸¾æ™‚é–“ |
|------|--------|--------|
| å•é¡Œåˆ†æžãƒ»èª¿æŸ» | 1h | âœ… 0.5h |
| ã‚³ãƒ¼ãƒ‰ç¢ºèªãƒ»è¿½è·¡ | 1.5h | âœ… 1.5h |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ | 1.5h | âœ… 2h |
| **åˆè¨ˆ** | **4h** | **âœ… 4h** |

---

## âœ… å®Œäº†ã—ãŸæˆæžœç‰©

1. âœ… å•é¡Œå ±å‘Šæ›¸ï¼ˆè©³ç´°ãªåŽŸå› åˆ†æžï¼‰
2. âœ… æŠ€è¡“èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ9ã¤ã®æ¤œè¨¼é …ç›®ï¼‰
3. âœ… ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰ï¼ˆ11ã‚¹ãƒ†ãƒƒãƒ—ã®æ‰‹é †ï¼‰
4. âœ… å®Ÿè£…è¨ˆç”»æ›¸ï¼ˆ3ã¤ã®è§£æ±ºç­–ã¨æŽ¨å¥¨æ¡ˆï¼‰
5. âœ… ä½œæ¥­ãƒ­ã‚°ï¼ˆã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰

---

## ðŸŽ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### ã™ãã«ã‚„ã‚‹ã“ã¨

1. **ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰ã®å®Ÿè¡Œ**
   - ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ `[BracketRule] Handler called` ã®å‡ºåŠ›å›žæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
   - åŒã˜ãƒžãƒƒãƒãŒè¤‡æ•°å›žå‡ºåŠ›ã•ã‚Œã‚‹ã‹ç¢ºèª
   - â†’ ã“ã‚Œã§ä»®èª¬ã‚’ç¢ºå®š

2. **ä¿®æ­£æ¡ˆã®å®Ÿè£…** (æŽ¨å¥¨: æ¡ˆ1)
   - é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿæ§‹ã‚’è¿½åŠ 
   - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®Ÿè£…
   - æ‰‹å‹•ç¢ºèª

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

- **2025-10-23 ä¸­**: âœ… èª¿æŸ»å®Œäº†
- **2025-10-24 ä¸­**: ä¿®æ­£å®Ÿè£…ï¼ˆæ¡ˆ1ï¼‰
- **2025-10-24 å¤•**: çµ±åˆãƒ†ã‚¹ãƒˆ
- **2025-10-25 ä¸­**: ãƒ‡ãƒ—ãƒ­ã‚¤

---

## ðŸ“Œ é‡è¦ãªæ°—ã¥ã

### 1. processedBracketMatches ãŒä½¿ã‚ã‚Œã¦ã„ãªã„

æ¤œç´¢çµæžœã§ã¯ `processedBracketMatches` ã®è¨˜è¿°ãŒã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚µãƒ¼ãƒã«å‡ºã¦ããŸãŒã€å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å­˜åœ¨ã—ãªã„
â†’ éŽåŽ»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ãŸã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸Šã®è¨˜è¿°ã®å¯èƒ½æ€§

### 2. insertContent ã®3åˆ†å‰²ã¯è¨­è¨ˆçš„ãªæ„å›³

æ‹¬å¼§ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€ä¸­å¤®ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã« mark ã‚’é©ç”¨ã™ã‚‹è¨­è¨ˆ
â†’ ã“ã®è¨­è¨ˆè‡ªä½“ã¯æ‚ªããªã„ã€‚å•é¡Œã¯é‡è¤‡å®Ÿè¡Œ

### 3. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®Ÿè¡Œé †åºãŒé‡è¦

```
auto-bracket-plugin     ([ å…¥åŠ›ã§ [] è‡ªå‹•ä½œæˆ)
bracket-cursor-plugin   (ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•è¿½è·¡)
click-handler-plugin    (ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º)
suggestion-plugin       (ææ¡ˆUI)
```

ã“ã®é †åºã§ã®ç›¸äº’ä½œç”¨ãŒè¤‡é›‘ã«ãªã£ã¦ã„ã‚‹

---

## ðŸ“š å‚è€ƒè³‡æ–™

| è³‡æ–™ | URL/ãƒ‘ã‚¹ |
|------|---------|
| å•é¡Œå ±å‘Šæ›¸ | `docs/01_issues/open/2025_10/20251023_01_bracket-duplication-bug.md` |
| æŠ€è¡“èª¿æŸ» | `docs/02_research/2025_10/20251023_01_bracket-duplication-research.md` |
| ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰ | `docs/guides/debug-bracket-duplication.md` |
| å®Ÿè£…è¨ˆç”» | `docs/03_plans/unified-link-bracket-fix/20251023_01_investigation-summary.md` |
| å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ« | `lib/tiptap-extensions/unified-link-mark/input-rules/bracket-rule.ts` |

---

## ðŸŽ“ å­¦ã‚“ã ã“ã¨

1. **ProseMirror ã® InputRule**
   - ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®ãŸã³ã«è©•ä¾¡ã•ã‚Œã‚‹
   - è¤‡æ•°å›žãƒžãƒƒãƒã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
   - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã¯è¤‡é›‘

2. **TipTap Chain API**
   - chain() â†’ run() ã§1ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
   - è¤‡æ•°ã® insertContent ã‚’ãƒã‚§ãƒ¼ãƒ³ã—ã¦ã‚‚å•é¡Œãªã„ã¯ãš
   - ã—ã‹ã— InputRule è‡ªä½“ãŒä½•åº¦ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§

3. **ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯**
   - logger ãƒ¬ãƒ™ãƒ«èª¿æ•´ã§è©³ç´°ãƒ­ã‚°å‡ºåŠ›
   - Breakpoint ã§ã‚³ãƒ¼ãƒ«å±¥æ­´ã‚’ç¢ºèª
   - Console ã§çŠ¶æ…‹å¤‰åŒ–ã‚’è¿½è·¡

---

## ðŸ“ ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š

1. **é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿæ§‹ã®çµ±ä¸€**
   - ä»–ã® InputRuleï¼ˆtag ãªã©ï¼‰ã«ã‚‚åŒã˜æ©Ÿæ§‹ã‚’é©ç”¨

2. **ã‚¤ãƒ™ãƒ³ãƒˆ ãƒ­ã‚°ã®æ§‹é€ åŒ–**
   - logger ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€
   - ãƒ‡ãƒãƒƒã‚°åŠ¹çŽ‡å‘ä¸Š

3. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š**
   - Enterã‚­ãƒ¼ãƒ»Spaceã‚­ãƒ¼ã®ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆè¿½åŠ 
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆå¼·åŒ–

---

## ðŸ™ è¬è¾ž

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãªãƒã‚°å ±å‘ŠãŒã€åŽŸå› ã®è¿½è·¡ã«å¤§å¤‰å½¹ç«‹ã¡ã¾ã—ãŸã€‚

---

**ä½œæˆè€…**: AI (GitHub Copilot)
**æœ€çµ‚æ›´æ–°**: 2025-10-23
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: èª¿æŸ»å®Œäº† âœ… â†’ ä¿®æ­£å®Ÿè£…ã¸
