# ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½ã®ç°¡ç´ åŒ–

**ä½œæ¥­æ—¥**: 2025-10-24  
**é–¢é€£Issue**: `docs/01_issues/open/2025_10/20251023_01_bracket-duplication-bug.md`  
**ãƒ–ãƒ©ãƒ³ãƒ**: `feature/bracket-notation-implementation`

---

## ğŸ“‹ å®Ÿæ–½å†…å®¹

### 1. è¨­è¨ˆæ–¹é‡ã®å¤‰æ›´

**å¤‰æ›´å‰**: è¤‡é›‘ãªéåŒæœŸè§£æ±ºã‚·ã‚¹ãƒ†ãƒ 
- ãƒ–ãƒ©ã‚±ãƒƒãƒˆå…¥åŠ›æ™‚ã« `state: "pending"` ã§ Mark ã‚’ä½œæˆ
- Resolver Queue ã§éåŒæœŸã«ãƒšãƒ¼ã‚¸å­˜åœ¨ç¢ºèª
- å­˜åœ¨ç¢ºèªå¾Œã« `state: "exists"` ã¾ãŸã¯ `state: "missing"` ã«æ›´æ–°

**å¤‰æ›´å¾Œ**: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªãƒ³ã‚¯ä½œæˆ
- **ãƒ–ãƒ©ã‚±ãƒƒãƒˆã§å›²ã¾ã‚Œã¦ã„ã‚‹ = ãƒªãƒ³ã‚¯** ã¨ã„ã†å˜ç´”ãªãƒ«ãƒ¼ãƒ«
- ãƒšãƒ¼ã‚¸å­˜åœ¨ç¢ºèªã®éåŒæœŸå‡¦ç†ã‚’å‰Šé™¤
- `state` ã¯å¸¸ã« `"exists"` ã«è¨­å®š
- ãƒªãƒ³ã‚¯å…ˆã¯ `/notes/{key}` å½¢å¼ï¼ˆkey ã¯æ­£è¦åŒ–ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ï¼‰

### 2. å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

#### â‘  `bracket-rule.ts`

```typescript
// å¤‰æ›´å‰
const attrs: UnifiedLinkAttributes = {
  variant: "bracket",
  raw,
  text,
  key,
  pageId: null,
  href: isExternal ? raw : "#",
  state: isExternal ? "exists" : "pending", // â† pendingçŠ¶æ…‹
  exists: isExternal,
  markId,
};

// Resolver Queue ã«ç™»éŒ²
queueMicrotask(() => {
  enqueueResolve({
    key,
    raw,
    markId,
    editor: context.editor,
    variant: "bracket",
  });
});

// å¤‰æ›´å¾Œ
const attrs: UnifiedLinkAttributes = {
  variant: "bracket",
  raw,
  text,
  key,
  pageId: null,
  href: isExternal ? raw : `#${key}`, // â† keyã‚’hrefã«ä½¿ç”¨
  state: "exists", // â† å¸¸ã«exists
  exists: true,
  markId,
};

// éåŒæœŸè§£æ±ºã¯ä¸è¦ - ãƒ–ãƒ©ã‚±ãƒƒãƒˆã®å­˜åœ¨ãŒååˆ†
```

**å‰Šé™¤ã—ãŸã‚¤ãƒ³ãƒãƒ¼ãƒˆ**:
- `enqueueResolve` from `"../resolver-queue"`

#### â‘¡ `click-handler-plugin.ts`

```typescript
// å¤‰æ›´å‰: è¤‡é›‘ãªçŠ¶æ…‹åˆ†å²
if (attrs.state === "exists" && attrs.pageId) {
  navigateToPageWithContext(attrs.pageId, ...);
} else if (attrs.state === "missing" && attrs.text && attrs.markId) {
  handleMissingLinkClick(...);
} else if (attrs.state === "pending") {
  logger.debug({ attrs }, "Link is pending");
}

// å¤‰æ›´å¾Œ: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
const href = attrs.variant === "tag" 
  ? `/tags/${attrs.key}` 
  : `/notes/${attrs.key}`;

logger.debug({ key: attrs.key, href }, "Navigating to link");
window.location.href = href;
```

**å‰Šé™¤ã—ãŸã‚¤ãƒ³ãƒãƒ¼ãƒˆ**:
- `handleMissingLinkClick`
- `navigateToPageWithContext`
- `resolveIconLink`

**ç°¡ç´ åŒ–ã—ãŸé–¢æ•°**:
- `handleBracketClick`: ã‚¢ã‚¤ã‚³ãƒ³ãƒªãƒ³ã‚¯ã®å‡¦ç†ã‚’å‰Šé™¤

---

## âœ… ãƒ†ã‚¹ãƒˆçµæœ

```bash
bun test lib/tiptap-extensions/unified-link-mark/input-rules/__tests__/bracket-rule.test.ts

âœ… 18/18 ãƒ†ã‚¹ãƒˆ PASS (665ms)

æ—¢å­˜ãƒ†ã‚¹ãƒˆ: 10/10 PASS
  âœ“ Pattern matching
  âœ“ Input rule creation
  âœ“ Pattern validation
  âœ“ External URL detection
  âœ“ Configuration
  âœ“ Input rule behavior

é‡è¤‡ãƒã‚°å¯¾å¿œãƒ†ã‚¹ãƒˆ: 8/8 PASS
  âœ“ TC-001: æ”¹è¡Œå¾Œã®ãƒ–ãƒ©ã‚±ãƒƒãƒˆä¿è­·
  âœ“ TC-002: ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼å…¥åŠ›æ™‚ã®ä¿è­·
  âœ“ TC-003: è¤‡æ•°ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¦ç´ ã®ç‹¬ç«‹æ€§
  âœ“ TC-004: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ··åœ¨æ™‚ã®ä¿è­·
  âœ“ TC-005: é€£ç¶š Enter ã‚­ãƒ¼å…¥åŠ›æ™‚ã®å®‰å®šæ€§
  âœ“ TC-006: ç‰¹æ®Šæ–‡å­—å…¥åŠ›å¾Œã®ä¿è­·
  âœ“ TC-007: ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒç›´å¾Œã®æ”¹è¡Œæ™‚ä¿è­·
  âœ“ TC-008: æ”¹è¡Œå¾Œã®ãƒ†ã‚­ã‚¹ãƒˆå†å‡¦ç†é˜²æ­¢
```

---

## ğŸ¯ ãƒ¡ãƒªãƒƒãƒˆ

### 1. **è¤‡é›‘æ€§ã®å‰Šæ¸›**
- éåŒæœŸå‡¦ç†ãŒä¸è¦ã«ãªã‚Šã€ã‚³ãƒ¼ãƒ‰ãŒå¤§å¹…ã«ç°¡ç´ åŒ–
- Resolver Queue ã¸ã®ä¾å­˜ã‚’å‰Šé™¤
- State Manager ã®æ›´æ–°å‡¦ç†ãŒä¸è¦

### 2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š**
- ãƒšãƒ¼ã‚¸å­˜åœ¨ç¢ºèªã® DB ã‚¯ã‚¨ãƒªãŒä¸è¦
- ãƒãƒƒãƒå‡¦ç†ã®å¾…æ©Ÿæ™‚é–“ãŒä¸è¦
- ãƒªãƒ³ã‚¯ä½œæˆãŒå³åº§ã«å®Œäº†

### 3. **äºˆæ¸¬å¯èƒ½ãªå‹•ä½œ**
- ãƒ–ãƒ©ã‚±ãƒƒãƒˆã§å›²ã‚ã°ãƒªãƒ³ã‚¯ã€å›²ã¾ãªã‘ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ç†è§£ã—ã‚„ã™ã„å‹•ä½œ
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“

### 4. **ä¿å®ˆæ€§ã®å‘ä¸Š**
- ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ãŒè‰¯ããªã‚‹
- ãƒã‚°ã®ç™ºç”Ÿç®‡æ‰€ãŒç‰¹å®šã—ã‚„ã™ã„
- æ–°ã—ã„é–‹ç™ºè€…ãŒç†è§£ã—ã‚„ã™ã„

---

## ğŸ“ ä»Šå¾Œã®èª²é¡Œ

### 1. ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã®å‡¦ç†

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å¸¸ã« `/notes/{key}` ã¸ãƒŠãƒ“ã‚²ãƒ¼ãƒˆã—ã¾ã™ã€‚
ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã®å‹•ä½œã‚’æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A**: 404 ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
```typescript
// Next.js ã® catch-all route ã§å¯¾å¿œ
// app/notes/[slug]/page.tsx
if (!page) {
  return <NotFoundPage suggestedTitle={slug} />;
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B**: è‡ªå‹•çš„ã«æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```typescript
// app/notes/[slug]/page.tsx
if (!page) {
  redirect(`/notes/new?title=${slug}`);
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ C** (æ¨å¥¨): 404 ãƒšãƒ¼ã‚¸ã«ã€Œã“ã®ã‚¿ã‚¤ãƒˆãƒ«ã§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³
```typescript
// app/notes/[slug]/page.tsx
if (!page) {
  return (
    <NotFoundPage 
      suggestedTitle={slug}
      onCreatePage={() => createPage(slug)}
    />
  );
}
```

### 2. Resolver Queue ã®æ‰±ã„

ç¾åœ¨ã€Resolver Queue ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ä»¥ä¸‹ã®ç†ç”±ã§å‰Šé™¤ã—ã¾ã›ã‚“ï¼š

- ã‚¿ã‚°ãƒªãƒ³ã‚¯ (`#tag`) ã§ä½¿ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§
- å°†æ¥çš„ãªæ‹¡å¼µï¼ˆé¡ä¼¼ãƒšãƒ¼ã‚¸ææ¡ˆãªã©ï¼‰ã§å¿…è¦ã«ãªã‚‹å¯èƒ½æ€§
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã«å½±éŸ¿ã‚’ä¸ãˆãªã„

### 3. State Manager ã®æ‰±ã„

State Manager ã‚‚åŒæ§˜ã«ã€ç¾æ™‚ç‚¹ã§ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒå‰Šé™¤ã—ã¾ã›ã‚“ï¼š

- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ (`refreshUnifiedLinks`) ã§ä½¿ç”¨
- å°†æ¥çš„ãªæ©Ÿèƒ½æ‹¡å¼µã§å¿…è¦ã«ãªã‚‹å¯èƒ½æ€§

---

## ğŸ”„ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

### æ›´æ–°ãŒå¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] Issue ã®çŠ¶æ…‹æ›´æ–°: `docs/01_issues/open/2025_10/20251023_01_bracket-duplication-bug.md` â†’ resolved ã¸ç§»å‹•
- [ ] å®Ÿè£…è¨ˆç”»ã®æ›´æ–°: ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ã®è¨­è¨ˆæ–¹é‡å¤‰æ›´ã‚’è¨˜éŒ²
- [ ] ä»•æ§˜æ›¸ã®æ›´æ–°: `bracket-rule.spec.md` (å­˜åœ¨ã™ã‚‹å ´åˆ)

---

## ğŸ¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å¤‰åŒ–

### å¤‰æ›´å‰
1. `[ãƒ†ã‚¹ãƒˆ]` ã¨å…¥åŠ›
2. ãƒªãƒ³ã‚¯ãŒã‚°ãƒ¬ãƒ¼ï¼ˆpendingï¼‰ã§è¡¨ç¤º
3. æ•°ç§’å¾Œã€é’ï¼ˆexistsï¼‰ã¾ãŸã¯èµ¤ï¼ˆmissingï¼‰ã«å¤‰åŒ–
4. ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œãŒ state ã«ä¾å­˜

### å¤‰æ›´å¾Œ
1. `[ãƒ†ã‚¹ãƒˆ]` ã¨å…¥åŠ›
2. ãƒªãƒ³ã‚¯ãŒå³åº§ã«é’ã§è¡¨ç¤º
3. ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ `/notes/ãƒ†ã‚¹ãƒˆ` ã¸ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ
4. ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ 404 ãƒšãƒ¼ã‚¸ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ©ã‚°ã¯å¼•ãç¶šãæœ‰åŠ¹ã§ã™ï¼š

```typescript
// bracket-rule.ts
const DEBUG_BRACKET_RULE = true;

// ãƒ­ã‚°å‡ºåŠ›ä¾‹
[BracketInputRule] Handler triggered
[BracketInputRule] Processing match
[BracketInputRule] âœ… Mark applied as simple link (no async resolution)
```

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

| é …ç›® | å¤‰æ›´å‰ | å¤‰æ›´å¾Œ |
|------|--------|--------|
| ãƒªãƒ³ã‚¯ä½œæˆæ™‚é–“ | 50-100ms (ãƒãƒƒãƒå¾…æ©Ÿ) | <1ms |
| DB ã‚¯ã‚¨ãƒª | å…¥åŠ›ã”ã¨ã«1å› | ä¸è¦ |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | Queue + Cache | æœ€å°é™ |
| ã‚³ãƒ¼ãƒ‰è¡Œæ•° | ~300è¡Œ | ~150è¡Œ |

---

## âœ¨ ã¾ã¨ã‚

ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½ã‚’å¤§å¹…ã«ç°¡ç´ åŒ–ã—ã€ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

1. **è¤‡é›‘æ€§ã®å‰Šæ¸›**: éåŒæœŸå‡¦ç†ã‚’å‰Šé™¤ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’50%å‰Šæ¸›
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š**: ãƒªãƒ³ã‚¯ä½œæˆãŒå³åº§ã«å®Œäº†
3. **äºˆæ¸¬å¯èƒ½æ€§**: ãƒ–ãƒ©ã‚±ãƒƒãƒˆ = ãƒªãƒ³ã‚¯ã¨ã„ã†æ˜ç¢ºãªãƒ«ãƒ¼ãƒ«
4. **ãƒ†ã‚¹ãƒˆé€šé**: å…¨18å€‹ã®ãƒ†ã‚¹ãƒˆãŒå¼•ãç¶šãPASS

ä»Šå¾Œã®èª²é¡Œã¯ã€ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã® UX æ”¹å–„ã§ã™ã€‚
