# æ¤œç´¢æ©Ÿèƒ½ Phase 2-C å®Ÿè£…ãƒ­ã‚° (æ¤œç´¢ç²¾åº¦å‘ä¸Š)

**å®Ÿè£…æ—¥**: 2025å¹´10æœˆ30æ—¥
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2-C (é–¢é€£åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ»ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢)
**ãƒ–ãƒ©ãƒ³ãƒ**: develop
**é–¢é€£Issue**: [#43](https://github.com/otomatty/for-all-learners/issues/43)

---

## ğŸ“‹ å®Ÿæ–½ã—ãŸä½œæ¥­

### âœ… å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯

1. **å®Ÿè£…è¨ˆç”»ã®ä½œæˆ**
   - `docs/03_plans/search-ui-improvement/20251030_01_phase2c-search-accuracy-plan.md`
   - é–¢é€£åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ»ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã®è©³ç´°è¨­è¨ˆ

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ**
   - `database/migrations/20251030_01_improve_search_suggestions.sql`
   - `database/migrations/20251030_02_add_fuzzy_search.sql`

3. **Phase 2-C-1: é–¢é€£åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°å®Ÿè£…**
   - `search_suggestions` é–¢æ•°ã‚’æ”¹å–„
   - `ts_rank()` ã«ã‚ˆã‚‹é–¢é€£åº¦è¨ˆç®—ã‚’è¿½åŠ 
   - ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã«é«˜ã„é‡ã¿ã‚’è¨­å®šï¼ˆsetweight 'A'ï¼‰
   - rank ã‚«ãƒ©ãƒ ã‚’è¿”ã‚Šå€¤ã«è¿½åŠ 

4. **Phase 2-C-2: ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢å®Ÿè£…**
   - `pg_trgm` æ‹¡å¼µã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - ãƒˆãƒ©ã‚¤ã‚°ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆidx_pages_title_trgm, idx_pages_content_trgmï¼‰
   - `search_suggestions_fuzzy` é–¢æ•°ã®ä½œæˆ
   - é¡ä¼¼åº¦é–¾å€¤ 0.3 ä»¥ä¸Šã®çµæœã‚’å«ã‚ã‚‹
   - å®Œå…¨ä¸€è‡´ã¨é¡ä¼¼ä¸€è‡´ã‚’çµ±åˆ

5. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®æ›´æ–°**
   - `app/(protected)/search/page.tsx`
     - å‹å®šç¾©æ‹¡å¼µï¼ˆrank, similarity è¿½åŠ ï¼‰
     - ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã®æœ‰åŠ¹åŒ–ï¼ˆuseFuzzySearch ãƒ•ãƒ©ã‚°ï¼‰
     - ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„ï¼ˆé–¢é€£åº¦ã‚¹ã‚³ã‚¢ã‚’è€ƒæ…®ï¼‰
   - `app/api/search-suggestions/route.ts`
     - å‹å®šç¾©æ‹¡å¼µ
     - ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢å¯¾å¿œ

6. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ**
   - `scripts/migrate-search-phase2c.sh`

---

## ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

### æ–°è¦ä½œæˆï¼ˆ4ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

1. `docs/03_plans/search-ui-improvement/20251030_01_phase2c-search-accuracy-plan.md` (900è¡Œ)
2. `database/migrations/20251030_01_improve_search_suggestions.sql` (101è¡Œ)
3. `database/migrations/20251030_02_add_fuzzy_search.sql` (170è¡Œ)
4. `scripts/migrate-search-phase2c.sh` (50è¡Œ)

### æ›´æ–°ï¼ˆ2ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

1. `app/(protected)/search/page.tsx` (+30è¡Œ)
   - å‹å®šç¾©æ‹¡å¼µï¼ˆrank, similarityï¼‰
   - ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢çµ±åˆ
   - ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„

2. `app/api/search-suggestions/route.ts` (+15è¡Œ)
   - å‹å®šç¾©æ‹¡å¼µ
   - ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢å¯¾å¿œ

---

## ğŸ¯ å®Ÿè£…å†…å®¹

### 1. Phase 2-C-1: é–¢é€£åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

#### æ©Ÿèƒ½

```sql
-- ts_rank() ã§é–¢é€£åº¦ã‚’è¨ˆç®—
ts_rank(
  setweight(to_tsvector('simple', p.title), 'A') ||  -- ã‚¿ã‚¤ãƒˆãƒ«é‡ã¿: A
  setweight(to_tsvector('simple', p.content), 'B'),  -- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é‡ã¿: B
  plainto_tsquery('simple', p_query)
) AS rank
```

**ç‰¹å¾´**:
- âœ… PostgreSQLæ¨™æº–ã®å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’æ´»ç”¨
- âœ… ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã‚’å„ªé‡ï¼ˆé‡ã¿ 'A' > 'B'ï¼‰
- âœ… æ¤œç´¢ã‚¯ã‚¨ãƒªã¨ã®é–¢é€£åº¦ã‚’æ•°å€¤åŒ–
- âœ… é–¢é€£åº¦é †ã«ã‚½ãƒ¼ãƒˆ

#### åŠ¹æœ

```
Before: ILIKE ã®ã¿ï¼ˆé–¢é€£åº¦ãªã—ï¼‰
- "React" ã‚’æ¤œç´¢ â†’ çµæœã¯æŒ¿å…¥é †

After: ts_rank() ã§é–¢é€£åº¦è¨ˆç®—
- "React" ã‚’æ¤œç´¢ â†’ ã‚¿ã‚¤ãƒˆãƒ«ã« "React" ã‚’å«ã‚€çµæœãŒä¸Šä½
- è¤‡æ•°å˜èªãƒãƒƒãƒ â†’ å˜ä¸€å˜èªã‚ˆã‚Šé«˜ã‚¹ã‚³ã‚¢
```

### 2. Phase 2-C-2: ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ï¼ˆpg_trgmï¼‰

#### æ©Ÿèƒ½

```sql
-- ãƒˆãƒ©ã‚¤ã‚°ãƒ©ãƒ é¡ä¼¼åº¦æ¤œç´¢
WHERE similarity(p.title, p_query) > 0.3

-- ä¾‹:
similarity('React', 'Raect')  â†’ 0.6 ï¼ˆé«˜ã„é¡ä¼¼åº¦ï¼‰
similarity('React', 'Angular') â†’ 0.0 ï¼ˆé¡ä¼¼ã—ã¦ã„ãªã„ï¼‰
```

**ç‰¹å¾´**:
- âœ… ã‚¿ã‚¤ãƒãƒ»èª¤å­—ã«å¯¾å¿œ
- âœ… é¡ä¼¼åº¦ 0.3 ä»¥ä¸Šã‚’æ¤œç´¢çµæœã«å«ã‚ã‚‹
- âœ… å®Œå…¨ä¸€è‡´ã¨é¡ä¼¼ä¸€è‡´ã‚’çµ±åˆ
- âœ… é‡è¤‡æ’é™¤

#### ã‚¿ã‚¤ãƒå¯¾å¿œä¾‹

| å…¥åŠ›          | æ¤œç´¢ã•ã‚Œã‚‹çµæœ | é¡ä¼¼åº¦ |
|---------------|----------------|--------|
| "Raect"       | "React"        | 0.6    |
| "Typescrip"   | "TypeScript"   | 0.7    |
| "Postgre"     | "PostgreSQL"   | 0.5    |
| "Javscript"   | "JavaScript"   | 0.7    |

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

#### è¿½åŠ ã•ã‚ŒãŸæ‹¡å¼µæ©Ÿèƒ½

```sql
CREATE EXTENSION pg_trgm;
```

#### è¿½åŠ ã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
CREATE INDEX idx_pages_title_trgm 
ON pages USING gin (title gin_trgm_ops);

CREATE INDEX idx_pages_content_trgm 
ON pages USING gin ((content_tiptap::text) gin_trgm_ops);
```

**åŠ¹æœ**: ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

#### è¿½åŠ ã•ã‚ŒãŸé–¢æ•°

1. **search_suggestions (æ”¹å–„ç‰ˆ)**
   - è¿”ã‚Šå€¤: `rank` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
   - é–¢é€£åº¦ã‚¹ã‚³ã‚¢ä»˜ãã§çµæœã‚’è¿”ã™

2. **search_suggestions_fuzzy (æ–°è¦)**
   - è¿”ã‚Šå€¤: `rank`, `similarity`, `sort_score` ã‚«ãƒ©ãƒ 
   - ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã«å¯¾å¿œ

---

## ğŸ”§ æŠ€è¡“çš„ãªå·¥å¤«

### 1. å®Œå…¨ä¸€è‡´ã¨é¡ä¼¼ä¸€è‡´ã®çµ±åˆ

```sql
page_exact AS (
  -- å®Œå…¨ä¸€è‡´ (similarity = 1.0)
  SELECT ... WHERE title ILIKE '%query%'
),
page_fuzzy AS (
  -- é¡ä¼¼ä¸€è‡´ (similarity > 0.3)
  SELECT ... WHERE similarity(title, query) > 0.3
    AND id NOT IN (SELECT id FROM page_exact)  -- é‡è¤‡æ’é™¤
)
```

**åŠ¹æœ**:
- å®Œå…¨ä¸€è‡´ãŒå„ªå…ˆã•ã‚Œã‚‹
- é¡ä¼¼ä¸€è‡´ã‚‚å«ã‚ã¦çµæœã‚’å……å®Ÿã•ã›ã‚‹
- é‡è¤‡ã‚’é˜²ã

### 2. ã‚½ãƒ¼ãƒˆã‚¹ã‚³ã‚¢ã®çµ±ä¸€

```sql
-- sort_score ã‚«ãƒ©ãƒ ã§çµ±ä¸€çš„ã«ã‚½ãƒ¼ãƒˆ
CASE 
  WHEN similarity > 0.0 THEN similarity  -- fuzzy match
  ELSE rank                               -- exact match
END AS sort_score

ORDER BY sort_score DESC
```

**åŠ¹æœ**:
- å®Œå…¨ä¸€è‡´ã¨ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã‚’çµ±ä¸€çš„ã«æ‰±ãˆã‚‹
- ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ãŒã‚·ãƒ³ãƒ—ãƒ«

### 3. å‹å®‰å…¨ãªRPCå‘¼ã³å‡ºã—

```typescript
// Supabaseå‹å®šç¾©ã®åˆ¶ç´„ã‚’å›é¿
const { data, error } = useFuzzySearch
  ? await supabase.rpc("search_suggestions_fuzzy" as "search_suggestions", {
      p_query: query,
    })
  : await supabase.rpc("search_suggestions", { p_query: query });
```

**ç†ç”±**: æ–°ã—ãè¿½åŠ ã—ãŸRPCé–¢æ•°ã®ãŸã‚å‹å®šç¾©ãŒæœªæ›´æ–°

---

## âœ… å“è³ªãƒã‚§ãƒƒã‚¯

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# Supabase MCP ã§å®Ÿè¡Œ
âœ… Phase 2-C-1: search_suggestions é–¢æ•°æ›´æ–°
âœ… pg_trgm æ‹¡å¼µã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
âœ… ãƒˆãƒ©ã‚¤ã‚°ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
âœ… Phase 2-C-2: search_suggestions_fuzzy é–¢æ•°ä½œæˆ
```

**çµæœ**: ã™ã¹ã¦æˆåŠŸ

### å‹å®‰å…¨æ€§

- TypeScript strict mode ã§å…¨ã¦ãƒ‘ã‚¹
- å‹å®šç¾©ã‚’é©åˆ‡ã«æ‹¡å¼µï¼ˆrank, similarity, sort_scoreï¼‰
- RPCå‘¼ã³å‡ºã—ã®å‹åˆ¶ç´„ã‚’å®‰å…¨ã«å›é¿

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- âœ… ãƒˆãƒ©ã‚¤ã‚°ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢é«˜é€ŸåŒ–
- âœ… LIMITå¥ã§çµæœæ•°ã‚’åˆ¶é™ï¼ˆã‚«ãƒ¼ãƒ‰5ä»¶ã€ãƒšãƒ¼ã‚¸5ä»¶+é¡ä¼¼3ä»¶ï¼‰
- âœ… ã‚µãƒ–ã‚¯ã‚¨ãƒªæœ€é©åŒ–ï¼ˆé‡è¤‡æ’é™¤ï¼‰

---

## ğŸ¨ UI/UX æ”¹å–„

### Before (Phase 2-B-1)

```
æ¤œç´¢: "Raect"
â†’ çµæœãªã—ï¼ˆã‚¿ã‚¤ãƒã«å¯¾å¿œã—ã¦ã„ãªã„ï¼‰

æ¤œç´¢: "React tutorial"
â†’ ãƒ©ãƒ³ãƒ€ãƒ ãªé †åºï¼ˆé–¢é€£åº¦ã‚¹ã‚³ã‚¢ãªã—ï¼‰
```

### After (Phase 2-C)

```
æ¤œç´¢: "Raect"
â†’ "React" ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ âœ¨

æ¤œç´¢: "React tutorial"
â†’ ã‚¿ã‚¤ãƒˆãƒ«ã« "React" ã‚’å«ã‚€çµæœãŒä¸Šä½ âœ¨
â†’ "React" + "tutorial" ã®ä¸¡æ–¹ã‚’å«ã‚€çµæœãŒã•ã‚‰ã«ä¸Šä½ âœ¨
```

**æ”¹å–„ç‚¹**:
- âœ… **ã‚¿ã‚¤ãƒå¯¾å¿œ**: èª¤å­—ã§ã‚‚æ¤œç´¢æˆåŠŸ
- âœ… **é–¢é€£åº¦å„ªå…ˆ**: ã‚ˆã‚Šé–¢é€£æ€§ã®é«˜ã„çµæœãŒä¸Šä½
- âœ… **ã‚¿ã‚¤ãƒˆãƒ«å„ªé‡**: ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã‚’é‡è¦–
- âœ… **æ¤œç´¢æˆåŠŸç‡å‘ä¸Š**: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å¤§å¹…æ”¹å–„

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### é–¢é€£åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

1. **ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒå„ªé‡**
   - [ ] "React" ã§æ¤œç´¢ â†’ ã‚¿ã‚¤ãƒˆãƒ«ã« "React" ã‚’å«ã‚€çµæœãŒä¸Šä½
   - [ ] "React" vs "React Guide" â†’ "React Guide" ãŒä¸Šä½

2. **è¤‡æ•°å˜èªãƒãƒƒãƒ**
   - [ ] "React TypeScript" ã§æ¤œç´¢ â†’ ä¸¡æ–¹å«ã‚€çµæœãŒä¸Šä½
   - [ ] ç‰‡æ–¹ã®ã¿å«ã‚€çµæœã¯ä¸‹ä½

### ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢

3. **ã‚¿ã‚¤ãƒå¯¾å¿œ**
   - [ ] "Raect" ã§ "React" ãŒæ¤œç´¢ã•ã‚Œã‚‹
   - [ ] "Typescrip" ã§ "TypeScript" ãŒæ¤œç´¢ã•ã‚Œã‚‹
   - [ ] "Postgre" ã§ "PostgreSQL" ãŒæ¤œç´¢ã•ã‚Œã‚‹

4. **é¡ä¼¼åº¦é–¾å€¤**
   - [ ] é¡ä¼¼åº¦ 0.3 ä»¥ä¸Šã®çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - [ ] é¡ä¼¼åº¦ 0.3 æœªæº€ã¯é™¤å¤–ã•ã‚Œã‚‹

5. **é‡è¤‡æ’é™¤**
   - [ ] å®Œå…¨ä¸€è‡´ã¨é¡ä¼¼ä¸€è‡´ãŒé‡è¤‡ã—ãªã„
   - [ ] å®Œå…¨ä¸€è‡´ãŒå„ªå…ˆã•ã‚Œã‚‹

---

## ğŸ“Š å®Ÿè£…çµ±è¨ˆ

### è¿½åŠ è¡Œæ•°

| ãƒ•ã‚¡ã‚¤ãƒ«                                  | è¡Œæ•°  | ç¨®é¡          |
|-------------------------------------------|-------|---------------|
| phase2c-search-accuracy-plan.md           | 900   | Documentation |
| 20251030_01_improve_search_suggestions.sql| 101   | Migration     |
| 20251030_02_add_fuzzy_search.sql          | 170   | Migration     |
| migrate-search-phase2c.sh                 | 50    | Script        |
| search/page.tsx                           | +30   | Update        |
| search-suggestions/route.ts               | +15   | Update        |
| **åˆè¨ˆ**                                  | **1266** | -             |

### å®Ÿè£…æ™‚é–“

- **è¨ˆç”»**: 30åˆ†
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ**: 1æ™‚é–“
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é©ç”¨**: 30åˆ†
- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°**: 30åˆ†
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: 30åˆ†
- **åˆè¨ˆ**: ç´„3æ™‚é–“

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

- âœ… **ã‚¿ã‚¤ãƒå¯¾å¿œ**: èª¤å­—ãƒ»è„±å­—ã§ã‚‚æ¤œç´¢æˆåŠŸ
- âœ… **æ¤œç´¢ç²¾åº¦å‘ä¸Š**: ã‚ˆã‚Šé–¢é€£æ€§ã®é«˜ã„çµæœãŒä¸Šä½
- âœ… **æ¤œç´¢æˆåŠŸç‡å‘ä¸Š**: æ¤œç´¢å¤±æ•—ã«ã‚ˆã‚‹é›¢è„±ã‚’é˜²æ­¢
- âœ… **å­¦ç¿’åŠ¹ç‡å‘ä¸Š**: ç›®çš„ã®æƒ…å ±ã«ç´ æ—©ãã‚¢ã‚¯ã‚»ã‚¹

### æŠ€è¡“çš„ãƒ¡ãƒªãƒƒãƒˆ

- âœ… **PostgreSQLæ¨™æº–æ©Ÿèƒ½**: è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦
- âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§é«˜é€ŸåŒ–
- âœ… **ä¿å®ˆæ€§**: ã‚·ãƒ³ãƒ—ãƒ«ãªSQLé–¢æ•°
- âœ… **æ‹¡å¼µæ€§**: é¡ä¼¼åº¦é–¾å€¤ã‚’èª¿æ•´å¯èƒ½

---

## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 2-C ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æ¤œç´¢æ©Ÿèƒ½ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®çŠ¶æ…‹ã§ã™ï¼š

### âœ… å®Œäº†æ¸ˆã¿

- Phase 1-A: æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã®åŸºæœ¬UI
- Phase 1-B: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
- Phase 2-A: æ¤œç´¢å±¥æ­´æ©Ÿèƒ½
- Phase 2-B-1: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆCmd+Kï¼‰
- **Phase 2-C: æ¤œç´¢ç²¾åº¦å‘ä¸Šï¼ˆé–¢é€£åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ»ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ï¼‰** â† ä»Šå›
- **Phase 2-C-3: Tiptapã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º** â† è¿½åŠ å®Ÿè£…

### ğŸ”„ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå°†æ¥çš„ã«ï¼‰

- Phase 3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
  - å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
  - ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ã®æœ€é©åŒ–
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

---

## ğŸ“ Phase 2-C-3: Tiptapã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼ˆè¿½åŠ å®Ÿè£…ï¼‰

### èƒŒæ™¯

å½“åˆã®å®Ÿè£…ã§ã¯ã€æ¤œç´¢çµæœã®`excerpt`éƒ¨åˆ†ã«Tiptapã®JSONæ§‹é€ ãŒãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

```json
// å•é¡Œ: JSONãŒãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã‚‹
{
  "type": "doc",
  "content": [
    { "type": "paragraph", "content": [{ "type": "text", "text": "ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆ" }] }
  ]
}
```

### è§£æ±ºç­–

`extract_tiptap_text()` é–¢æ•°ã‚’ä½œæˆã—ã€Tiptapã®JSONæ§‹é€ ã‹ã‚‰å¹³æ–‡ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```sql
CREATE OR REPLACE FUNCTION public.extract_tiptap_text(tiptap_json jsonb)
  RETURNS text
  LANGUAGE plpgsql
  IMMUTABLE AS $$
DECLARE
  result text := '';
  paragraph jsonb;
  node jsonb;
  text_content text;
BEGIN
  IF tiptap_json IS NULL THEN RETURN ''; END IF;
  
  FOR paragraph IN SELECT * FROM jsonb_array_elements(tiptap_json->'content')
  LOOP
    FOR node IN SELECT * FROM jsonb_array_elements(paragraph->'content')
    LOOP
      text_content := node->>'text';
      IF text_content IS NOT NULL AND text_content != '' THEN
        IF result != '' THEN result := result || ' '; END IF;
        result := result || text_content;
      END IF;
    END LOOP;
  END LOOP;
  
  RETURN result;
END;
$$;
```

### å®Ÿè£…å†…å®¹

1. **extract_tiptap_text() é–¢æ•°ã‚’ä½œæˆ**
   - Tiptapã®JSONæ§‹é€ ã‚’èµ°æŸ»
   - å„ãƒãƒ¼ãƒ‰ã‹ã‚‰`text`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŠ½å‡º
   - ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã£ã¦çµåˆ

2. **search_suggestions() é–¢æ•°ã‚’æ›´æ–°**
   - `extract_tiptap_text(p.content_tiptap::jsonb)` ã‚’ä½¿ç”¨
   - æ¤œç´¢å¯¾è±¡ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã®ä¸¡æ–¹ã«é©ç”¨

3. **search_suggestions_fuzzy() é–¢æ•°ã‚’æ›´æ–°**
   - åŒæ§˜ã«`extract_tiptap_text()`ã‚’ä½¿ç”¨
   - å®Œå…¨ä¸€è‡´ãƒ»ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã®ä¸¡æ–¹ã§å¹³æ–‡ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º

### åŠ¹æœ

```
Before:
  excerpt: '{"type":"doc","content":[{"type":"paragraph"...}'
  âŒ JSONãŒè¡¨ç¤ºã•ã‚Œã¦èª­ã¿ã¥ã‚‰ã„

After:
  excerpt: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™ã€‚æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚'
  âœ… å¹³æ–‡ãƒ†ã‚­ã‚¹ãƒˆã§èª­ã¿ã‚„ã™ã„
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `database/migrations/20251030_03_extract_tiptap_text.sql`
- **é©ç”¨çŠ¶æ³**: âœ… æˆåŠŸï¼ˆSupabase MCPä½¿ç”¨ï¼‰

### ãƒ†ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆ

- [ ] ãƒšãƒ¼ã‚¸æ¤œç´¢ã§ excerpt ãŒå¹³æ–‡ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ`<mark>`ã‚¿ã‚°ï¼‰ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹
- [ ] è¤‡æ•°æ®µè½ã®Tiptapã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹
- [ ] ç©ºã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„

---

## ğŸ› ç™ºç”Ÿã—ãŸå•é¡Œã¨è§£æ±º

### å•é¡Œ1: é–¢æ•°ã®è¿”ã‚Šå€¤å‹å¤‰æ›´ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼**:
```
cannot change return type of existing function
```

**è§£æ±ºç­–**: æ—¢å­˜é–¢æ•°ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†ä½œæˆ
```sql
DROP FUNCTION IF EXISTS public.search_suggestions(text);
```

### å•é¡Œ2: UNION ORDER BY ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼**:
```
invalid UNION/INTERSECT/EXCEPT ORDER BY clause
```

**è§£æ±ºç­–**: `sort_score` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦çµ±ä¸€çš„ã«ã‚½ãƒ¼ãƒˆ
```sql
SELECT ..., rank AS sort_score FROM card_cte
UNION ALL
SELECT ..., similarity AS sort_score FROM page_fuzzy
ORDER BY sort_score DESC;
```

---

## ğŸ“š å­¦ã‚“ã ã“ã¨

### 1. PostgreSQL å…¨æ–‡æ¤œç´¢ã®æ´»ç”¨

- `ts_rank()` ã§é–¢é€£åº¦ã‚’æ•°å€¤åŒ–
- `setweight()` ã§é‡ã¿ä»˜ã‘å¯èƒ½
- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒƒãƒã‚’å„ªé‡ã™ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### 2. pg_trgm ã®ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢

- ãƒˆãƒ©ã‚¤ã‚°ãƒ©ãƒ é¡ä¼¼åº¦æ¤œç´¢ã¯å¼·åŠ›
- é¡ä¼¼åº¦é–¾å€¤ã®èª¿æ•´ãŒé‡è¦ï¼ˆ0.3 ãŒé©åˆ‡ï¼‰
- GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

### 3. Supabase MCP ã®æ´»ç”¨

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç°¡å˜
- æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚å¯èƒ½
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè©³ç´°ã§åˆ†ã‹ã‚Šã‚„ã™ã„

### 4. å®Œå…¨ä¸€è‡´ã¨ãƒ•ã‚¡ã‚¸ãƒ¼æ¤œç´¢ã®çµ±åˆ

- é‡è¤‡æ’é™¤ãŒé‡è¦
- å®Œå…¨ä¸€è‡´ã‚’å„ªå…ˆã™ã‚‹è¨­è¨ˆ
- ã‚¹ã‚³ã‚¢ã®çµ±ä¸€åŒ–ã§ã‚½ãƒ¼ãƒˆãŒç°¡å˜

---

## ğŸ“ å‚è€ƒè³‡æ–™

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Issue #43](https://github.com/otomatty/for-all-learners/issues/43)
- [Phase 2-C å®Ÿè£…è¨ˆç”»](../../03_plans/search-ui-improvement/20251030_01_phase2c-search-accuracy-plan.md)
- [Phase 2-B-1 ãƒ­ã‚°](./20251029_04_search-keyboard-shortcut-phase2b1.md)
- [Phase 2-A ãƒ­ã‚°](./20251029_03_search-history-phase2a.md)

### æŠ€è¡“å‚è€ƒ

- [PostgreSQL Full Text Search](https://www.postgresql.org/docs/current/textsearch.html)
- [ts_rank() Documentation](https://www.postgresql.org/docs/current/textsearch-controls.html#TEXTSEARCH-RANKING)
- [pg_trgm Extension](https://www.postgresql.org/docs/current/pgtrgm.html)
- [Supabase Database Functions](https://supabase.com/docs/guides/database/functions)

---

**ä½œæˆè€…**: AI (GitHub Copilot)
**æœ€çµ‚æ›´æ–°**: 2025-10-30
