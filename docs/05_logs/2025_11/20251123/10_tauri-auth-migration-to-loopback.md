# Taurièªè¨¼ Loopback Serveræ–¹å¼ã¸ã®ç§»è¡Œ

**ä½œæˆæ—¥**: 2025-11-23
**é–¢é€£Issue**: #157 (Phase 6)
**å‰å›ã®ãƒ­ã‚°**: `docs/05_logs/2025_11/20251123/09_tauri-auth-deep-link-issue-summary.md`

---

## ğŸ”„ å¤‰æ›´æ¦‚è¦

macOSã®é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹Deep Linkã®åˆ¶é™ï¼ˆ`tauri://` ã‚¹ã‚­ãƒ¼ãƒ ãŒOSã«ç™»éŒ²ã•ã‚Œãªã„å•é¡Œï¼‰ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€**Loopback Serveræ–¹å¼**ã¸ç§»è¡Œã—ã¾ã—ãŸã€‚

### å¤‰æ›´å‰ï¼ˆDeep Link / IPC Pollingæ–¹å¼ï¼‰
- **Deep Link**: `tauri://localhost/auth/callback` ã‚’ä½¿ç”¨ï¼ˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã›ãšï¼‰
- **IPC Polling**: ã‚µãƒ¼ãƒãƒ¼ã«èªè¨¼æƒ…å ±ã‚’ä¸€æ™‚ä¿å­˜ã—ã€Tauriã‚¢ãƒ—ãƒªãŒãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹è¤‡é›‘ãªä»•çµ„ã¿

### å¤‰æ›´å¾Œï¼ˆLoopback Serveræ–¹å¼ï¼‰
- **Rust Plugin**: `tauri-plugin-oauth` ã‚’ä½¿ç”¨
- **ãƒ•ãƒ­ãƒ¼**:
  1. Rustå´ã§ä¸€æ™‚çš„ãªHTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆä¾‹: `http://localhost:54321`ï¼‰
  2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãã®ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’æ§‹ç¯‰
  3. Googleèªè¨¼å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒlocalhostã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  4. Rustã‚µãƒ¼ãƒãƒ¼ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆ (`oauth_callback`) ã‚’é€šçŸ¥
  5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚Šã€Supabaseã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹

## ğŸ›  å®Ÿè£…è©³ç´°

### 1. Rustå´ (`src-tauri/src/lib.rs`)
- `tauri-plugin-oauth` ã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ 
- `start_oauth_server` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…
  - ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡æ™‚ã« `oauth_callback` ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (`lib/auth/tauri-login.ts`)
- `loginWithGoogleTauri` é–¢æ•°ã‚’å…¨é¢çš„ã«æ›¸ãæ›ãˆ
- `invoke("start_oauth_server")` ã§ãƒãƒ¼ãƒˆã‚’å–å¾—
- `listen("oauth_callback")` ã§å¾…æ©Ÿ
- `http://localhost:{port}` ã‚’ `redirectTo` ã«è¨­å®š

### 3. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- ä¸è¦ã«ãªã£ãŸ `app/api/auth/tauri-callback/` ã‚’å‰Šé™¤
- ä¸è¦ã«ãªã£ãŸ `app/auth/callback/tauri/` ã‚’å‰Šé™¤
- `app/auth/callback/route.ts` ã‹ã‚‰Tauriç”¨ã®åˆ†å²å‡¦ç†ã‚’å‰Šé™¤

## âœ… ãƒ¡ãƒªãƒƒãƒˆ

1. **é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®å‹•ä½œ**: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²ãŒä¸è¦ãªãŸã‚ã€`bun tauri dev` ã§ãã®ã¾ã¾å‹•ä½œã—ã¾ã™ã€‚
2. **ã‚³ãƒ¼ãƒ‰ã®ç°¡ç´ åŒ–**: ãƒãƒ¼ãƒªãƒ³ã‚°ã‚„ã‚µãƒ¼ãƒãƒ¼å´ã®ä¸€æ™‚ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸è¦ã«ãªã‚Šã€ä¿å®ˆæ€§ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚
3. **UXå‘ä¸Š**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼å®Œäº†å¾Œã«ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ãã ã•ã„ã€ã¨ã„ã†æ¨™æº–çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚

## âš ï¸ æ³¨æ„äº‹é …

**Supabaseã®è¨­å®š**:
Supabaseã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆAuthentication > URL Configuration > Redirect URLsï¼‰ã«ã€ä»¥ä¸‹ã®è¨±å¯è¨­å®šãŒå¿…è¦ã§ã™ï¼š

- `http://localhost:*`

â€» ãƒãƒ¼ãƒˆç•ªå·ãŒãƒ©ãƒ³ãƒ€ãƒ ã§å¤‰ã‚ã‚‹ãŸã‚ã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰æŒ‡å®šãŒå¿…è¦ã§ã™ã€‚

---

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `src-tauri/Cargo.toml`
- `src-tauri/src/lib.rs`
- `lib/auth/tauri-login.ts`
- `lib/auth/tauri-auth-handler.ts`

