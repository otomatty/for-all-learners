# リンク機能実装調査 - 概要図

## リンク実装の 3 世代

```
┌─────────────────────────────────────────────────────────┐
│                    実装の変遷                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Phase 1: Decoration ベース (旧)                        │
│  ┌──────────────────────────────────────────────────┐  │
│  │ PageLink Extension                               │  │
│  │ - bracketPlugin (Decoration)                     │  │
│  │ - suggestionPlugin                               │  │
│  │ - previewPlugin ❌削除済み                        │  │
│  │ - existencePlugin ❌削除済み                      │  │
│  └──────────────────────────────────────────────────┘  │
│                        ↓ 移行中                         │
│  Phase 2: Mark ベース (移行中)                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │ PageLinkMark                                     │  │
│  │ - [Title] 専用                                    │  │
│  │ - 基本的なMark実装                                │  │
│  │ ⚠️ 互換性のため残存（新規使用非推奨）              │  │
│  └──────────────────────────────────────────────────┘  │
│                        ↓ 推奨                           │
│  Phase 3: 統合Mark実装 (現在) ⭐                        │
│  ┌──────────────────────────────────────────────────┐  │
│  │ UnifiedLinkMark                                  │  │
│  │ - [Title] + #タグ 対応                            │  │
│  │ - 非同期バッチ解決                                │  │
│  │ - キャッシュ機能                                  │  │
│  │ - リトライ機能                                    │  │
│  │ - クロスタブ同期                                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## UnifiedLinkMark アーキテクチャ

```
┌──────────────────────────────────────────────────────────┐
│                   ユーザー入力                            │
│              [Page Title] または #タグ                    │
└──────────────────────┬───────────────────────────────────┘
                       │
                       ↓
┌──────────────────────────────────────────────────────────┐
│                  InputRule 検出                           │
│  - ブラケット: /\[([^\[\]]+)\]$/                         │
│  - タグ: /\B#([\p{...}]{1,50})/u (計画中)               │
└──────────────────────┬───────────────────────────────────┘
                       │
                       ↓
┌──────────────────────────────────────────────────────────┐
│               Mark生成 (state: "pending")                 │
│  {                                                        │
│    variant: "bracket",                                    │
│    raw: "Page Title",                                     │
│    key: "page title",  ← 正規化済み                      │
│    state: "pending",                                      │
│    markId: "unilink-xxx"                                  │
│  }                                                        │
└──────────────────────┬───────────────────────────────────┘
                       │
                       ↓
┌──────────────────────────────────────────────────────────┐
│                 Resolver Queue追加                        │
│              (バッチサイズ: 10件)                         │
└──────────────────────┬───────────────────────────────────┘
                       │
                       ↓
         ┌─────────────┴─────────────┐
         │                           │
         ↓                           ↓
┌─────────────────┐         ┌─────────────────┐
│  キャッシュ確認  │  Hit    │   searchPages   │
│   (30秒TTL)     │────────→│  (Supabase検索)  │
└─────────────────┘         └────────┬─────────┘
         │ Miss                      │
         └───────────────────────────┘
                       │
                       ↓
         ┌─────────────┴─────────────┐
         │                           │
    完全一致あり              一致なし/エラー
         │                           │
         ↓                           ↓
┌─────────────────┐         ┌─────────────────┐
│ state: "exists" │         │state: "missing" │
│ pageId: "..."   │         │  or "error"     │
│ href: /pages/id │         │ href: "#"       │
└─────────────────┘         └─────────────────┘
         │                           │
         └───────────────┬───────────┘
                         │
                         ↓
         ┌───────────────────────────┐
         │      Mark更新・表示       │
         │   (色・スタイル変更)       │
         └───────────────────────────┘
```

## 状態遷移図

```
                ┌─────────────┐
                │   pending   │ ← 初期状態
                └──────┬──────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ↓              ↓              ↓
┌──────────┐    ┌──────────┐   ┌──────────┐
│  exists  │    │ missing  │   │  error   │
│          │    │          │   │          │
│ ページ   │    │ ページ   │   │ 通信     │
│ 存在確認 │    │ 未存在   │   │ エラー   │
└──────────┘    └────┬─────┘   └──────────┘
                     │
                     │ ページ作成
                     │
                     ↓
              ┌──────────┐
              │  exists  │
              │ (created)│
              └──────────┘
```

## データ構造の比較

```
┌─────────────────────────────────────────────────────────┐
│              PageLinkMark vs UnifiedLinkMark            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  PageLinkMark (旧)                                      │
│  ┌─────────────────────────────────────────────┐       │
│  │ href: string                                │       │
│  │ pageId?: string                             │       │
│  │ pageTitle?: string                          │       │
│  │ external?: boolean                          │       │
│  │ plId?: string                               │       │
│  │ exists?: boolean                            │       │
│  │ state?: 'pending'|'exists'|'missing'        │       │
│  └─────────────────────────────────────────────┘       │
│                                                         │
│  UnifiedLinkMark (新) ⭐                                │
│  ┌─────────────────────────────────────────────┐       │
│  │ variant: 'bracket'|'tag'          ← 新機能  │       │
│  │ raw: string                       ← 新機能  │       │
│  │ text: string                      ← 新機能  │       │
│  │ key: string                       ← 新機能  │       │
│  │ pageId?: string                             │       │
│  │ href: string                                │       │
│  │ state: 'pending'|'exists'|'missing'|'error' │       │
│  │ exists: boolean                             │       │
│  │ created?: boolean                           │       │
│  │ meta?: object                     ← 新機能  │       │
│  │ markId: string                              │       │
│  └─────────────────────────────────────────────┘       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## パフォーマンス最適化機能

```
┌──────────────────────────────────────────────────────────┐
│            UnifiedLinkMark 最適化戦略                     │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. キャッシュ機能                                        │
│     ┌────────────────────────────────────┐              │
│     │ メモリキャッシュ (Map)              │              │
│     │ TTL: 30秒                          │              │
│     │ key → pageId                       │              │
│     └────────────────────────────────────┘              │
│                                                          │
│  2. バッチ処理                                           │
│     ┌────────────────────────────────────┐              │
│     │ Resolver Queue                     │              │
│     │ 10件ずつバッチで処理                │              │
│     │ 50ms間隔で実行                      │              │
│     └────────────────────────────────────┘              │
│                                                          │
│  3. リトライ機能                                         │
│     ┌────────────────────────────────────┐              │
│     │ 指数バックオフ                      │              │
│     │ - 1回目: 100ms                     │              │
│     │ - 2回目: 200ms                     │              │
│     │ - 3回目: 400ms                     │              │
│     │ 最大2回リトライ                     │              │
│     └────────────────────────────────────┘              │
│                                                          │
│  4. クロスタブ同期 (P3)                                  │
│     ┌────────────────────────────────────┐              │
│     │ BroadcastChannel                   │              │
│     │ - ページ作成通知                    │              │
│     │ - キャッシュ同期                    │              │
│     │ - 状態同期                          │              │
│     └────────────────────────────────────┘              │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

## ファイル構造

```
lib/
├── tiptap-extensions/
│   ├── unified-link-mark.ts          ⭐ メイン実装
│   ├── page-link-mark.ts             ⚠️ 旧実装（互換性）
│   ├── page-link.ts                  ❌ Legacy（削除予定）
│   └── page-link-preview-mark-plugin.ts  プレビュー機能
│
├── unilink/                          ⭐ サポートモジュール
│   ├── index.ts                      エクスポート集約
│   ├── utils.ts                      正規化・キャッシュ
│   ├── resolver.ts                   ページ作成・解決
│   ├── metrics.ts                    メトリクス
│   ├── broadcast-channel.ts          クロスタブ通信
│   ├── realtime-listener.ts          Realtime連携
│   ├── auto-reconciler.ts            自動調整
│   ├── mark-index.ts                 Mark検索
│   └── reconcile-queue.ts            調整キュー
│
├── utils/
│   ├── searchPages.ts                ページ検索API
│   └── transformPageLinks.ts         リンク変換
│
└── metrics/
    └── pageLinkMetrics.ts            基本メトリクス

docs/
├── unified-link-mark-spec.md         ⭐ 仕様書
├── page-link-legacy-removal-plan.md  削除計画
└── unified-link-mark-*-*.md          実装ログ

components/
└── tiptap-editor.tsx                 エディタ統合
```

## 推奨される使用方法

```typescript
// ✅ 推奨: UnifiedLinkMark を使用
import { UnifiedLinkMark } from "@/lib/tiptap-extensions/unified-link-mark";

const editor = useEditor({
  extensions: [
    UnifiedLinkMark, // これを使う
    // ...
  ],
});

// ⚠️ 非推奨: PageLinkMark（互換性のため残存）
import { PageLinkMark } from "@/lib/tiptap-extensions/page-link-mark";
// 既存コードでのみ使用可能、新規では使用しない

// ❌ 使用禁止: PageLink（削除予定）
import { PageLink } from "@/lib/tiptap-extensions/page-link";
// Legacy実装、使用しないこと
```
