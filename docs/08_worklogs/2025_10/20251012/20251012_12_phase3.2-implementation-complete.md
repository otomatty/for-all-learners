# Phase 3.2 実装完了: DOM Click Handler & Page Creation

## 概要

Phase 3.2 の実装が完了しました。UnifiedLinkMark の click-handler-plugin に DOM click handler を追加し、以下の新機能をサポートしました:

- ✅ handleDOMEvents.click ハンドラーの実装
- ✅ data-page-title 属性による新規ページ作成
- ✅ note_page_links テーブルへの自動関連付け
- ✅ アンダースコアからスペースへの変換
- ✅ 認証統合 (userId 自動取得)
- ✅ エラーハンドリングとトースト通知
- ✅ BroadcastChannel による他タブへの通知

## 作業内容

### 1. resolver.ts への createPageFromLink 関数追加

**ファイル:** `lib/unilink/resolver.ts`

**追加関数:** `createPageFromLink(title, userId, noteSlug?)`

**機能:**

1. **ページ作成**

   - Supabase から pages テーブルに insert
   - title のアンダースコアをスペースに変換 (`My_Page` → `My Page`)
   - 初期コンテンツは空 (`{ type: "doc", content: [] }`)
   - is_public は false (デフォルトで非公開)

2. **Note 関連付け**

   - noteSlug が提供されている場合:
     - notes テーブルから note_id を取得
     - note_page_links テーブルに insert (`note_id`, `page_id`)
   - エラーが発生してもページ作成は成功とする (継続処理)

3. **URL 生成**

   - noteSlug がある場合: `/notes/:slug/:id?newPage=true`
   - noteSlug がない場合: `/pages/:id?newPage=true`
   - noteSlug は encodeURIComponent でエンコード

4. **BroadcastChannel 通知**

   - 他のタブに新規ページ作成を通知
   - key = normalizeTitleToKey(title)
   - payload = { key, pageId }

5. **トースト通知**
   - 成功時: `ページ「{title}」を作成しました`
   - 失敗時: `ページ作成に失敗しました` + エラー詳細

**コード量:** 約 90 行

**エラーハンドリング:**

- Database insert エラー → null 返却 + toast.error
- Note query エラー → note 関連付けスキップ (ページ作成は成功)
- Note linking エラー → ログ出力 (ページ作成は成功)
- Broadcast エラー → 無視 (ページ作成は成功)

### 2. click-handler-plugin.ts への handleDOMEvents 追加

**ファイル:** `lib/tiptap-extensions/unified-link-mark/plugins/click-handler-plugin.ts`

**追加関数:** `handleAnchorClick(target, event, context)`

**機能:**

1. **data-page-title 属性の処理**

   - `<a data-page-title="My Page">` 形式のリンクを検出
   - event.preventDefault() でデフォルト動作を抑制
   - userId を options から取得、なければ auth から取得
   - 未認証の場合は toast.error("ログインしてください")

2. **ページ作成と遷移**

   - createPageFromLink() を呼び出し
   - 成功時: window.location.href = result.href
   - 失敗時: トースト通知のみ (遷移しない)

3. **通常の href ナビゲーション**
   - data-page-title がない場合の処理
   - target="\_blank" → window.open() (noopener, noreferrer)
   - それ以外 → window.location.href
   - href="#" は無視

**handleDOMEvents の登録:**

```typescript
props: {
  handleClick: (view, pos, event) => {
    // Phase 3.1 の処理
  },
  handleDOMEvents: {
    click: (view, event) => {
      const target = event.target as HTMLElement;

      if (target.tagName === "A") {
        handleAnchorClick(target as HTMLAnchorElement, event, context);
        return true;
      }

      return false;
    },
  },
}
```

**コード量:** 約 60 行

**特徴:**

- Dynamic import で循環依存を回避
- TypeScript 型安全 (HTMLAnchorElement, MouseEvent)
- async/await でエラーハンドリング

### 3. テストケースの追加

**テストファイル:**

1. `lib/tiptap-extensions/unified-link-mark/plugins/__tests__/click-handler-plugin.test.ts`
2. `lib/unilink/__tests__/resolver-phase3.test.ts`

**テストカテゴリ (合計 56 テスト):**

#### click-handler-plugin.test.ts (29 テスト)

1. **DOM click handler integration (5 テスト)**

   - handleDOMEvents.click の登録確認
   - <a> タグの検出
   - 非アンカー要素の無視
   - data-page-title 属性の抽出
   - preventDefault の呼び出し

2. **New page creation from link (7 テスト)**

   - data-page-title からの作成
   - アンダースコア変換
   - userId の使用 (options 優先)
   - userId の動的取得 (auth)
   - 認証エラーの処理
   - 作成後の遷移
   - return true

3. **noteSlug integration with page creation (5 テスト)**

   - noteSlug の createPageFromLink への引き渡し
   - note_page_links への関連付け
   - /notes/:slug/:id への遷移
   - /pages/:id への遷移 (noteSlug なし)
   - URL エンコーディング

4. **Normal href navigation (5 テスト)**

   - href 属性の処理 (data-page-title なし)
   - target="\_blank" の window.open
   - 通常の window.location.href
   - preventDefault の呼び出し
   - href="#" の無視

5. **Error handling (3 テスト)**
   - ページ作成エラー
   - 認証エラー
   - Note linking エラー

#### resolver-phase3.test.ts (27 テスト)

1. **Page creation (6 テスト)**

   - 正しい title での作成
   - アンダースコア変換
   - is_public=false
   - 空コンテンツ初期化
   - 成功時の pageId, href 返却
   - 失敗時の null 返却

2. **Note linking (6 テスト)**

   - noteSlug 提供時の関連付け
   - notes テーブルのクエリ
   - note_page_links への insert
   - noteSlug なしの場合スキップ
   - note 見つからない場合の継続
   - linking エラーのログ出力

3. **URL generation (5 テスト)**

   - /notes/:slug/:id (noteSlug あり)
   - /pages/:id (noteSlug なし)
   - ?newPage=true の付与
   - noteSlug のエンコーディング
   - 特殊文字の処理

4. **Broadcast notification (4 テスト)**

   - emitPageCreated の呼び出し
   - title の key への正規化
   - 正しい pageId
   - ログ出力

5. **Toast notifications (3 テスト)**

   - 成功時の toast.success
   - 失敗時の toast.error
   - エラー詳細の表示

6. **Error handling (5 テスト)**

   - Database insert エラー
   - Note query エラー
   - Note linking エラー
   - Broadcast エラー
   - すべてのエラーのログ出力

7. **Authentication (2 テスト)**
   - userId の必須チェック
   - user_id フィールドの設定

## テスト結果

### テスト実行

```bash
bun test lib/tiptap-extensions/unified-link-mark/plugins/__tests__/click-handler-plugin.test.ts \
         lib/unilink/__tests__/resolver-phase3.test.ts
```

### 結果サマリー

- **Total Tests:** 188 (Phase 3.1: 132, Phase 3.2: 56)
- **Pass:** 188 ✅
- **Fail:** 0
- **Duration:** 112ms

### カテゴリ別結果

**Phase 3.1 テスト (132 テスト) - すべてパス ✅**

**Phase 3.2 新規テスト (56 テスト) - すべてパス ✅**

- DOM click handler integration: 5/5 ✅
- New page creation from link: 7/7 ✅
- noteSlug integration with page creation: 5/5 ✅
- Normal href navigation: 5/5 ✅
- Error handling (click-handler): 3/3 ✅
- Page creation: 6/6 ✅
- Note linking: 6/6 ✅
- URL generation: 5/5 ✅
- Broadcast notification: 4/4 ✅
- Toast notifications: 3/3 ✅
- Error handling (resolver): 5/5 ✅
- Authentication: 2/2 ✅

## 技術的な学び

### 1. DOM イベントハンドラーの統合

- **handleDOMEvents vs handleClick**:
  - handleClick: ProseMirror レベルのイベント (エディタ内)
  - handleDOMEvents: DOM レベルのイベント (レンダリング後)
  - 両方を使用して完全なクリック処理をカバー

### 2. 循環依存の回避

- **Dynamic import の活用**:
  ```typescript
  const { createClient } = await import("@/lib/supabase/client");
  const { createPageFromLink } = await import("../../../unilink/resolver");
  ```
- **理由**: resolver ↔ tiptap-extensions の循環参照を防ぐ

### 3. エラーハンドリングの階層化

- **ページ作成は優先**:
  - Note linking が失敗してもページ作成は成功
  - Broadcast が失敗してもページ作成は成功
- **ユーザー体験の優先**:
  - 副次的なエラーは内部ログのみ
  - 主要なエラーのみトースト通知

### 4. 後方互換性の維持

- **data-page-title 属性**:
  - 既存の PageLink Extension の動作を完全再現
  - UnifiedLinkMark に段階的に統合可能
- **noteSlug 統合**:
  - オプショナルなパラメータで既存コードを壊さない

### 5. BroadcastChannel の統合

- **クロスタブ同期**:
  - 新規ページ作成を他のタブにリアルタイム通知
  - UnifiedLinkMark の自動解決機能と連携

## 変更ファイル一覧

1. `lib/unilink/resolver.ts`

   - createPageFromLink() 関数追加 (~90 行)
   - Phase 3.2 コメント追加

2. `lib/tiptap-extensions/unified-link-mark/plugins/click-handler-plugin.ts`

   - handleAnchorClick() 関数追加 (~60 行)
   - handleDOMEvents.click ハンドラー追加
   - toast import 追加

3. `lib/tiptap-extensions/unified-link-mark/plugins/__tests__/click-handler-plugin.test.ts`

   - Phase 3.2 テスト 29 件追加 (既存 70 → 合計 99)

4. `lib/unilink/__tests__/resolver-phase3.test.ts`
   - Phase 3.2 テスト 27 件追加 (既存 62 → 合計 89)

## 実装の特徴

### 優先順位の設計

1. **ユーザー認証**: 未認証の場合は即座にエラー表示
2. **ページ作成**: 最優先で成功させる
3. **Note 関連付け**: エラーでも処理継続
4. **Broadcast**: エラーでも処理継続
5. **トースト通知**: すべての結果を通知

### noteSlug の統一的な扱い

- **すべての経路で noteSlug をサポート**:
  - createPageFromLink
  - resolveIconLink
  - navigateToPageWithContext
  - handleMissingLinkClick

### エラー通知の一貫性

- **toast.error**: ユーザーに表示
- **console.error**: 開発者向けログ
- **console.log**: デバッグ情報

## 課題と改善点

### 解決済み

- ✅ DOM イベントハンドラーの統合
- ✅ 循環依存の回避 (dynamic import)
- ✅ エラーハンドリングの網羅性
- ✅ テストカバレッジ (188/188 Pass)

### 今後の対応

1. **Phase 3.3: existencePluginKey の置き換え**

   - useLinkExistenceChecker の削除
   - UnifiedLinkMark の自動解決で代替

2. **Phase 3.4: PageLink Extension の削除**

   - 完全な統合後に削除
   - インポート文の削除

3. **パフォーマンス最適化**
   - Icon link のキャッシュ実装
   - バッチクエリでの複数リンク解決

## PageLink Extension との比較

### PageLink Extension (削除予定)

```typescript
handleDOMEvents: {
  click(view, event) {
    const target = event.target as HTMLAnchorElement;
    if (target.tagName === "A") {
      const newTitle = target.getAttribute("data-page-title");
      if (newTitle) {
        // インライン実装 (100+ 行)
        // Supabase クライアント作成
        // ページ作成
        // Note 関連付け
        // 遷移
      }
    }
  }
}
```

### UnifiedLinkMark (新実装)

```typescript
handleDOMEvents: {
  click: (view, event) => {
    const target = event.target as HTMLElement;

    if (target.tagName === "A") {
      handleAnchorClick(target as HTMLAnchorElement, event, context);
      return true;
    }

    return false;
  },
}

// handleAnchorClick → createPageFromLink (resolver)
// 責任の分離、テスト可能、再利用可能
```

**改善点**:

1. **責任の分離**: プラグイン (UI) と resolver (ビジネスロジック) を分離
2. **テスト可能性**: 個別の関数単位でテスト
3. **再利用性**: createPageFromLink は他の箇所からも使用可能
4. **保守性**: 変更箇所が明確

## 次回の作業予定

1. **Phase 3.3 実装**: existencePluginKey の置き換え
2. **Phase 3.4 実装**: PageLink Extension 削除
3. **統合テスト**: エンドツーエンドでの動作確認
4. **パフォーマンステスト**: 大量リンクでの負荷確認

## 関連ドキュメント

- [Phase 3 実装計画](../../../04_implementation/plans/unified-link-mark/20251012_10_phase3-click-handler-migration-plan.md)
- [Phase 3.1 実装完了ログ](./20251012_11_phase3.1-implementation-complete.md)
- [Phase 2.1 実装完了ログ](./20251011_02_phase2.1-implementation-complete.md)

## 作成日時

- **作成日**: 2025-10-12
- **最終更新**: 2025-10-12
- **作業時間**: 約 1.5 時間
- **ステータス**: Phase 3.2 完了 ✅
