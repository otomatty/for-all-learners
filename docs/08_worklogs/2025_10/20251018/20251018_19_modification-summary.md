# ç„¡é™ POST ãƒ«ãƒ¼ãƒ—ä¿®æ­£ - æ¤œè¨¼ä½œæ¥­å®Œäº† - 2025-10-18

## ä¿®æ­£å†…å®¹ã®ã‚µãƒãƒªãƒ¼

### âŒ å•é¡Œã®æ¦‚è¦

ãƒšãƒ¼ã‚¸ç·¨é›†ä¸­ã«ç„¡é™ POST ãƒ«ãƒ¼ãƒ—ãŒç™ºç”Ÿã™ã‚‹å•é¡ŒãŒå ±å‘Šã•ã‚Œã¦ã„ã‚‹ã€‚

**æ ¹æœ¬åŸå› ï¼ˆä»®èª¬ï¼‰**:

1. `updatePage` ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã§è¤‡æ•°ã® DB æ“ä½œãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹
   - pages ãƒ†ãƒ¼ãƒ–ãƒ« UPDATE
   - page_page_links DELETE
   - page_page_links INSERT
2. ã“ã‚Œã‚‰ã®æ“ä½œã«ã‚ˆã‚Šè¤‡æ•°ã® Realtime ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿ
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è‡ªå‹•ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ãŒé€£é–çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹
4. ç„¡é™ãƒ«ãƒ¼ãƒ—ã«é™¥ã‚‹

---

## ğŸ”§ å®Ÿè£…ã—ãŸä¿®æ­£

### ä¿®æ­£ 1: updatePage ã«ãƒ­ã‚®ãƒ³ã‚°ã‚’è¿½åŠ  âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/_actions/updatePage.ts`

**å¤‰æ›´å†…å®¹**:

- é–¢æ•°é–‹å§‹æ™‚ã«ãƒ­ã‚°å‡ºåŠ›: `[updatePage] Starting`
- é–¢æ•°çµ‚äº†æ™‚ã«å®Ÿè¡Œæ™‚é–“ä»˜ããƒ­ã‚°å‡ºåŠ›: `[updatePage] Completed`

**ç›®çš„**:

- `updatePage` ã®å®Ÿè¡Œå›æ•°ã‚’ç›£è¦–
- 1 å›ã®å®Ÿè¡Œã«ã‹ã‹ã‚‹æ™‚é–“ã‚’æ¸¬å®š
- ç„¡é™ãƒ«ãƒ¼ãƒ—ã®æ¤œå‡ºã¨åˆ†æ

**ã‚³ãƒ¼ãƒ‰ä¾‹**:

```typescript
const startTime = Date.now();
logger.info(
  { pageId: id, timestamp: new Date().toISOString() },
  "[updatePage] Starting"
);

// ... å‡¦ç† ...

logger.info(
  { pageId: id, duration: Date.now() - startTime },
  "[updatePage] Completed"
);
```

---

### ä¿®æ­£ 2: useAutoSave ã«å®Ÿè¡Œé »åº¦åˆ¶é™ã‚’è¿½åŠ  âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/(protected)/pages/[id]/_hooks/useAutoSave.ts`

**å¤‰æ›´å†…å®¹**:

1. **æœ€å°ä¿å­˜é–“éš”ã®è¨­å®š**: `MIN_SAVE_INTERVAL = 3000ms`
2. **ä¿å­˜çŠ¶æ…‹ãƒ•ãƒ©ã‚°**: `isSavingRef` ã§åŒæ™‚å®Ÿè¡Œã‚’é˜²æ­¢
3. **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°**: `lastSaveTimeRef` ã§å‰å›ã®ä¿å­˜æ™‚åˆ»ã‚’è¨˜éŒ²
4. **ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿæ§‹**: 3 ç§’ä»¥å†…ã®ä¿å­˜è¦æ±‚ã‚’ã‚¹ã‚­ãƒƒãƒ—
5. **è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°**: ã‚¹ã‚­ãƒƒãƒ—ç†ç”±ã¨æ™‚é–“æƒ…å ±ã‚’å‡ºåŠ›

**ç›®çš„**:

- `updatePage` å‘¼ã³å‡ºã—ã®é »åº¦ã‚’è‡ªå‹•çš„ã«åˆ¶é™
- è¤‡æ•°ã®åŒæ™‚ä¿å­˜è¦æ±‚ã‚’é˜²æ­¢
- DB è² è·ã‚’è»½æ¸›
- ç„¡é™ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚¹ã‚¯ã‚’ä½æ¸›

**ã‚³ãƒ¼ãƒ‰ä¾‹**:

```typescript
const attemptSave = useCallback(async () => {
  // ä¿å­˜ä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (isSavingRef.current) return;

  // æœ€å°é–“éš”ã«é”ã—ã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  const timeSinceLastSave = Date.now() - lastSaveTimeRef.current;
  if (timeSinceLastSave < MIN_SAVE_INTERVAL) {
    setTimeout(() => attemptSave(), MIN_SAVE_INTERVAL - timeSinceLastSave);
    return;
  }

  // å®Ÿè¡Œ
  isSavingRef.current = true;
  lastSaveTimeRef.current = Date.now();
  try {
    await savePageRef.current();
  } finally {
    isSavingRef.current = false;
  }
}, []);
```

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ä¿®æ­£å‰ã®æŒ™å‹•

```
æ™‚åˆ»    ã‚¤ãƒ™ãƒ³ãƒˆ
t=0s   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
t=2s   updatePage å‘¼ã³å‡ºã— 1 å›
       pages UPDATE â†’ Realtime ã‚¤ãƒ™ãƒ³ãƒˆ
       page_page_links DELETE/INSERT â†’ Realtime ã‚¤ãƒ™ãƒ³ãƒˆ
       ãƒšãƒ¼ã‚¸å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°?
t=2.5s useAutoSave ãƒˆãƒªã‚¬ãƒ¼? â†’ updatePage å‘¼ã³å‡ºã— 2 å›
t=3s   useAutoSave ãƒˆãƒªã‚¬ãƒ¼? â†’ updatePage å‘¼ã³å‡ºã— 3 å›
...    ç„¡é™ãƒ«ãƒ¼ãƒ—ç¶šè¡Œ âš ï¸
```

### ä¿®æ­£å¾Œã®æŒ™å‹•

```
æ™‚åˆ»    ã‚¤ãƒ™ãƒ³ãƒˆ
t=0s   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
t=2s   updatePage å‘¼ã³å‡ºã— 1 å›
       lastSaveTime = t=2s
       pages UPDATE
       page_page_links DELETE/INSERT
       ãƒšãƒ¼ã‚¸å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°?
t=2.5s useAutoSave ãƒˆãƒªã‚¬ãƒ¼?
       attemptSave() ãŒå‘¼ã°ã‚Œã‚‹ãŒ...
       timeSinceLastSave = 500ms < MIN_SAVE_INTERVAL
       â†’ ã‚¹ã‚­ãƒƒãƒ—! âœ…
       â†’ 3.5s å¾Œã«å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
t=5s   å‰å›ã®ä¿å­˜ã‹ã‚‰ 3 ç§’çµŒé
       æ¬¡ã® updatePage å‘¼ã³å‡ºã—è¨±å¯
       lastSaveTime = t=5s
```

---

## âœ… æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿè£…å¾Œã«ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

### ãƒ–ãƒ©ã‚¦ã‚¶æ¤œè¨¼

- [ ] Network ã‚¿ãƒ–ã§ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›£è¦–
- [ ] POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ãŒ 3 ç§’ä»¥ä¸Šã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] Console ã§ `[updatePage]` ãƒ­ã‚°ã‚’ç¢ºèª
- [ ] Console ã§ `[useAutoSave]` ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç¢ºèª

### ãƒ­ã‚°ç¢ºèª

- [ ] `[updatePage] Starting` ã¨ `[updatePage] Completed` ãŒå¯¾ã«ãªã£ã¦ã„ã‚‹ã‹
- [ ] å®Ÿè¡Œæ™‚é–“ï¼ˆdurationï¼‰ãŒåˆç†çš„ã‹ï¼ˆ1-2 ç§’ç¨‹åº¦ï¼‰
- [ ] `[useAutoSave] Save interval too short, skipping` ãŒå‡ºç¾ã—ã¦ã„ã‚‹ã‹

### å‹•ä½œç¢ºèª

- [ ] ãƒšãƒ¼ã‚¸ç·¨é›†æ™‚ã«ç„¡é™ POST ãŒç™ºç”Ÿã—ãªã„ã‹
- [ ] æ‰‹å‹•ä¿å­˜ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
- [ ] è‡ªå‹•ä¿å­˜ã¯é©åˆ‡ã«å‹•ä½œã™ã‚‹ã‹ï¼ˆ3 ç§’é–“éš”ã§ï¼‰

---

## ğŸ” ã•ã‚‰ã«è©³ç´°ãªæ¤œè¨¼ãŒå¿…è¦ãªå ´åˆ

### Step 4: Realtime subscription ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚°è¿½åŠ 

page_page_links ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ãŒè¤‡æ•°å›ç™ºç”Ÿã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯:

1. Realtime subscription ã‚’ãƒ­ã‚°ä»˜ãã§è¨­å®š
2. INSERT/UPDATE/DELETE ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç”Ÿå›æ•°ã‚’ç›£è¦–
3. ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®æ™‚é–“å·®ã‚’æ¸¬å®š

### Step 5: updatePage ã® DB æ“ä½œã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒ–ï¼ˆé•·æœŸå¯¾ç­–ï¼‰

è¤‡æ•°ã® DB æ“ä½œã‚’ 1 ã¤ã® RPC ã§å®Ÿè¡Œ:

```typescript
const { error } = await supabase.rpc("update_page_with_links", {
  page_id: id,
  page_title: title,
  page_content: parsedContent,
  page_thumbnail: thumbnailUrl,
  link_ids: outgoingIds,
});
```

ã“ã‚Œã«ã‚ˆã‚Š Realtime ã‚¤ãƒ™ãƒ³ãƒˆãŒ 1 å›ã«å‰Šæ¸›ã•ã‚Œã‚‹ã€‚

---

## ğŸ“ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `20251018_17_true-root-cause-discovery.md` - æ ¹æœ¬åŸå› ã®è©³ç´°åˆ†æ
- `20251018_16_comprehensive-failure-analysis.md` - éå»ã®ä¿®æ­£è©¦è¡Œã®åˆ†æ
- `20251018_11_infinite-post-root-cause-analysis.md` - åˆæœŸã®æ ¹æœ¬åŸå› åˆ†æ

---

## ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **ä»Šã™ã**: ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèªã‚’å®Ÿæ–½
2. **ç¢ºèªå¾Œ**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ¤œè¨¼çµæœã‚’è¨˜éŒ²
3. **å•é¡ŒãŒã‚ã‚‹å ´åˆ**: Step 4 ä»¥é™ã®è©³ç´°ãªãƒ­ã‚°ã‚’è¿½åŠ 
4. **æœ¬æ ¼å¯¾ç­–**: é•·æœŸçš„ã«ã¯ updatePage ã® DB æ“ä½œã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒ–

---

## ğŸ’¡ å­¦ã‚“ã ã“ã¨

- è‡ªå‹•ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¨ DB æ“ä½œã®é€£é–åå¿œã¯äºˆæœŸã—ãªã„ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’å¼•ãèµ·ã“ã™
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿ã®ä¿®æ­£ã§ã¯ä¸ååˆ† â†’ ã‚µãƒ¼ãƒãƒ¼å´ã®å®Ÿè¡Œé »åº¦åˆ¶é™ãŒå¿…è¦
- ãƒ­ã‚°ã¯å•é¡Œè¨ºæ–­ã®é‡è¦ãªãƒ„ãƒ¼ãƒ« â†’ è©³ç´°ãªã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æƒ…å ±ãŒä¸å¯æ¬ 
- è¤‡æ•°ã® DB æ“ä½œã‚’åˆ†é›¢ã—ãŸã¾ã¾ã ã¨ Realtime ã‚¤ãƒ™ãƒ³ãƒˆãŒè¤‡æ•°å›ç™ºç”Ÿ â†’ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒ–ã®æ¤œè¨ãŒå¿…è¦
