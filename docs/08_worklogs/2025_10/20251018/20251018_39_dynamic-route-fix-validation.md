# ç„¡é™ POST å•é¡Œï¼šNext.js Dynamic/Static åˆ‡ã‚Šæ›¿ãˆå¾ªç’°ã®æ ¹æœ¬åŸå› ã¨å¯¾ç­– - 2025-10-18

## ğŸ” å•é¡Œã®æ•´ç†

### ç—‡çŠ¶

- é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆ`bun dev`ï¼‰ã§ãƒšãƒ¼ã‚¸ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆ`/pages/[id]`ï¼‰ã‚’é–‹ã
- Next.js DevTools ãƒ‘ãƒãƒ«ã§ `route` ãŒ `dynamic` â†” `static` ã‚’**é«˜é€Ÿã§ç„¡é™ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹**

### å®Ÿè£…ã—ãŸä¿®æ­£

- `app/(protected)/pages/[id]/page.tsx` ã« `export const dynamic = "force-dynamic"` ã‚’è¿½åŠ 
- `.next/cache` ã‚’ãƒªã‚»ãƒƒãƒˆ

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®çµæœãŒæœŸå¾…ã•ã‚Œã¾ã™ï¼š

### âœ… route ãŒ `dynamic` ã«å›ºå®šã•ã‚Œã‚‹

```
Before: dynamic â†’ static â†’ dynamic â†’ static â†’ ... (ç„¡é™å¾ªç’°)
After: dynamic (å›ºå®š)
```

### âœ… DevTools ã§ã®ä¸å®‰å®šãªè¡¨ç¤ºãŒè§£æ¶ˆ

```
Before: route status ãŒé«˜é€Ÿã§åˆ‡ã‚Šæ›¿ã‚ã‚‹
After: route status ãŒå®‰å®šã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
```

### âœ… äºˆæ¸¬ä¸å¯èƒ½ãªã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°å‹•ä½œãŒæ’é™¤

```
Before: ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ãŒä¸å®‰å®š
After: ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ãŒæ˜ç¢ºï¼ˆalways dynamicï¼‰
```

## ğŸ“Š æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### STEP 1: é–‹ç™ºç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

- [ ] **DevTools ãƒ‘ãƒãƒ«ã®ç¢ºèª**

  ```
  ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å·¦ä¸‹ã® Next.js ã‚¢ã‚¤ã‚³ãƒ³ â†’ ãƒ‘ãƒãƒ«ã‚’é–‹ã
  Route: [status] ãŒ dynamic ã«å›ºå®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  ```

- [ ] **ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ç¢ºèª**

  ```
  DevTools â†’ Console
  [searchPages] ãƒ­ã‚°ãŒå‡ºç¶šã‘ã¦ã„ãªã„ã‹
  [AutoReconciler] ãƒ­ã‚°ãŒå‡ºç¶šã‘ã¦ã„ãªã„ã‹
  ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹
  ```

- [ ] **Network ã‚¿ãƒ–ã®ç¢ºèª**

  ```
  DevTools â†’ Network
  POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é »åº¦ãŒé«˜ããªã„ã‹ï¼ˆ3ç§’ä»¥ä¸Šã®é–“éš”ãŒã‚ã‚‹ã‹ï¼‰
  åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ãªã„ã‹
  ```

- [ ] **ãƒšãƒ¼ã‚¸æ“ä½œã®ãƒ†ã‚¹ãƒˆ**
  ```
  - ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›† â†’ 3ç§’å¾Œã«è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹
  - ãƒšãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ â†’ æ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹
  - ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã•ã‚Œã¦å†èª­ã¿è¾¼ã¿ã•ã‚Œã‚‹
  ```

### STEP 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

- [ ] **ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“**

  ```
  lighthouse ã¾ãŸã¯ DevTools â†’ Performance ã‚¿ãƒ–
  - First Contentful Paint (FCP)
  - Largest Contentful Paint (LCP)
  - Time to Interactive (TTI)
  ã®æ”¹å–„ã‚’ç¢ºèª
  ```

- [ ] **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**
  ```
  DevTools â†’ Memory
  ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒãªã„ã‹ç¢ºèª
  ```

### STEP 3: æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºèª

- [ ] **ãƒ“ãƒ«ãƒ‰ã¨ã‚µãƒ¼ãƒãƒ¼èµ·å‹•**

  ```bash
  npm run build
  npm run start
  ```

  - ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹
  - ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‹

- [ ] **æœ¬ç•ªç’°å¢ƒã§ã® route status**
  ```
  æœ¬ç•ªç’°å¢ƒã§ã‚‚ route ãŒ stable ã«è¦‹ãˆã‚‹ã‹
  ãŸã ã—ã€æœ¬ç•ªã§ã¯é€šå¸¸ static ãŒã‚ã‚‹ç¨‹åº¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
  ```

## ğŸ”§ æŠ€è¡“çš„èƒŒæ™¯

### Next.js ã® Dynamic Route åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

Next.js 14+ ã§ã¯ã€ä»¥ä¸‹ã®æ¡ä»¶ã§ route ãŒ **dynamic** ã¨åˆ¤å®šã•ã‚Œã¾ã™ï¼š

```typescript
// âŒ Dynamic ã«ãªã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ä¸å®‰å®šï¼‰
export default async function Page() {
  const user = await getUser(); // å‹•çš„ãƒ‡ãƒ¼ã‚¿å–å¾—
  return <div>{user.name}</div>;
}

// âœ… Static ã«ãªã‚‹å¯èƒ½æ€§ï¼ˆæ˜ç¤ºåŒ–ï¼‰
export const revalidate = 3600; // 1æ™‚é–“ã”ã¨ã«revalidate
export default async function Page() {
  // ...
}

// âœ… æ˜ç¤ºçš„ã« Dynamicï¼ˆæ¨å¥¨ï¼‰
export const dynamic = "force-dynamic";
export default async function Page() {
  const user = await getUser(); // ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æŒ™å‹•ãŒæ˜ç¢º
  return <div>{user.name}</div>;
}
```

### ãªãœå•é¡ŒãŒç™ºç”Ÿã—ãŸã®ã‹

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® `/pages/[id]` ã§ã¯ï¼š

```typescript
// ğŸ”´ å•é¡Œã®ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
export default async function PageDetail() {
  // ã“ã‚Œã‚‰ã®ã‚¯ã‚¨ãƒªã¯æ¯å›å®Ÿè¡Œã•ã‚Œã‚‹
  const user = await supabase.auth.getUser();
  const pages = await getPagesByUser(user.id);
  const sharedPages = await getSharedPagesByUser(user.id);
  // ... ã•ã‚‰ã«è¤‡æ•°ã®ã‚¯ã‚¨ãƒª
}
```

ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°è¨­å®šãŒæ˜ç¤ºã•ã‚Œã¦ã„ãªã„ãŸã‚ã€Next.js ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ¤å®šï¼š

1. **åˆå›**: ã€Œå‹•çš„ãƒ‡ãƒ¼ã‚¿ã ã€ã¨åˆ¤å®š â†’ `dynamic` ã«æ±ºå®š
2. **æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ã€Œã‚ã€ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã—ãªãã¦ã„ã„ã®ã‹ã€ã¨å†åˆ¤å®š â†’ `static` ã«å€™è£œ
3. **ãã®æ¬¡**: ã€Œã§ã‚‚å‹•çš„ãƒ‡ãƒ¼ã‚¿ã ã—ã€... â†’ `dynamic` ã«æˆ»ã‚‹
4. ç„¡é™ãƒ«ãƒ¼ãƒ—

### ä¿®æ­£å¾Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// ğŸŸ¢ ä¿®æ­£å¾Œ
export const dynamic = "force-dynamic";

export default async function PageDetail() {
  // å‹•çš„ãƒ‡ãƒ¼ã‚¿å–å¾—
  const user = await supabase.auth.getUser();
  const pages = await getPagesByUser(user.id);
  // ...ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ãŒæ˜ç¢ºã«ãªã£ãŸ
}
```

ã“ã‚Œã«ã‚ˆã‚Šï¼š

- Next.js ã¯ `route: dynamic` ã«å›ºå®š
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°å‹•ä½œãŒäºˆæ¸¬å¯èƒ½ã«
- ä¸å®‰å®šãªåˆ‡ã‚Šæ›¿ã‚ã‚ŠãŒæ’é™¤

## ğŸ“ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- å‰å›ä¿®æ­£ï¼ˆinfinite POST loopï¼‰: `docs/08_worklogs/2025_10/20251018_34_final-summary.md`
- auto-reconciler ãƒã‚°: `docs/issues/open/20251018_01_infinite-editor-preload-loop.md`
- ç„¡é™ POST ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰: `docs/08_worklogs/2025_10/20251018_37_infinite-post-debug-checklist.md`

## âš ï¸ æ³¨æ„äº‹é …

### ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒé©åˆ‡ãªç†ç”±

```typescript
// âœ… é©åˆ‡: ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ãƒšãƒ¼ã‚¸ã‚¨ãƒ‡ã‚£ã‚¿ã¯å¸¸ã«dynamic
export const dynamic = "force-dynamic";
export default async function PageDetail() {
  // user-specific data
}
```

### æ…é‡ãŒå¿…è¦ãªä»–ã®ãƒšãƒ¼ã‚¸

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦ã¯ã€å€‹åˆ¥ã«æ¤œè¨ãŒå¿…è¦ï¼š

- `/pages` - ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆï¼ˆä¸€éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½ï¼‰
- `/dashboard` - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆä¸€éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½ï¼‰
- `/decks/[deckId]` - ãƒ‡ãƒƒã‚­è©³ç´°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½ï¼‰

ã“ã‚Œã‚‰ã¯ `revalidate` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ®µéšçš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’é©ç”¨ã§ãã¾ã™ã€‚

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### çŸ­æœŸï¼ˆä»Šæ—¥ä¸­ï¼‰

- [ ] ä¿®æ­£ã®æ¤œè¨¼ï¼ˆDevTools ãƒ‘ãƒãƒ«ã§ route ãŒ stable ã‹ç¢ºèªï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ
- [ ] ä»–ã® `/pages` é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç¢ºèª

### ä¸­æœŸï¼ˆä»Šé€±ä¸­ï¼‰

- [ ] ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã® cache strategy ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] ä»–ã® protected route ã«å¯¾ã™ã‚‹ `export const dynamic` ã®é©ç”¨æ¤œè¨
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°

### é•·æœŸ

- [ ] Next.js 15 ã¸ã® upgrade æ¤œè¨ï¼ˆISR ã®æ”¹å–„ãªã©ï¼‰
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ã®æ–‡æ›¸åŒ–
- [ ] é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã« cache strategy ã‚’è¿½åŠ 

## ä½œæˆæ—¥æ™‚

2025-10-18 15:00 JST
