# ğŸ”§ Static/Dynamic åˆ‡ã‚Šæ›¿ã‚ã‚Šå•é¡Œã®ä¿®æ­£ - 2025-10-18

## ğŸ“ å•é¡Œã®ç‰¹å®š

`next dev` ãƒ„ãƒ¼ãƒ«ã®ãƒ‘ãƒãƒ«ã§ **static â†” dynamic ãŒç„¡é™ã«åˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ãŸ**åŸå› ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚

### æ ¹æœ¬åŸå› 

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã®ä¸å®Œå…¨ã•**
   - ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ `app/(protected)/pages/[id]/page.tsx` ã« `export const dynamic = "force-dynamic";` ã¯è¨­å®šã•ã‚Œã¦ã„ãŸ
   - ã—ã‹ã— `export const dynamicParams = true;` ãŒæ¬ è½ã—ã¦ã„ãŸ

2. **revalidatePathã®æ¬ è½**
   - `autoSetThumbnailOnPageView()` ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¦ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ– (`revalidatePath`) ãŒãªã‹ã£ãŸ
   - æ›´æ–°å¾Œã€Next.js ãŒãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œå‡º â†’ å‹•çš„è©•ä¾¡ã«åˆ‡ã‚Šæ›¿ãˆ
   - ã—ã‹ã—ç„¡åŠ¹åŒ–ãŒãªã„ãŸã‚ã€å†åº¦staticåˆ¤å®šã«æˆ»ã‚‹ â†’ ç„¡é™ãƒ«ãƒ¼ãƒ—

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã«ã‚ˆã‚‹æš—é»™çš„ãªå†è©•ä¾¡**
   - ã‚µãƒ ãƒã‚¤ãƒ«è‡ªå‹•è¨­å®šæ™‚ã« `pages` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
   - Supabase ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãŒå¤‰æ›´ã‚’é€šçŸ¥
   - ãƒšãƒ¼ã‚¸ãŒå†è©•ä¾¡ã•ã‚Œã‚‹

---

## âœ… å®Ÿæ–½ã—ãŸä¿®æ­£

### ä¿®æ­£ 1: `dynamicParams` è¨­å®šã‚’è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/(protected)/pages/[id]/page.tsx`

```typescript
// Disable static caching for dynamic page content
// This page fetches user-specific data from Supabase, so it must be rendered dynamically
export const dynamic = "force-dynamic";

// Allow dynamic params to be generated at request time
// Without this, Next.js may try to prerender static params during build
export const dynamicParams = true;
```

**åŠ¹æœ**:
- å‹•çš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `[id]` ãŒé™çš„ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å¯¾è±¡ã«ãªã‚‰ãªã„
- ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å‹•çš„ã«å‡¦ç†ã•ã‚Œã‚‹

### ä¿®æ­£ 2: `revalidatePath` ã‚’è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/_actions/autoSetThumbnail.ts`

```typescript
// Revalidate the page cache after thumbnail update
revalidatePath(`/pages/${pageId}`);
```

**åŠ¹æœ**:
- ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ˜ç¤ºçš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
- Next.js ãŒçµ±ä¸€çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
- static â†” dynamic ã®ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²æ­¢

---

## ğŸ” å‹•ä½œåŸç†

### Before (å•é¡Œã‚ã‚Š)

```
1. ãƒšãƒ¼ã‚¸è¡¨ç¤º (dynamic = force-dynamic)
2. autoSetThumbnailOnPageView() ã§DBã‚’æ›´æ–°
3. Next.js ãŒãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œå‡º
4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ãŒãªã„ãŸã‚ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å†åˆ¤å®š
5. ãƒ‡ãƒ¼ã‚¿ã¯æ›´æ–°ã•ã‚ŒãŸã¾ã¾ â†’ static ã¨åˆ¤å®š
6. æ•°ãƒŸãƒªç§’å¾Œã€DBã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
7. å‰å›ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ â†’ dynamic ã«å¤‰æ›´
8. 1 ã«æˆ»ã‚‹ â†’ ç„¡é™ãƒ«ãƒ¼ãƒ—
```

### After (ä¿®æ­£å¾Œ)

```
1. ãƒšãƒ¼ã‚¸è¡¨ç¤º (dynamic = force-dynamic, dynamicParams = true)
2. autoSetThumbnailOnPageView() ã§DBã‚’æ›´æ–°
3. revalidatePath ã§æ˜ç¤ºçš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
4. æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã§æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
5. ãƒšãƒ¼ã‚¸ãŒå®‰å®šã—ã¦ rendering ã•ã‚Œã‚‹
```

---

## ğŸ“‹ ãƒ†ã‚¹ãƒˆé …ç›®

- [ ] ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã« static â†” dynamic ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
- [ ] next dev ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã§ page type ãŒä¸€å®šã«ä¿ãŸã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚µãƒ ãƒã‚¤ãƒ«è‡ªå‹•è¨­å®šå¾Œã«ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã€å‰ã®ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ï¼‰ãŒå®‰å®šã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- å‰å›ã®ç„¡é™ãƒ«ãƒ¼ãƒ—å•é¡Œ: `docs/08_worklogs/2025_10/20251018_01_infinite-post-loop.md`
- IntersectionObserver ä¿®æ­£: `docs/08_worklogs/2025_10/20251018_30_intersectionobserver-cleanup-fix.md`
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°å•é¡Œ: `docs/issues/open/20251018_02_missing-cache-config.md`

---

## ğŸ¯ é‡è¦åº¦

**High** - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨å®‰å®šæ€§ã«ç›´çµã™ã‚‹å•é¡Œ

---

## ä½œæˆæ—¥

2025-10-18
