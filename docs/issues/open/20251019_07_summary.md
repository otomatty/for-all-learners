# デバッグ準備完了サマリー

**作成日**: 2025-10-19  
**目的**: ユーザーにデバッグ準備状況と次のステップを説明

---

## 📋 現在の状況

### ✅ 完了したこと

1. **デバッグコード追加**
   - `suggestion-plugin.ts` に詳細なキーボードイベントログを追加
   - `tag-rule.ts` に InputRule 実行ログを追加
   - ブラウザコンソール（F12）で処理フローを確認可能に

2. **ドキュメント作成**
   - `20251019_07_tag-duplication-on-enter-space-keys.md` - 問題の詳細
   - `20251019_07_debug-execution-guide.md` - デバッグ方法（詳細版）
   - `20251019_07_debug-ready.md` - 準備状況とテスト方法

3. **修正試行（暫定）**
   - Enter キー時に `insertUnifiedLinkWithQuery()` で手動処理
   - Space キー時に `insertUnifiedLinkWithSpaceKey()` で手動処理
   - ただし、まだ根本原因は特定されていない

---

## 🔍 問題の原因（現在の仮説）

### 仮説 1: InputRule の二重実行（最も可能性が高い）

```
処理順序:
1. ユーザー Enter キー押下
2. KeyHandler が処理 → insertUnifiedLinkWithQuery() 実行
3. トランザクション dispatch → エディタに "#テスト" が挿入
4. **自動的に InputRule がチェック実行**
5. PATTERNS.tag に "#テスト" がマッチ
6. TagInputRule が再度実行 → "##テスト" に変更

原因: dispatch() 後に自動的に InputRule が実行されてしまっている
```

### 仮説 2: Suggestion 状態のクリア失敗

```
仮説: Suggestion state をクリアしても、
InputRule は完全に独立した処理として実行されているため、
state のクリアが効かない
```

---

## 🚀 次のステップ

### ステップ 1: ブラウザでデバッグ実行（推奨）

```bash
# ターミナルで実行
cd /Users/sugaiakimasa/apps/for-all-learners
bun dev
```

ブラウザを開いて `http://localhost:3000` にアクセス

### ステップ 2: テスト実行

1. **F12 キーでコンソール開く**
2. **エディタで以下を実行**:
   ```
   1. " #テスト" と入力（スペース必須）
   2. Enter キーを押す
   ```
3. **コンソール出力を確認**

### ステップ 3: ログ解析

コンソール出力から以下を確認：

| 項目 | 確認事項 |
|------|---------|
| KeyHandler ログ | "Enter key pressed" が表示されるか |
| insertUnifiedLinkWithQuery ログ | "Starting insertion" が表示されるか |
| TagRule ログ | "Tag InputRule triggered" が表示されるか ← ここが重要 |
| エディタ表示 | `#テスト` か `##テスト` か |

---

## 🔧 修正方針

ログから原因を特定した後、以下のいずれかの修正を検討：

### 修正案 A: KeyHandler で Enter を consume する

```typescript
// 現在: preventDefault() だけ
event.preventDefault();

// 修正: keydown イベントを完全に処理済みにする
event.preventDefault();
event.stopPropagation();
```

### 修正案 B: InputRule のパターンを厳密にする

```typescript
// 現在: (?:^|\s)#tag... で、スペース後の # にマッチ
// 修正: より厳密な条件を追加（例：タグの前に "##" がないか確認）
```

### 修正案 C: Tag InputRule を無効化して、KeyHandler のみで処理

```typescript
// 代替案: Suggestion で処理した場合は、InputRule を skip する仕組みを追加
```

---

## ❓ よくある質問

### Q1: デバッグコードはいつ削除するの？

**A**: 原因が特定された後、以下のタイミング:
- 修正コードが確定したら
- テストが全て PASS してから
- `DEBUG_TAG_DUPLICATION = false` に変更して削除

### Q2: テスト環境でのみ表示されるの？

**A**: はい。デバッグコードは以下の条件で表示されます:
- `DEBUG_TAG_DUPLICATION = true` の場合のみ
- ブラウザコンソール（本番環境では通常非表示）
- 本番コードには含まれません

### Q3: パフォーマンスに影響はある？

**A**: デバッグモードで若干のログ出力オーバーヘッドがありますが:
- ブラウザの通常使用では影響なし
- 本番環境では `DEBUG_TAG_DUPLICATION = false` で削除
- コンソール出力のみなので I/O 影響も小さい

---

## 📝 実行後にやること

### ログを確認したら:

1. **ログ全文をコピー**
   - Chrome DevTools: コンソール右クリック → "Save as..."
   - Firefox: コンソール右クリック → "Save logs"

2. **結果を記録**
   - `docs/08_worklogs/2025_10/YYYYMMDD_XX_debug-results.md` に記録
   - 観測内容、コンソール出力、スクリーンショットを含める

3. **修正方針を決定**
   - ログから原因を特定
   - 修正案を選択
   - テストケースを設計

---

## 🔗 関連ドキュメント

- **問題詳細**: `docs/issues/open/20251019_07_tag-duplication-on-enter-space-keys.md`
- **デバッグガイド**: `docs/issues/open/20251019_07_debug-execution-guide.md`
- **実行準備**: `docs/issues/open/20251019_07_debug-ready.md`
- **前の修正**: `docs/issues/resolved/20251019/20251019_06_tag-suggestion-ui-fix-completion.md`

---

## 🎯 最終ゴール

```
現在: #テスト + Enter → ##テスト (❌ 重複)
目標: #テスト + Enter → #テスト (✅ 正常)
      + 改行して次の行へ

現在: #テスト + Space → ##テスト (❌ 重複)
目標: #テスト + Space → #テスト  (✅ 正常)
      + スペース入力
```

---

**準備完了日**: 2025-10-19  
**次の実行**: ブラウザテストでデバッグログを確認
