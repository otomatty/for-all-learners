# F.A.L（For All Learners）要件定義書（逆生成）

## 分析概要

**分析日時**: 2025-07-31  
**対象コードベース**: /Users/sugaiakimasa/apps/for-all-learners  
**抽出要件数**: 45個の機能要件、18個の非機能要件  
**信頼度**: 85% （実装カバレッジと充実したドキュメントに基づく）

## システム概要

### 推定されたシステム目的
F.A.L（For All Learners）は、AI技術を活用した学習体験プラットフォーム（LXP）である。学習者が効率的に学習コンテンツを作成・管理し、科学的根拠に基づいた間隔反復学習を通じて知識の定着を図ることを目的とする。音声入力、OCR、テキストからのAI自動カード生成、ノートテイキング、クイズ機能を統合したオールインワン学習環境を提供する。

### 対象ユーザー
- **学生**: 定期試験対策、受験勉強を行う高校生・大学生
- **資格取得者**: キャリアアップのための資格勉強を行う社会人
- **生涯学習者**: 知的好奇心を満たすため新しいスキルを習得したい一般ユーザー
- **管理者**: システム運用・ユーザー管理を行う管理者

## ユーザーストーリー

### ストーリー1: ユーザー認証・アカウント管理
- **である** 未登録・既存ユーザー **として**
- **私は** Google OAuth またはマジックリンクでシステムに安全にログイン **をしたい**
- **そうすることで** 個人的な学習データやサービスにアクセスできる

**実装根拠**: 
- `app/_actions/auth.ts` - Google OAuth認証、マジックリンク認証
- `app/auth/login/page.tsx` - ログインページ実装
- `middleware.ts` - 認証状態による路由制御

### ストーリー2: 学習目標管理
- **である** 学習者 **として**
- **私は** 学習目標を設定・管理し進捗を追跡 **をしたい**
- **そうすることで** 体系的な学習計画を立て継続的な学習習慣を形成できる

**実装根拠**:
- `app/_actions/study_goals.ts` - 学習目標CRUD操作
- `app/(protected)/goals/` - 目標管理UI
- プラン制限機能（無料プラン: 3個、有料プラン: 10個の目標制限）

### ストーリー3: AI活用学習カード作成
- **である** 学習者 **として**  
- **私は** 音声入力・画像OCR・テキストからAIが自動でフラッシュカードを生成 **してほしい**
- **そうすることで** 手動でのカード作成時間を削減し効率的に学習コンテンツを作成できる

**実装根拠**:
- `app/_actions/generateCards.ts` - AIカード自動生成
- `lib/gemini/` - Google Gemini AI統合
- `app/(protected)/decks/[deckId]/audio/`, `ocr/` - 音声・画像入力ページ

### ストーリー4: 科学的間隔反復学習
- **である** 学習者 **として**
- **私は** FSRSアルゴリズムに基づく最適なタイミングでカード復習 **をしたい**
- **そうすることで** 科学的根拠に基づいた効率的な記憶定着を図れる

**実装根拠**:
- `app/(protected)/learn/` - クイズセッション機能
- `database/schema.sql` - FSRSパラメータフィールド（stability, difficulty等）
- `app/_actions/quiz.ts` - クイズロジック実装

### ストーリー5: ノート・ナレッジベース構築
- **である** 学習者 **として**
- **私は** ノートを作成し、ページ間のリンクを通じて知識を構造化 **をしたい**
- **そうすることで** 学習内容の理解を深め知識の関連性を把握できる

**実装根拠**:
- `app/(protected)/notes/`, `pages/` - ノート・ページ管理システム
- `lib/tiptap-extensions/page-link.ts` - ページ間リンク機能
- `app/(protected)/notes/explorer/` - ノートエクスプローラー

### ストーリー6: 協働学習・共有機能
- **である** 学習者 **として**
- **私は** 作成したデッキやノートを他のユーザーと共有・協働編集 **をしたい**
- **そうすることで** 他者から学び、知識を共有してコミュニティでの学習効果を高められる

**実装根拠**:
- `database/schema.sql` - deck_shares, page_shares, note_shares テーブル
- `app/_actions/notes/shareNote.ts` - ノート共有機能
- share_links テーブル - 一時的共有リンクサポート

## 機能要件（EARS記法）

### 通常要件

#### REQ-001: ユーザー認証
システムは、Google OAuthとマジックリンクによるユーザー認証を提供しなければならない。

**実装根拠**: 
- `app/_actions/auth.ts:loginWithGoogle()` - Google OAuth実装
- `app/_actions/auth.ts:loginWithMagicLink()` - マジックリンク認証
- Supabase Auth統合

#### REQ-002: 学習デッキ管理
システムは、ユーザーがフラッシュカードのデッキを作成、編集、削除できなければならない。

**実装根拠**:
- `app/_actions/decks.ts` - デッキCRUD操作
- `app/(protected)/decks/` - デッキ管理UI
- `database/schema.sql:decks` テーブル定義

#### REQ-003: AI自動カード生成
システムは、音声入力、画像OCR、テキストからAIがフラッシュカードを自動生成しなければならない。

**実装根拠**:
- `app/_actions/generateCards.ts:generateCardsFromTranscript()` 
- `lib/gemini/client.ts` - Google Gemini API統合
- `app/(protected)/decks/[deckId]/audio/` - 音声入力処理

#### REQ-004: FSRS間隔反復学習
システムは、FSRSアルゴリズムに基づく間隔反復スケジューリングを提供しなければならない。

**実装根拠**:
- `database/schema.sql` - stability, difficulty, next_review_at フィールド
- `app/_actions/quiz.ts` - 復習スケジューリングロジック
- `lib/utils/fsrs.ts` - FSRSアルゴリズム実装

#### REQ-005: クイズセッション
システムは、フラッシュカード、多項選択式、穴埋め問題の3つのクイズ形式を提供しなければならない。

**実装根拠**:
- `app/(protected)/learn/_components/` - 各種クイズコンポーネント
- `lib/gemini` - AIによる問題生成（FlashcardQuestion, MultipleChoiceQuestion, ClozeQuestion）

#### REQ-006: ノート・ページ管理
システムは、ユーザーがTiptapエディタを使用してリッチテキストノートとページを作成・編集できなければならない。

**実装根拠**:
- `app/(protected)/pages/`, `notes/` - ページ・ノート管理
- `components/tiptap-editor.tsx` - Tiptapエディタ統合
- `lib/tiptap-extensions/` - カスタム拡張機能

#### REQ-007: ページ間リンク機能
システムは、ノート・ページ間の双方向リンクによるナレッジグラフ構築をサポートしなければならない。

**実装根拠**:
- `lib/tiptap-extensions/page-link.ts` - ページリンク拡張
- `app/_actions/updatePageLinks.ts` - リンク更新処理
- `database/schema.sql` - リンク関係管理

#### REQ-008: コンテンツ共有機能
システムは、デッキ、ページ、ノートの他ユーザーとの共有機能を提供しなければならない。

**実装根拠**:
- `database/schema.sql` - deck_shares, page_shares, note_shares
- `app/_actions/notes/shareNote.ts` - ノート共有ロジック
- 権限レベル管理（view, edit, owner）

#### REQ-009: 一時共有リンク
システムは、有効期限付きの一時共有リンクを生成できなければならない。

**実装根拠**:
- `database/schema.sql:share_links` - 共有リンク管理
- `app/_actions/notes/generateNoteShareLink.ts` - リンク生成
- expires_at フィールドによる期限管理

#### REQ-010: 学習進捗追跡
システムは、ユーザーの学習時間、正解率、デッキ別進捗を記録・表示しなければならない。

**実装根拠**:
- `database/schema.sql:learning_logs` - 学習記録
- `app/(protected)/dashboard/_components/dashboard-summary.tsx` - 統計表示
- `app/_actions/dashboardStats.ts` - 統計計算

### 条件付き要件

#### REQ-101: プラン制限チェック
無料プランユーザーが学習目標を3個超作成しようとした場合、システムは作成を拒否し適切なメッセージを表示しなければならない。

**実装根拠**:
- `app/_actions/study_goals.ts:addStudyGoal()` - プラン制限チェック
- `app/_actions/subscriptions.ts:isUserPaid()` - 有料プラン判定

#### REQ-102: AI機能制限
無料プランユーザーがAI機能を利用する場合、システムは基本機能のみを提供しなければならない。

**実装根拠**:
- `app/_actions/cards.ts:createCard()` - 有料ユーザーのみ問題プリジェネ
- `app/_actions/subscriptions.ts:getUserPlanFeatures()` - プラン機能取得

#### REQ-103: 認証失敗時の処理
無効な認証情報が提供された場合、システムは適切なエラーメッセージを表示しなければならない。

**実装根拠**:
- `app/_actions/auth.ts` - 認証エラーハンドリング
- `middleware.ts` - 未認証ユーザーのリダイレクト処理

#### REQ-104: 管理者権限チェック
管理者機能にアクセスしようとするユーザーの場合、システムは管理者権限を確認しなければならない。

**実装根拠**:
- `app/admin/layout.tsx` - 管理者権限チェック
- `app/_actions/admin.ts:isAdmin()` - 管理者判定ロジック

### 状態要件

#### REQ-201: 認証状態での表示
ユーザーがログイン状態にある場合、システムは認証済みユーザー向けのUIを表示しなければならない。

**実装根拠**:
- `middleware.ts` - 認証状態による路由制御
- protected routesでの認証確認

#### REQ-202: 学習セッション中の状態管理
クイズセッション実行中の場合、システムは進捗状況と残り時間を表示し続けなければならない。

**実装根拠**:
- `app/(protected)/learn/_components/quiz-session.tsx` - セッション状態管理
- タイマー機能、進捗表示

#### REQ-203: 編集モード状態
ページ編集モード中の場合、システムは自動保存とリアルタイムプレビューを提供しなければならない。

**実装根拠**:
- `app/(protected)/pages/[id]/_hooks/useAutoSave.ts` - 自動保存
- `app/(protected)/pages/[id]/_hooks/usePageEditorLogic.ts` - 編集状態管理

### オプション要件

#### REQ-301: 外部サービス連携
システムは、CoSenseとGyazoとの連携機能を提供してもよい。

**実装根拠**:
- `app/_actions/cosense.ts` - CoSense連携
- `app/_actions/gyazo.ts` - Gyazo連携
- `app/(protected)/settings/_components/external-sync-settings/` - 連携設定UI

#### REQ-302: 音声再生機能
システムは、テキスト読み上げ機能を提供してもよい。

**実装根拠**:
- `app/(protected)/pages/[id]/_hooks/useSpeechControls.ts` - 音声制御
- `app/(protected)/pages/[id]/_components/speech-control-buttons.tsx` - UI

#### REQ-303: テーマ・外観カスタマイズ
システムは、ダークモード、カラーテーマの選択機能を提供してもよい。

**実装根拠**:
- `app/(protected)/settings/_components/appearance/` - 外観設定
- `app/themes/` - 複数テーマCSS
- `components/theme-provider.tsx` - テーマ切り替え

### 制約要件

#### REQ-401: プラン目標数制限
システムは、無料プランユーザーに対して最大3個、有料プランユーザーに対して最大10個の学習目標制限を設けなければならない。

**実装根拠**:
- `app/_actions/study_goals.ts` - プラン別制限実装
- サーバーサイドでの制限チェック

#### REQ-402: データアクセス制限（RLS）
システムは、行レベルセキュリティ（RLS）により各ユーザーが自身のデータのみアクセス可能な制約を設けなければならない。

**実装根拠**:
- `database/schema.sql` - RLSポリシー設定
- 全テーブルでのauth.uid()ベース制限

#### REQ-403: ファイルサイズ制限
システムは、アップロード画像・音声ファイルに適切なサイズ制限を設けなければならない。

**実装根拠**:
- `browser-image-compression` パッケージ使用
- クライアントサイドでの圧縮処理

#### REQ-404: セッション管理制約
システムは、Supabase Authによるセッション管理とJWTトークンの適切な期限管理を行わなければならない。

**実装根拠**:
- `lib/supabase/` - Supabaseクライアント設定
- SSRサポートでのセッション継続

## 非機能要件

### パフォーマンス

#### NFR-001: ページ読み込み時間
システムは、主要ページの初期読み込みを3秒以内に完了しなければならない。

**実装根拠**:
- Next.js 15 with Turbopack使用
- 静的最適化とコード分割

#### NFR-002: AI応答時間
システムは、AI機能（カード生成、問題生成）の応答を10秒以内に完了しなければならない。

**実装根拠**:
- Google Gemini 2.5 Flash使用
- 非同期処理による応答性向上

#### NFR-003: 同時ユーザー対応
システムは、同時に1000ユーザーのアクセスを処理できなければならない。

**実装根拠**:
- Vercelでのサーバーレス展開
- Supabase接続プール

### セキュリティ

#### NFR-101: データ暗号化
システムは、保存時および転送時のデータ暗号化を実装しなければならない。

**実装根拠**:
- Supabaseによる保存時暗号化
- HTTPS通信強制

#### NFR-102: 認証セキュリティ
システムは、OAuth2.0準拠の安全な認証機構を実装しなければならない。

**実装根拠**:
- Supabase Auth（OAuth2.0準拠）
- JWTトークンによるセッション管理

#### NFR-103: 入力値検証
システムは、すべてのユーザー入力に対して適切な検証・サニタイズを行わなければならない。

**実装根拠**:
- `react-hook-form` + バリデーション
- `dompurify`, `sanitize-html` パッケージ使用

#### NFR-104: アクセス制御
システムは、リソースレベルでの細粒度アクセス制御を実装しなければならない。

**実装根拠**:
- Supabase RLS（Row Level Security）
- 権限レベル別アクセス制御（owner, editor, viewer）

### ユーザビリティ

#### NFR-201: レスポンシブデザイン
システムは、デスクトップ・タブレット・モバイルデバイスで適切に動作しなければならない。

**実装根拠**:
- Tailwind CSSレスポンシブクラス
- モバイルファーストアプローチ

#### NFR-202: アクセシビリティ
システムは、WCAG 2.1 AA レベルのアクセシビリティ要件を満たさなければならない。

**実装根拠**:
- Radix UIプリミティブ使用
- セマンティックHTML構造
- ARIA属性実装

#### NFR-203: 国際化サポート
システムは、日本語および英語での利用をサポートしなければならない。

**実装根拠**:
- `database/schema.sql` - user_settings.locale
- 多言語対応設定UI

#### NFR-204: PWA対応
システムは、プログレッシブウェブアプリ（PWA）として動作しなければならない。

**実装根拠**:
- `next-pwa` パッケージ使用
- `public/manifest.json`, サービスワーカー実装

### 可用性・信頼性

#### NFR-301: 稼働率
システムは、99.5%以上の稼働率を維持しなければならない。

**実装根拠**:
- Vercel・Supabaseのインフラ信頼性
- サーバーレスアーキテクチャ

#### NFR-302: データバックアップ
システムは、自動的なデータバックアップ機構を持たなければならない。

**実装根拠**:
- Supabaseによる自動バックアップ
- PostgreSQLレプリケーション

#### NFR-303: エラー追跡
システムは、発生したエラーを追跡・ログ記録しなければならない。

**実装根拠**:
- サーバーサイドコンソールログ
- クライアントサイドエラーハンドリング

### 運用性

#### NFR-401: 監視・アラート
システムは、重要メトリクスの監視とアラート機能を提供しなければならない。

**実装根拠**:
- `app/admin/` - 管理者ダッシュボード
- `app/_actions/supabase_metrics.ts` - メトリクス収集

#### NFR-402: ログ出力
システムは、ユーザーアクション・システムイベントの構造化ログを出力しなければならない。

**実装根拠**:
- `database/schema.sql:action_logs` - アクションログ記録
- `app/_actions/actionLogs.ts` - ログ記録処理

#### NFR-403: バージョン管理
システムは、アプリケーションバージョンとデータベーススキーマのバージョン管理を行わなければならない。

**実装根拠**:
- `package.json:version` - アプリバージョン
- `database/migrations/` - マイグレーション管理
- `app/_actions/version.ts` - バージョン情報API

## エッジケース

### エラー処理

#### EDGE-001: AI API失敗時の処理
Google Gemini APIが利用できない場合の代替処理とユーザー通知

**実装根拠**:
- `app/_actions/generateCards.ts` - API呼び出しエラーハンドリング
- try-catch による適切なエラーメッセージ表示

#### EDGE-002: データベース接続失敗
Supabaseデータベース接続が失敗した場合のリトライとフォールバック処理

**実装根拠**:
- Supabaseクライアントの自動リトライ機能
- 接続エラー時のユーザーフィードバック

#### EDGE-003: ファイルアップロード失敗
画像・音声ファイルアップロードが失敗した場合の処理

**実装根拠**:
- ファイルサイズ・形式チェック
- アップロード進捗表示とエラー通知

#### EDGE-004: セッション期限切れ
認証セッションが期限切れになった場合の自動ログアウトとリダイレクト

**実装根拠**:
- `middleware.ts` - セッション期限チェック
- 自動ログインページリダイレクト

### 境界値

#### EDGE-101: 最大文字数制限
各入力フィールドの最大文字数制限とバリデーション

**実装根拠**:
- フォームバリデーション実装
- データベース制約との整合性

#### EDGE-102: プランの境界値
無料プラン制限（目標3個）の境界値での適切な処理

**実装根拠**:
- `app/_actions/study_goals.ts` - 制限チェックロジック
- 制限到達時のUI反応

#### EDGE-103: ファイルサイズ境界
最大ファイルサイズでのアップロード処理

**実装根拠**:
- `browser-image-compression` による圧縮処理
- ファイルサイズチェック

#### EDGE-104: 同時編集時の競合
複数ユーザーが同一ノートを同時編集する場合の競合解決

**実装根拠**:
- `app/(protected)/notes/explorer/_components/conflict-resolution-dialog.tsx`
- 競合検出とマージ機能

## 受け入れ基準

### 実装済み機能テスト

- [x] **ユーザー認証機能**
  - [x] Google OAuth認証によるログイン成功
  - [x] マジックリンク認証によるログイン成功
  - [x] 無効な認証情報でのログイン失敗処理
  - [x] セッション管理とログアウト機能

- [x] **学習デッキ・カード管理機能**
  - [x] デッキの作成・編集・削除
  - [x] カードの作成・編集・削除
  - [x] デッキ内カード一覧表示

- [x] **AI自動カード生成機能**
  - [x] 音声入力からのカード生成
  - [x] 画像OCRからのカード生成
  - [x] テキスト入力からのカード生成
  - [x] 生成されたカードの表示・編集

- [x] **クイズ・学習機能**
  - [x] フラッシュカードクイズ実行
  - [x] 多項選択式クイズ実行
  - [x] 穴埋めクイズ実行
  - [x] FSRS基づく復習スケジューリング

- [x] **ノート・ページ機能**
  - [x] リッチテキストエディタでのノート作成
  - [x] ページ間リンク機能
  - [x] ノートエクスプローラーでの階層管理

- [x] **共有・協働機能**
  - [x] デッキ・ノートの他ユーザーとの共有
  - [x] 権限レベル管理（view, edit, owner）
  - [x] 一時共有リンクの生成・管理

- [x] **プラン・制限管理機能**
  - [x] 無料プラン・有料プランの判定
  - [x] プラン別機能制限（目標数制限等）
  - [x] アップグレード促進UI

- [x] **管理者機能**
  - [x] 管理者権限チェック
  - [x] ユーザー管理・統計表示
  - [x] システムメトリクス監視

### 推奨追加テスト

- [ ] **パフォーマンステスト**
  - [ ] ページ読み込み時間測定（3秒以内目標）
  - [ ] AI応答時間測定（10秒以内目標）
  - [ ] 同時アクセス負荷テスト（1000ユーザー）

- [ ] **セキュリティテスト**
  - [ ] SQLインジェクション対策テスト
  - [ ] XSS対策テスト
  - [ ] CSRF対策テスト
  - [ ] RLS（行レベルセキュリティ）テスト

- [ ] **アクセシビリティテスト**
  - [ ] スクリーンリーダー対応テスト
  - [ ] キーボード操作テスト
  - [ ] カラーコントラスト測定

- [ ] **モバイル・レスポンシブテスト**
  - [ ] iOS・Android実機テスト
  - [ ] タブレット表示テスト
  - [ ] PWA機能テスト

- [ ] **統合テスト**
  - [ ] AI機能のE2Eテスト
  - [ ] 外部サービス連携テスト（CoSense、Gyazo）
  - [ ] データ整合性テスト

## 推定されていない要件

### 不明確な部分

以下の要件は実装から推定が困難なため、ステークホルダーとの確認が必要：

1. **ビジネス要件**
   - 具体的な収益目標・KPI設定
   - ユーザー獲得・維持戦略
   - 競合優位性の定量的指標

2. **運用要件**
   - 災害復旧計画（DR）
   - SLA（サービスレベル合意）の詳細
   - キャパシティプランニング

3. **法的・コンプライアンス要件**
   - GDPR等個人情報保護規則への準拠詳細
   - 教育機関向けFERPA等の規制対応
   - データ保持・削除ポリシー

4. **AI・機械学習要件**
   - 学習効果測定・改善アルゴリズム
   - AIモデルの継続的改善プロセス
   - バイアス対策・公平性要件

### 推奨される次ステップ

1. **ステークホルダーインタビュー** - 推定された要件の確認と詳細化
2. **ユーザビリティテスト** - 実際のユーザーフィードバックの収集
3. **パフォーマンス・セキュリティ監査** - 非機能要件の検証
4. **AI機能評価** - 学習効果・精度の定量的測定

## 分析の制約事項

### 信頼度に影響する要因

- **高い実装カバレッジ**: 主要機能は充実した実装とドキュメントが存在
- **明確なアーキテクチャ**: Next.js + Supabase の構成が明確
- **包括的なデータモデル**: データベーススキーマが詳細に定義済み
- **制約**: ビジネス戦略や運用詳細の推定は困難

### 推定の根拠

- **強い根拠（85%）**: 実装 + テスト + 明確なUI/UX + ドキュメント
- **中程度の根拠（15%）**: 実装のみ、または部分的実装
- **弱い根拠（0%）**: コメントのみ、未実装機能

この要件定義書は、実装された機能を基に逆生成されているため、実際のビジネス要件や仕様と差異がある可能性があります。本書を参考に、ステークホルダーとの確認を通じて正確な要件定義を行うことを推奨します。