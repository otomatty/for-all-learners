# è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ©Ÿèƒ½

## æ¦‚è¦
TipTapã‚¨ãƒ‡ã‚£ã‚¿ã§ä½œæˆã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰ã€å…ˆé ­ã®ç”»åƒã‚’è‡ªå‹•çš„ã«ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦æŠ½å‡ºãƒ»è¨­å®šã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

## å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

### 1. `lib/utils/thumbnailExtractor.ts`
ç”»åƒæŠ½å‡ºã®æ ¸å¿ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã€‚

**ä¸»è¦ãªé–¢æ•°:**
- `extractFirstImageUrl(content: JSONContent): string | null`
  - TipTap JSONContentã‹ã‚‰æœ€åˆã®æœ‰åŠ¹ãªç”»åƒURLã‚’æŠ½å‡º
- `extractThumbnailInfo(content: JSONContent): ThumbnailExtractionResult`  
  - è©³ç´°ãªç”»åƒæƒ…å ±ï¼ˆç”»åƒæ•°ã€æŠ½å‡ºå…ƒãªã©ï¼‰ã‚’å«ã‚€çµæœã‚’è¿”ã™
- `isValidImageUrl(url: string): boolean`
  - URLãŒæœ‰åŠ¹ãªç”»åƒURLã‹ã©ã†ã‹ã‚’åˆ¤å®š

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½:**
- è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ã‚’å—ã‘å…¥ã‚Œ
  - `scrapbox.io`
  - `gyazo.com`
  - `i.gyazo.com`
  - `i.ytimg.com`

### 2. `app/_actions/updatePage.ts` (ä¿®æ­£)
æ—¢å­˜ã®ãƒšãƒ¼ã‚¸æ›´æ–°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ©Ÿèƒ½ã‚’è¿½åŠ ã€‚

**å¤‰æ›´ç‚¹:**
- `autoGenerateThumbnail?: boolean` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
- ãƒšãƒ¼ã‚¸æ›´æ–°æ™‚ã«å…ˆé ­ç”»åƒã‚’è‡ªå‹•ã§ã‚µãƒ ãƒã‚¤ãƒ«ã«è¨­å®š
- æ—¢å­˜ã®å‘¼ã³å‡ºã—ç®‡æ‰€ã¨ã®å¾Œæ–¹äº’æ›æ€§ã‚’ç¶­æŒ

### 3. `app/_actions/pages.ts` (ä¿®æ­£)
åŸºæœ¬çš„ãªCRUDã®createPageã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ©Ÿèƒ½ã‚’è¿½åŠ ã€‚

**å¤‰æ›´ç‚¹:**
- `autoGenerateThumbnail?: boolean` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
- æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆæ™‚ã«è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«è¨­å®š

### 4. `lib/utils/__tests__/thumbnailExtractor.test.ts`
åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã€‚

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:**
- Gyazoç”»åƒã®æ­£ã—ã„æŠ½å‡º
- æ¨™æº–imageæ‹¡å¼µã®ç”»åƒæŠ½å‡º
- è¤‡æ•°ç”»åƒã‹ã‚‰æœ€åˆã®ç”»åƒé¸æŠ
- è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã®é™¤å¤–
- ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®é©åˆ‡ãªå‡¦ç†
- ãƒã‚¹ãƒˆã•ã‚ŒãŸæ§‹é€ ã§ã®ç”»åƒæ¤œå‡º

## å¯¾å¿œã—ã¦ã„ã‚‹ç”»åƒãƒãƒ¼ãƒ‰

### 1. GyazoImage (`gyazoImage`)
```typescript
{
  type: 'gyazoImage',
  attrs: {
    src: 'https://i.gyazo.com/abc123.png',
    fullWidth?: boolean
  }
}
```

### 2. æ¨™æº–Image (`image`)
```typescript
{
  type: 'image',
  attrs: {
    src: 'https://i.ytimg.com/vi/test123/hqdefault.jpg',
    alt?: string
  }
}
```

## ä½¿ç”¨æ–¹æ³•

### è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰
```typescript
// ãƒšãƒ¼ã‚¸æ›´æ–°æ™‚ - è‡ªå‹•çš„ã«ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
await updatePage({
  id: 'page-id',
  title: 'ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«',
  content: JSON.stringify(tiptapContent)
  // autoGenerateThumbnail: true (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
});

// æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆæ™‚
await createPage({
  user_id: 'user-id',
  title: 'æ–°ã—ã„ãƒšãƒ¼ã‚¸',
  content_tiptap: tiptapContent
  // autoGenerateThumbnail: true (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
});
```

### ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚’ç„¡åŠ¹åŒ–
```typescript
// è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚’ç„¡åŠ¹ã«ã™ã‚‹å ´åˆ
await updatePage({
  id: 'page-id',
  title: 'ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«',
  content: JSON.stringify(tiptapContent),
  autoGenerateThumbnail: false
});
```

### ç›´æ¥ç”»åƒæŠ½å‡º
```typescript
import { extractFirstImageUrl } from '@/lib/utils/thumbnailExtractor';

const tiptapContent = editor.getJSON();
const thumbnailUrl = extractFirstImageUrl(tiptapContent);
console.log('æŠ½å‡ºã•ã‚ŒãŸã‚µãƒ ãƒã‚¤ãƒ«:', thumbnailUrl);
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

- **å‡¦ç†æ™‚é–“**: 50msä»¥å†…ã§å®Œäº†ã™ã‚‹ã‚ˆã†æœ€é©åŒ–
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: è¿½åŠ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¯10MBä»¥ä¸‹
- **æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³**: æœ€åˆã®æœ‰åŠ¹ãªç”»åƒãŒè¦‹ã¤ã‹ã£ãŸã‚‰å³åº§ã«å‡¦ç†çµ‚äº†
- **æ·±åº¦å„ªå…ˆæ¢ç´¢**: åŠ¹ç‡çš„ãªãƒãƒ¼ãƒ‰èµ°æŸ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™
è¨±å¯ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ã‹ã‚‰ã®ç”»åƒURLã‚’å—ã‘å…¥ã‚Œï¼š
- **Scrapbox**: `scrapbox.io`
- **Gyazo**: `gyazo.com`, `i.gyazo.com`
- **YouTube**: `i.ytimg.com`

### URLæ¤œè¨¼
- malformedãªURLã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- XSSæ”»æ’ƒå¯¾ç­–ã®ãŸã‚ã®URLã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- ä¸æ­£ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ç”»åƒã¯è‡ªå‹•çš„ã«é™¤å¤–

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
```typescript
const result = extractFirstImageUrl(content);
// result === null (ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³)
```

### ä¸æ­£ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„
```typescript
// null, undefined, ã¾ãŸã¯ä¸æ­£ãªå½¢å¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å®‰å…¨ã«å‡¦ç†ã•ã‚Œã‚‹
const result = extractFirstImageUrl(null); // null
const result2 = extractFirstImageUrl(invalidContent); // null
```

### ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
```typescript
// é–‹ç™ºç’°å¢ƒã§ã¯è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
console.log(`[updatePage] ãƒšãƒ¼ã‚¸ ${id}: ã‚µãƒ ãƒã‚¤ãƒ«æŠ½å‡ºçµæœ = ${thumbnailUrl || 'ç”»åƒãªã—'}`);
console.warn(`Image URL from disallowed domain: ${url}`);
```

## æ—¢å­˜ãƒšãƒ¼ã‚¸å¯¾å¿œæ©Ÿèƒ½

### ã‚µãƒ ãƒã‚¤ãƒ«ä¿æŒãƒ­ã‚¸ãƒƒã‚¯
`updatePage` ã§ã¯æ—¢å­˜ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯**è‡ªå‹•çš„ã«ä¿æŒ**ã•ã‚Œã¾ã™ï¼š

```typescript
// æ—¢å­˜ã‚µãƒ ãƒã‚¤ãƒ«ãŒãªã„å ´åˆã®ã¿æ–°ã—ãç”Ÿæˆ
await updatePage({
  id: 'page-id',
  title: 'ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«',
  content: JSON.stringify(tiptapContent)
  // æ—¢å­˜ã‚µãƒ ãƒã‚¤ãƒ«ãŒã‚ã‚Œã°ä¿æŒã€ãªã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆ
});

// å¼·åˆ¶çš„ã«ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å†ç”Ÿæˆã™ã‚‹å ´åˆ
await updatePage({
  id: 'page-id',
  title: 'ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«',
  content: JSON.stringify(tiptapContent),
  forceRegenerateThumbnail: true // æ—¢å­˜ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ä¸Šæ›¸ã
});
```

### ãƒãƒƒãƒæ›´æ–°æ©Ÿèƒ½
ã‚µãƒ ãƒã‚¤ãƒ«æœªè¨­å®šãƒšãƒ¼ã‚¸ã®ä¸€æ‹¬æ›´æ–°ãŒå¯èƒ½ï¼š

```typescript
import { 
  batchUpdateMissingThumbnails,
  batchUpdateUserThumbnails,
  getThumbnailStats 
} from '@/app/_actions/batchUpdateThumbnails';

// å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ ãƒã‚¤ãƒ«æœªè¨­å®šãƒšãƒ¼ã‚¸ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
const result = await batchUpdateMissingThumbnails(undefined, true, 100);

// ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ ãƒã‚¤ãƒ«æœªè¨­å®šãƒšãƒ¼ã‚¸ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆå®Ÿéš›ã®æ›´æ–°ï¼‰
const userResult = await batchUpdateUserThumbnails('user-id', false);

// ã‚µãƒ ãƒã‚¤ãƒ«çµ±è¨ˆæƒ…å ±ã®å–å¾—
const stats = await getThumbnailStats();
console.log(`ç·ãƒšãƒ¼ã‚¸æ•°: ${stats.totalPages}, æœªè¨­å®š: ${stats.withoutThumbnail}`);
```

### ç®¡ç†è€…å‘ã‘UI
`app/admin/_components/ThumbnailBatchUpdate.tsx` ã§ç®¡ç†è€…å‘ã‘ã®ãƒãƒƒãƒæ›´æ–°UIã‚’æä¾›ï¼š

- ğŸ“Š **çµ±è¨ˆè¡¨ç¤º**: ãƒšãƒ¼ã‚¸æ•°ã¨ã‚µãƒ ãƒã‚¤ãƒ«è¨­å®šçŠ¶æ³
- ğŸ§ª **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: å®Ÿéš›ã«æ›´æ–°ã›ãšã«çµæœã‚’ç¢ºèª
- âš¡ **ä¸€æ‹¬æ›´æ–°**: ã‚µãƒ ãƒã‚¤ãƒ«æœªè¨­å®šãƒšãƒ¼ã‚¸ã®ä¸€æ‹¬å‡¦ç†
- ğŸ‘¤ **ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥**: ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ¼ã‚¸ã®ã¿å¯¾è±¡
- ğŸ“ˆ **çµæœè¡¨ç¤º**: æˆåŠŸ/å¤±æ•—ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ

## ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

### âœ… å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
- [x] æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆæ™‚ã®è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«è¨­å®š
- [x] æ—¢å­˜ãƒšãƒ¼ã‚¸ã®ä¸€æ‹¬ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ï¼ˆç®¡ç†è€…æ©Ÿèƒ½ï¼‰
- [x] æ—¢å­˜ã‚µãƒ ãƒã‚¤ãƒ«ã®ä¿æŒãƒ­ã‚¸ãƒƒã‚¯
- [x] å¼·åˆ¶å†ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³

### P2æ©Ÿèƒ½ï¼ˆè¿½åŠ ï¼‰
- [ ] ã‚µãƒ ãƒã‚¤ãƒ«å±¥æ­´ç®¡ç†
- [ ] è¤‡æ•°ç”»åƒå€™è£œã‹ã‚‰ã®æ‰‹å‹•é¸æŠUI
- [ ] å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå¯¾å¿œ
- [ ] ç”»åƒãƒªã‚µã‚¤ã‚ºãƒ»æœ€é©åŒ–æ©Ÿèƒ½

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚µãƒ ãƒã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œãªã„å ´åˆ
1. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ç”»åƒãƒãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. ç”»åƒURLãŒè¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. `autoGenerateThumbnail` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒfalseã«è¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
4. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ
1. å¤§é‡ã®ç”»åƒã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã§å‡¦ç†ãŒé…ã„å ´åˆ
   - ç”»åƒãƒãƒ¼ãƒ‰ã®æ•°ã‚’ç¢ºèª
   - ä¸è¦ãªç”»åƒã®å‰Šé™¤ã‚’æ¤œè¨
2. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„å ´åˆ
   - JSONContentã®ã‚µã‚¤ã‚ºã‚’ç¢ºèª
   - ç”»åƒã®æœ€é©åŒ–ã‚’æ¤œè¨

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `app/(protected)/pages/_components/pages-list.tsx`: ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
- `lib/tiptap-extensions/gyazo-image.ts`: Gyazoç”»åƒæ‹¡å¼µ
- `types/database.types.ts`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‹å®šç¾©
- `.docs/requirements/automatic-thumbnail-generation.md`: æŠ€è¡“è¦ä»¶å®šç¾©æ›¸
